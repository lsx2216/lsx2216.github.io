<!doctype html><html lang=en><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><style>:root{--accent-color:#FF4D4D}</style><title>JB3-6-ElasticSearch</title>
<meta name=description content="[!NOTE] Java道经第3卷 - 第6阶 - ElasticSearch v3-6-ssm-elasticsearch
S01. ES基础入门 武技: 创建 v3-6-ssm-elasticsearch 子项目
在父项目中锁定版本: …"><meta name=keywords content='blog,lsx2216,hugo'><meta property="og:url" content="https://lsx2216.netlify.app/%E7%AC%AC3%E9%98%B6%E6%AE%B5-SSM/JB3-6-ElasticSearch/JB3-6-ElasticSearch/"><meta property="og:type" content="website"><meta property="og:title" content="JB3-6-ElasticSearch"><meta property="og:description" content="[!NOTE] Java道经第3卷 - 第6阶 - ElasticSearch v3-6-ssm-elasticsearch
S01. ES基础入门 武技: 创建 v3-6-ssm-elasticsearch 子项目
在父项目中锁定版本: …"><meta property="og:image" content="https://lsx2216.netlify.app/assets/images/user.jpg"><meta property="og:image:secure_url" content="https://lsx2216.netlify.app/assets/images/user.jpg"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="JB3-6-ElasticSearch"><meta name=twitter:description content="[!NOTE] Java道经第3卷 - 第6阶 - ElasticSearch v3-6-ssm-elasticsearch
S01. ES基础入门 武技: 创建 v3-6-ssm-elasticsearch 子项目
在父项目中锁定版本: …"><meta property="twitter:domain" content="https://lsx2216.netlify.app/%E7%AC%AC3%E9%98%B6%E6%AE%B5-SSM/JB3-6-ElasticSearch/JB3-6-ElasticSearch/"><meta property="twitter:url" content="https://lsx2216.netlify.app/%E7%AC%AC3%E9%98%B6%E6%AE%B5-SSM/JB3-6-ElasticSearch/JB3-6-ElasticSearch/"><meta name=twitter:image content="https://lsx2216.netlify.app/assets/images/user.jpg"><link rel=canonical href=https://lsx2216.netlify.app/%E7%AC%AC3%E9%98%B6%E6%AE%B5-SSM/JB3-6-ElasticSearch/JB3-6-ElasticSearch/><link rel=stylesheet type=text/css href=/css/normalize.min.css media=print><link rel=stylesheet type=text/css href=/css/main.min.css><link id=dark-theme rel=stylesheet href=/css/dark.min.css><script src=/js/bundle.min.3eb19cb61dde9e37b9522867f3e024aeb68e26ab8e03252e46e365abcb19acf7.js integrity="sha256-PrGcth3enje5Uihn8+AkrraOJquOAyUuRuNlq8sZrPc="></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css integrity=sha384-Xi8rHCmBmhbuyyhbI88391ZKP2dmfnOl4rT9ZfRI7mLTdk1wblIUnrIq35nqwEvC crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.js integrity=sha384-X/XCfMm41VSsqRNQgDerQczD69XqmjOOOwYQvr/uuC+j4OPoNhVgjdGFwhvN02Ja crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],throwOnError:!1})})</script>    <link rel="shortcut icon" href="/assets/images/user.jpg" type="image/x-icon">
</head><body><script>setThemeByUserPref()</script><header class=header><nav class=header-nav><div class=avatar><a href=https://lsx2216.netlify.app/><img src=/assets/images/user.jpg alt=avatar></a></div><div class=nav-title><a class=nav-brand href=https://lsx2216.netlify.app/>lsx2216</a></div><div class=nav-links><div class=nav-link><a href=https://lsx2216.netlify.app/ aria-label><span data-feather=home></span> Home</a></div><div class=nav-link><a href=https://lsx2216.netlify.app/projects/ aria-label><span data-feather=code></span> Projects</a></div><div class=nav-link><a href=https://github.com aria-label=github><span data-feather=github></span></a></div><span class=nav-icons-divider></span><div class="nav-link dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target">theme</span>
<a aria-hidden=true role=switch><span class=theme-toggle-icon data-feather=moon></span></a></div><div class=nav-link id=hamburger-menu-toggle><span class="sr-only hamburger-menu-toggle-screen-reader-target">menu</span>
<a aria-checked=false aria-labelledby=hamburger-menu-toggle id=hamburger-menu-toggle-target role=switch><span data-feather=menu></span></a></div><ul class="nav-hamburger-list visibility-hidden"><li class=nav-item><a href=https://lsx2216.netlify.app/><span data-feather=home></span> Home</a></li><li class=nav-item><a href=https://lsx2216.netlify.app/projects/><span data-feather=code></span> Projects</a></li><li class=nav-item><a href=https://github.com><span data-feather=github></span></a></li><li class="nav-item dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target">theme</span>
<a role=switch><span class=theme-toggle-icon data-feather=moon></span></a></li></ul></div></nav></header><main id=content><div class="post container"><div class=post-header-section><h1>JB3-6-ElasticSearch</h1></div><div class=post-content><blockquote><p>[!NOTE] Java道经第3卷 - 第6阶 - ElasticSearch
v3-6-ssm-elasticsearch</p></blockquote><h1 id=s01-es基础入门>S01. ES基础入门</h1><blockquote><p>武技: 创建 <code>v3-6-ssm-elasticsearch</code> 子项目</p></blockquote><ol><li>在父项目中锁定版本:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#f92672>&lt;junit-version&gt;</span>4.13.2<span style=color:#f92672>&lt;/junit-version&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;lombok-version&gt;</span>1.18.24<span style=color:#f92672>&lt;/lombok-version&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;hutool-version&gt;</span>5.8.14<span style=color:#f92672>&lt;/hutool-version&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;spring-boot-version&gt;</span>2.3.12.RELEASE<span style=color:#f92672>&lt;/spring-boot-version&gt;</span>
</span></span></code></pre></div><ol start=2><li>在父项目中管理依赖:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#75715e>&lt;!--junit--&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;groupId&gt;</span>junit<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;artifactId&gt;</span>junit<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;version&gt;</span>${junit-version}<span style=color:#f92672>&lt;/version&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;scope&gt;</span>test<span style=color:#f92672>&lt;/scope&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;!--lombok--&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;groupId&gt;</span>org.projectlombok<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;artifactId&gt;</span>lombok<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;version&gt;</span>${lombok-version}<span style=color:#f92672>&lt;/version&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;scope&gt;</span>provided<span style=color:#f92672>&lt;/scope&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;!--hutool-all--&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;groupId&gt;</span>cn.hutool<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;artifactId&gt;</span>hutool-all<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;version&gt;</span>${hutool-version}<span style=color:#f92672>&lt;/version&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;!--spring-boot-starter-parent--&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;groupId&gt;</span>org.springframework.boot<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;artifactId&gt;</span>spring-boot-starter-parent<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;version&gt;</span>${spring-boot-version}<span style=color:#f92672>&lt;/version&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;type&gt;</span>pom<span style=color:#f92672>&lt;/type&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;scope&gt;</span>import<span style=color:#f92672>&lt;/scope&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span></code></pre></div><ol start=3><li>在子项目中引入依赖:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#75715e>&lt;!--junit--&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;groupId&gt;</span>junit<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;artifactId&gt;</span>junit<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;!--lombok--&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;groupId&gt;</span>org.projectlombok<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;artifactId&gt;</span>lombok<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;!--hutool-all--&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;groupId&gt;</span>cn.hutool<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;artifactId&gt;</span>hutool-all<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;!--spring-boot-starter-test--&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>&lt;groupId&gt;</span>org.springframework.boot<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>&lt;artifactId&gt;</span>spring-boot-starter-test<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span></code></pre></div><ol start=4><li>开发启动类:</li></ol><p><code>com.lsx.EsApp</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@SpringBootApplication</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>EsApp</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span>(String<span style=color:#f92672>[]</span> args) {
</span></span><span style=display:flex><span>        SpringApplication.<span style=color:#a6e22e>run</span>(EsApp.<span style=color:#a6e22e>class</span>, args);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=e01-es搜索引擎>E01. ES搜索引擎</h2><h3 id=1-elk收集系统>1. ELK收集系统</h3><blockquote><p>心法: ELK = ElasticSearch + Logstash + Kibana</p></blockquote><ul><li>ELK系统要求三个开源工具的版本号必须保持一致:</li></ul><table><thead><tr><th>ELK组件</th><th>关键字</th><th>描述</th></tr></thead><tbody><tr><td>Logstash</td><td>收集，过滤</td><td>数据收集处理引擎，负责收集和过滤项目日志数据。</td></tr><tr><td>Elasticsearch</td><td>搜索，分析</td><td>分布式搜索引擎，负责存储和分析日志数据。</td></tr><tr><td>Kibana</td><td>展示，操作</td><td>数据可视化平台，负责展示日志数据。</td></tr></tbody></table><h3 id=2-es搜索引擎>2. ES搜索引擎</h3><blockquote><p>心法: <a href=https://www.elastic.co>ElasticSearch搜索引擎</a></p></blockquote><ul><li>ES全称 <code>ElasticSearch</code>，是基于lucene核心并由Java开发的一款开源的检索引擎。</li><li>ES支持全文检索，分布式检索，数据统计分析，内容纠错和提示等功能。</li><li>ES可扩展到上百台服务器，可处理PB级数据，且检索延迟通常在1秒以内。</li><li>ES常用于日志搜索，数据聚合，数据监控，报表统计分析等业务。</li></ul><table><thead><tr><th>相关概念</th><th>中文</th><th>描述</th></tr></thead><tbody><tr><td><code>node</code></td><td>节点</td><td>1个启动的ES服务即为一个ES节点，默认名随机生成，用于存储，索引，搜索数据</td></tr><tr><td><code>cluster</code></td><td>集群</td><td>1或N个ES节点可构成1个ES集群，默认名 <code>elasticsearch</code>，集群间共享数据，均可操作数据</td></tr><tr><td><code>index</code></td><td>索引</td><td>对应DB实例 <code>database</code>，索引名建议全小写，包含1或N个 <code>type</code></td></tr><tr><td><code>type</code></td><td>类别</td><td>对应DB表 <code>table</code>，默认名 <code>_doc</code>，ES7+中已被废弃，包含1或N个 <code>document</code></td></tr><tr><td><code>document</code></td><td>文档</td><td>对应DB表记录 <code>record</code>，采用JSON格式存储数据</td></tr><tr><td><code>field</code></td><td>字段</td><td>对应DB表列 <code>column</code>，是构成 <code>document</code> 文档的单元</td></tr><tr><td><code>mapping</code></td><td>映射</td><td><code>index</code> 的配置项，如 <code>field</code> 类型约束，某些数据的使用规则等</td></tr><tr><td><code>shard</code></td><td>分片</td><td>将 <code>index</code> 拆成多个 <code>shard</code> 可以水平切分数据以提升整体查询性能分片数量必须在 <code>index</code> 创建时指定，默认为 <code>1</code> 个，<code>index</code> 创建后不可动态修改分片也是一个功能完整的 <code>index</code>，最多存放int最大值减去128个 <code>document</code></td></tr><tr><td><code>replica</code></td><td>副本</td><td>每个 <code>shard</code> 可以配置1或N个 <code>replica</code> 副本以提升高可用性和并发性能副本数量可以在 <code>index</code> 创建时指定，默认为 <code>1</code> 个，<code>index</code> 创建后也仍可动态修改</td></tr></tbody></table><h2 id=e02-es倒排索引>E02. ES倒排索引</h2><blockquote><p>心法: ES倒排索引 <code>Elasticsearch Inverted Index</code></p></blockquote><ul><li>倒排索引是ES核心特性之一，用于高效地存储和查询文档数据，提高数据搜索效率。</li><li>正排索引是通过主键查内容，适用于精准查询，倒排索引是通过内容查主键，适用于模糊查询。</li></ul><h3 id=1-倒排索引流程>1. 倒排索引流程</h3><blockquote><p>心法: ES倒排索引流程</p></blockquote><pre tabindex=0><code class=language-mermaid data-lang=mermaid>flowchart LR

    n1[&#34;文档&lt;br/&gt;分词&#34;]
--&gt; n2[&#34;对每个文档内容&lt;br/&gt;生成对应的倒排表&#34;]
--&gt; n3[&#34;合并全部倒排表&lt;br/&gt;产生倒排索引结构&#34;]
--&gt; n4[&#34;查询匹配时&lt;br/&gt;通过词条定位到文档&#34;]
</code></pre><ol><li>初始文档：</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{ <span style=color:#f92672>&#34;id&#34;</span>: <span style=color:#ae81ff>1</span>, <span style=color:#f92672>&#34;text&#34;</span>: <span style=color:#e6db74>&#34;hi, i am lilei&#34;</span> }<span style=color:#960050;background-color:#1e0010>,</span>
</span></span><span style=display:flex><span>{ <span style=color:#f92672>&#34;id&#34;</span>: <span style=color:#ae81ff>2</span>, <span style=color:#f92672>&#34;text&#34;</span>: <span style=color:#e6db74>&#34;hi, i am hanmeimei&#34;</span> }<span style=color:#960050;background-color:#1e0010>,</span>
</span></span><span style=display:flex><span>{ <span style=color:#f92672>&#34;id&#34;</span>: <span style=color:#ae81ff>3</span>, <span style=color:#f92672>&#34;text&#34;</span>: <span style=color:#e6db74>&#34;how are you&#34;</span> }<span style=color:#960050;background-color:#1e0010>,</span>
</span></span><span style=display:flex><span>{ <span style=color:#f92672>&#34;id&#34;</span>: <span style=color:#ae81ff>4</span>, <span style=color:#f92672>&#34;text&#34;</span>: <span style=color:#e6db74>&#34;fine, thank you, and you&#34;</span> }<span style=color:#960050;background-color:#1e0010>,</span>
</span></span><span style=display:flex><span>{ <span style=color:#f92672>&#34;id&#34;</span>: <span style=color:#ae81ff>5</span>, <span style=color:#f92672>&#34;text&#34;</span>: <span style=color:#e6db74>&#34;i am fine too&#34;</span> }<span style=color:#960050;background-color:#1e0010>,</span>
</span></span></code></pre></div><ol start=2><li>文档分词：按一定的规则对文档内容分词处理，即将文本内容拆分成terms词条，拆分结果如下：</li></ol><table><thead><tr><th>文档ID</th><th>terms词条</th><th>terms词条</th><th>terms词条</th><th>terms词条</th><th>terms词条</th></tr></thead><tbody><tr><td>1</td><td>hi</td><td>i</td><td>am</td><td>lilei</td><td></td></tr><tr><td>2</td><td>hi</td><td>i</td><td>am</td><td>hanmeimei</td><td></td></tr><tr><td>3</td><td>how</td><td>are</td><td>you</td><td></td><td></td></tr><tr><td>4</td><td>fine</td><td>thank</td><td>you</td><td>and</td><td>you</td></tr><tr><td>5</td><td>i</td><td>am</td><td>fine</td><td>too</td><td></td></tr></tbody></table><ol start=3><li>对于每个词条，ES会创建一个对应的倒排列表，记录该词条在哪些文档中出现：<ol><li>格式：<code>(出现某单词的文档ID; 单词在该文档中出现的次数; 单词在文档中的位置)</code></li></ol></li></ol><table><thead><tr><th>单词</th><th>单词出现频率</th><th>倒排列表</th></tr></thead><tbody><tr><td>hi</td><td>2</td><td>(1; 1; &lt;1>), (2; 1; &lt;1>)</td></tr><tr><td>i</td><td>3</td><td>(1; 1; &lt;2>), (2; 1; &lt;2>), (5; 1; &lt;1>)</td></tr><tr><td>am</td><td>3</td><td>(1; 1; &lt;3>), (2; 1; &lt;3>), (5; 1; &lt;2>)</td></tr><tr><td>lilei</td><td>1</td><td>(1; 1; &lt;4>)</td></tr><tr><td>hanmeimei</td><td>1</td><td>(2; 1; &lt;4>)</td></tr><tr><td>how</td><td>1</td><td>(3; 1; &lt;1>)</td></tr><tr><td>are</td><td>1</td><td>(3; 1; &lt;2>)</td></tr><tr><td>you</td><td>3</td><td>(3; 1; &lt;3>), (4; 2; &lt;3, 5>)</td></tr><tr><td>fine</td><td>1</td><td>(5; 1; &lt;3>)</td></tr><tr><td>too</td><td>1</td><td>(5; 1; &lt;4>)</td></tr></tbody></table><ol start=4><li>索引合并：ES将所有文档的倒排列表合并成一个大的倒排索引结构。</li><li>查询匹配：搜索时，ES根据查询词在倒排索引中查找对应的倒排列表，从而定位相关文档。</li></ol><h1 id=s02-elasticsearch>S02. ElasticSearch</h1><h2 id=e01-单机容器搭建>E01. 单机容器搭建</h2><blockquote><p>武技: 在Docker中搭建单机ElasticSearch容器</p></blockquote><h3 id=1-创建相关目录>1. 创建相关目录</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 创建ElasticSearch相关目录</span>
</span></span><span style=display:flex><span>mkdir -p /opt/es/single/data;
</span></span><span style=display:flex><span>mkdir -p /opt/es/single/plugins;
</span></span><span style=display:flex><span>chmod -R <span style=color:#ae81ff>777</span> /opt/es;
</span></span></code></pre></div><h3 id=2-开发配置文件>2. 开发配置文件</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 拉取镜像（二选一）</span>
</span></span><span style=display:flex><span>docker pull elasticsearch:7.11.2;
</span></span><span style=display:flex><span>docker pull registry.cn-hangzhou.aliyuncs.com/lsx/elasticsearch:7.11.2;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 创建并运行临时的容器: 该容器仅用于拷贝配置文件，用完即删</span>
</span></span><span style=display:flex><span>docker run -d --name tmp <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>      -e ES_JAVA_OPTS<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;-Xms512m -Xmx512m&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>      -e <span style=color:#e6db74>&#34;discovery.type=single-node&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>      registry.cn-hangzhou.aliyuncs.com/lsx/elasticsearch:7.11.2;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 拷贝配置目录到虚拟机</span>
</span></span><span style=display:flex><span>docker cp tmp:/usr/share/elasticsearch/config /opt/es/single/conf
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 停止并删除临时容器，为后续真正的容器让出端口</span>
</span></span><span style=display:flex><span>docker rm -f tmp;
</span></span></code></pre></div><h3 id=3-创建运行容器>3. 创建运行容器</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 创建并运行真正的ES容器</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 参数 `-e &#34;discovery.type=single-node&#34;`: 使用单机模式</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 参数 `-e ES_JAVA_OPTS=&#34;-Xms512m -Xmx512m&#34;`: 设置JVM参数，小于512M无法启动</span>
</span></span><span style=display:flex><span>docker run -itd --name es --network my-net -p 9200:9200 -p 9300:9300 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>      -e <span style=color:#e6db74>&#34;discovery.type=single-node&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>      -e ES_JAVA_OPTS<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;-Xms512m -Xmx512m&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>      -v /opt/es/single/conf:/usr/share/elasticsearch/config <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>      -v /opt/es/single/data:/usr/share/elasticsearch/data <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>      -v /opt/es/single/plugins:/usr/share/elasticsearch/plugins <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>      elasticsearch:7.11.2
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 查看ES容器</span>
</span></span><span style=display:flex><span>docker ps --format <span style=color:#e6db74>&#34;{{.ID}}\t{{.Names}}\t{{.Ports}}&#34;</span>
</span></span><span style=display:flex><span>docker logs es --tail <span style=color:#ae81ff>30</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 进入容器的内部: 查看ES版本</span>
</span></span><span style=display:flex><span>docker exec -it es bash
</span></span><span style=display:flex><span>elasticsearch -version
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 永久开放9200端口和9300端口</span>
</span></span><span style=display:flex><span>firewall-cmd --add-port<span style=color:#f92672>=</span>9200/tcp --permanent
</span></span><span style=display:flex><span>firewall-cmd --add-port<span style=color:#f92672>=</span>9300/tcp --permanent
</span></span><span style=display:flex><span>firewall-cmd --reload
</span></span></code></pre></div><h3 id=4-访问单机容器>4. 访问单机容器</h3><p><code>http://192.168.40.77:9200</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;c5f718301da3&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;cluster_name&#34;</span>: <span style=color:#e6db74>&#34;docker-cluster&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;cluster_uuid&#34;</span>: <span style=color:#e6db74>&#34;3B8ylhOVR9ysdkSwfB39og&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;version&#34;</span>: {
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;number&#34;</span>: <span style=color:#e6db74>&#34;7.11.2&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;build_flavor&#34;</span>: <span style=color:#e6db74>&#34;default&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;build_type&#34;</span>: <span style=color:#e6db74>&#34;docker&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;build_hash&#34;</span>: <span style=color:#e6db74>&#34;3e5a16cfec50876d20ea77b075070932c6464c7d&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;build_date&#34;</span>: <span style=color:#e6db74>&#34;2021-03-06T05:54:38.141101Z&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;build_snapshot&#34;</span>: <span style=color:#66d9ef>false</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;lucene_version&#34;</span>: <span style=color:#e6db74>&#34;8.7.0&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;minimum_wire_compatibility_version&#34;</span>: <span style=color:#e6db74>&#34;6.8.0&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;minimum_index_compatibility_version&#34;</span>: <span style=color:#e6db74>&#34;6.0.0-beta1&#34;</span>
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;tagline&#34;</span>: <span style=color:#e6db74>&#34;You Know, for Search&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=e02-集群容器搭建>E02. 集群容器搭建</h2><blockquote><p>武技: 在Docker中搭建ElasticSearch集群容器</p></blockquote><h3 id=1-修改虚拟内存>1. 修改虚拟内存</h3><ul><li>默认65530字节，ES集群要求在262144字节以上:</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 在 /etc/sysctl.conf 文件末尾添加虚拟内存大小配置</span>
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#39;vm.max_map_count=262144&#39;</span> &gt;&gt; /etc/sysctl.conf;
</span></span><span style=display:flex><span>cat /etc/sysctl.conf;
</span></span><span style=display:flex><span><span style=color:#75715e># 刷新配置</span>
</span></span><span style=display:flex><span>sysctl -p
</span></span></code></pre></div><h3 id=2-创建相关目录>2. 创建相关目录</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 创建2个ES节点的相关目录</span>
</span></span><span style=display:flex><span>mkdir -p /opt/es/cluster/node9201/data;
</span></span><span style=display:flex><span>mkdir -p /opt/es/cluster/node9201/plugins;
</span></span><span style=display:flex><span>mkdir -p /opt/es/cluster/node9202/data;
</span></span><span style=display:flex><span>mkdir -p /opt/es/cluster/node9202/plugins;
</span></span><span style=display:flex><span>chmod -R <span style=color:#ae81ff>777</span> /opt/es/cluster;
</span></span></code></pre></div><h3 id=3-开发配置文件>3. 开发配置文件</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 将单机ES目录的 `conf` 目录分别拷贝到两个ES节点目录中</span>
</span></span><span style=display:flex><span>cp -r /opt/es/single/conf/ /opt/es/cluster/node9201/;
</span></span><span style=display:flex><span>cp -r /opt/es/single/conf/ /opt/es/cluster/node9202/;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 修改9201节点的配置</span>
</span></span><span style=display:flex><span>cd /opt/es/cluster/node9201/conf;
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#39;&#39;</span> &gt; elasticsearch.yml;
</span></span><span style=display:flex><span><span style=color:#75715e># 集群名，必须保证两个ES节点的集群名一致</span>
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#39;cluster.name: &#34;docker-cluster&#34;&#39;</span> &gt;&gt; elasticsearch.yml;
</span></span><span style=display:flex><span><span style=color:#75715e># 允许所有IP对我访问</span>
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#39;network.host: 0.0.0.0&#39;</span> &gt;&gt; elasticsearch.yml;
</span></span><span style=display:flex><span><span style=color:#75715e># ES节点的端口号，默认9200</span>
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#39;http.port: 9201&#39;</span> &gt;&gt; elasticsearch.yml;
</span></span><span style=display:flex><span><span style=color:#75715e># 节点名，必须保证两个ES节点的名称不一致</span>
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#39;node.name: node9201&#39;</span> &gt;&gt; elasticsearch.yml;
</span></span><span style=display:flex><span><span style=color:#75715e># 该节点拥有成为Master的资格</span>
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#39;node.master: true&#39;</span> &gt;&gt; elasticsearch.yml;
</span></span><span style=display:flex><span><span style=color:#75715e># 该节点允许存储数据</span>
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#39;node.data: true&#39;</span> &gt;&gt; elasticsearch.yml;
</span></span><span style=display:flex><span><span style=color:#75715e># 该ES节点的内部集群间通信端口号，必须保证与ES节点端口号不同</span>
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#39;transport.tcp.port: 9301&#39;</span> &gt;&gt; elasticsearch.yml;
</span></span><span style=display:flex><span><span style=color:#75715e># 集群节点列表</span>
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#39;discovery.zen.ping.unicast.hosts: [ &#34;192.168.40.77:9301&#34;, &#34;192.168.40.77:9302&#34; ]&#39;</span> &gt;&gt; elasticsearch.yml;
</span></span><span style=display:flex><span><span style=color:#75715e># 配置初始主节点名</span>
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#39;cluster.initial_master_nodes: node9201&#39;</span> &gt;&gt; elasticsearch.yml;
</span></span><span style=display:flex><span><span style=color:#75715e># 允许被跨域访问，默认false</span>
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#39;http.cors.enabled: true&#39;</span> &gt;&gt; elasticsearch.yml;
</span></span><span style=display:flex><span><span style=color:#75715e># 允许所有域名对我进行访问，值为RE表达式</span>
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#39;http.cors.allow-origin: &#34;*&#34;&#39;</span> &gt;&gt; elasticsearch.yml;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 修改9202节点的配置</span>
</span></span><span style=display:flex><span>cd /opt/es/cluster/node9202/conf;
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#39;&#39;</span> &gt; elasticsearch.yml;
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#39;cluster.name: &#34;docker-cluster&#34;&#39;</span> &gt;&gt; elasticsearch.yml;
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#39;network.host: 0.0.0.0&#39;</span> &gt;&gt; elasticsearch.yml;
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#39;http.port: 9202&#39;</span> &gt;&gt; elasticsearch.yml;
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#39;node.name: node9202&#39;</span> &gt;&gt; elasticsearch.yml;
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#39;node.master: true&#39;</span> &gt;&gt; elasticsearch.yml;
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#39;node.data: true&#39;</span> &gt;&gt; elasticsearch.yml;
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#39;transport.tcp.port: 9302&#39;</span> &gt;&gt; elasticsearch.yml;
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#39;discovery.zen.ping.unicast.hosts: [ &#34;192.168.40.77:9301&#34;, &#34;192.168.40.77:9302&#34; ]&#39;</span> &gt;&gt; elasticsearch.yml;
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#39;cluster.initial_master_nodes: node9201&#39;</span> &gt;&gt; elasticsearch.yml;
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#39;http.cors.enabled: true&#39;</span> &gt;&gt; elasticsearch.yml;
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#39;http.cors.allow-origin: &#34;*&#34;&#39;</span> &gt;&gt; elasticsearch.yml;
</span></span></code></pre></div><h3 id=4-创建运行容器>4. 创建运行容器</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 创建并运行9201节点容器</span>
</span></span><span style=display:flex><span>docker run -d --name es9201 --network my-net -p 9201:9201 -p 9301:9301 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>      -e ES_JAVA_OPTS<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;-Xms512m -Xmx512m&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>      -v /opt/es/cluster/node9201/conf:/usr/share/elasticsearch/config <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>      -v /opt/es/cluster/node9201/data:/usr/share/elasticsearch/data <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>      -v /opt/es/cluster/node9201/plugins:/usr/share/elasticsearch/plugins <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>      registry.cn-hangzhou.aliyuncs.com/lsx/elasticsearch:7.11.2;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 创建并运行9202节点容器</span>
</span></span><span style=display:flex><span>docker run -d --name es9202 --network my-net -p 9202:9202 -p 9302:9302 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>      -e ES_JAVA_OPTS<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;-Xms512m -Xmx512m&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>      -v /opt/es/cluster/node9202/conf:/usr/share/elasticsearch/config <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>      -v /opt/es/cluster/node9202/data:/usr/share/elasticsearch/data <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>      -v /opt/es/cluster/node9202/plugins:/usr/share/elasticsearch/plugins <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>      registry.cn-hangzhou.aliyuncs.com/lsx/elasticsearch:7.11.2;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 查看运行的容器</span>
</span></span><span style=display:flex><span>docker ps --format <span style=color:#e6db74>&#34;{{.ID}}\t{{.Names}}\t{{.Ports}}&#34;</span>
</span></span><span style=display:flex><span>docker logs es9201 --tail <span style=color:#ae81ff>30</span>
</span></span><span style=display:flex><span>docker logs es9202 --tail <span style=color:#ae81ff>30</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 永久开放9201/9202/9301/9302端口</span>
</span></span><span style=display:flex><span>firewall-cmd --add-port<span style=color:#f92672>=</span>9201/tcp --permanent
</span></span><span style=display:flex><span>firewall-cmd --add-port<span style=color:#f92672>=</span>9202/tcp --permanent
</span></span><span style=display:flex><span>firewall-cmd --add-port<span style=color:#f92672>=</span>9301/tcp --permanent
</span></span><span style=display:flex><span>firewall-cmd --add-port<span style=color:#f92672>=</span>9302/tcp --permanent
</span></span><span style=display:flex><span>firewall-cmd --reload
</span></span></code></pre></div><h3 id=5-访问集群容器>5. 访问集群容器</h3><ol><li><a href=http://192.168.40.77:9201/_cat/nodes?pretty>查看ES集群的节点列表</a></li><li><a href=http://192.168.40.77:9201/_cat/health?v>查看ES集群的健康状态</a></li></ol><h1 id=s03-kibana>S03. Kibana</h1><h2 id=e01-单机容器搭建-1>E01. 单机容器搭建</h2><blockquote><p>心法: Kibana可视化平台</p></blockquote><ul><li>Kibana是一个开源的分析与可视化平台，可以使用图形化的界面展示和操作存储在Elasticsearch中的数据。</li></ul><blockquote><p>武技: 在Docker中搭建Kibana容器</p></blockquote><h3 id=1-创建相关目录-1>1. 创建相关目录</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 创建Kibana相关目录</span>
</span></span><span style=display:flex><span>mkdir -p /opt/kibana/conf;
</span></span><span style=display:flex><span>chmod -R <span style=color:#ae81ff>777</span> /opt/kibana;
</span></span></code></pre></div><h3 id=2-编写配置文件>2. 编写配置文件</h3><p><code>vim /opt/kibana/conf/kibana.yml</code>：内容如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-properties data-lang=properties><span style=display:flex><span><span style=color:#75715e># 配置服务名</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>server.name</span><span style=color:#f92672>:</span> <span style=color:#e6db74>kibana</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 配置服务地址 `&#34;0.0.0.0&#34;` 可以简写为 `&#34;0&#34;`</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>server.host</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;0&#34;</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 配置ES服务端地址</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>elasticsearch.hosts</span><span style=color:#f92672>:</span> <span style=color:#e6db74>[&#34;http://192.168.40.77:9200&#34;]</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 配置连接ES服务端的超时毫秒数</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>elasticsearch.requestTimeout</span><span style=color:#f92672>:</span> <span style=color:#e6db74>100000</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 配置Kibana界面使用中文</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>i18n.locale</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;zh-CN&#34;</span>
</span></span></code></pre></div><h3 id=3-创建运行容器-1>3. 创建运行容器</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 拉取镜像（二选一）</span>
</span></span><span style=display:flex><span>docker pull kibana:7.11.2;
</span></span><span style=display:flex><span>docker pull registry.cn-hangzhou.aliyuncs.com/lsx/kibana:7.11.2;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 创建并运行Kibana容器</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 参数 `-e ELASTICSEARCH_URL=http://192.168.40.77:9200`: 指定ES服务端地址。</span>
</span></span><span style=display:flex><span>docker run -itd --name kibana --network my-net -p 5601:5601 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>      -e ELASTICSEARCH_URL<span style=color:#f92672>=</span>http://192.168.40.77:9200 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>      -v /opt/kibana/conf:/usr/share/kibana/config <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>      registry.cn-hangzhou.aliyuncs.com/lsx/kibana:7.11.2;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 查看运行的容器</span>
</span></span><span style=display:flex><span>docker ps --format <span style=color:#e6db74>&#34;{{.ID}}\t{{.Names}}\t{{.Ports}}&#34;</span>
</span></span><span style=display:flex><span>docker logs kibana --tail <span style=color:#ae81ff>30</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 进入Kibana容器的内部: 查看Kibana版本</span>
</span></span><span style=display:flex><span>docker exec -it kibana bash
</span></span><span style=display:flex><span>kibana --version
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 永久开放5601端口</span>
</span></span><span style=display:flex><span>firewall-cmd --add-port<span style=color:#f92672>=</span>5601/tcp --permanent
</span></span><span style=display:flex><span>firewall-cmd --reload
</span></span></code></pre></div><h3 id=4-访问单机容器-1>4. 访问单机容器</h3><ul><li><a href=http://192.168.40.77:5601>在Windows机器上访问Kibana容器</a></li></ul><h2 id=e02-安装ik分词器>E02. 安装IK分词器</h2><h3 id=1-ik基础概念>1. IK基础概念</h3><blockquote><p>心法: IK分词器插件</p></blockquote><ul><li>ElasticSearch自带的标准分词器仅对英文分词合理，对中文采取逐字拆分法，此时建议安装中文的IK分词器插件已解决中文分词问题。</li><li>IK分词器对英文单词忽略大小写。</li></ul><h3 id=2-ik分词方式>2. IK分词方式</h3><blockquote><p>心法: IK分词器分词方式</p></blockquote><pre tabindex=0><code class=language-mermaid data-lang=mermaid>flowchart LR
n1[&#34;ik_smart&lt;br/&gt;最小拆分法&#34;]
	--&gt; n1a[&#34;结果集词条数量较少&lt;br/&gt;适用于检索场景&#34;]
	--&gt; n1b[&#34;JB1-2-Java基础学习&#34;]
		--&gt; n1b1[&#34;jb1-2-java&#34;] &amp; n1b2[&#34;基础&#34;] &amp; n1b3[&#34;学习&#34;]
n2[&#34;ik_max_word&lt;br/&gt;最大拆分法&#34;]
	--&gt; n2a[&#34;结果集词条数量较多&lt;br/&gt;适用于存储场景&#34;]
	--&gt; n2b[&#34;JB1-2-Java基础学习&#34;]
		--&gt; n2b1[&#34;jb1-2-java&#34;] &amp; n2b2[&#34;jb&#34;] &amp; n2b3[&#34;1&#34;] &amp; n2b4[&#34;2&#34;] &amp; n2b5[&#34;java&#34;] &amp; n2b6[&#34;基础&#34;] &amp; n2b7[&#34;学习&#34;]
</code></pre><h3 id=3-ik分词安装>3. IK分词安装</h3><blockquote><p>武技: 为Docker中的ES容器添加IK分词器插件</p></blockquote><ol><li>下载 <a href=https://github.com/medcl/elasticsearch-analysis-ik/releases/tag/v7.11.2>IK分词器插件</a>: 必须和ES服务端版本一致：<ol><li>res: <code>res/elasticsearch-analysis-ik-7.11.2.zip</code></li></ol></li><li>为Docker中的ES容器添加IK分词器插件:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 创建IK分词器插件目录，将IK分词器插件的zip包拷贝进来</span>
</span></span><span style=display:flex><span>mkdir -p /opt/es/single/plugins/ik;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 解压ZIP包</span>
</span></span><span style=display:flex><span>cd /opt/es/single/plugins/ik;
</span></span><span style=display:flex><span>unzip elasticsearch-analysis-ik-7.11.2.zip;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 删除ZIP包（可选）</span>
</span></span><span style=display:flex><span>rm -f elasticsearch-analysis-ik-7.11.2.zip;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 重启ES服务使插件生效</span>
</span></span><span style=display:flex><span>docker restart es
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 查看ES中的所有插件</span>
</span></span><span style=display:flex><span>docker exec -it es bash
</span></span><span style=display:flex><span>elasticsearch-plugin list
</span></span></code></pre></div><ol start=3><li>在Kibana首页的 <code>开发工具</code> 中使用REST命令测试IK分词效果:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 不配置 `analyzer` 则仍然使用默认的逐字拆分法</span>
</span></span><span style=display:flex><span>POST _analyze
</span></span><span style=display:flex><span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;text&#34;</span>: <span style=color:#e6db74>&#34;JB1-2-Java基础学习&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 使用IK最小拆分法</span>
</span></span><span style=display:flex><span>POST _analyze
</span></span><span style=display:flex><span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;text&#34;</span>: <span style=color:#e6db74>&#34;JB1-2-Java基础学习&#34;</span>, <span style=color:#e6db74>&#34;analyzer&#34;</span>: <span style=color:#e6db74>&#34;ik_smart&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 使用IK最大拆分法</span>
</span></span><span style=display:flex><span>POST _analyze
</span></span><span style=display:flex><span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;text&#34;</span>: <span style=color:#e6db74>&#34;JB1-2-Java基础学习&#34;</span>, <span style=color:#e6db74>&#34;analyzer&#34;</span>: <span style=color:#e6db74>&#34;ik_max_word&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h1 id=s04-logstash>S04. Logstash</h1><h2 id=e01-单机容器搭建-2>E01. 单机容器搭建</h2><blockquote><p>武技: 在Docker中搭建Logstash容器</p></blockquote><h3 id=1-创建相关目录-2>1. 创建相关目录</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 创建Logstash相关目录</span>
</span></span><span style=display:flex><span>mkdir -p /opt/logstash/conf;
</span></span></code></pre></div><h3 id=2-修改配置文件>2. 修改配置文件</h3><ol><li>创建 <code>logstash.yml</code> 配置文件：</li></ol><p><code>vim /opt/logstash/conf/logstash.yml</code>：内容如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>http.host</span>: <span style=color:#e6db74>&#34;0.0.0.0&#34;</span> <span style=color:#75715e># 允许任意主机访问</span>
</span></span><span style=display:flex><span><span style=color:#f92672>xpack.monitoring.elasticsearch.hosts</span>: [ <span style=color:#e6db74>&#34;http://192.168.40.77:9200&#34;</span> ] <span style=color:#75715e># ES服务地址</span>
</span></span></code></pre></div><ol start=2><li>创建 <code>logstash.conf</code> 配置文件：</li></ol><p><code>vim /opt/logstash/conf/logstash.conf</code>：内容如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-properties data-lang=properties><span style=display:flex><span><span style=color:#75715e># logstash 输入模块，从日志或数据库中采集数据</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>input</span> <span style=color:#e6db74>{</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>tcp</span> <span style=color:#e6db74>{</span>
</span></span><span style=display:flex><span>	  <span style=color:#75715e># 服务器模式</span>
</span></span><span style=display:flex><span>	  <span style=color:#a6e22e>mode</span> <span style=color:#f92672>=</span><span style=color:#e6db74>&gt; &#34;server&#34;</span>
</span></span><span style=display:flex><span>	  <span style=color:#75715e># 允许任意主机发送日志</span>
</span></span><span style=display:flex><span>	  <span style=color:#a6e22e>host</span> <span style=color:#f92672>=</span><span style=color:#e6db74>&gt; &#34;0.0.0.0&#34; </span>
</span></span><span style=display:flex><span>	  <span style=color:#75715e># 端口号，默认4560</span>
</span></span><span style=display:flex><span>	  <span style=color:#a6e22e>port</span> <span style=color:#f92672>=</span><span style=color:#e6db74>&gt; 4560</span>
</span></span><span style=display:flex><span>	  <span style=color:#75715e># 数据格式</span>
</span></span><span style=display:flex><span>	  <span style=color:#a6e22e>codec</span> <span style=color:#f92672>=</span><span style=color:#e6db74>&gt; json_lines</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>  }</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># logstash 输出模块，将采集好的数据同步至 ES</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>output</span> <span style=color:#e6db74>{</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>elasticsearch</span> <span style=color:#e6db74>{</span>
</span></span><span style=display:flex><span>	  <span style=color:#75715e># ES主机地址</span>
</span></span><span style=display:flex><span>	  <span style=color:#a6e22e>hosts</span> <span style=color:#f92672>=</span><span style=color:#e6db74>&gt; [&#34;http://192.168.40.77:9200&#34;]</span>
</span></span><span style=display:flex><span>	  <span style=color:#75715e># ES索引名称，名称随意</span>
</span></span><span style=display:flex><span>	  <span style=color:#a6e22e>index</span> <span style=color:#f92672>=</span><span style=color:#e6db74>&gt; &#34;lesson-server-%{+yyyy.MM.dd}&#34;</span>
</span></span><span style=display:flex><span>	  <span style=color:#75715e># 数据格式</span>
</span></span><span style=display:flex><span>	  <span style=color:#a6e22e>codec</span> <span style=color:#f92672>=</span><span style=color:#e6db74>&gt; &#34;json&#34;</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>  }</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>}</span>
</span></span></code></pre></div><ol start=3><li>提升两个配置文件的权限：</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 提升两个配置文件权限</span>
</span></span><span style=display:flex><span>chmod -R <span style=color:#ae81ff>777</span> /opt/logstash;
</span></span></code></pre></div><h3 id=3-创建运行容器-2>3. 创建运行容器</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 拉取镜像（二选一）</span>
</span></span><span style=display:flex><span>docker pull logstash:7.11.2;
</span></span><span style=display:flex><span>docker pull registry.cn-hangzhou.aliyuncs.com/lsx/logstash:7.11.2;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 创建并运行Logstash容器</span>
</span></span><span style=display:flex><span>docker run -d --name logstash --network my-net -p 4560:4560 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	-v /opt/logstash/conf/logstash.yml:/usr/share/logstash/config/logstash.yml <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	-v /opt/logstash/conf/logstash.conf:/usr/share/logstash/pipeline/logstash.conf <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	registry.cn-hangzhou.aliyuncs.com/lsx/logstash:7.11.2;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 查看运行的容器</span>
</span></span><span style=display:flex><span>docker ps --format <span style=color:#e6db74>&#34;{{.ID}}\t{{.Names}}\t{{.Ports}}&#34;</span>
</span></span><span style=display:flex><span>docker logs logstash --tail <span style=color:#ae81ff>30</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 永久开放4560端口</span>
</span></span><span style=display:flex><span>firewall-cmd --add-port<span style=color:#f92672>=</span>4560/tcp --permanent
</span></span><span style=display:flex><span>firewall-cmd --reload
</span></span></code></pre></div><h2 id=e02-收集项目日志>E02. 收集项目日志</h2><h3 id=1-添加相关依赖>1. 添加相关依赖</h3><blockquote><p>武技：使用 Logstash 收集项目日志</p></blockquote><ol><li>在父项目中锁定版本:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#f92672>&lt;logstash-version&gt;</span>7.3<span style=color:#f92672>&lt;/logstash-version&gt;</span>
</span></span></code></pre></div><ol start=2><li>在父项目中管理依赖:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#75715e>&lt;!--logstash-logback-encoder--&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;groupId&gt;</span>net.logstash.logback<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;artifactId&gt;</span>logstash-logback-encoder<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;version&gt;</span>${logstash-version}<span style=color:#f92672>&lt;/version&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span></code></pre></div><ol start=3><li>在子项目中引入依赖:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#75715e>&lt;!--logstash-logback-encoder--&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;groupId&gt;</span>net.logstash.logback<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;artifactId&gt;</span>logstash-logback-encoder<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span></code></pre></div><h3 id=2-发送logback日志>2. 发送logback日志</h3><ol><li>在子项目的日志配置文件中添加一个Appender：</li></ol><p><code>logback.xml</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#75715e>&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;configuration&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>&lt;!--定义通用日志格式模板--&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;property</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#34;LOG_PATTERN&#34;</span> 
</span></span><span style=display:flex><span>              <span style=color:#a6e22e>value=</span><span style=color:#e6db74>&#34;%d{yyyy-MM-dd HH:mm:ss.SSS} %-5p %4.15(%t) %c{1}.%M:%L %msg%n&#34;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>&lt;!--控制台Appender: 将日志输出在控制台--&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;appender</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#34;CONSOLE&#34;</span> <span style=color:#a6e22e>class=</span><span style=color:#e6db74>&#34;ch.qos.logback.core.ConsoleAppender&#34;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>&lt;!--配置日志格式--&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;encoder&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>&lt;pattern&gt;</span>${LOG_PATTERN}<span style=color:#f92672>&lt;/pattern&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;/encoder&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;/appender&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>&lt;!--LogStashAppender: 将日志输出到指定的LogStash中--&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;appender</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#34;LOGSTASH&#34;</span> 
</span></span><span style=display:flex><span>              <span style=color:#a6e22e>class=</span><span style=color:#e6db74>&#34;net.logstash.logback.appender.LogstashTcpSocketAppender&#34;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>&lt;!--logStash的服务地址和端口--&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;destination&gt;</span>192.168.40.77:4560<span style=color:#f92672>&lt;/destination&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>&lt;!--编码器--&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;encoder</span> <span style=color:#a6e22e>charset=</span><span style=color:#e6db74>&#34;UTF-8&#34;</span> 
</span></span><span style=display:flex><span>                 <span style=color:#a6e22e>class=</span><span style=color:#e6db74>&#34;net.logstash.logback.encoder.LogstashEncoder&#34;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>&lt;!--过滤器: 阻止INFO级别的日志--&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;filter</span> <span style=color:#a6e22e>class=</span><span style=color:#e6db74>&#34;ch.qos.logback.classic.filter.LevelFilter&#34;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>&lt;level&gt;</span>INFO<span style=color:#f92672>&lt;/level&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>&lt;onMatch&gt;</span>DENY<span style=color:#f92672>&lt;/onMatch&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>&lt;onMismatch&gt;</span>ACCEPT<span style=color:#f92672>&lt;/onMismatch&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;/filter&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;/appender&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>&lt;!--根日志记录器: 对全局的启动日志和运行时日志进行记录，最低级别为INFO--&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;root</span> <span style=color:#a6e22e>level=</span><span style=color:#e6db74>&#34;INFO&#34;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;appender-ref</span> <span style=color:#a6e22e>ref=</span><span style=color:#e6db74>&#34;CONSOLE&#34;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;appender-ref</span> <span style=color:#a6e22e>ref=</span><span style=color:#e6db74>&#34;LOGSTASH&#34;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;/root&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/configuration&gt;</span>
</span></span></code></pre></div><ol start=2><li>开发测试类:</li></ol><p><code>logStash.LogStashTest</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Slf4j</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RunWith</span>(SpringRunner.<span style=color:#a6e22e>class</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@SpringBootTest</span>(classes <span style=color:#f92672>=</span> EsApp.<span style=color:#a6e22e>class</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>LogStashTest</span> {  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@SneakyThrows</span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Test</span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>logstash</span>() {  
</span></span><span style=display:flex><span>        log.<span style=color:#a6e22e>debug</span>(<span style=color:#e6db74>&#34;一条DEBUG级别日志测试记录&#34;</span>);  
</span></span><span style=display:flex><span>        log.<span style=color:#a6e22e>info</span>(<span style=color:#e6db74>&#34;一条INFO级别日志测试记录&#34;</span>);  
</span></span><span style=display:flex><span>        log.<span style=color:#a6e22e>warn</span>(<span style=color:#e6db74>&#34;一条WARN级别日志测试记录&#34;</span>);  
</span></span><span style=display:flex><span>        log.<span style=color:#a6e22e>error</span>(<span style=color:#e6db74>&#34;一条ERROR级别日志测试记录&#34;</span>);  
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 保证Logstash在项目运行结束前完成日志采集工作</span>
</span></span><span style=display:flex><span>        TimeUnit.<span style=color:#a6e22e>SECONDS</span>.<span style=color:#a6e22e>sleep</span>(2L);  
</span></span><span style=display:flex><span>    }  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=3-查看logback日志>3. 查看logback日志</h3><ol><li><a href=http://192.168.40.77:5601>在Windows机器上访问Kibana容器</a></li><li>创建索引模式：</li></ol><p><img src=/%E7%AC%AC3%E9%98%B6%E6%AE%B5-SSM/JB3-6-ElasticSearch/image/%E6%9F%A5%E7%9C%8B%E6%97%A5%E5%BF%97%E6%95%B0%E6%8D%AE01.png alt>
<img src=/%E7%AC%AC3%E9%98%B6%E6%AE%B5-SSM/JB3-6-ElasticSearch/image/%E6%9F%A5%E7%9C%8B%E6%97%A5%E5%BF%97%E6%95%B0%E6%8D%AE02.png alt>
<img src=/%E7%AC%AC3%E9%98%B6%E6%AE%B5-SSM/JB3-6-ElasticSearch/image/%E6%9F%A5%E7%9C%8B%E6%97%A5%E5%BF%97%E6%95%B0%E6%8D%AE03.png alt></p><ol start=3><li>查看日志数据：</li></ol><p><img src=/%E7%AC%AC3%E9%98%B6%E6%AE%B5-SSM/JB3-6-ElasticSearch/image/%E6%9F%A5%E7%9C%8B%E6%97%A5%E5%BF%97%E6%95%B0%E6%8D%AE04.png alt>
<img src=/%E7%AC%AC3%E9%98%B6%E6%AE%B5-SSM/JB3-6-ElasticSearch/image/%E6%9F%A5%E7%9C%8B%E6%97%A5%E5%BF%97%E6%95%B0%E6%8D%AE05.png alt></p><h2 id=e03-同步mysql数据>E03. 同步MySQL数据</h2><blockquote><p>心法: 如何既保证数据同步速度又不影响正常MySQL使用？</p></blockquote><ul><li>数据同步会增加MySQL的负载，可能会对MySQL正常的数据读写造成影响。</li><li>可以在MySQL集群中增加一个专用的只读节点，该节点尽可能与ELK同在一个机房。</li></ul><h3 id=1-mysql同步方案>1. MySQL同步方案</h3><blockquote><p>心法: 同步MySQL数据方案</p></blockquote><ul><li>全量同步：每次都将MySQL中的数据全部同步到ES中，数据一致性高，但效率低。</li><li>增量同步：每次只将MySQL中新增的数据同步到ES中，数据一致性低，但效率高：<ul><li>首次执行仍可视为是一次全量同步。</li></ul></li></ul><blockquote><p>武技: 创建测试数据库并引入员工和部门表</p></blockquote><ul><li><a href=../../%E7%AC%AC2%E9%98%B6%E6%AE%B5-WEB/JB2-3-MySQL/res/%E5%91%98%E5%B7%A5%E5%92%8C%E9%83%A8%E9%97%A8SQL.md>员工和部门SQL</a></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>create</span> <span style=color:#66d9ef>database</span> es <span style=color:#66d9ef>default</span> charset utf8mb4;
</span></span><span style=display:flex><span>use es;
</span></span></code></pre></div><h3 id=2-mysql同步流程>2. MySQL同步流程</h3><ol><li>Logstash执行 <code>select count(*)</code> 获得总条目数。</li><li>Logstash根据 <code>statement</code> 配置的SQL语句来拉取数据：<ol><li>若配置了分页，则Logstatsh通过Limit语句分批从MySQL拉取数据，默认是每次10万条。</li></ol></li><li>数据拉取完毕后，Logstash将最后一条数据的 <code>updated</code> 写入到 <code>lastRun</code> 文件中：<ol><li>若数据拉取过程中下次拉取调度已经到达，则会将下次拉取调度的任务放到任务执行堆栈中。</li><li>全量同步时不需要记录 <code>lastRun</code> 文件。</li></ol></li><li>Logstash会根据schedule配置来执行下一次数据拉取任务：<ol><li>下一次数据拉取任务中只有 <code>updated > lastRun</code> 的记录会被拉取。</li><li>删除掉的SQL记录，不会被拉取到ES中，需要在业务逻辑中进行相关删除或使用逻辑删除。</li></ol></li></ol><h3 id=3-mysql全量同步>3. MySQL全量同步</h3><blockquote><p>武技: 使用Logstash全量同步MySQL中的部门表</p></blockquote><ol><li>创建相关目录：</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 创建Logstash相关目录</span>
</span></span><span style=display:flex><span>mkdir -p /opt/logstash-dept/conf;
</span></span></code></pre></div><ol start=2><li>将 <code>mysql-connector-java-8.0.16.jar</code> 拷贝到 <code>/opt/logstash-dept/</code> 下。</li><li>创建 <code>logstash.yml</code> 配置文件：</li></ol><p><code>touch /opt/logstash-dept/conf/logstash.yml</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># 允许任意主机访问</span>
</span></span><span style=display:flex><span><span style=color:#f92672>http.host</span>: <span style=color:#e6db74>&#34;0.0.0.0&#34;</span> 
</span></span><span style=display:flex><span><span style=color:#75715e># ES服务地址</span>
</span></span><span style=display:flex><span><span style=color:#f92672>xpack.monitoring.elasticsearch.hosts</span>: [ <span style=color:#e6db74>&#34;http://192.168.40.77:9200&#34;</span> ] 
</span></span></code></pre></div><ol start=4><li>创建 <code>logstash.conf</code> 配置文件：</li></ol><p><code>touch /opt/logstash-dept/conf/logstash.conf</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-properties data-lang=properties><span style=display:flex><span><span style=color:#75715e># logstash 输入模块，从日志或数据库中采集数据</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>input</span> <span style=color:#e6db74>{</span>
</span></span><span style=display:flex><span>  	<span style=color:#a6e22e>jdbc</span> <span style=color:#e6db74>{</span>
</span></span><span style=display:flex><span>	    <span style=color:#75715e># MySQL驱动包：地址相对容器内部</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>jdbc_driver_library</span> <span style=color:#f92672>=</span><span style=color:#e6db74>&gt; &#34;/data/mysql-connector-java-8.0.16.jar&#34;</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e># MySQL数据源</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>jdbc_driver_class</span> <span style=color:#f92672>=</span><span style=color:#e6db74>&gt; &#34;com.mysql.cj.jdbc.Driver&#34;</span>
</span></span><span style=display:flex><span>	  	<span style=color:#a6e22e>jdbc_connection_string</span> <span style=color:#f92672>=</span><span style=color:#e6db74>&gt; &#34;jdbc:mysql://192.168.40.77:3306/es?characterEncoding=UTF-8&amp;autoReconnect=true&amp;serverTimezone=Asia/Shanghai&#34;</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>jdbc_user</span> <span style=color:#f92672>=</span><span style=color:#e6db74>&gt; &#34;lsx&#34;</span>
</span></span><span style=display:flex><span>	    <span style=color:#a6e22e>jdbc_password</span> <span style=color:#f92672>=</span><span style=color:#e6db74>&gt; &#34;lsx&#34;</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e># 数据库重连尝试次数</span>
</span></span><span style=display:flex><span>	    <span style=color:#a6e22e>connection_retry_attempts</span> <span style=color:#f92672>=</span><span style=color:#e6db74>&gt; &#34;3&#34;</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e># 是否校验数据库连接：默认false不校验</span>
</span></span><span style=display:flex><span>	    <span style=color:#a6e22e>jdbc_validate_connection</span> <span style=color:#f92672>=</span><span style=color:#e6db74>&gt; &#34;true&#34;</span>
</span></span><span style=display:flex><span>	    <span style=color:#75715e># 校验数据库连接的超时时间：默认3600ms</span>
</span></span><span style=display:flex><span>	    <span style=color:#a6e22e>jdbc_validation_timeout</span> <span style=color:#f92672>=</span><span style=color:#e6db74>&gt; &#34;3600&#34;</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e># 查询语句：通过哪条SQL语句采集数据库记录</span>
</span></span><span style=display:flex><span>	    <span style=color:#a6e22e>statement</span> <span style=color:#f92672>=</span><span style=color:#e6db74>&gt; &#34;select * from es.dept d order by d.updated asc&#34;</span>
</span></span><span style=display:flex><span>	    <span style=color:#75715e># 开启分页查询：默认false不开启</span>
</span></span><span style=display:flex><span>	    <span style=color:#a6e22e>jdbc_paging_enabled</span> <span style=color:#f92672>=</span><span style=color:#e6db74>&gt; &#34;true&#34;</span>
</span></span><span style=display:flex><span>	    <span style=color:#75715e># 单次分页查询条数：默认100000</span>
</span></span><span style=display:flex><span>	    <span style=color:#a6e22e>jdbc_page_size</span> <span style=color:#f92672>=</span><span style=color:#e6db74>&gt; &#34;500&#34;</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e># 同步频率：默认 &#34;* * * * *&#34;，表示每分钟同步一次 </span>
</span></span><span style=display:flex><span>		<span style=color:#75715e># CORN表达式：&#34;分 时 天 月 年&#34;</span>
</span></span><span style=display:flex><span>	    <span style=color:#a6e22e>schedule</span> <span style=color:#f92672>=</span><span style=color:#e6db74>&gt; &#34;* * * * *&#34;</span>
</span></span><span style=display:flex><span>	    <span style=color:#75715e># SQL日志等级: 可选 fatal, error, warn, info, debug，默认info</span>
</span></span><span style=display:flex><span>	    <span style=color:#a6e22e>sql_log_level</span> <span style=color:#f92672>=</span><span style=color:#e6db74>&gt; warn</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># 是否将字段名转换为小写：默认true</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># 如果有数据序列化、反序列化需求，建议改为false</span>
</span></span><span style=display:flex><span>	    <span style=color:#a6e22e>lowercase_column_names</span> <span style=color:#f92672>=</span><span style=color:#e6db74>&gt; false</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>  }</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 过滤移除 @timestamp 和 @version 属性</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>filter</span> <span style=color:#e6db74>{</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>mutate</span> <span style=color:#e6db74>{</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>remove_field</span> <span style=color:#f92672>=</span><span style=color:#e6db74>&gt; [&#34;@timestamp&#34;]</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>	}</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>mutate</span> <span style=color:#e6db74>{</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>remove_field</span> <span style=color:#f92672>=</span><span style=color:#e6db74>&gt; [&#34;@version&#34;]</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>	}</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># logstash 输出模块，将采集好的数据同步至 ES</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>output</span> <span style=color:#e6db74>{</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>elasticsearch</span> <span style=color:#e6db74>{</span>
</span></span><span style=display:flex><span>	  <span style=color:#75715e># ES主机地址</span>
</span></span><span style=display:flex><span>	  <span style=color:#a6e22e>hosts</span> <span style=color:#f92672>=</span><span style=color:#e6db74>&gt; [&#34;http://192.168.40.77:9200&#34;]</span>
</span></span><span style=display:flex><span>	  <span style=color:#75715e># ES索引名称：名称随意</span>
</span></span><span style=display:flex><span>	  <span style=color:#a6e22e>index</span> <span style=color:#f92672>=</span><span style=color:#e6db74>&gt; &#34;dept&#34;</span>
</span></span><span style=display:flex><span>	  <span style=color:#75715e># 数据格式</span>
</span></span><span style=display:flex><span>	  <span style=color:#a6e22e>codec</span> <span style=color:#f92672>=</span><span style=color:#e6db74>&gt; &#34;json&#34;</span>
</span></span><span style=display:flex><span>	  <span style=color:#75715e># 文档索引：建议使用数据库表主键，该值会注入文档的 _id 字段，缺省时随机生成，会造成数据重复</span>
</span></span><span style=display:flex><span>	  <span style=color:#a6e22e>document_id</span> <span style=color:#f92672>=</span><span style=color:#e6db74>&gt; &#34;%{deptno}&#34;</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>  }</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>}</span>
</span></span></code></pre></div><ol start=5><li>提升两个配置文件的权限：</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 提升两个配置文件权限</span>
</span></span><span style=display:flex><span>chmod -R <span style=color:#ae81ff>777</span> /opt/logstash-dept;
</span></span></code></pre></div><ol start=6><li>创建运行容器</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 创建并运行Logstash容器</span>
</span></span><span style=display:flex><span>docker run -d --name logstash-dept --network my-net -p 4660:4560 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	-v /opt/logstash-dept/conf/logstash.yml:/usr/share/logstash/config/logstash.yml <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	-v /opt/logstash-dept/conf/logstash.conf:/usr/share/logstash/pipeline/logstash.conf <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	-v /opt/logstash-dept:/data <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	logstash:7.11.2
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 查看运行的容器</span>
</span></span><span style=display:flex><span>docker ps --format <span style=color:#e6db74>&#34;{{.ID}}\t{{.Names}}\t{{.Ports}}&#34;</span>
</span></span><span style=display:flex><span>docker logs logstash-dept --tail <span style=color:#ae81ff>30</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 永久开放4660端口</span>
</span></span><span style=display:flex><span>firewall-cmd --add-port<span style=color:#f92672>=</span>4660/tcp --permanent
</span></span><span style=display:flex><span>firewall-cmd --reload
</span></span></code></pre></div><ol start=7><li>在Kibana中添加索引模式 <code>dept</code>，然后查看数据是否已经同步到ES中。</li></ol><h3 id=4-mysql增量同步>4. MySQL增量同步</h3><blockquote><p>武技: 使用Logstash全量同步MySQL中的员工表</p></blockquote><ol><li>创建相关目录：</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 创建Logstash相关目录</span>
</span></span><span style=display:flex><span>mkdir -p /opt/logstash-emp/conf;
</span></span></code></pre></div><ol start=2><li>将 <code>mysql-connector-java-8.0.16.jar</code> 拷贝到 <code>/opt/logstash-dept/</code> 下。</li><li>创建 <code>logstash.yml</code> 配置文件：</li></ol><p><code>touch /opt/logstash-emp/conf/logstash.yml</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># 允许任意主机访问</span>
</span></span><span style=display:flex><span><span style=color:#f92672>http.host</span>: <span style=color:#e6db74>&#34;0.0.0.0&#34;</span>
</span></span><span style=display:flex><span><span style=color:#75715e># ES服务地址</span>
</span></span><span style=display:flex><span><span style=color:#f92672>xpack.monitoring.elasticsearch.hosts</span>: [ <span style=color:#e6db74>&#34;http://192.168.40.77:9200&#34;</span> ]
</span></span></code></pre></div><ol start=4><li>创建 <code>logstash.conf</code> 配置文件：</li></ol><p><code>touch /opt/logstash-emp/conf/logstash.conf</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-properties data-lang=properties><span style=display:flex><span><span style=color:#75715e># logstash 输入模块，从日志或数据库中采集数据</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>input</span> <span style=color:#e6db74>{</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>jdbc</span> <span style=color:#e6db74>{</span>
</span></span><span style=display:flex><span>	    <span style=color:#75715e># MySQL驱动包：地址相对容器内部</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>jdbc_driver_library</span> <span style=color:#f92672>=</span><span style=color:#e6db74>&gt; &#34;/data/mysql-connector-java-8.0.16.jar&#34;</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e># MySQL数据源</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>jdbc_driver_class</span> <span style=color:#f92672>=</span><span style=color:#e6db74>&gt; &#34;com.mysql.cj.jdbc.Driver&#34;</span>
</span></span><span style=display:flex><span>	  	<span style=color:#a6e22e>jdbc_connection_string</span> <span style=color:#f92672>=</span><span style=color:#e6db74>&gt; &#34;jdbc:mysql://192.168.40.77:3306/es?characterEncoding=UTF-8&amp;autoReconnect=true&amp;serverTimezone=Asia/Shanghai&#34;</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>jdbc_user</span> <span style=color:#f92672>=</span><span style=color:#e6db74>&gt; &#34;lsx&#34;</span>
</span></span><span style=display:flex><span>	    <span style=color:#a6e22e>jdbc_password</span> <span style=color:#f92672>=</span><span style=color:#e6db74>&gt; &#34;lsx&#34;</span>
</span></span><span style=display:flex><span>	    <span style=color:#75715e># 数据库重连尝试次数</span>
</span></span><span style=display:flex><span>	    <span style=color:#a6e22e>connection_retry_attempts</span> <span style=color:#f92672>=</span><span style=color:#e6db74>&gt; &#34;3&#34;</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e># 是否校验数据库连接：默认false不校验</span>
</span></span><span style=display:flex><span>	    <span style=color:#a6e22e>jdbc_validate_connection</span> <span style=color:#f92672>=</span><span style=color:#e6db74>&gt; &#34;true&#34;</span>
</span></span><span style=display:flex><span>	    <span style=color:#75715e># 校验数据库连接的超时时间：默认3600ms</span>
</span></span><span style=display:flex><span>	    <span style=color:#a6e22e>jdbc_validation_timeout</span> <span style=color:#f92672>=</span><span style=color:#e6db74>&gt; &#34;3600&#34;</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e># 查询语句：通过哪条SQL语句采集数据库记录</span>
</span></span><span style=display:flex><span>	    <span style=color:#a6e22e>statement</span> <span style=color:#f92672>=</span><span style=color:#e6db74>&gt; &#34;select * from es.emp e where e.updated &gt; :sql_last_value order by e.updated asc&#34;</span>
</span></span><span style=display:flex><span>	    <span style=color:#75715e># 开启分页查询：默认false不开启</span>
</span></span><span style=display:flex><span>	    <span style=color:#a6e22e>jdbc_paging_enabled</span> <span style=color:#f92672>=</span><span style=color:#e6db74>&gt; &#34;true&#34;</span>
</span></span><span style=display:flex><span>	    <span style=color:#75715e># 单次分页查询条数：默认100000</span>
</span></span><span style=display:flex><span>	    <span style=color:#a6e22e>jdbc_page_size</span> <span style=color:#f92672>=</span><span style=color:#e6db74>&gt; &#34;500&#34;</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e># 同步频率：默认 &#34;* * * * *&#34;，表示每分钟同步一次 </span>
</span></span><span style=display:flex><span>		<span style=color:#75715e># CORN表达式：&#34;分 时 天 月 年&#34;</span>
</span></span><span style=display:flex><span>	    <span style=color:#a6e22e>schedule</span> <span style=color:#f92672>=</span><span style=color:#e6db74>&gt; &#34;* * * * *&#34;</span>
</span></span><span style=display:flex><span>	    <span style=color:#75715e># SQL日志等级: 可选 fatal, error, warn, info, debug，默认info；</span>
</span></span><span style=display:flex><span>	    <span style=color:#a6e22e>sql_log_level</span> <span style=color:#f92672>=</span><span style=color:#e6db74>&gt; warn</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># 是否将字段名转换为小写：默认true</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># 如果有数据序列化、反序列化需求，建议改为false</span>
</span></span><span style=display:flex><span>	    <span style=color:#a6e22e>lowercase_column_names</span> <span style=color:#f92672>=</span><span style=color:#e6db74>&gt; false</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>############## 增量同步相关配置 ############## </span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e># 开启自定义标识列：false时，标识列默认为当前timestamp的值</span>
</span></span><span style=display:flex><span>	    <span style=color:#a6e22e>use_column_value</span> <span style=color:#f92672>=</span><span style=color:#e6db74>&gt; true</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e># 标识列：用于增量同步，需是数据库字段，不用添加别名</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>tracking_column</span> <span style=color:#f92672>=</span><span style=color:#e6db74>&gt; &#34;updated&#34;</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e># 标识列类型：可选 numeric 和 timestamp，默认numeric</span>
</span></span><span style=display:flex><span>	    <span style=color:#a6e22e>tracking_column_type</span> <span style=color:#f92672>=</span><span style=color:#e6db74>&gt; timestamp</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># true：将上次执行结果中的最后一条SQL记录的 updated 字段的值记录在TXT文件中</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># false：不记录</span>
</span></span><span style=display:flex><span>	    <span style=color:#a6e22e>record_last_run</span> <span style=color:#f92672>=</span><span style=color:#e6db74>&gt; true</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e># TXT文件：地址相对容器内部</span>
</span></span><span style=display:flex><span>	    <span style=color:#a6e22e>last_run_metadata_path</span> <span style=color:#f92672>=</span><span style=color:#e6db74>&gt; &#34;/data/last_id.txt&#34;</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e># 是否清除TXT文件记录：增量同步时此配置字段必须设置为false</span>
</span></span><span style=display:flex><span>	    <span style=color:#a6e22e>clean_run</span> <span style=color:#f92672>=</span><span style=color:#e6db74>&gt; false</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>  }</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 过滤移除 @timestamp 和 @version 属性</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>filter</span> <span style=color:#e6db74>{</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>mutate</span> <span style=color:#e6db74>{</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>remove_field</span> <span style=color:#f92672>=</span><span style=color:#e6db74>&gt; [&#34;@timestamp&#34;]</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>	}</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>mutate</span> <span style=color:#e6db74>{</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>remove_field</span> <span style=color:#f92672>=</span><span style=color:#e6db74>&gt; [&#34;@version&#34;]</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>	}</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># logstash 输出模块，将采集好的数据同步至 ES</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>output</span> <span style=color:#e6db74>{</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>elasticsearch</span> <span style=color:#e6db74>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e># ES主机地址</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>hosts</span> <span style=color:#f92672>=</span><span style=color:#e6db74>&gt; [&#34;http://192.168.40.77:9200&#34;]</span>
</span></span><span style=display:flex><span>	    <span style=color:#75715e># ES索引名称：名称随意</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>index</span> <span style=color:#f92672>=</span><span style=color:#e6db74>&gt; &#34;emp&#34;</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e># 文档索引：建议使用数据库表主键，该值会注入文档的 _id 字段，缺省时随机生成，会造成数据重复</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>document_id</span> <span style=color:#f92672>=</span><span style=color:#e6db74>&gt; &#34;%{empno}&#34;</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>	}</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>stdout</span> <span style=color:#e6db74>{</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>codec</span> <span style=color:#f92672>=</span><span style=color:#e6db74>&gt; json_lines</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>	}</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>}</span>
</span></span></code></pre></div><ol start=5><li>提升两个配置文件的权限：</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 提升两个配置文件权限</span>
</span></span><span style=display:flex><span>chmod -R <span style=color:#ae81ff>777</span> /opt/logstash-emp;
</span></span></code></pre></div><ol start=6><li>创建运行容器</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 创建并运行Logstash容器</span>
</span></span><span style=display:flex><span>docker run -d --name logstash-emp --network my-net -p 4760:4560 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	-v /opt/logstash-emp/conf/logstash.yml:/usr/share/logstash/config/logstash.yml <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	-v /opt/logstash-emp/conf/logstash.conf:/usr/share/logstash/pipeline/logstash.conf <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	-v /opt/logstash-emp:/data <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	logstash:7.11.2
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 查看运行的容器</span>
</span></span><span style=display:flex><span>docker ps --format <span style=color:#e6db74>&#34;{{.ID}}\t{{.Names}}\t{{.Ports}}&#34;</span>
</span></span><span style=display:flex><span>docker logs logstash-emp --tail <span style=color:#ae81ff>30</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 永久开放4760端口</span>
</span></span><span style=display:flex><span>firewall-cmd --add-port<span style=color:#f92672>=</span>4760/tcp --permanent
</span></span><span style=display:flex><span>firewall-cmd --reload
</span></span></code></pre></div><ol start=7><li>在Kibana中添加索引模式 <code>emp</code>，然后查看数据是否已经同步到ES中。</li></ol><h1 id=s05-es基本命令>S05. ES基本命令</h1><h2 id=e01-rest索引操作>E01. REST索引操作</h2><blockquote><p>心法: REST索引操作</p></blockquote><table><thead><tr><th>REST命令</th><th>描述</th><th>细节</th></tr></thead><tbody><tr><td><code>PUT i_user</code></td><td>创建指定索引</td><td>重复创建报错</td></tr><tr><td><code>GET i_user</code></td><td>查看指定索引</td><td></td></tr><tr><td><code>GET _cat/indices?v</code></td><td>查看当前ES节点中全部索引</td><td></td></tr><tr><td><code>DELETE i_user</code></td><td>删除指定索引</td><td>索引不存在报错</td></tr></tbody></table><blockquote><p>武技: 在Kibana控制台测试ES索引相关的常用REST命令</p></blockquote><h3 id=1-创建索引>1. 创建索引</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 创建指定索引，该命令不支持POST</span>
</span></span><span style=display:flex><span>PUT i_user
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 重复创建报错</span>
</span></span><span style=display:flex><span>PUT i_user
</span></span></code></pre></div><h3 id=2-查看索引>2. 查看索引</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 查看指定索引</span>
</span></span><span style=display:flex><span>GET i_user
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 查看当前ES节点中全部索引</span>
</span></span><span style=display:flex><span>GET _cat/indices?v
</span></span></code></pre></div><h3 id=3-删除索引>3. 删除索引</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 删除指定索引</span>
</span></span><span style=display:flex><span>DELETE i_user
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 索引不存在报错</span>
</span></span><span style=display:flex><span>DELETE i_user_2
</span></span></code></pre></div><h2 id=e02-rest文档操作>E02. REST文档操作</h2><blockquote><p>心法: REST文档操作</p></blockquote><table><thead><tr><th>REST命令</th><th>描述</th></tr></thead><tbody><tr><td><code>POST i_user/_doc/1 { "name": "赵四" }</code></td><td>在指定索引的指定类型下创建1号文档</td></tr><tr><td><code>GET i_user/_doc/1</code></td><td>查看指定索引的指定类型下的1号文档</td></tr><tr><td><code>DELETE i_user/_doc/1</code></td><td>删除指定索引的指定类型下的1号文档</td></tr></tbody></table><blockquote><p>武技: 在Kibana控制台测试ES文档相关的常用REST命令</p></blockquote><h3 id=1-创建文档>1. 创建文档</h3><ul><li>创建文档时，文档类型 <code>type</code> 和文档 <code>id</code> 需要同时指定：</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#75715e># 向指定索引中添加1号文档数据，body需要另起一行</span>
</span></span><span style=display:flex><span>POST i_user/_doc/<span style=color:#ae81ff>1</span> 
</span></span><span style=display:flex><span>{ 
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;name&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#e6db74>&#34;赵四&#34;</span>, <span style=color:#e6db74>&#34;age&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#ae81ff>18</span> 
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 向指定索引中添加1号文档数据：重复添加视为修改</span>
</span></span><span style=display:flex><span>POST i_user/_doc/<span style=color:#ae81ff>1</span> 
</span></span><span style=display:flex><span>{ 
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;name&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#e6db74>&#34;赵四&#34;</span>, <span style=color:#e6db74>&#34;age&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#ae81ff>58</span> 
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 向指定索引中添加2号文档数据：重复添加视为修改</span>
</span></span><span style=display:flex><span>POST i_user/_doc/<span style=color:#ae81ff>2</span> 
</span></span><span style=display:flex><span>{ 
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;name&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#e6db74>&#34;刘能&#34;</span>, <span style=color:#e6db74>&#34;age&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#ae81ff>60</span> 
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=2-查看文档>2. 查看文档</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 查看指定索引中的1号文档数据</span>
</span></span><span style=display:flex><span>GET i_user/_doc/1
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 查看指定索引中的2号文档数据</span>
</span></span><span style=display:flex><span>GET i_user/_doc/2
</span></span></code></pre></div><h3 id=3-删除文档>3. 删除文档</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 删除指定索引中的2号文档数据</span>
</span></span><span style=display:flex><span>DELETE i_user/_doc/2
</span></span></code></pre></div><h2 id=e03-rest文档检索>E03. REST文档检索</h2><blockquote><p>心法: 检索结果集分析</p></blockquote><ul><li>ES的检索使用 <code>_search</code> 关键字，用于检索指定索引中的文档，默认只展示10条文档:</li></ul><pre tabindex=0><code class=language-mermaid data-lang=mermaid>flowchart LR
n[&#34;结果集&#34;] --&gt; n1 &amp; n2 &amp; n3 &amp; n4
n1[&#34;took 检索耗时毫秒数&#34;]
n2[&#34;timed_out 本次检索是否超时&#34;]
n3[&#34;_shards 分片情况&#34;]
	n3 --&gt; n3a[&#34;total 总计检索了少分片&#34;]
	n3 --&gt; n3b[&#34;successful 成功检索了少分片&#34;]
	n3 --&gt; n3c[&#34;skipped 跳过了多少分片&#34;]
	n3 --&gt; n3d[&#34;failed 失败了多少分片&#34;]
n4[&#34;hits 命中情况&#34;]
	n4 --&gt; n4a[&#34;total 总计数量&#34;]
		n4a --&gt; n4a1[&#34;value 命中数量&#34;]
		n4a --&gt; n4a2[&#34;relation 命中关系&#34;]
	n4 --&gt; n4b[&#34;max_score 最高命中匹配分数&#34;]
	n4 --&gt; n4c[&#34;hits 命中内容列表&#34;]
</code></pre><blockquote><p>武技: 在Kibana控制台测试ES检索相关的常用REST命令</p></blockquote><ol><li>准备测试数据：</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>POST i_user/_doc/1
</span></span><span style=display:flex><span><span style=color:#f92672>{</span><span style=color:#e6db74>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;赵四&#34;</span>, <span style=color:#e6db74>&#34;age&#34;</span>, 18, <span style=color:#e6db74>&#34;gender&#34;</span>: <span style=color:#e6db74>&#34;male&#34;</span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>POST i_user/_doc/2
</span></span><span style=display:flex><span><span style=color:#f92672>{</span><span style=color:#e6db74>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;刘能&#34;</span>, <span style=color:#e6db74>&#34;age&#34;</span>, 19, <span style=color:#e6db74>&#34;gender&#34;</span>: <span style=color:#e6db74>&#34;male&#34;</span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>POST i_user/_doc/3
</span></span><span style=display:flex><span><span style=color:#f92672>{</span><span style=color:#e6db74>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;广坤&#34;</span>, <span style=color:#e6db74>&#34;age&#34;</span>, 35, <span style=color:#e6db74>&#34;gender&#34;</span>: <span style=color:#e6db74>&#34;male&#34;</span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>POST i_user/_doc/4
</span></span><span style=display:flex><span><span style=color:#f92672>{</span><span style=color:#e6db74>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;刘英&#34;</span>, <span style=color:#e6db74>&#34;age&#34;</span>, 44, <span style=color:#e6db74>&#34;gender&#34;</span>: <span style=color:#e6db74>&#34;male&#34;</span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>POST i_user/_doc/5
</span></span><span style=display:flex><span><span style=color:#f92672>{</span><span style=color:#e6db74>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;王云&#34;</span>, <span style=color:#e6db74>&#34;age&#34;</span>, 65, <span style=color:#e6db74>&#34;gender&#34;</span>: <span style=color:#e6db74>&#34;male&#34;</span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>POST i_user/_doc/6
</span></span><span style=display:flex><span><span style=color:#f92672>{</span><span style=color:#e6db74>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;大拿&#34;</span>, <span style=color:#e6db74>&#34;age&#34;</span>, 18, <span style=color:#e6db74>&#34;gender&#34;</span>: <span style=color:#e6db74>&#34;male&#34;</span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=1-全文检索>1. 全文检索</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 检索指定索引中的全部文档</span>
</span></span><span style=display:flex><span>GET i_user/_search
</span></span></code></pre></div><h3 id=2-分页检索>2. 分页检索</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 检索分页: 从第0条文档开始（默认0），检索并显示3条文档（默认10）</span>
</span></span><span style=display:flex><span>GET i_user/_search 
</span></span><span style=display:flex><span><span style=color:#f92672>{</span> 
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;from&#34;</span>: 0, 
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;size&#34;</span>: <span style=color:#ae81ff>3</span> 
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=3-检索排序>3. 检索排序</h3><ul><li>ES排序查询时，默认使用 <code>_score</code> 倒序：<ul><li>若使用其他字段排序，则默认的 <code>_score</code> 排序会失效，若想保留该效果则需要手动设置。</li></ul></li><li>ES排序查询时，尽量只使用数字进行排序，若非要对字符串排序，用 <code>属性名.keyword</code> 替代。</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 按年龄升序，年龄相同时按姓名降序</span>
</span></span><span style=display:flex><span>GET i_user/_search
</span></span><span style=display:flex><span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;sort&#34;</span>: <span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;age&#34;</span>: <span style=color:#e6db74>&#34;asc&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;name.keyword&#34;</span>: <span style=color:#e6db74>&#34;desc&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>]</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=4-条件检索>4. 条件检索</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#75715e># 查询name属性中包含 `赵` 或 `刘` 的全部文档 - 方案1</span>
</span></span><span style=display:flex><span>GET i_user/_search
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;query&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> {
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;match&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> {
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;name&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#e6db74>&#34;赵刘&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 查询name属性中包含 `赵` 或 `刘` 的全部文档 - 方案2</span>
</span></span><span style=display:flex><span>GET i_user/_search
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;query&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> {
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;bool&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> {
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;must&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;match&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> {
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;name&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#e6db74>&#34;赵刘&#34;</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 查询name属性值中包含 `赵四` 短语的全部文档 - 方案1</span>
</span></span><span style=display:flex><span>GET i_user/_search
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;query&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> {
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;match_phrase&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> {
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;name&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#e6db74>&#34;赵四&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 查询name属性值中包含 `赵四` 短语的全部文档 - 方案2</span>
</span></span><span style=display:flex><span>GET i_user/_search
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;query&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> {
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;bool&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> {
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;must&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;match_phrase&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> {
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;name&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#e6db74>&#34;赵四&#34;</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 查询id属性值不为1的全部文档</span>
</span></span><span style=display:flex><span>GET i_user/_search
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;query&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> {
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;bool&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> {
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;must_not&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> [
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;match&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> {
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;id&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      ]
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 查询id属性值在3到7之间（包括两端值）的全部文档</span>
</span></span><span style=display:flex><span>GET i_user/_search
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;query&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> {
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;bool&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> {
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;filter&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> [
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;range&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> {
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;age&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> {
</span></span><span style=display:flex><span>              <span style=color:#e6db74>&#34;gte&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#ae81ff>30</span>,
</span></span><span style=display:flex><span>              <span style=color:#e6db74>&#34;lte&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#ae81ff>70</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      ]
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=5-聚合检索>5. 聚合检索</h3><ul><li>聚合筛选结果的命名是自定义的，如 <code>sumResult/minResult</code> 等。</li><li>聚合筛选默认会展示部分数据，如不需要，可以额外设置 <code>size: 0</code> 来屏蔽数据。</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#75715e># 查询全部文档中的age属性值的总和/最小值/最大值/平均值/多少个/多少种/全部聚合信息</span>
</span></span><span style=display:flex><span>GET i_user/_search
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;aggs&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> {
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;sumResult&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> {
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;sum&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;field&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#e6db74>&#34;age&#34;</span>
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;minResult&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> {
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;min&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;field&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#e6db74>&#34;age&#34;</span>
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;maxResult&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> {
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;max&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;field&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#e6db74>&#34;age&#34;</span>
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;avgResult&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> {
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;avg&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;field&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#e6db74>&#34;age&#34;</span>
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;countResult&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> {
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;value_count&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;field&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#e6db74>&#34;age&#34;</span>
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;typeResult&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> {
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;cardinality&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;field&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#e6db74>&#34;age&#34;</span>
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;statsResult&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> {
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;stats&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;field&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#e6db74>&#34;age&#34;</span>
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;size&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 按gender分组，查询每组的age的总和/最大值/最小值/平均值/总数量</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 支持在 `terms` 同级再次用 `aggs` 聚合</span>
</span></span><span style=display:flex><span>GET i_user/_search
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;aggs&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> {
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;result&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> {
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;terms&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;field&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#e6db74>&#34;gender.keyword&#34;</span>
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;aggs&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;statsResult&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> {
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;stats&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> {
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;field&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#e6db74>&#34;age&#34;</span>
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;size&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h1 id=s06-es客户端类>S06. ES客户端类</h1><blockquote><p>心法: o.s.d.e.c.ElasticsearchRestTemplate</p></blockquote><ul><li>ElasticsearchRestTemplate是ES常用的一个Java客户端模板。</li></ul><h2 id=e01-模板类常用注解>E01. 模板类常用注解</h2><h3 id=1-doc实体类>1. Doc实体类</h3><blockquote><p>心法: Doc实体类</p></blockquote><ul><li>Doc实体类用于映射ES数据，相当于映射数据库数据的Entity实体类。</li><li>Doc实体类使用 <code>@Document</code> 标记，一个实体类对应一条ES文档:<ul><li><code>indexName</code> 属性: 指定ES索引名，索引自动创建。</li></ul></li><li>Doc实体类主键属性使用 <code>@Id</code> 标记: 提高按主键查询时的效率。</li><li>Doc实体类非主键属性使用 <code>@Field</code> 标记，对应ES字段。</li></ul><table><thead><tr><th><code>@Field</code> 常用属性</th><th>描述</th></tr></thead><tbody><tr><td><code>type = FieldType.Text</code></td><td>String型属性，可以进行IK分词<code>analyzer="ik_max_word"</code>: 对该属性的值采用IK最大拆分后存入ES数据库<code>searchAnalyzer="ik_smart"</code>: 对该属性的值采用IK最小拆分后，依次到ES数据库中搜索</td></tr><tr><td><code>type = FieldType.KeyWord</code></td><td>String型属性，不可以进行IK分词</td></tr><tr><td><code>type=FieldType.Double</code></td><td>Double型属性</td></tr><tr><td><code>type=FieldType.Integer</code></td><td>Integer型属性</td></tr><tr><td><code>type=FieldType.Byte</code></td><td>Byte型属性</td></tr><tr><td><code>type=FieldType.Boolean</code></td><td>Boolean型属性</td></tr><tr><td><code>type=FieldType.Date</code></td><td>Date型属性<code>format=DateFormat.custom</code>: 使用自定义日期格式，默认使用时间戳<code>pattern="yyyy-MM-dd HH:mm:ss"</code>: 指定具体的日期格式</td></tr></tbody></table><h2 id=e02-模板类整合方式>E02. 模板类整合方式</h2><blockquote><p>武技: 在项目中整合ElasticsearchRestTemplate模板</p></blockquote><h3 id=1-添加相关依赖-1>1. 添加相关依赖</h3><p><code>pom.xml</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#75715e>&lt;!--spring-boot-starter-data-elasticsearch--&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;groupId&gt;</span>org.springframework.boot<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;artifactId&gt;</span>spring-boot-starter-data-elasticsearch<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span></code></pre></div><h3 id=2-开发主配文件>2. 开发主配文件</h3><p><code>classpath:application.properties</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-properties data-lang=properties><span style=display:flex><span><span style=color:#75715e>############################# ElasticsearchRestTemplate ##############################</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 指定ES服务器，集群用逗号分隔</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.elasticsearch.rest.uris</span><span style=color:#f92672>=</span><span style=color:#e6db74>http://192.168.40.77:9200</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 忽略CustomConversions的日志警告</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>logging.level.org.springframework.data.convert.CustomConversions</span><span style=color:#f92672>=</span><span style=color:#e6db74>ERROR</span>
</span></span></code></pre></div><h3 id=3-开发doc实体类>3. 开发Doc实体类</h3><p><code>com.lsx.es.DeptDoc</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>import</span> java.time.LocalDateTime;  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Data</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Document</span>(indexName <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;dept&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@JsonNaming</span>(PropertyNamingStrategy.<span style=color:#a6e22e>KebabCaseStrategy</span>.<span style=color:#a6e22e>class</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>DeptDoc</span> {  
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Id</span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Integer deptno;  
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Field</span>(type <span style=color:#f92672>=</span> FieldType.<span style=color:#a6e22e>Text</span>, analyzer <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;ik_max_word&#34;</span>, searchAnalyzer <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;ik_smart&#34;</span>)  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String dname;  
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Field</span>(type <span style=color:#f92672>=</span> FieldType.<span style=color:#a6e22e>Keyword</span>)  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String loc;  
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Field</span>(type <span style=color:#f92672>=</span> FieldType.<span style=color:#a6e22e>Date</span>, format <span style=color:#f92672>=</span> DateFormat.<span style=color:#a6e22e>custom</span>,  
</span></span><span style=display:flex><span>            pattern <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;yyyy-MM-dd&#39;T&#39;HH:mm:ss.SSS&#39;Z&#39;&#34;</span>)  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> LocalDateTime created;  
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Field</span>(type <span style=color:#f92672>=</span> FieldType.<span style=color:#a6e22e>Date</span>, format <span style=color:#f92672>=</span> DateFormat.<span style=color:#a6e22e>custom</span>,  
</span></span><span style=display:flex><span>            pattern <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;yyyy-MM-dd&#39;T&#39;HH:mm:ss.SSS&#39;Z&#39;&#34;</span>)  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> LocalDateTime updated;  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=4-配置属性分词>4. 配置属性分词</h3><ul><li>对指定索引中的指定属性字段设置IK分词，需要手动更改该索引的 <code>mapping{}</code> 内容。</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#75715e># 拷贝 dept 索引中的 `mapping{}` 配置，注意末尾逗号不需要</span>
</span></span><span style=display:flex><span>GET dept
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 删除 `dept` 索引</span>
</span></span><span style=display:flex><span>DELETE dept
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 重建 dept 索引，在body中粘贴 `mapping{}` 内容</span>
</span></span><span style=display:flex><span><span style=color:#75715e># `dname` 字段需要在 `fields` 同级额外添加 `&#34;analyzer&#34; : &#34;ik_max_word&#34;` 配置</span>
</span></span><span style=display:flex><span><span style=color:#75715e># `dname` 字段需要在 `fields` 同级额外添加 `&#34;search_analyzer&#34; : &#34;ik_smart&#34;` 配置</span>
</span></span><span style=display:flex><span>PUT dept
</span></span><span style=display:flex><span>{ 
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;mappings&#34;</span> <span style=color:#960050;background-color:#1e0010>:</span> {
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;properties&#34;</span> <span style=color:#960050;background-color:#1e0010>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;created&#34;</span> <span style=color:#960050;background-color:#1e0010>:</span> {
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;type&#34;</span> <span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#e6db74>&#34;date&#34;</span>
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;deptno&#34;</span> <span style=color:#960050;background-color:#1e0010>:</span> {
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;type&#34;</span> <span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#e6db74>&#34;long&#34;</span>
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;dname&#34;</span> <span style=color:#960050;background-color:#1e0010>:</span> {
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;type&#34;</span> <span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#e6db74>&#34;text&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;fields&#34;</span> <span style=color:#960050;background-color:#1e0010>:</span> {
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;keyword&#34;</span> <span style=color:#960050;background-color:#1e0010>:</span> {
</span></span><span style=display:flex><span>              <span style=color:#e6db74>&#34;type&#34;</span> <span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#e6db74>&#34;keyword&#34;</span>,
</span></span><span style=display:flex><span>              <span style=color:#e6db74>&#34;ignore_above&#34;</span> <span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#ae81ff>256</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>          },
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;analyzer&#34;</span> <span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#e6db74>&#34;ik_max_word&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;search_analyzer&#34;</span> <span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#e6db74>&#34;ik_smart&#34;</span>
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;loc&#34;</span> <span style=color:#960050;background-color:#1e0010>:</span> {
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;type&#34;</span> <span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#e6db74>&#34;text&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;fields&#34;</span> <span style=color:#960050;background-color:#1e0010>:</span> {
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;keyword&#34;</span> <span style=color:#960050;background-color:#1e0010>:</span> {
</span></span><span style=display:flex><span>              <span style=color:#e6db74>&#34;type&#34;</span> <span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#e6db74>&#34;keyword&#34;</span>,
</span></span><span style=display:flex><span>              <span style=color:#e6db74>&#34;ignore_above&#34;</span> <span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#ae81ff>256</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;updated&#34;</span> <span style=color:#960050;background-color:#1e0010>:</span> {
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;type&#34;</span> <span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#e6db74>&#34;date&#34;</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 测试 dept 索引的分词效果</span>
</span></span><span style=display:flex><span>GET dept/_analyze
</span></span><span style=display:flex><span>{ 
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;text&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#e6db74>&#34;JB1-2-Java基础学习&#34;</span>, 
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;analyzer&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#e6db74>&#34;ik_smart&#34;</span> 
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=e03-模板类常用方法>E03. 模板类常用方法</h2><blockquote><p>武技: 在子项目中测试ES客户端常用API</p></blockquote><p><code>doc.DeptDocTest</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Slf4j</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RunWith</span>(SpringRunner.<span style=color:#a6e22e>class</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>@SpringBootTest</span>(classes <span style=color:#f92672>=</span> EsApp.<span style=color:#a6e22e>class</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>DeptDocTest</span> {
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Autowired</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> ElasticsearchRestTemplate esTemplate;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=1-批量添加>1. 批量添加</h3><p><code>doc.DeptDocTest.save()</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Test</span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>save</span>() {  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 返回刚添加的数据</span>
</span></span><span style=display:flex><span>	Iterable<span style=color:#f92672>&lt;</span>DeptDoc<span style=color:#f92672>&gt;</span> result <span style=color:#f92672>=</span> esTemplate.<span style=color:#a6e22e>save</span>(  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>new</span> DeptDoc(50, <span style=color:#e6db74>&#34;人事部&#34;</span>, <span style=color:#e6db74>&#34;哈尔滨&#34;</span>, LocalDateTime.<span style=color:#a6e22e>now</span>(), LocalDateTime.<span style=color:#a6e22e>now</span>()),  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>new</span> DeptDoc(51, <span style=color:#e6db74>&#34;运维开发部&#34;</span>, <span style=color:#e6db74>&#34;齐齐哈尔&#34;</span>, LocalDateTime.<span style=color:#a6e22e>now</span>(), LocalDateTime.<span style=color:#a6e22e>now</span>()),  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>new</span> DeptDoc(52, <span style=color:#e6db74>&#34;测试开发部&#34;</span>, <span style=color:#e6db74>&#34;河南&#34;</span>, LocalDateTime.<span style=color:#a6e22e>now</span>(), LocalDateTime.<span style=color:#a6e22e>now</span>()),  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>new</span> DeptDoc(53, <span style=color:#e6db74>&#34;总222&#34;</span>, <span style=color:#e6db74>&#34;广州&#34;</span>, LocalDateTime.<span style=color:#a6e22e>now</span>(), LocalDateTime.<span style=color:#a6e22e>now</span>()),  
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 重复添加视为修改  </span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>new</span> DeptDoc(53, <span style=color:#e6db74>&#34;总部&#34;</span>, <span style=color:#e6db74>&#34;广州&#34;</span>, LocalDateTime.<span style=color:#a6e22e>now</span>(), LocalDateTime.<span style=color:#a6e22e>now</span>()),  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>new</span> DeptDoc(54, <span style=color:#e6db74>&#34;设计部&#34;</span>, <span style=color:#e6db74>&#34;北京&#34;</span>, LocalDateTime.<span style=color:#a6e22e>now</span>(), LocalDateTime.<span style=color:#a6e22e>now</span>()));  
</span></span><span style=display:flex><span>	System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(result);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=2-按主键查询>2. 按主键查询</h3><p><code>doc.DeptDocTest.get()</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>get</span>() {
</span></span><span style=display:flex><span>	System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(esTemplate.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;50&#34;</span>, DeptDoc.<span style=color:#a6e22e>class</span>));
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 查询失败返回null</span>
</span></span><span style=display:flex><span>	System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(esTemplate.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;99&#34;</span>, DeptDoc.<span style=color:#a6e22e>class</span>));
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=3-按主键删除>3. 按主键删除</h3><p><code>doc.DeptDocTest.delete()</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>delete</span>() {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (esTemplate.<span style=color:#a6e22e>exists</span>(<span style=color:#e6db74>&#34;99&#34;</span>, DeptDoc.<span style=color:#a6e22e>class</span>)) {
</span></span><span style=display:flex><span>		System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(esTemplate.<span style=color:#a6e22e>delete</span>(<span style=color:#e6db74>&#34;99&#34;</span>, DeptDoc.<span style=color:#a6e22e>class</span>));
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=4-按条件查数>4. 按条件查数</h3><p><code>doc.DeptDocTest.count()</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Test</span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>count</span>() {  
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 构建本地搜索器: 条件查询器  </span>
</span></span><span style=display:flex><span>	Query query <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> NativeSearchQueryBuilder()  
</span></span><span style=display:flex><span>	        .<span style=color:#a6e22e>withQuery</span>(QueryBuilders.<span style=color:#a6e22e>matchQuery</span>(<span style=color:#e6db74>&#34;dname&#34;</span>, <span style=color:#e6db74>&#34;开发&#34;</span>))  
</span></span><span style=display:flex><span>	        .<span style=color:#a6e22e>build</span>();  
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>long</span> count <span style=color:#f92672>=</span> esTemplate.<span style=color:#a6e22e>count</span>(query, DeptDoc.<span style=color:#a6e22e>class</span>);  
</span></span><span style=display:flex><span>	System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(count);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=5-按条件搜索>5. 按条件搜索</h3><p><code>doc.DeptDocTest.search()</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Test</span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>search</span>() {  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 构建本地搜索器: 条件查询器，分页数据，结果集按分数倒序，符和条件的词语倾斜高亮  </span>
</span></span><span style=display:flex><span>    Query query <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> NativeSearchQueryBuilder()  
</span></span><span style=display:flex><span>            .<span style=color:#a6e22e>withQuery</span>(QueryBuilders.<span style=color:#a6e22e>matchQuery</span>(<span style=color:#e6db74>&#34;dname&#34;</span>, <span style=color:#e6db74>&#34;开发&#34;</span>))  
</span></span><span style=display:flex><span>            <span style=color:#75715e>// ES中的分页是从0开始的</span>
</span></span><span style=display:flex><span>            .<span style=color:#a6e22e>withPageable</span>(PageRequest.<span style=color:#a6e22e>of</span>(0, 5))  
</span></span><span style=display:flex><span>            .<span style=color:#a6e22e>withSort</span>(SortBuilders.<span style=color:#a6e22e>fieldSort</span>(<span style=color:#e6db74>&#34;_score&#34;</span>).<span style=color:#a6e22e>order</span>(SortOrder.<span style=color:#a6e22e>DESC</span>))  
</span></span><span style=display:flex><span>            .<span style=color:#a6e22e>withHighlightFields</span>(<span style=color:#66d9ef>new</span> HighlightBuilder.<span style=color:#a6e22e>Field</span>(<span style=color:#e6db74>&#34;dname&#34;</span>))  
</span></span><span style=display:flex><span>            .<span style=color:#a6e22e>build</span>();  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ES: 按条件搜索数据  </span>
</span></span><span style=display:flex><span>    SearchHits<span style=color:#f92672>&lt;</span>DeptDoc<span style=color:#f92672>&gt;</span> searchHits <span style=color:#f92672>=</span> esTemplate.<span style=color:#a6e22e>search</span>(query, DeptDoc.<span style=color:#a6e22e>class</span>);  
</span></span><span style=display:flex><span>    System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(searchHits);  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 若搜索成功，则将结果转为List类型的数据并返回  </span>
</span></span><span style=display:flex><span>    List<span style=color:#f92672>&lt;</span>DeptDoc<span style=color:#f92672>&gt;</span> result <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ArrayList<span style=color:#f92672>&lt;&gt;</span>();  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>searchHits.<span style=color:#a6e22e>isEmpty</span>()) {  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> (SearchHit<span style=color:#f92672>&lt;</span>DeptDoc<span style=color:#f92672>&gt;</span> searchHit : searchHits) {  
</span></span><span style=display:flex><span>            result.<span style=color:#a6e22e>add</span>(searchHit.<span style=color:#a6e22e>getContent</span>());  
</span></span><span style=display:flex><span>        }  
</span></span><span style=display:flex><span>    }  
</span></span><span style=display:flex><span>    System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(result);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></div><svg id="btt-button" class="arrow-logo" xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 384 512" onclick="scrollToTop()" title="Go to top"><path d="M177 159.7l136 136c9.4 9.4 9.4 24.6.0 33.9l-22.6 22.6c-9.4 9.4-24.6 9.4-33.9.0L160 255.9l-96.4 96.4c-9.4 9.4-24.6 9.4-33.9.0L7 329.7c-9.4-9.4-9.4-24.6.0-33.9l136-136c9.4-9.5 24.6-9.5 34-.1z"/></svg>
<script>let backToTopButton=document.getElementById("btt-button");window.onscroll=function(){scrollFunction()};function scrollFunction(){document.body.scrollTop>20||document.documentElement.scrollTop>20?backToTopButton.style.display="block":backToTopButton.style.display="none"}function scrollToTop(){window.scrollTo(0,0)}</script></div></main><footer class=footer><span>&copy; 2024 The Marauders</span>
<span>Made with &#10084;&#65039; using <a target=_blank href=https://github.com/gokarna-theme/gokarna-hugo>Gokarna</a></span></footer></body></html>