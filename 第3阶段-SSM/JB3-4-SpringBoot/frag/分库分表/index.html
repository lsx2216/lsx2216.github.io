<!doctype html><html lang=en><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><style>:root{--accent-color:#FF4D4D}</style><title>lsx2216</title>
<meta name=description content="[!NOTE] Java道经第3卷 - 第4阶 - SpringBoot v3-4-ssm-springboot/shardingsphere
S01. 分库分表 E01. 分库分表概念 1. 何为分库分表 心法：通常分库与分表的操作会同时进行，以至于我们习惯性的将它们合在一起叫做分库分表
单机的容量可以随意扩展，但数 …"><meta name=keywords content='blog,lsx2216,hugo'><meta property="og:url" content="https://lsx2216.netlify.app/%E7%AC%AC3%E9%98%B6%E6%AE%B5-SSM/JB3-4-SpringBoot/frag/%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8/"><meta property="og:type" content="website"><meta property="og:title" content="lsx2216"><meta property="og:description" content="[!NOTE] Java道经第3卷 - 第4阶 - SpringBoot v3-4-ssm-springboot/shardingsphere
S01. 分库分表 E01. 分库分表概念 1. 何为分库分表 心法：通常分库与分表的操作会同时进行，以至于我们习惯性的将它们合在一起叫做分库分表
单机的容量可以随意扩展，但数 …"><meta property="og:image" content="https://lsx2216.netlify.app/assets/images/user.jpg"><meta property="og:image:secure_url" content="https://lsx2216.netlify.app/assets/images/user.jpg"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="lsx2216"><meta name=twitter:description content="[!NOTE] Java道经第3卷 - 第4阶 - SpringBoot v3-4-ssm-springboot/shardingsphere
S01. 分库分表 E01. 分库分表概念 1. 何为分库分表 心法：通常分库与分表的操作会同时进行，以至于我们习惯性的将它们合在一起叫做分库分表
单机的容量可以随意扩展，但数 …"><meta property="twitter:domain" content="https://lsx2216.netlify.app/%E7%AC%AC3%E9%98%B6%E6%AE%B5-SSM/JB3-4-SpringBoot/frag/%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8/"><meta property="twitter:url" content="https://lsx2216.netlify.app/%E7%AC%AC3%E9%98%B6%E6%AE%B5-SSM/JB3-4-SpringBoot/frag/%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8/"><meta name=twitter:image content="https://lsx2216.netlify.app/assets/images/user.jpg"><link rel=canonical href=https://lsx2216.netlify.app/%E7%AC%AC3%E9%98%B6%E6%AE%B5-SSM/JB3-4-SpringBoot/frag/%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8/><link rel=stylesheet type=text/css href=/css/normalize.min.css media=print><link rel=stylesheet type=text/css href=/css/main.min.css><link id=dark-theme rel=stylesheet href=/css/dark.min.css><script src=/js/bundle.min.3eb19cb61dde9e37b9522867f3e024aeb68e26ab8e03252e46e365abcb19acf7.js integrity="sha256-PrGcth3enje5Uihn8+AkrraOJquOAyUuRuNlq8sZrPc="></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css integrity=sha384-Xi8rHCmBmhbuyyhbI88391ZKP2dmfnOl4rT9ZfRI7mLTdk1wblIUnrIq35nqwEvC crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.js integrity=sha384-X/XCfMm41VSsqRNQgDerQczD69XqmjOOOwYQvr/uuC+j4OPoNhVgjdGFwhvN02Ja crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],throwOnError:!1})})</script>    <link rel="shortcut icon" href="/assets/images/user.jpg" type="image/x-icon">
</head><body><script>setThemeByUserPref()</script><header class=header><nav class=header-nav><div class=avatar><a href=https://lsx2216.netlify.app/><img src=/assets/images/user.jpg alt=avatar></a></div><div class=nav-title><a class=nav-brand href=https://lsx2216.netlify.app/>lsx2216</a></div><div class=nav-links><div class=nav-link><a href=https://lsx2216.netlify.app/ aria-label><span data-feather=home></span> Home</a></div><div class=nav-link><a href=https://lsx2216.netlify.app/projects/ aria-label><span data-feather=code></span> Projects</a></div><div class=nav-link><a href=https://github.com aria-label=github><span data-feather=github></span></a></div><span class=nav-icons-divider></span><div class="nav-link dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target">theme</span>
<a aria-hidden=true role=switch><span class=theme-toggle-icon data-feather=moon></span></a></div><div class=nav-link id=hamburger-menu-toggle><span class="sr-only hamburger-menu-toggle-screen-reader-target">menu</span>
<a aria-checked=false aria-labelledby=hamburger-menu-toggle id=hamburger-menu-toggle-target role=switch><span data-feather=menu></span></a></div><ul class="nav-hamburger-list visibility-hidden"><li class=nav-item><a href=https://lsx2216.netlify.app/><span data-feather=home></span> Home</a></li><li class=nav-item><a href=https://lsx2216.netlify.app/projects/><span data-feather=code></span> Projects</a></li><li class=nav-item><a href=https://github.com><span data-feather=github></span></a></li><li class="nav-item dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target">theme</span>
<a role=switch><span class=theme-toggle-icon data-feather=moon></span></a></li></ul></div></nav></header><main id=content><div class="post container"><div class=post-header-section><h1></h1></div><div class=post-content><blockquote><p>[!NOTE] Java道经第3卷 - 第4阶 - SpringBoot
v3-4-ssm-springboot/shardingsphere</p></blockquote><h1 id=s01-分库分表>S01. 分库分表</h1><h2 id=e01-分库分表概念>E01. 分库分表概念</h2><h3 id=1-何为分库分表>1. 何为分库分表</h3><blockquote><p>心法：通常分库与分表的操作会同时进行，以至于我们习惯性的将它们合在一起叫做分库分表</p></blockquote><ul><li>单机的容量可以随意扩展，但数据库的连接数却是有限的，它自身就很容易会成为系统的瓶颈：<ul><li>当数据量过大时，导致数据库性能持续下降， 严重影响用户体验。</li><li>当访问量过高时，导致连接数耗尽抛出 <code>too many connections</code> 异常，数据库宕机。</li></ul></li><li>分库分表通过将数据分散到多个数据库或表中，从而有效提升系统的处理能力和稳定性：<ul><li>分库：就是将1个库拆为N个库。</li><li>分表：就是将1个表拆为N个表</li></ul></li></ul><table><thead><tr><th>分库分表</th><th>描述</th></tr></thead><tbody><tr><td>优点</td><td>突破单体数据库的瓶颈，减少数据库负担，提升数据库性能</td></tr><tr><td>缺点</td><td>系统复杂度提升，需要额外考虑事务一致性，全局ID，跨节点查询（分页，排序等），数据迁移，服务治理等问题</td></tr></tbody></table><blockquote><p>武技：测试 MySQL 数据库的最大连接数</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#75715e>-- 151
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>show</span> variables <span style=color:#66d9ef>like</span> <span style=color:#e6db74>&#39;max_connections&#39;</span>
</span></span></code></pre></div><h3 id=2-何时分库分表>2. 何时分库分表</h3><blockquote><p>心法：什么情况下需要考虑进行分库分表</p></blockquote><ul><li>阿里开发手册建议，单表行数超500万行或者单表容量超过2GB时，推荐分库分表。</li><li>然而实际中很多公司单表数据几千万、 亿级别仍然不选择分库分表。</li></ul><table><thead><tr><th>单表数据量</th><th>优化方案推荐</th></tr></thead><tbody><tr><td>百万级以内</td><td>考虑通过添加从库、优化索引等手段提升性能</td></tr><tr><td>千万级以上</td><td>考虑分库分表</td></tr></tbody></table><h3 id=3-分库分表产品>3. 分库分表产品</h3><blockquote><p>心法：常见的分库分表产品工具</p></blockquote><ul><li>客户端直连模式：直接在业务层连接数据库，性能略高：<ul><li>优点：使用简单，通常引入一个jar包即可。</li><li>缺点：升级成本高，jar包若升级或Bug修改，则所有相关项目都要跟着升级。</li></ul></li><li>代理连库模式：通过代理连接数据库，性能略低：<ul><li>优点：升级成本低，jar包若升级或Bug修改，只需要重新部署代理服务即可，业务方无感知。</li><li>缺点：使用复杂，需要搭建单独的服务（还需要考虑高可用），有一定的维护成本。</li></ul></li></ul><table><thead><tr><th>对比项</th><th>shardingsphere</th><th>cobar</th><th>mycat</th><th>TDDL</th><th>mysql fabric</th></tr></thead><tbody><tr><td>连接模式</td><td>两种都支持</td><td>代理连库</td><td>代理连库</td><td>客户端直连</td><td>代理连库</td></tr><tr><td>数据库支持</td><td>任意</td><td>仅MySQL</td><td>仅MySQL</td><td>MySQL，Oracle，SQLServer</td><td>仅MySQL</td></tr><tr><td>ORM框架支持</td><td>任意</td><td>任意</td><td>任意</td><td>任意</td><td>任意</td></tr><tr><td>工具来源</td><td>Apache基金会</td><td>阿里巴巴</td><td>社区爱好者</td><td>阿里巴巴</td><td>MySQL官方</td></tr><tr><td>社区活跃度</td><td>非常活跃</td><td>相对较低</td><td>相对较低</td><td>相对较低</td><td>相对较低</td></tr></tbody></table><h2 id=e02-分库分表方式>E02. 分库分表方式</h2><blockquote><p>心法：分库分表可以从垂直（纵向）和 水平（横向）两种纬度进行拆分</p></blockquote><p><img src=/%E7%AC%AC3%E9%98%B6%E6%AE%B5-SSM/JB3-4-SpringBoot/frag/image/%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E6%96%B9%E5%BC%8F.png alt></p><h3 id=1--垂直分库>1. 垂直分库</h3><blockquote><p>心法：垂直分库的核心是 ”专库专用“</p></blockquote><ul><li>垂直分库一般按业务维度进行拆分，不同业务禁止跨库直连 ，只能通过API接口进行数据交互。</li><li>垂直分库提升了一些数据库性能，但并没有解决由于单表数据量过大导致的性能问题，所以就需要配合后边的分表来解决。</li></ul><p><img src=/%E7%AC%AC3%E9%98%B6%E6%AE%B5-SSM/JB3-4-SpringBoot/frag/image/%E5%9E%82%E7%9B%B4%E5%88%86%E5%BA%93.png alt></p><h3 id=2--垂直分表>2. 垂直分表</h3><blockquote><p>心法：垂直分表的核心是 &ldquo;大表拆小表&rdquo;</p></blockquote><ul><li>垂直分表是指将字段较多的大表中比较独立，或非热点字段拆分到单独的数据表中：<ul><li>分出来的表可以通过主键或某唯一约束字段进行关联。</li></ul></li><li>数据库是以 <code>row</code> 为单位将数据加载到内存中的，垂直分表后，核心表大多是访问频率较高的字段，而且字段较短，因而可以加载更多数据到内存中，减少磁盘IO，增加索引查询的命中率，进一步提升数据库性能。</li></ul><p><img src=/%E7%AC%AC3%E9%98%B6%E6%AE%B5-SSM/JB3-4-SpringBoot/frag/image/%E5%9E%82%E7%9B%B4%E5%88%86%E8%A1%A8.png alt></p><h3 id=3-水平分库>3. 水平分库</h3><blockquote><p>心法: 水平分库的核心是 &ldquo;表数据平摊&rdquo;</p></blockquote><ul><li>水平分库一般按一定分片算法进行拆分，每个库可以位于不同的服务器上：<ul><li>分片算法：如字段取模算法，范围限定算法、预定义算法等，详见E02章。</li></ul></li><li>水平分库解决了单库数据量过大的问题，但也提升了系统复杂度。</li></ul><p><img src=/%E7%AC%AC3%E9%98%B6%E6%AE%B5-SSM/JB3-4-SpringBoot/frag/image/%E6%B0%B4%E5%B9%B3%E5%88%86%E5%BA%93.png alt></p><h3 id=4-水平分表>4. 水平分表</h3><blockquote><p>心法: 水平分表的核心是 &ldquo;行数据平摊&rdquo;</p></blockquote><ul><li>水平分表一般按一定分片算法进行拆分，每个表只存原表的一部分数据：<ul><li>分片算法：如字段取模算法，范围限定算法、预定义算法等，详见E02章。</li></ul></li><li>拆分后的表一般会被分散到不同的机器上，以达到分布式效果。</li><li>以订单表 <code>order</code> 为例，拆表后，<code>order</code> 表将不存在，取而代之的是一堆 <code>order_n</code> 表：<ul><li>此时 <code>order_n</code> 被称为真实表，存储真实数据。</li><li>此时 <code>order</code> 被称为逻辑表，即使已经不存在，但业务中的SQL语句仍要使用它作为关键字。</li></ul></li></ul><p><img src=/%E7%AC%AC3%E9%98%B6%E6%AE%B5-SSM/JB3-4-SpringBoot/frag/image/%E6%B0%B4%E5%B9%B3%E5%88%86%E8%A1%A8.png alt></p><h2 id=e03-常见分片算法>E03. 常见分片算法</h2><blockquote><p>心法：分库分表带来的问题</p></blockquote><ul><li>分库分表后，一张表可能会出现在多个数据库中，新数据如何决定存入哪里就成了必须考虑的问题。</li><li>分库分表的分片策略配置是相对独立的，可以各自使用不同的策略与算法：<ul><li>每种策略中可以是多个分片算法的组合。</li><li>每个分片算法可以对多个分片键做逻辑判断。</li></ul></li></ul><h3 id=1-字段取模算法>1. 字段取模算法</h3><blockquote><p>心法：关键字段取模路由算法是最为常见的 一种路由方式</p></blockquote><ol><li>以订单表为例，假设选定的关键字段为 <code>no</code> 订单编号：<ol><li>用于分片的关键字段也被称为分片键。</li></ol></li><li>首先，对 <code>no</code> 字段进行取余运算，并路由到对应的表中：<ol><li><code>result1 = hash(no) % 10</code>：10为当前数据库或子表的数量。</li></ol></li><li>最后，余数为几就存入几号库。</li></ol><table><thead><tr><th>字段取模算法</th><th>描述</th></tr></thead><tbody><tr><td>优点</td><td>实现简单，数据分布相对比较均匀，不易出现请求都打到一个库上的情况</td></tr><tr><td>缺点</td><td>集群伸缩时，取模结果会发生改变，容易造成数据倾斜</td></tr></tbody></table><h3 id=2-范围限定算法>2. 范围限定算法</h3><blockquote><p>心法：范围限定算法以某些范围字段，如时间，ID区间，地理位置等进行拆分</p></blockquote><ol><li>以订单表为例，假设选定的关键字段为 <code>id</code> 订单表主键。</li><li>将订单表 <code>order</code> 拆分成 <code>order_01</code>，<code>order_02</code> 和 <code>order_03</code> 三张表。</li><li>然后：<ol><li>将 <code>id</code> 范围在 <code>1 ~ 1000w</code> 的记录存入 <code>order_01</code> 表。</li><li>将 <code>id</code> 范围在 <code>1000w ~ 2000w</code> 的记录存入 <code>order_02</code> 表。</li><li>将 <code>id</code> 范围在 <code>2000w ~ 3000w</code> 的记录存入 <code>order_03</code> 表。</li></ol></li><li>按日期字段范围划分同理。</li></ol><table><thead><tr><th>范围限定算法</th><th>描述</th></tr></thead><tbody><tr><td>优点</td><td>单表数据量可控，水平扩展时可直接增加节点，无需数据迁移</td></tr><tr><td>缺点</td><td>某分片若存在热点数据，则仍有可能造成数据倾斜</td></tr></tbody></table><h3 id=3-范围取模算法>3. 范围取模算法</h3><blockquote><p>心法：范围取模算法就是将范围限定算法和字段取模算法合二为一的算法</p></blockquote><ol><li>以订单表为例，假设选定的关键字段为 <code>id</code> 订单表主键：<ol><li>用于分片的关键字段也被称为分片键。</li></ol></li><li>首先，将订单库 <code>db_order</code> 拆分成 <code>db_order_01</code>，<code>db_order_02</code> 和 <code>db_order_03</code> 三个库。</li><li>然后通过范围限定算法定义每个库的订单表只存1000w数据：<ol><li>将 <code>id</code> 范围在 <code>1 ~ 1000w</code> 的记录存入 <code>db_order_01</code> 库。</li><li>将 <code>id</code> 范围在 <code>1000w ~ 2000w</code> 的记录存入 <code>db_order_02</code> 库。</li><li>将 <code>id</code> 范围在 <code>2000w ~ 3000w</code> 的记录存入 <code>db_order_03</code> 库。</li></ol></li><li>将每个库中的用户表 <code>order</code> 拆分成 <code>order_01</code>，<code>order_02</code> 和 <code>order_03</code> 三个表。</li><li>根据 <code>id</code> 字段进行取余运算并路由到对应的表中：<ul><li><code>result = hash(id) % 3</code>：3为当前子表的数量。</li></ul></li></ol><table><thead><tr><th>范围取模算法</th><th>描述</th></tr></thead><tbody><tr><td>优点</td><td>单库数据量可控，水平扩展时可直接增加节点，无需数据迁移有效的避免数据分布不均匀的问题</td></tr><tr><td>缺点</td><td>系统复杂度提升</td></tr></tbody></table><h3 id=4-预定义算法>4. 预定义算法</h3><blockquote><p>心法：预定义算法是事先已经明确知道分库和分表的数量</p></blockquote><ul><li>预定义算法可以直接将某类数据路由到指定库或表中，查询时亦是如此。</li></ul><h2 id=e04-分布式id方案>E04. 分布式ID方案</h2><blockquote><p>分库分表之后，id主键如何处理？</p></blockquote><h3 id=1-单库id方案>1. 单库ID方案</h3><blockquote><p>心法：单独设置一个库，负责全局ID自增，自增后再往对应的分库分表里去写入。</p></blockquote><ul><li>此方案适用于因单库数据量太大而导致的分库分表。</li><li>此方案不适用于因单库并发过高而导致的分库分表。</li></ul><h3 id=2-uuid方案>2. UUID方案</h3><blockquote><p>心法：使用UUID生成随机字符串作为主键。</p></blockquote><ul><li>此方案好处就是本地生成，不要基于数据库操作。</li><li>此方案缺点是UUID太长，占用空间大，作为主键性能太差，强烈不建议。</li></ul><h3 id=3-雪花算法>3. 雪花算法</h3><blockquote><p>心法：使用Twitter开源的分布式ID生成算法，名为 <code>snowflake</code> 雪花算法。</p></blockquote><p>![[第3阶段-SSM/JB3-4-SpringBoot/draw/雪花算法.md#^group=CPTwzLwSbw5RlW4Eqofux|100%]]</p><ol><li>设置一个long类型的ID值，共64位：<ol><li>如果使用雪花算法生成分布式ID，则数据库表的主键应该设计为 <code>bigint</code> 类型。</li></ol></li><li>第1个bit忽略并弃用，因为是符号位。</li><li>其后41个bit存储一个时间戳，记录了生成ID的时间，可以确保生成的ID是按时间有序的：<ol><li>41个bit位大概可以表示69年的时间。</li></ol></li><li>其后5个bit存储产生这个ID的机房的ID，最多可表示 <code>2^5=32</code> 个机房。</li><li>其后5个bit存储产生这个ID的机器的ID，最多可表示 <code>2^5=32</code> 台机器。</li><li>最后12个bit存储同一个毫秒内产生的不同ID的序号，最多存储 <code>2^12=4096</code> 个序号。</li></ol><h1 id=s02-shardingsphere>S02. ShardingSphere</h1><blockquote><p>心法：<a href=https://shardingsphere.apache.org>ShardingSphere</a></p></blockquote><ul><li><code>ShardingSphere</code> 是一款开源的分布式关系型数据库中间件，目前是 Apache 的顶级项目：<ul><li><code>ShardingSphere = sharding-jdbc + sharding-proxy</code>：2018合并并正式更名。</li></ul></li><li><code>ShardingSphere</code> 仅支持Java应用，在Java的Jdbc层以jar包的形式对外提供服务，可理解为增强版的Jdbc驱动，完全兼容Jdbc和各种ORM框架。</li></ul><table><thead><tr><th>版本</th><th>描述</th></tr></thead><tbody><tr><td><code>ShardingSphere1.0</code></td><td>只有数据分片</td></tr><tr><td><code>ShardingSphere2.0</code></td><td>支持数据库治，如注册中心、配置中心等</td></tr><tr><td><code>ShardingSphere3.0</code></td><td>支持分布式事务</td></tr><tr><td><code>ShardingSphere4.0</code></td><td>改进分片策略，添加更多数据库的支持，提升环境兼容性等</td></tr></tbody></table><h2 id=e01-测试项目>E01. 测试项目</h2><blockquote><p>武技：创建测试项目 <code>v3-4-ssm-springboot/shardingsphere</code> 并搭建起始环境</p></blockquote><h3 id=1-添加三方依赖>1. 添加三方依赖</h3><p><code>pom.xml</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#75715e>&lt;!--lombok--&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>&lt;groupId&gt;</span>org.projectlombok<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>&lt;artifactId&gt;</span>lombok<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;!--hutool--&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>&lt;groupId&gt;</span>cn.hutool<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>&lt;artifactId&gt;</span>hutool-all<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;!--spring-boot-starter-web--&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>&lt;groupId&gt;</span>org.springframework.boot<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>&lt;artifactId&gt;</span>spring-boot-starter-web<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;!--spring-boot-starter-test--&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>&lt;groupId&gt;</span>org.springframework.boot<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>&lt;artifactId&gt;</span>spring-boot-starter-test<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>&lt;scope&gt;</span>test<span style=color:#f92672>&lt;/scope&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;!--mysql-connector-j--&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>&lt;groupId&gt;</span>com.mysql<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>&lt;artifactId&gt;</span>mysql-connector-j<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;!--mybatis-spring-boot-starter--&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>&lt;groupId&gt;</span>org.mybatis.spring.boot<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>&lt;artifactId&gt;</span>mybatis-spring-boot-starter<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;!--sharding-jdbc-spring-boot-starter--&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>&lt;groupId&gt;</span>org.apache.shardingsphere<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>&lt;artifactId&gt;</span>sharding-jdbc-spring-boot-starter<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>&lt;version&gt;</span>4.0.0-RC1<span style=color:#f92672>&lt;/version&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span></code></pre></div><h3 id=2-开发主配文件>2. 开发主配文件</h3><p><code>classpath:application.properties</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-properties data-lang=properties><span style=display:flex><span><span style=color:#75715e>############################# App ##############################</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#端口号，项目名称#</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>server.port</span><span style=color:#f92672>=</span><span style=color:#e6db74>8120</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.application.name</span><span style=color:#f92672>=</span><span style=color:#e6db74>shardingsphere</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>############################# MyBatis ##############################</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#实体类别名包扫描，下划线自动转驼峰，控制台打印SQL#</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>mybatis.type-aliases-package</span><span style=color:#f92672>=</span><span style=color:#e6db74>com.lsx.entity</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>mybatis.configuration.map-underscore-to-camel-case</span><span style=color:#f92672>=</span><span style=color:#e6db74>true</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>mybatis.configuration.log-impl</span><span style=color:#f92672>=</span><span style=color:#e6db74>org.apache.ibatis.logging.stdout.StdOutImpl</span>
</span></span></code></pre></div><h3 id=3-开发启动类>3. 开发启动类</h3><p><code>com.lsx.ShardingSphereApp</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@SpringBootApplication</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@MapperScan</span>(<span style=color:#e6db74>&#34;com.lsx.mapper&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ShardingSphereApp</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span>(String<span style=color:#f92672>[]</span> args) {
</span></span><span style=display:flex><span>        SpringApplication.<span style=color:#a6e22e>run</span>(ShardingSphereApp.<span style=color:#a6e22e>class</span>, args);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=e02-读写分离>E02. 读写分离</h2><h3 id=1-创建数据库>1. 创建数据库</h3><blockquote><p>心法：数据库信息架构</p></blockquote><pre tabindex=0><code>mysql-master：MySQL主节点，端口3307
	|__ sharding: 数据库
		|__ order: 订单表
		
mysql-slave-01：MySQL从节点，端口3308
	|__ sharding: 数据库
		|__ order: 订单表
</code></pre><blockquote><p>武技：在MySQL中准备数据库</p></blockquote><ol><li><a href=../../../%E7%AC%AC2%E9%98%B6%E6%AE%B5-WEB/JB2-3-MySQL/res/MySQL%E6%90%AD%E5%BB%BA%E4%B8%BB%E4%BB%8E%E6%9E%B6%E6%9E%84.md>MySQL搭建主从架构</a>：<ol><li>此时系统中至少存在 <code>mysql-master</code> 和 <code>mysql-slave-01</code> 两个MySQL容器节点。</li></ol></li><li>在MySQL主节点中创建数据库 <code>sharding</code>，主从结构正确配置时，从节点会自动同步该库。</li><li>在MySQL主节点中创建表 <code>sharding.order</code>，主从结构正确配置时，从节点会自动同步该表。</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#75715e>-- 创建数据库
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>create</span> <span style=color:#66d9ef>database</span> sharding <span style=color:#66d9ef>default</span> charset utf8mb4;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- 创建表
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>create</span> <span style=color:#66d9ef>table</span> sharding.<span style=color:#66d9ef>order</span>
</span></span><span style=display:flex><span>(
</span></span><span style=display:flex><span>    id bigint unsigned <span style=color:#66d9ef>comment</span> <span style=color:#e6db74>&#39;主键&#39;</span>,
</span></span><span style=display:flex><span>    sn varchar(<span style=color:#ae81ff>128</span>) <span style=color:#66d9ef>not</span> <span style=color:#66d9ef>null</span> <span style=color:#66d9ef>default</span> <span style=color:#e6db74>&#39;&#39;</span> <span style=color:#66d9ef>comment</span> <span style=color:#e6db74>&#39;订单编号&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>primary</span> <span style=color:#66d9ef>key</span> (id)
</span></span><span style=display:flex><span>);
</span></span></code></pre></div><h3 id=2-开发实体类>2. 开发实体类</h3><p><code>com.lsx.entity.Order</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Data</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Order</span> <span style=color:#66d9ef>implements</span> Serializable {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Long id;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String sn;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=3-开发mapper接口>3. 开发Mapper接口</h3><p><code>com.lsx.mapper.OrderMapper</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Repository</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>OrderMapper</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * 新增一条订单记录
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param order 订单实体
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Options</span>(useGeneratedKeys <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>, keyProperty <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;id&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Insert</span>(<span style=color:#e6db74>&#34;insert into `order` (id, sn) values (#{id}, #{sn})&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>insert</span>(Order order);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * 查询全部订单记录
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Select</span>(<span style=color:#e6db74>&#34;select o.id, o.sn from `order` o&#34;</span>)
</span></span><span style=display:flex><span>    List<span style=color:#f92672>&lt;</span>Order<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>list</span>();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=4-开发主配文件>4. 开发主配文件</h3><ol><li>开发主配文件 <code>application-slave.properties</code>：</li></ol><p><code>classpath:application-slave.properties</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-properties data-lang=properties><span style=display:flex><span><span style=color:#75715e>############################# ShardingSphere ##############################  </span>
</span></span><span style=display:flex><span><span style=color:#75715e># 连接池大小，数据源名称列表，主从结构名，从库负载均衡策略，主库名，从库名，默认库，SQL日志，解决renaming报错#  </span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.shardingsphere.datasource.ds.max-pool-size</span><span style=color:#f92672>=</span><span style=color:#e6db74>100  </span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.shardingsphere.datasource.names</span><span style=color:#f92672>=</span><span style=color:#e6db74>ds1,ds2  </span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.shardingsphere.masterslave.name</span><span style=color:#f92672>=</span><span style=color:#e6db74>ms0  </span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.shardingsphere.masterslave.load-balance-algorithm-type</span><span style=color:#f92672>=</span><span style=color:#e6db74>round_robin  </span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.shardingsphere.masterslave.master-data-source-name</span><span style=color:#f92672>=</span><span style=color:#e6db74>ds1  </span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.shardingsphere.masterslave.slave-data-source-names</span><span style=color:#f92672>=</span><span style=color:#e6db74>ds2  </span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.shardingsphere.sharding.default-data-source-name</span><span style=color:#f92672>=</span><span style=color:#e6db74>ds1  </span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.shardingsphere.props.sql.show</span><span style=color:#f92672>=</span><span style=color:#e6db74>true  </span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.main.allow-bean-definition-overriding</span><span style=color:#f92672>=</span><span style=color:#e6db74>true  </span>
</span></span><span style=display:flex><span><span style=color:#75715e># 数据源相关：配置ds1数据源（主库，端口3307）  </span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.shardingsphere.datasource.ds1.type</span><span style=color:#f92672>=</span><span style=color:#e6db74>com.zaxxer.hikari.HikariDataSource  </span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.shardingsphere.datasource.ds1.driver-class-name</span><span style=color:#f92672>=</span><span style=color:#e6db74>com.mysql.cj.jdbc.Driver  </span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.shardingsphere.datasource.ds1.jdbc-url</span><span style=color:#f92672>=</span><span style=color:#e6db74>jdbc:mysql://192.168.40.77:3307/sharding? \  </span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>serverTimezone</span><span style=color:#f92672>=</span><span style=color:#e6db74>Asia/Shanghai&amp;useUnicode=true&amp;characterEncoding=utf-8spring.shardingsphere.datasource.ds1.username=root  </span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.shardingsphere.datasource.ds1.password</span><span style=color:#f92672>=</span><span style=color:#e6db74>root  </span>
</span></span><span style=display:flex><span><span style=color:#75715e># 数据源相关：配置ds2数据源（从库，端口3308）  </span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.shardingsphere.datasource.ds2.type</span><span style=color:#f92672>=</span><span style=color:#e6db74>com.zaxxer.hikari.HikariDataSource  </span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.shardingsphere.datasource.ds2.driver-class-name</span><span style=color:#f92672>=</span><span style=color:#e6db74>com.mysql.cj.jdbc.Driver  </span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.shardingsphere.datasource.ds2.jdbc-url</span><span style=color:#f92672>=</span><span style=color:#e6db74>jdbc:mysql://192.168.40.77:3308/sharding? \  </span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>serverTimezone</span><span style=color:#f92672>=</span><span style=color:#e6db74>Asia/Shanghai&amp;useUnicode=true&amp;characterEncoding=utf-8spring.shardingsphere.datasource.ds2.username=root  </span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.shardingsphere.datasource.ds2.password</span><span style=color:#f92672>=</span><span style=color:#e6db74>root</span>
</span></span></code></pre></div><ol start=2><li>在主配文件 <code>application.properties</code> 中引入该属性文件：</li></ol><p><code>classpath:application.properties</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-properties data-lang=properties><span style=display:flex><span><span style=color:#75715e>#切换主配文件</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.profiles.active</span><span style=color:#f92672>=</span><span style=color:#e6db74>slave</span>
</span></span></code></pre></div><h3 id=5-开发测试类>5. 开发测试类</h3><ol><li>开发测试类：</li></ol><p><code>mapper.OrderMapperTest</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RunWith</span>(SpringRunner.<span style=color:#a6e22e>class</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>@SpringBootTest</span>(classes <span style=color:#f92672>=</span> ShardingSphereApp.<span style=color:#a6e22e>class</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>OrderMapperTest</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Autowired</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> OrderMapper orderMapper;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>list</span>() {
</span></span><span style=display:flex><span>        orderMapper.<span style=color:#a6e22e>list</span>().<span style=color:#a6e22e>forEach</span>(System.<span style=color:#a6e22e>out</span>::println);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>insert</span>() {
</span></span><span style=display:flex><span>        Order order <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Order();
</span></span><span style=display:flex><span>        order.<span style=color:#a6e22e>setId</span>(1L);
</span></span><span style=display:flex><span>        order.<span style=color:#a6e22e>setSn</span>(RandomUtil.<span style=color:#a6e22e>randomString</span>(10));
</span></span><span style=display:flex><span>        orderMapper.<span style=color:#a6e22e>insert</span>(order);
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(order);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=2><li>运行 <code>list()</code> 查询方法，在控制台发现使用的是 <code>ds2</code> 从库：</li></ol><p><img src=/%E7%AC%AC3%E9%98%B6%E6%AE%B5-SSM/JB3-4-SpringBoot/frag/image/%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6-%E6%9F%A5%E8%AF%A2.png alt></p><ol start=3><li>运行 <code>insert()</code> 新增方法，在控制台发现使用的是 <code>ds1</code> 主库：</li></ol><p><img src=/%E7%AC%AC3%E9%98%B6%E6%AE%B5-SSM/JB3-4-SpringBoot/frag/image/%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6-%E6%8F%92%E5%85%A5.png alt></p><h2 id=e03-分库分表>E03. 分库分表</h2><h3 id=1-创建数据库-1>1. 创建数据库</h3><blockquote><p>心法：数据库信息架构</p></blockquote><pre tabindex=0><code>mysql-master：MySQL主节点，端口3307
	|__ sharding_male: 男性记录全部进入这个库
		|__ user_0: 男性中 id 为偶数的记录记录在这张表
		|__ user_1: 男性中 id 为奇数的记录记录在这张表
	|__ sharding_female: 女性记录全部进入这个库
		|__ user_0: 女性中 id 为偶数的记录记录在这张表
		|__ user_1: 女性中 id 为奇数的记录记录在这张表
		
mysql-slave-01：MySQL从节点，端口3308
	|__ sharding_male: 男性记录全部进入这个库
		|__ user_0: 男性中 id 为偶数的记录记录在这张表
		|__ user_1: 男性中 id 为奇数的记录记录在这张表
	|__ sharding_female: 女性记录全部进入这个库
		|__ user_0: 女性中 id 为偶数的记录记录在这张表
		|__ user_1: 女性中 id 为奇数的记录记录在这张表
</code></pre><blockquote><p>武技：在MySQL中准备数据库</p></blockquote><ol><li>使用 <code>sharding_male</code> 和 <code>sharding_female</code> 两个库。</li><li>每个库中都包含 <code>user_0</code> 和 <code>user_1</code> 两张表，这4张表的结构要求一模一样。</li></ol><p><code>docker exec -it mysql-master bash</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#75715e>-- 创建数据库 sharding_male：男性记录全部进入这个库
</span></span></span><span style=display:flex><span><span style=color:#75715e>-- 创建数据库 sharding_female：女性记录全部进入这个库
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>create</span> <span style=color:#66d9ef>database</span> sharding_male <span style=color:#66d9ef>default</span> charset utf8mb4;
</span></span><span style=display:flex><span><span style=color:#66d9ef>create</span> <span style=color:#66d9ef>database</span> sharding_female <span style=color:#66d9ef>default</span> charset utf8mb4;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- 在数据库 sharding_male 中创建表 user_0 和表 user_1
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>create</span> <span style=color:#66d9ef>table</span> sharding_male.user_0
</span></span><span style=display:flex><span>(
</span></span><span style=display:flex><span>    id bigint unsigned <span style=color:#66d9ef>comment</span> <span style=color:#e6db74>&#39;主键&#39;</span>,
</span></span><span style=display:flex><span>    gender tinyint <span style=color:#66d9ef>not</span> <span style=color:#66d9ef>null</span> <span style=color:#66d9ef>default</span> <span style=color:#ae81ff>0</span> <span style=color:#66d9ef>comment</span> <span style=color:#e6db74>&#39;0女1男&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>primary</span> <span style=color:#66d9ef>key</span> (id)
</span></span><span style=display:flex><span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>create</span> <span style=color:#66d9ef>table</span> sharding_male.user_1
</span></span><span style=display:flex><span>(
</span></span><span style=display:flex><span>    id bigint unsigned <span style=color:#66d9ef>comment</span> <span style=color:#e6db74>&#39;主键&#39;</span>,
</span></span><span style=display:flex><span>    gender tinyint <span style=color:#66d9ef>not</span> <span style=color:#66d9ef>null</span> <span style=color:#66d9ef>default</span> <span style=color:#ae81ff>0</span> <span style=color:#66d9ef>comment</span> <span style=color:#e6db74>&#39;0女1男&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>primary</span> <span style=color:#66d9ef>key</span> (id)
</span></span><span style=display:flex><span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- 在数据库 sharding_female 中创建表 user_0 和表 user_1
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>create</span> <span style=color:#66d9ef>table</span> sharding_female.user_0
</span></span><span style=display:flex><span>(
</span></span><span style=display:flex><span>    id bigint unsigned <span style=color:#66d9ef>comment</span> <span style=color:#e6db74>&#39;主键&#39;</span>,
</span></span><span style=display:flex><span>    gender tinyint <span style=color:#66d9ef>not</span> <span style=color:#66d9ef>null</span> <span style=color:#66d9ef>default</span> <span style=color:#ae81ff>0</span> <span style=color:#66d9ef>comment</span> <span style=color:#e6db74>&#39;0女1男&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>primary</span> <span style=color:#66d9ef>key</span> (id)
</span></span><span style=display:flex><span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>create</span> <span style=color:#66d9ef>table</span> sharding_female.user_1
</span></span><span style=display:flex><span>(
</span></span><span style=display:flex><span>    id bigint unsigned <span style=color:#66d9ef>comment</span> <span style=color:#e6db74>&#39;主键&#39;</span>,
</span></span><span style=display:flex><span>    gender tinyint <span style=color:#66d9ef>not</span> <span style=color:#66d9ef>null</span> <span style=color:#66d9ef>default</span> <span style=color:#ae81ff>0</span> <span style=color:#66d9ef>comment</span> <span style=color:#e6db74>&#39;0女1男&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>primary</span> <span style=color:#66d9ef>key</span> (id)
</span></span><span style=display:flex><span>);
</span></span></code></pre></div><h3 id=2-开发实体类-1>2. 开发实体类</h3><p><code>com.lsx.entity.User</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Data</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>User</span> <span style=color:#66d9ef>implements</span> Serializable {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Long id;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Integer gender;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=3-开发mapper接口-1>3. 开发Mapper接口</h3><ul><li>分库后，SQL语句中不要再使用 <code>库名.表名</code> 的结构，直接使用 <code>表名</code> 即可。</li></ul><p><code>com.lsx.mapper.UserMapper</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Repository</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>UserMapper</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * 新增一条用户记录
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param user 用户实体
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Options</span>(useGeneratedKeys <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>, keyProperty <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;id&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Insert</span>(<span style=color:#e6db74>&#34;insert into `user` (id, gender) values (#{id}, #{gender})&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>insert</span>(User user);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * 查询全部用户记录
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Select</span>(<span style=color:#e6db74>&#34;select u.id, u.gender from `user` u&#34;</span>)
</span></span><span style=display:flex><span>    List<span style=color:#f92672>&lt;</span>User<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>list</span>();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=4-开发主配文件-1>4. 开发主配文件</h3><ol><li>开发主配文件 <code>application-div.properties</code>：</li></ol><p><code>classpath:application-div.properties</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-properties data-lang=properties><span style=display:flex><span><span style=color:#75715e>############################# ShardingSphere ##############################</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 连接池大小，数据源名称列表，SQL日志，解决renaming报错#</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.shardingsphere.datasource.ds.max-pool-size</span><span style=color:#f92672>=</span><span style=color:#e6db74>100</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.shardingsphere.datasource.names</span><span style=color:#f92672>=</span><span style=color:#e6db74>ds1,ds2</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.shardingsphere.props.sql.show</span><span style=color:#f92672>=</span><span style=color:#e6db74>true</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.main.allow-bean-definition-overriding</span><span style=color:#f92672>=</span><span style=color:#e6db74>true</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 数据源相关：配置ds1数据源</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.shardingsphere.datasource.ds1.type</span><span style=color:#f92672>=</span><span style=color:#e6db74>com.zaxxer.hikari.HikariDataSource</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.shardingsphere.datasource.ds1.driver-class-name</span><span style=color:#f92672>=</span><span style=color:#e6db74>com.mysql.cj.jdbc.Driver</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.shardingsphere.datasource.ds1.jdbc-url</span><span style=color:#f92672>=</span><span style=color:#e6db74>jdbc:mysql://192.168.40.77:3307/sharding_female? \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  serverTimezone=Asia/Shanghai&amp;useUnicode=true&amp;characterEncoding=utf-8</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.shardingsphere.datasource.ds1.username</span><span style=color:#f92672>=</span><span style=color:#e6db74>root</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.shardingsphere.datasource.ds1.password</span><span style=color:#f92672>=</span><span style=color:#e6db74>root</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 数据源相关：配置ds2数据源</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.shardingsphere.datasource.ds2.type</span><span style=color:#f92672>=</span><span style=color:#e6db74>com.zaxxer.hikari.HikariDataSource</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.shardingsphere.datasource.ds2.driver-class-name</span><span style=color:#f92672>=</span><span style=color:#e6db74>com.mysql.cj.jdbc.Driver</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.shardingsphere.datasource.ds2.jdbc-url</span><span style=color:#f92672>=</span><span style=color:#e6db74>jdbc:mysql://192.168.40.77:3307/sharding_male? \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  serverTimezone=Asia/Shanghai&amp;useUnicode=true&amp;characterEncoding=utf-8</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.shardingsphere.datasource.ds2.username</span><span style=color:#f92672>=</span><span style=color:#e6db74>root</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.shardingsphere.datasource.ds2.password</span><span style=color:#f92672>=</span><span style=color:#e6db74>root</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 分片规则</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.shardingsphere.sharding.tables.user.actual-data-nodes</span><span style=color:#f92672>=</span><span style=color:#e6db74>ds$-&gt;{1..2}.user_$-&gt;{0..1}</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.shardingsphere.sharding.tables.user.key-generator.column</span><span style=color:#f92672>=</span><span style=color:#e6db74>id</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.shardingsphere.sharding.tables.user.key-generator.type</span><span style=color:#f92672>=</span><span style=color:#e6db74>SNOWFLAKE</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 分表策略：根据 id 字段，偶数id 存入 user_0 表，奇数id 存入 user_1 表</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.shardingsphere.sharding.tables.user.table-strategy.inline.sharding-column</span><span style=color:#f92672>=</span><span style=color:#e6db74>id</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.shardingsphere.sharding.tables.user.table-strategy.inline.algorithm-expression</span><span style=color:#f92672>=</span><span style=color:#e6db74>user_$-&gt;{id % 2}</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 分库策略：根据 gender 字段，男性使用 ds1 数据源，女性使用 ds2 数据源</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.shardingsphere.sharding.tables.user.database-strategy.inline.sharding-column</span><span style=color:#f92672>=</span><span style=color:#e6db74>gender</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.shardingsphere.sharding.tables.user.database-strategy.inline.algorithm-expression</span><span style=color:#f92672>=</span><span style=color:#e6db74>ds$-&gt;{gender == 0 ? 1 : 2}</span>
</span></span></code></pre></div><ol start=2><li>在主配文件 <code>application.properties</code> 中引入该属性文件：</li></ol><p><code>classpath:application.properties</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-properties data-lang=properties><span style=display:flex><span><span style=color:#75715e>#切换主配文件</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.profiles.active</span><span style=color:#f92672>=</span><span style=color:#e6db74>div</span>
</span></span></code></pre></div><h3 id=5-开发测试类-1>5. 开发测试类</h3><ol><li>开发测试类：</li></ol><p><code>mapper.UserMapperTest</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RunWith</span>(SpringRunner.<span style=color:#a6e22e>class</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>@SpringBootTest</span>(classes <span style=color:#f92672>=</span> ShardingSphereApp.<span style=color:#a6e22e>class</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>UserMapperTest</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Autowired</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> UserMapper userMapper;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>list</span>() {
</span></span><span style=display:flex><span>        userMapper.<span style=color:#a6e22e>list</span>().<span style=color:#a6e22e>forEach</span>(System.<span style=color:#a6e22e>out</span>::println);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>insert</span>() {
</span></span><span style=display:flex><span>        User user <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> User();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0; i <span style=color:#f92672>&lt;</span> 10; i<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>            user.<span style=color:#a6e22e>setId</span>((<span style=color:#66d9ef>long</span>)i);
</span></span><span style=display:flex><span>            user.<span style=color:#a6e22e>setGender</span>(i <span style=color:#f92672>%</span> 2);
</span></span><span style=display:flex><span>            userMapper.<span style=color:#a6e22e>insert</span>(user);
</span></span><span style=display:flex><span>            System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(user);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=2><li>运行 <code>list()</code> 查询方法，在控制台发现分别从4张表进行查询，然后汇总数据：</li></ol><p><img src=/%E7%AC%AC3%E9%98%B6%E6%AE%B5-SSM/JB3-4-SpringBoot/frag/image/%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8-%E6%9F%A5%E8%AF%A2.png alt></p><ol start=3><li>运行 <code>insert()</code> 新增方法插入10条数据，发现数据已经相对均匀地插入到了各个分片中：</li></ol><p><img src=/%E7%AC%AC3%E9%98%B6%E6%AE%B5-SSM/JB3-4-SpringBoot/frag/image/%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8-%E6%8F%92%E5%85%A5.png alt></p></div><svg id="btt-button" class="arrow-logo" xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 384 512" onclick="scrollToTop()" title="Go to top"><path d="M177 159.7l136 136c9.4 9.4 9.4 24.6.0 33.9l-22.6 22.6c-9.4 9.4-24.6 9.4-33.9.0L160 255.9l-96.4 96.4c-9.4 9.4-24.6 9.4-33.9.0L7 329.7c-9.4-9.4-9.4-24.6.0-33.9l136-136c9.4-9.5 24.6-9.5 34-.1z"/></svg>
<script>let backToTopButton=document.getElementById("btt-button");window.onscroll=function(){scrollFunction()};function scrollFunction(){document.body.scrollTop>20||document.documentElement.scrollTop>20?backToTopButton.style.display="block":backToTopButton.style.display="none"}function scrollToTop(){window.scrollTo(0,0)}</script></div></main><footer class=footer><span>&copy; 2024 The Marauders</span>
<span>Made with &#10084;&#65039; using <a target=_blank href=https://github.com/gokarna-theme/gokarna-hugo>Gokarna</a></span></footer></body></html>