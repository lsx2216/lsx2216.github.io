<!doctype html><html lang=en><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><style>:root{--accent-color:#FF4D4D}</style><title>JB5-8-事务机制</title>
<meta name=description content="[!NOTE] Java道经第5卷 - 第8阶 - 事务机制 v5-8-alibaba-seata
S01. Seata概念入门 E01. 基础入门概念 1. 分布式事务 心法: 分布式事务
分布式事务是为了保证当一个事务中的N个操作分布在不同的微服务中时，仍可以具有本地事务的ACID特性。 2. Seata基础概念  …"><meta name=keywords content='blog,lsx2216,hugo'><meta property="og:url" content="https://lsx2216.netlify.app/%E7%AC%AC5%E9%98%B6%E6%AE%B5-ALIBABA/JB5-8-%E4%BA%8B%E5%8A%A1%E6%9C%BA%E5%88%B6/JB5-8-%E4%BA%8B%E5%8A%A1%E6%9C%BA%E5%88%B6/"><meta property="og:type" content="website"><meta property="og:title" content="JB5-8-事务机制"><meta property="og:description" content="[!NOTE] Java道经第5卷 - 第8阶 - 事务机制 v5-8-alibaba-seata
S01. Seata概念入门 E01. 基础入门概念 1. 分布式事务 心法: 分布式事务
分布式事务是为了保证当一个事务中的N个操作分布在不同的微服务中时，仍可以具有本地事务的ACID特性。 2. Seata基础概念  …"><meta property="og:image" content="https://lsx2216.netlify.app/assets/images/user.jpg"><meta property="og:image:secure_url" content="https://lsx2216.netlify.app/assets/images/user.jpg"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="JB5-8-事务机制"><meta name=twitter:description content="[!NOTE] Java道经第5卷 - 第8阶 - 事务机制 v5-8-alibaba-seata
S01. Seata概念入门 E01. 基础入门概念 1. 分布式事务 心法: 分布式事务
分布式事务是为了保证当一个事务中的N个操作分布在不同的微服务中时，仍可以具有本地事务的ACID特性。 2. Seata基础概念  …"><meta property="twitter:domain" content="https://lsx2216.netlify.app/%E7%AC%AC5%E9%98%B6%E6%AE%B5-ALIBABA/JB5-8-%E4%BA%8B%E5%8A%A1%E6%9C%BA%E5%88%B6/JB5-8-%E4%BA%8B%E5%8A%A1%E6%9C%BA%E5%88%B6/"><meta property="twitter:url" content="https://lsx2216.netlify.app/%E7%AC%AC5%E9%98%B6%E6%AE%B5-ALIBABA/JB5-8-%E4%BA%8B%E5%8A%A1%E6%9C%BA%E5%88%B6/JB5-8-%E4%BA%8B%E5%8A%A1%E6%9C%BA%E5%88%B6/"><meta name=twitter:image content="https://lsx2216.netlify.app/assets/images/user.jpg"><link rel=canonical href=https://lsx2216.netlify.app/%E7%AC%AC5%E9%98%B6%E6%AE%B5-ALIBABA/JB5-8-%E4%BA%8B%E5%8A%A1%E6%9C%BA%E5%88%B6/JB5-8-%E4%BA%8B%E5%8A%A1%E6%9C%BA%E5%88%B6/><link rel=stylesheet type=text/css href=/css/normalize.min.css media=print><link rel=stylesheet type=text/css href=/css/main.min.css><link id=dark-theme rel=stylesheet href=/css/dark.min.css><script src=/js/bundle.min.3eb19cb61dde9e37b9522867f3e024aeb68e26ab8e03252e46e365abcb19acf7.js integrity="sha256-PrGcth3enje5Uihn8+AkrraOJquOAyUuRuNlq8sZrPc="></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css integrity=sha384-Xi8rHCmBmhbuyyhbI88391ZKP2dmfnOl4rT9ZfRI7mLTdk1wblIUnrIq35nqwEvC crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.js integrity=sha384-X/XCfMm41VSsqRNQgDerQczD69XqmjOOOwYQvr/uuC+j4OPoNhVgjdGFwhvN02Ja crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],throwOnError:!1})})</script>    <link rel="shortcut icon" href="/assets/images/user.jpg" type="image/x-icon">
</head><body><script>setThemeByUserPref()</script><header class=header><nav class=header-nav><div class=avatar><a href=https://lsx2216.netlify.app/><img src=/assets/images/user.jpg alt=avatar></a></div><div class=nav-title><a class=nav-brand href=https://lsx2216.netlify.app/>lsx2216</a></div><div class=nav-links><div class=nav-link><a href=https://lsx2216.netlify.app/ aria-label><span data-feather=home></span> Home</a></div><div class=nav-link><a href=https://lsx2216.netlify.app/projects/ aria-label><span data-feather=code></span> Projects</a></div><div class=nav-link><a href=https://github.com aria-label=github><span data-feather=github></span></a></div><span class=nav-icons-divider></span><div class="nav-link dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target">theme</span>
<a aria-hidden=true role=switch><span class=theme-toggle-icon data-feather=moon></span></a></div><div class=nav-link id=hamburger-menu-toggle><span class="sr-only hamburger-menu-toggle-screen-reader-target">menu</span>
<a aria-checked=false aria-labelledby=hamburger-menu-toggle id=hamburger-menu-toggle-target role=switch><span data-feather=menu></span></a></div><ul class="nav-hamburger-list visibility-hidden"><li class=nav-item><a href=https://lsx2216.netlify.app/><span data-feather=home></span> Home</a></li><li class=nav-item><a href=https://lsx2216.netlify.app/projects/><span data-feather=code></span> Projects</a></li><li class=nav-item><a href=https://github.com><span data-feather=github></span></a></li><li class="nav-item dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target">theme</span>
<a role=switch><span class=theme-toggle-icon data-feather=moon></span></a></li></ul></div></nav></header><main id=content><div class="post container"><div class=post-header-section><h1>JB5-8-事务机制</h1></div><div class=post-content><blockquote><p>[!NOTE] Java道经第5卷 - 第8阶 - 事务机制
v5-8-alibaba-seata</p></blockquote><h1 id=s01-seata概念入门>S01. Seata概念入门</h1><h2 id=e01-基础入门概念>E01. 基础入门概念</h2><h3 id=1-分布式事务>1. 分布式事务</h3><blockquote><p>心法: 分布式事务</p></blockquote><ul><li>分布式事务是为了保证当一个事务中的N个操作分布在不同的微服务中时，仍可以具有本地事务的ACID特性。</li></ul><h3 id=2-seata基础概念>2. Seata基础概念</h3><blockquote><p>心法: Simple Extensible Autonomous Transaction Architecture</p></blockquote><ul><li>Seata是阿里巴巴架构中的分布式事务解决方案，对业务无侵入。</li><li>Seata让分布式事务的使用像本地事务的使用一样简单和高效。</li><li>Seata1.5.X版本SeataServer的配置文件只需要配置 <code>application.yml</code> 配置文件即可。</li><li>从1.5.2版本开始支持Mysql8版本。</li></ul><table><thead><tr><th>核心组件</th><th>全称</th><th>中文</th><th>功能描述</th></tr></thead><tbody><tr><td>TC</td><td><code>Transaction Coordinator</code></td><td>事务协调器</td><td>用于协调全局事务</td></tr><tr><td>RM</td><td><code>Resource Manager</code></td><td>资源管理器</td><td>用于发起分支事务</td></tr><tr><td>TM</td><td><code>Transaction Manager</code></td><td>事务管理器</td><td>用于向TC申请全局事务</td></tr></tbody></table><h3 id=3-seataat模式>3. SeataAT模式</h3><blockquote><p>心法: Seata底层原理 - AT模式</p></blockquote><p><img src=/%E7%AC%AC5%E9%98%B6%E6%AE%B5-ALIBABA/JB5-8-%E4%BA%8B%E5%8A%A1%E6%9C%BA%E5%88%B6/image/448dac18cb08e8158b1899998039384d.png alt=Seata事务流程></p><h2 id=e02-搭建seata环境>E02. 搭建Seata环境</h2><blockquote><p>武技：搭建Seata使用环境</p></blockquote><h3 id=1-创建seata数据库>1. 创建Seata数据库</h3><blockquote><p>武技：创建seata专用数据库，并引入Seata服务相关的4张表</p></blockquote><ol><li>创建seata专用数据库：</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#75715e>-- 创建数据库
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>create</span> <span style=color:#66d9ef>database</span> seata character <span style=color:#66d9ef>set</span> utf8mb4;
</span></span><span style=display:flex><span>use seata;
</span></span></code></pre></div><ol start=2><li>引入 <a href=res/Seata%E7%9B%B8%E5%85%B34%E5%BC%A0%E8%A1%A8.md>Seata相关4张表</a>：<a href=https://github.com/seata/seata/blob/develop/script/server/db/mysql.sql>Seata相关4张表GitHub地址</a></li></ol><h3 id=2-创建业务数据库>2. 创建业务数据库</h3><blockquote><p>武技：创建业务数据库，包括订单表，商品表和UndoLog日志表</p></blockquote><ol><li>创建业务数据库：</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#75715e>-- 创建数据库
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>create</span> <span style=color:#66d9ef>database</span> alibaba character <span style=color:#66d9ef>set</span> utf8mb4;
</span></span><span style=display:flex><span>use alibaba;
</span></span></code></pre></div><ol start=2><li>创建订单表：</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#75715e>-- table
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>create</span> <span style=color:#66d9ef>table</span> <span style=color:#f92672>`</span><span style=color:#66d9ef>order</span><span style=color:#f92672>`</span>
</span></span><span style=display:flex><span>(
</span></span><span style=display:flex><span>    <span style=color:#f92672>`</span>id<span style=color:#f92672>`</span>         BIGINT AUTO_INCREMENT <span style=color:#66d9ef>COMMENT</span> <span style=color:#e6db74>&#39;主键&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>`</span>sn<span style=color:#f92672>`</span>         VARCHAR(<span style=color:#ae81ff>128</span>) <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span> <span style=color:#66d9ef>COMMENT</span> <span style=color:#e6db74>&#39;订单号&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>`</span>product_id<span style=color:#f92672>`</span> BIGINT       <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span> <span style=color:#66d9ef>COMMENT</span> <span style=color:#e6db74>&#39;购买的商品ID&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>`</span>number<span style=color:#f92672>`</span>     INT          <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span> <span style=color:#66d9ef>COMMENT</span> <span style=color:#e6db74>&#39;购买的商品个数&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>primary</span> <span style=color:#66d9ef>key</span> (<span style=color:#f92672>`</span>id<span style=color:#f92672>`</span>)
</span></span><span style=display:flex><span>);
</span></span></code></pre></div><ol start=3><li>创建商品表：</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>create</span> <span style=color:#66d9ef>table</span> <span style=color:#f92672>`</span>product<span style=color:#f92672>`</span>
</span></span><span style=display:flex><span>(
</span></span><span style=display:flex><span>    <span style=color:#f92672>`</span>id<span style=color:#f92672>`</span>    BIGINT       <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span> <span style=color:#66d9ef>COMMENT</span> <span style=color:#e6db74>&#39;主键&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>`</span>title<span style=color:#f92672>`</span> VARCHAR(<span style=color:#ae81ff>128</span>) <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span> <span style=color:#66d9ef>COMMENT</span> <span style=color:#e6db74>&#39;商品名称&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>`</span>stock<span style=color:#f92672>`</span> BIGINT      <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span> <span style=color:#66d9ef>COMMENT</span> <span style=color:#e6db74>&#39;商品库存&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>primary</span> <span style=color:#66d9ef>key</span> (<span style=color:#f92672>`</span>id<span style=color:#f92672>`</span>)
</span></span><span style=display:flex><span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>insert</span> <span style=color:#66d9ef>into</span> <span style=color:#f92672>`</span>product<span style=color:#f92672>`</span> (<span style=color:#f92672>`</span>id<span style=color:#f92672>`</span>, <span style=color:#f92672>`</span>title<span style=color:#f92672>`</span>, <span style=color:#f92672>`</span>stock<span style=color:#f92672>`</span>) <span style=color:#66d9ef>values</span> (<span style=color:#ae81ff>1</span>, <span style=color:#e6db74>&#39;小米手机&#39;</span>, <span style=color:#ae81ff>2</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>insert</span> <span style=color:#66d9ef>into</span> <span style=color:#f92672>`</span>product<span style=color:#f92672>`</span> (<span style=color:#f92672>`</span>id<span style=color:#f92672>`</span>, <span style=color:#f92672>`</span>title<span style=color:#f92672>`</span>, <span style=color:#f92672>`</span>stock<span style=color:#f92672>`</span>) <span style=color:#66d9ef>values</span> (<span style=color:#ae81ff>2</span>, <span style=color:#e6db74>&#39;苹果手机&#39;</span>, <span style=color:#ae81ff>4</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>insert</span> <span style=color:#66d9ef>into</span> <span style=color:#f92672>`</span>product<span style=color:#f92672>`</span> (<span style=color:#f92672>`</span>id<span style=color:#f92672>`</span>, <span style=color:#f92672>`</span>title<span style=color:#f92672>`</span>, <span style=color:#f92672>`</span>stock<span style=color:#f92672>`</span>) <span style=color:#66d9ef>values</span> (<span style=color:#ae81ff>3</span>, <span style=color:#e6db74>&#39;华为手机&#39;</span>, <span style=color:#ae81ff>200</span>);
</span></span></code></pre></div><ol start=3><li>创建 <a href=res/Seata%E7%9A%84UndoLog%E8%A1%A8.md>Seata的UndoLog表</a>：<ol><li>注意UndoLog属于业务表，不要在 <code>seata</code> 专用的数据库中添加。</li></ol></li></ol><h3 id=3-创建nacos命名空间>3. 创建Nacos命名空间</h3><blockquote><p>武技：在Nacos管控台创建一个Seata专属的命名空间</p></blockquote><ol><li>点击左侧的 <code>命名空间 -> 新建命名空间</code> 进入命名空间添加页面。<ol><li><code>命名空间ID</code>: <code>seata-namespace</code></li><li><code>命名空间名</code>: <code>seata</code></li></ol></li><li>点击标题栏的 <code>seata/public</code> 可切换 <code>seata/public</code> 命名空间。</li></ol><h3 id=4-配置default_tx_group>4. 配置default_tx_group</h3><blockquote><p>武技：在 <code>seata</code> 命名空间中添加 default_tx_group 配置</p></blockquote><ul><li>添加如下配置：</li></ul><table><thead><tr><th>配置项</th><th>值</th></tr></thead><tbody><tr><td>DataID</td><td><code>service.vgroupMapping.default_tx_group</code></td></tr><tr><td>Group</td><td><code>SEATA_GROUP</code></td></tr><tr><td>配置格式</td><td><code>TEXT</code></td></tr><tr><td>配置内容</td><td><code>default</code></td></tr></tbody></table><h3 id=5-配置seataserverproperties>5. 配置seataServer.properties</h3><blockquote><p>武技：在 <code>seata</code> 命名空间中添加 seataServer.properties 配置</p></blockquote><ol><li>添加如下配置：</li></ol><table><thead><tr><th>配置项</th><th>值</th></tr></thead><tbody><tr><td>DataID</td><td><code>seataServer.properties</code></td></tr><tr><td>Group</td><td><code>SEATA_GROUP</code></td></tr><tr><td>配置格式</td><td><code>Properties</code></td></tr><tr><td>配置内容</td><td><a href=res/seataServer.properties.md>seataServer.properties</a><a href=https://github.com/seata/seata/blob/develop/script/config-center/config.txt>GitHub地址</a></td></tr></tbody></table><ol start=2><li>修改 <code>seataServer.properties</code> 中的配置，如下:<ol><li>全部配置均存在，对位修改即可，不要添加，以免发生覆盖。</li></ol></li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-properties data-lang=properties><span style=display:flex><span><span style=color:#75715e># 修改：事务信息存储位置，默认file</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>store.mode</span><span style=color:#f92672>=</span><span style=color:#e6db74>db</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 修改：事务锁信息存储方式，默认file</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>store.lock.mode</span><span style=color:#f92672>=</span><span style=color:#e6db74>db</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 修改：事务会话信息存储方式，默认file</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>store.session.mode</span><span style=color:#f92672>=</span><span style=color:#e6db74>db</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 修改：db模式数据库url，修改为seata专用数据库</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>store.db.url</span><span style=color:#f92672>=</span><span style=color:#e6db74>jdbc:mysql://192.168.40.77:3306/seata?useUnicode=true&amp;rewriteBatchedStatements=true</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 修改：db模式数据库账户，修改为自己的账号</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>store.db.user</span><span style=color:#f92672>=</span><span style=color:#e6db74>root</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 修改：db模式数据库密码，修改为自己的密码</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>store.db.password</span><span style=color:#f92672>=</span><span style=color:#e6db74>root</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 修改：db模式数据库初始连接数，默认1，修改为5</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>store.db.minConn</span><span style=color:#f92672>=</span><span style=color:#e6db74>5</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 修改：db模式数据库最大连接数，默认20，修改为30</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>store.db.maxConn</span><span style=color:#f92672>=</span><span style=color:#e6db74>30</span>
</span></span></code></pre></div><h2 id=e03-搭建单机容器>E03. 搭建单机容器</h2><blockquote><p>武技：在Docker中搭建Seata的事务协调器服务容器</p></blockquote><h3 id=1-创建相关目录>1. 创建相关目录</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 创建Seata相关目录</span>
</span></span><span style=display:flex><span>mkdir -p /opt/seata/conf;
</span></span><span style=display:flex><span>chmod -R <span style=color:#ae81ff>777</span> /opt/seata;
</span></span></code></pre></div><h3 id=2-开发配置文件>2. 开发配置文件</h3><ol><li>创建临时容器，拷贝配置文件：</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 拉取镜像（二选一）</span>
</span></span><span style=display:flex><span>docker pull seataio/seata-server;
</span></span><span style=display:flex><span>docker pull registry.cn-hangzhou.aliyuncs.com/lsx/seata:latest;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 创建临时容器: 仅为拷贝主配文件</span>
</span></span><span style=display:flex><span>docker run -d --name tmp registry.cn-hangzhou.aliyuncs.com/lsx/seata:latest;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 拷贝配置文件</span>
</span></span><span style=display:flex><span>docker cp tmp:/seata-server/resources/application.yml /opt/seata/conf/application.yml;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 删除临时文件</span>
</span></span><span style=display:flex><span>docker rm -f tmp
</span></span></code></pre></div><ol start=2><li>修改配置文件：<ol><li>只要修改 <code>config</code>，<code>registry</code> 和 <code>store</code> 三块内容，其余配置默认即可。</li></ol></li></ol><p><code>vim /opt/seata/conf/application.yml</code>：内容如下</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span><span style=color:#f92672>seata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>config</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>type</span>: <span style=color:#ae81ff>nacos</span> <span style=color:#75715e># 使用Nacos作为配置中心</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>nacos</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>server-addr</span>: <span style=color:#ae81ff>http://192.168.40.77:8848</span> <span style=color:#75715e># Nacos注册中心地址</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>seata-namespace</span> <span style=color:#75715e># 命名空间，使用默认的命名空间时可以不用填</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>group</span>: <span style=color:#ae81ff>SEATA_GROUP</span> <span style=color:#75715e># 分组名称</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>data-id</span>: <span style=color:#ae81ff>seataServer.properties</span> <span style=color:#75715e># seataServer配置文件</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>registry</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>type</span>: <span style=color:#ae81ff>nacos</span> <span style=color:#75715e># 使用Nacos作为注册中心</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>nacos</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>application</span>: <span style=color:#ae81ff>seata-server</span> <span style=color:#75715e># Seata在Nacos中的服务名称</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>server-addr</span>: <span style=color:#ae81ff>http://192.168.40.77:8848</span> <span style=color:#75715e># Nacos配置中心地址</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>seata-namespace</span> <span style=color:#75715e># 命名空间，使用默认的命名空间时可以不用填</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>group</span>: <span style=color:#ae81ff>SEATA_GROUP</span> <span style=color:#75715e># 分组名称</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>cluster</span>: <span style=color:#ae81ff>default</span> <span style=color:#75715e># 集群名称，默认default</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>store</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>mode</span>: <span style=color:#ae81ff>db</span> <span style=color:#75715e># 使用数据库存储模式</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>db</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>datasource</span>: <span style=color:#ae81ff>druid</span> <span style=color:#75715e># 使用druid连接池</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>db-type</span>: <span style=color:#ae81ff>mysql</span> <span style=color:#75715e># 使用mysql数据库</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>driver-class-name</span>: <span style=color:#ae81ff>com.mysql.cj.jdbc.Driver</span> <span style=color:#75715e># 驱动串</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>url</span>: <span style=color:#ae81ff>jdbc:mysql://192.168.40.77:3306/seata?serverTimezone=Asia/Shanghai</span> <span style=color:#75715e># 连接串</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>user</span>: <span style=color:#ae81ff>root</span> <span style=color:#75715e># 数据库账号</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>password</span>: <span style=color:#ae81ff>root</span> <span style=color:#75715e># 数据库密码</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>min-conn</span>: <span style=color:#ae81ff>5</span>  <span style=color:#75715e># 最小连接数</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>max-conn</span>: <span style=color:#ae81ff>100</span> <span style=color:#75715e># 最大连接数</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>global-table</span>: <span style=color:#ae81ff>global_table</span> <span style=color:#75715e># 全局表</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>branch-table</span>: <span style=color:#ae81ff>branch_table</span> <span style=color:#75715e># 分支表</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>lock-table</span>: <span style=color:#ae81ff>lock_table</span> <span style=color:#75715e># 锁表</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>distributed-lock-table</span>: <span style=color:#ae81ff>distributed_lock</span> <span style=color:#75715e># 分布式锁表</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>query-limit</span>: <span style=color:#ae81ff>100</span> <span style=color:#75715e># 查询限制数</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>max-wait</span>: <span style=color:#ae81ff>5000</span> <span style=color:#75715e># 超时时间</span>
</span></span></code></pre></div><h3 id=3-创建运行容器>3. 创建运行容器</h3><ol><li>创建并运行Seata容器：</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 创建并运行Seata容器</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 参数: `-e SEATA_IP=192.168.40.77`: 指定Seata容器IP</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 参数: `-e SEATA_PORT=8091`: 指定Seata容器端口</span>
</span></span><span style=display:flex><span>docker run -d --name seata --network my-net <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -p 8091:8091 -p 7091:7091 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -e SEATA_IP<span style=color:#f92672>=</span>192.168.40.77 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -e SEATA_PORT<span style=color:#f92672>=</span><span style=color:#ae81ff>8091</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -v /opt/seata/conf/application.yml:/seata-server/resources/application.yml <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  registry.cn-hangzhou.aliyuncs.com/lsx/seata:latest
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 查看Seata容器</span>
</span></span><span style=display:flex><span>docker ps --format <span style=color:#e6db74>&#34;{{.ID}}\t{{.Names}}\t{{.Ports}}&#34;</span>
</span></span><span style=display:flex><span>docker logs seata --tail <span style=color:#ae81ff>30</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 永久开放服务端8091和客户端7091端口</span>
</span></span><span style=display:flex><span>firewall-cmd --add-port<span style=color:#f92672>=</span>8091/tcp --permanent
</span></span><span style=display:flex><span>firewall-cmd --add-port<span style=color:#f92672>=</span>7091/tcp --permanent
</span></span><span style=display:flex><span>firewall-cmd --reload
</span></span></code></pre></div><ol start=2><li>在Windows中访问 <a href=http://192.168.40.77:7091>Seata管控台</a>：使用 <code>admin/admin</code> 登录。</li><li>在Nacos管控台的 <code>服务列表</code> 中查看，是否成功注册了一个 <code>seata-server</code> 的服务。</li></ol><h2 id=e04-开发测试项目>E04. 开发测试项目</h2><blockquote><p>武技: 创建 <code>v5-8-alibaba-seata/seata-order</code> 和 <code>v5-8-alibaba-seata/seata-product</code> 两个子项目，用于测试 Seata</p></blockquote><h3 id=1-添加三方依赖>1. 添加三方依赖</h3><ul><li>分别在两个子项目中添加三方依赖：</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#75715e>&lt;!--lombok--&gt;</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>  
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;groupId&gt;</span>org.projectlombok<span style=color:#f92672>&lt;/groupId&gt;</span>  
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;artifactId&gt;</span>lombok<span style=color:#f92672>&lt;/artifactId&gt;</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;!--spring-boot-starter-web--&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>&lt;groupId&gt;</span>org.springframework.boot<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>&lt;artifactId&gt;</span>spring-boot-starter-web<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;!--mysql-connector-java--&gt;</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>  
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;groupId&gt;</span>mysql<span style=color:#f92672>&lt;/groupId&gt;</span>  
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;artifactId&gt;</span>mysql-connector-java<span style=color:#f92672>&lt;/artifactId&gt;</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>  
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;!--mybatis-spring-boot-starter--&gt;</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>  
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;groupId&gt;</span>org.mybatis.spring.boot<span style=color:#f92672>&lt;/groupId&gt;</span>  
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;artifactId&gt;</span>mybatis-spring-boot-starter<span style=color:#f92672>&lt;/artifactId&gt;</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;!--spring-cloud-starter-alibaba-nacos-discovery--&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>&lt;groupId&gt;</span>com.alibaba.cloud<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>&lt;artifactId&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;!--spring-cloud-starter-openfeign--&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>&lt;groupId&gt;</span>org.springframework.cloud<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>&lt;artifactId&gt;</span>spring-cloud-starter-openfeign<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;!--spring-cloud-starter-alibaba-seata--&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>&lt;groupId&gt;</span>com.alibaba.cloud<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>&lt;artifactId&gt;</span>spring-cloud-starter-alibaba-seata<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span></code></pre></div><h3 id=2-开发启动类>2. 开发启动类</h3><ol><li>在 <code>seata-order</code> 子项目中开发启动类：</li></ol><p><code>com.lsx.SeataOrderApp</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@EnableDiscoveryClient</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@MapperScan</span>(<span style=color:#e6db74>&#34;com.lsx.mapper&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@EnableFeignClients</span>(basePackages <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;com.lsx.feign&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@SpringBootApplication</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SeataOrderApp</span> {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span>(String<span style=color:#f92672>[]</span> args) {    
</span></span><span style=display:flex><span>        SpringApplication.<span style=color:#a6e22e>run</span>(SeataOrderApp.<span style=color:#a6e22e>class</span>, args);  
</span></span><span style=display:flex><span>    }    
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=2><li>在 <code>seata-product</code> 子项目中开发启动类：</li></ol><p><code>com.lsx.SeataProductApp</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@EnableDiscoveryClient</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@MapperScan</span>(<span style=color:#e6db74>&#34;com.lsx.mapper&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@EnableFeignClients</span>(basePackages <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;com.lsx.feign&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@SpringBootApplication</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SeataProductApp</span> {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span>(String<span style=color:#f92672>[]</span> args) {    
</span></span><span style=display:flex><span>        SpringApplication.<span style=color:#a6e22e>run</span>(SeataProductApp.<span style=color:#a6e22e>class</span>, args);  
</span></span><span style=display:flex><span>    }    
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=3-开发配置文件>3. 开发配置文件</h3><ol><li>在 <code>seata-order</code> 子项目中开发主配文件：</li></ol><p><code>classpath:application.yml</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span><span style=color:#f92672>server</span>:  
</span></span><span style=display:flex><span>  <span style=color:#f92672>port</span>: <span style=color:#ae81ff>8215</span> <span style=color:#75715e># 端口号  </span>
</span></span><span style=display:flex><span><span style=color:#f92672>spring</span>:  
</span></span><span style=display:flex><span>  <span style=color:#f92672>application</span>:  
</span></span><span style=display:flex><span>    <span style=color:#f92672>name</span>: <span style=color:#ae81ff>seata-order</span> <span style=color:#75715e># 项目名称  </span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>datasource</span>:  
</span></span><span style=display:flex><span>    <span style=color:#f92672>driver-class-name</span>: <span style=color:#ae81ff>com.mysql.cj.jdbc.Driver  </span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>url</span>: <span style=color:#ae81ff>jdbc:mysql://192.168.40.77:3306/alibaba?useUnicode=true&amp;characterEncoding=UTF-8&amp;useSSL=false&amp;serverTimezone=Asia/Shanghai  </span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>username</span>: <span style=color:#ae81ff>lsx  </span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>password</span>: <span style=color:#ae81ff>lsx  </span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>cloud</span>:  
</span></span><span style=display:flex><span>    <span style=color:#f92672>nacos</span>:  
</span></span><span style=display:flex><span>      <span style=color:#f92672>discovery</span>:  
</span></span><span style=display:flex><span>        <span style=color:#f92672>server-addr</span>: <span style=color:#ae81ff>192.168.40.77</span>:<span style=color:#ae81ff>8848</span> <span style=color:#75715e># nacos地址  </span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#f92672>mybatis</span>:  
</span></span><span style=display:flex><span>  <span style=color:#f92672>type-aliases-package</span>: <span style=color:#ae81ff>com.lsx.entity</span> <span style=color:#75715e># 实体类别名包扫描  </span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>configuration</span>:  
</span></span><span style=display:flex><span>    <span style=color:#f92672>map-underscore-to-camel-case</span>: <span style=color:#66d9ef>true</span> <span style=color:#75715e># 下划线自动转驼峰  </span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>log-impl</span>: <span style=color:#ae81ff>org.apache.ibatis.logging.stdout.StdOutImpl</span> <span style=color:#75715e># 控制台打印SQL</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>seata</span>:  
</span></span><span style=display:flex><span>  <span style=color:#f92672>enabled</span>: <span style=color:#66d9ef>true</span> <span style=color:#75715e># 启用seata  </span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>tx-service-group</span>: <span style=color:#ae81ff>default_tx_group</span> <span style=color:#75715e># 对应配置中心的 `service.vgroupMapping.default_tx_group` 项  </span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>registry</span>:  
</span></span><span style=display:flex><span>    <span style=color:#f92672>type</span>: <span style=color:#ae81ff>nacos</span> <span style=color:#75715e># 使用Nacos注册中心  </span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>nacos</span>:  
</span></span><span style=display:flex><span>      <span style=color:#f92672>application</span>: <span style=color:#ae81ff>seata-server</span> <span style=color:#75715e># Seata在Nacos中的服务名  </span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>server-addr</span>: <span style=color:#ae81ff>192.168.40.77</span>:<span style=color:#ae81ff>8848</span> <span style=color:#75715e># Nacos注册中心地址  </span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>seata-namespace</span> <span style=color:#75715e># 命名空间  </span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>cluster</span>: <span style=color:#ae81ff>default</span> <span style=color:#75715e># 集群名称  </span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>config</span>:  
</span></span><span style=display:flex><span>    <span style=color:#f92672>type</span>: <span style=color:#ae81ff>nacos</span> <span style=color:#75715e># 使用NacosConfig配置中心  </span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>nacos</span>:  
</span></span><span style=display:flex><span>      <span style=color:#f92672>server-addr</span>: <span style=color:#ae81ff>192.168.40.77</span>:<span style=color:#ae81ff>8848</span> <span style=color:#75715e># NacosConfig配置中心地址  </span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>seata-namespace</span> <span style=color:#75715e># 命名空间  </span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>data-id</span>: <span style=color:#e6db74>&#34;seataServer.properties&#34;</span> <span style=color:#75715e># 配置文件</span>
</span></span></code></pre></div><ol start=2><li>在 <code>seata-product</code> 子项目中开发主配文件：</li></ol><p><code>classpath:application.yml</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span><span style=color:#f92672>server</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>port</span>: <span style=color:#ae81ff>8216</span> <span style=color:#75715e># 端口号  </span>
</span></span><span style=display:flex><span><span style=color:#f92672>spring</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>application</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>name</span>: <span style=color:#ae81ff>seata-product</span> <span style=color:#75715e># 项目名称  </span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>datasource</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>driver-class-name</span>: <span style=color:#ae81ff>com.mysql.cj.jdbc.Driver</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>url</span>: <span style=color:#ae81ff>jdbc:mysql://192.168.40.77:3306/alibaba?useUnicode=true&amp;characterEncoding=UTF-8&amp;useSSL=false&amp;serverTimezone=Asia/Shanghai</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>username</span>: <span style=color:#ae81ff>lsx</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>password</span>: <span style=color:#ae81ff>lsx</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>cloud</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>nacos</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>discovery</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>server-addr</span>: <span style=color:#ae81ff>192.168.40.77</span>:<span style=color:#ae81ff>8848</span> <span style=color:#75715e># nacos地址  </span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>mybatis</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>type-aliases-package</span>: <span style=color:#ae81ff>com.lsx.entity</span> <span style=color:#75715e># 实体类别名包扫描  </span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>configuration</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>map-underscore-to-camel-case</span>: <span style=color:#66d9ef>true</span> <span style=color:#75715e># 下划线自动转驼峰  </span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>log-impl</span>: <span style=color:#ae81ff>org.apache.ibatis.logging.stdout.StdOutImpl</span> <span style=color:#75715e># 控制台打印SQL</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>seata</span>:  
</span></span><span style=display:flex><span>  <span style=color:#f92672>enabled</span>: <span style=color:#66d9ef>true</span> <span style=color:#75715e># 启用seata  </span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>tx-service-group</span>: <span style=color:#ae81ff>default_tx_group</span> <span style=color:#75715e># 对应配置中心的 `service.vgroupMapping.default_tx_group` 项  </span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>registry</span>:  
</span></span><span style=display:flex><span>    <span style=color:#f92672>type</span>: <span style=color:#ae81ff>nacos</span> <span style=color:#75715e># 使用Nacos注册中心  </span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>nacos</span>:  
</span></span><span style=display:flex><span>      <span style=color:#f92672>application</span>: <span style=color:#ae81ff>seata-server</span> <span style=color:#75715e># Seata在Nacos中的服务名  </span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>server-addr</span>: <span style=color:#ae81ff>192.168.40.77</span>:<span style=color:#ae81ff>8848</span> <span style=color:#75715e># Nacos注册中心地址  </span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>seata-namespace</span> <span style=color:#75715e># 命名空间  </span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>cluster</span>: <span style=color:#ae81ff>default</span> <span style=color:#75715e># 集群名称  </span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>config</span>:  
</span></span><span style=display:flex><span>    <span style=color:#f92672>type</span>: <span style=color:#ae81ff>nacos</span> <span style=color:#75715e># 使用NacosConfig配置中心  </span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>nacos</span>:  
</span></span><span style=display:flex><span>      <span style=color:#f92672>server-addr</span>: <span style=color:#ae81ff>192.168.40.77</span>:<span style=color:#ae81ff>8848</span> <span style=color:#75715e># NacosConfig配置中心地址  </span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>seata-namespace</span> <span style=color:#75715e># 命名空间  </span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>data-id</span>: <span style=color:#e6db74>&#34;seataServer.properties&#34;</span> <span style=color:#75715e># 配置文件</span>
</span></span></code></pre></div><h3 id=4-开发配置类>4. 开发配置类</h3><ol><li>分别在两个子项目中开发Seata配置类：</li></ol><p><code>com.lsx.config.SeataConfig</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RefreshScope</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Configuration</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SeataConfig</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Value</span>(<span style=color:#e6db74>&#34;${spring.datasource.driver-class-name}&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String driverClassName;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Value</span>(<span style=color:#e6db74>&#34;${spring.datasource.url}&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String url;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Value</span>(<span style=color:#e6db74>&#34;${spring.datasource.username}&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String username;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Value</span>(<span style=color:#e6db74>&#34;${spring.datasource.password}&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String password;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> SqlSessionFactory <span style=color:#a6e22e>sqlSessionFactory</span>(DataSourceProxy dataSourceProxy) <span style=color:#66d9ef>throws</span> Exception {
</span></span><span style=display:flex><span>        SqlSessionFactoryBean sqlSessionFactoryBean <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> SqlSessionFactoryBean();
</span></span><span style=display:flex><span>        sqlSessionFactoryBean.<span style=color:#a6e22e>setDataSource</span>(dataSourceProxy);
</span></span><span style=display:flex><span>        SqlSessionFactory sqlSessionFactory <span style=color:#f92672>=</span> sqlSessionFactoryBean.<span style=color:#a6e22e>getObject</span>();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>assert</span> sqlSessionFactory <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>        sqlSessionFactory.<span style=color:#a6e22e>getConfiguration</span>().<span style=color:#a6e22e>setMapUnderscoreToCamelCase</span>(<span style=color:#66d9ef>true</span>);
</span></span><span style=display:flex><span>        sqlSessionFactory.<span style=color:#a6e22e>getConfiguration</span>().<span style=color:#a6e22e>setLogImpl</span>(StdOutImpl.<span style=color:#a6e22e>class</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> sqlSessionFactory;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> DataSource <span style=color:#a6e22e>getDataSource</span>() {
</span></span><span style=display:flex><span>        DruidDataSource dataSource <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> DruidDataSource();
</span></span><span style=display:flex><span>        dataSource.<span style=color:#a6e22e>setUrl</span>(url);
</span></span><span style=display:flex><span>        dataSource.<span style=color:#a6e22e>setUsername</span>(username);
</span></span><span style=display:flex><span>        dataSource.<span style=color:#a6e22e>setPassword</span>(password);
</span></span><span style=display:flex><span>        dataSource.<span style=color:#a6e22e>setDriverClassName</span>(driverClassName);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> dataSource;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Primary</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Bean</span>(<span style=color:#e6db74>&#34;dataSource&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> DataSourceProxy <span style=color:#a6e22e>dataSource</span>(DataSource druidDataSource) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> DataSourceProxy(druidDataSource);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=2><li>在启动类上排除默认的数据源代理类，否则会引发启动冲突：</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@SpringBootApplication</span>(exclude <span style=color:#f92672>=</span> {DataSourceAutoConfiguration.<span style=color:#a6e22e>class</span>})
</span></span></code></pre></div><h3 id=5-开发实体类>5. 开发实体类</h3><ol><li>分别在两个项目中开发实体类 <code>Order</code>：<ol><li>推荐使用 <code>common</code> 服务来创建实体类。</li></ol></li></ol><p><code>com.lsx.entity.Order</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Data</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Order</span> <span style=color:#66d9ef>implements</span> Serializable {
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**主键*/</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Long id;
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**订单编号*/</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String sn;
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**购买商品的ID*/</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Long productId;
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**购买商品的数量*/</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Integer number;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=2><li>分别在两个项目中开发实体类 <code>Product</code>：<ol><li>推荐使用 <code>common</code> 服务来创建实体类。</li></ol></li></ol><p><code>com.lsx.entity.Product</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Data</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Product</span> <span style=color:#66d9ef>implements</span> Serializable {
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**主键*/</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Long id;
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**商品标题*/</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String title;
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**商品库存量*/</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Long stock;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=6-扣减库存业务>6. 扣减库存业务</h3><ol><li>在 <code>seata-product</code> 子项目中开发Mapper接口：</li></ol><p><code>com.lsx.mapper.ProductMapper</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Repository</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>ProductMapper</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/***
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * 根据主键查询商品信息
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param id 商品主键
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @return 商品信息
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Select</span>(<span style=color:#e6db74>&#34;select `id`, `title`, `stock` from `product` where `id` = #{param1}&#34;</span>)
</span></span><span style=display:flex><span>    Product <span style=color:#a6e22e>selectById</span>(Long id);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * 根据主键修改商品库存
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param product 商品实体
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @return 影响条目数
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Update</span>(<span style=color:#e6db74>&#34;UPDATE `product` SET stock = #{stock} WHERE `id` = #{id}&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>updateStock</span>(Product product);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=2><li>在 <code>seata-product</code> 子项目中Service接口：</li></ol><p><code>com.lsx.service.ProductService</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>ProductService</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * 扣减商品库存
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param productId 商品主键
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param number 扣减数量
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @return 影响条目数
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>updateStock</span>(Long productId, Integer number);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=3><li>在 <code>seata-product</code> 子项目中实现Service接口：</li></ol><p><code>com.lsx.service.impl.ProductServiceImpl</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Service</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ProductServiceImpl</span> <span style=color:#66d9ef>implements</span> ProductService {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Autowired</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> ProductMapper productMapper;
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>updateStock</span>(Long productId, Integer number) {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 根据主键查询商品信息</span>
</span></span><span style=display:flex><span>        Product product <span style=color:#f92672>=</span> productMapper.<span style=color:#a6e22e>selectById</span>(productId);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span>(product <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span>){
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RuntimeException(<span style=color:#e6db74>&#34;商品不存在&#34;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 判断库存是否充足</span>
</span></span><span style=display:flex><span>        Long currentStock <span style=color:#f92672>=</span> product.<span style=color:#a6e22e>getStock</span>();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span>(currentStock <span style=color:#f92672>&lt;</span> number){
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RuntimeException(<span style=color:#e6db74>&#34;库存不足&#34;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 更新库存</span>
</span></span><span style=display:flex><span>        product.<span style=color:#a6e22e>setStock</span>(currentStock <span style=color:#f92672>-</span> number);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> productMapper.<span style=color:#a6e22e>updateStock</span>(product);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=4><li>在 <code>seata-product</code> 子项目中开发控制器：</li></ol><p><code>com.lsx.controller.ProductController</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RestController</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RequestMapping</span>(<span style=color:#e6db74>&#34;/api/v1/product&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ProductController</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Autowired</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> ProductService productService;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@PostMapping</span>(<span style=color:#e6db74>&#34;/updateStock/{productId}/{number}&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>updateStock</span>(<span style=color:#a6e22e>@PathVariable</span> Long productId,
</span></span><span style=display:flex><span>                          <span style=color:#a6e22e>@PathVariable</span> Integer number) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> productService.<span style=color:#a6e22e>updateStock</span>(productId, number);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=5><li>访问控制器：</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-http data-lang=http><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>### 测试扣减库存接口  
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>POST http://localhost:8216/api/v1/product/updateStock/1/2  
</span></span></span></code></pre></div><h3 id=7-购买商品业务>7. 购买商品业务</h3><ol><li>在 <code>seata-order</code> 子项目中开发Mapper接口：</li></ol><p><code>com.lsx.mapper.OrderMapper</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Component</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>OrderMapper</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * 下单购买商品
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param order 订单实体
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @return 影响条目数
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Options</span>(useGeneratedKeys <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>, keyProperty <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;id&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Insert</span>(<span style=color:#e6db74>&#34;insert into `order` (id, sn, product_id, number) &#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;values (#{id}, #{sn}, #{productId}, #{number})&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>insert</span>(Order order);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=2><li>在 <code>seata-order</code> 子项目中Service接口：</li></ol><p><code>com.lsx.service.OrderService</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>OrderService</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * 下单购买商品
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param order 订单实体
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @return 影响条目数
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>insert</span>(Order order);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=3><li>在 <code>seata-order</code> 子项目中实现Service接口：</li></ol><p><code>com.lsx.service.impl.OrderServiceImpl</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Service</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>OrderServiceImpl</span> <span style=color:#66d9ef>implements</span> OrderService {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Autowired</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> OrderMapper orderMapper;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>insert</span>(Order order) {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 添加订单表记录</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (orderMapper.<span style=color:#a6e22e>insert</span>(order) <span style=color:#f92672>&lt;=</span> 0) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RuntimeException(<span style=color:#e6db74>&#34;订单记录添加失败&#34;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> 1;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=4><li>在 <code>seata-order</code> 子项目中开发控制器：</li></ol><p><code>com.lsx.controller.OrderController</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RestController</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RequestMapping</span>(<span style=color:#e6db74>&#34;/api/v1/order&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>OrderController</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Autowired</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> OrderService orderService;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@PostMapping</span>(<span style=color:#e6db74>&#34;/insert&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>insert</span>(<span style=color:#a6e22e>@RequestBody</span> Order order) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> orderService.<span style=color:#a6e22e>insert</span>(order);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=5><li>访问控制器：</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-http data-lang=http><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>### 测试添加订单
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>POST http://localhost:8215/api/v1/order/insert
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>Content-Type: application/json
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>{
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>  &#34;sn&#34;: 10086,
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>  &#34;productId&#34;: 1,
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>  &#34;number&#34;: 1
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>}
</span></span></span></code></pre></div><h3 id=8-开发远程调用>8. 开发远程调用</h3><ol><li>在 <code>seata-order</code> 子项目中开发远程接口：</li></ol><p><code>com.lsx.feign.ProductFeign</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@FeignClient</span>(<span style=color:#e6db74>&#34;seata-product&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>ProductFeign</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@PostMapping</span>(<span style=color:#e6db74>&#34;/api/v1/product//updateStock/{productId}/{number}&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>updateStock</span>(<span style=color:#a6e22e>@PathVariable</span>(<span style=color:#e6db74>&#34;productId&#34;</span>) Long productId,
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>@PathVariable</span>(<span style=color:#e6db74>&#34;number&#34;</span>) Integer number);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=2><li>在 <code>seata-order</code> 子项目中升级业务方法：</li></ol><p><code>com.lsx.service.OrderServiceImpl</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Service</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>OrderServiceImpl</span> <span style=color:#66d9ef>implements</span> OrderService {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Autowired</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> OrderMapper orderMapper;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Autowired</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> ProductFeign productFeign;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>insert</span>(Order order) {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 添加订单表记录</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (orderMapper.<span style=color:#a6e22e>insert</span>(order) <span style=color:#f92672>&lt;=</span> 0) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RuntimeException(<span style=color:#e6db74>&#34;订单记录添加失败&#34;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 远程调用扣减库存</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (productFeign.<span style=color:#a6e22e>updateStock</span>(order.<span style=color:#a6e22e>getProductId</span>(), order.<span style=color:#a6e22e>getNumber</span>()) <span style=color:#f92672>&lt;=</span> 0) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RuntimeException(<span style=color:#e6db74>&#34;扣减库存失败&#34;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> 1;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=3><li>重新测试下单接口：<ol><li>库存不足时，仍然会添加订单记录。</li></ol></li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-http data-lang=http><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>### 测试添加订单
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>POST http://localhost:8215/api/v1/order/insert
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>Content-Type: application/json
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>{
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>  &#34;sn&#34;: 10086,
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>  &#34;productId&#34;: 1,
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>  &#34;number&#34;: 1
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>}
</span></span></span></code></pre></div><h3 id=9-添加事务保护>9. 添加事务保护</h3><blockquote><p>武技: 在 <code>v3-alibaba-product</code> 商品微服务的扣减库存业务方法中回滚Seata事务</p></blockquote><ol><li>在 <code>seata-product</code> 子项目中升级业务方法：<ol><li>全部异常都需要throws抛出，不要手动捕获处理。</li></ol></li></ol><p><code>com.lsx.service.impl.ProductServiceImpl</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Service</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ProductServiceImpl</span> <span style=color:#66d9ef>implements</span> ProductService {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Autowired</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> ProductMapper productMapper;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>updateStock</span>(Long productId, Integer number) <span style=color:#66d9ef>throws</span> TransactionException {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 根据主键查询商品信息</span>
</span></span><span style=display:flex><span>        Product product <span style=color:#f92672>=</span> productMapper.<span style=color:#a6e22e>selectById</span>(productId);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (product <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 回滚Seata事务: reload()方法需要抛出TransactionException异常，不要捕获该异常</span>
</span></span><span style=display:flex><span>            GlobalTransactionContext.<span style=color:#a6e22e>reload</span>(RootContext.<span style=color:#a6e22e>getXID</span>()).<span style=color:#a6e22e>rollback</span>();
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RuntimeException(<span style=color:#e6db74>&#34;商品不存在&#34;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 判断库存是否充足</span>
</span></span><span style=display:flex><span>        Long currentStock <span style=color:#f92672>=</span> product.<span style=color:#a6e22e>getStock</span>();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (currentStock <span style=color:#f92672>&lt;</span> number) {
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 回滚Seata事务: reload()方法需要抛出TransactionException异常，不要捕获该异常</span>
</span></span><span style=display:flex><span>            GlobalTransactionContext.<span style=color:#a6e22e>reload</span>(RootContext.<span style=color:#a6e22e>getXID</span>()).<span style=color:#a6e22e>rollback</span>();
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RuntimeException(<span style=color:#e6db74>&#34;库存不足&#34;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 更新库存</span>
</span></span><span style=display:flex><span>        product.<span style=color:#a6e22e>setStock</span>(currentStock <span style=color:#f92672>-</span> number);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> productMapper.<span style=color:#a6e22e>updateStock</span>(product);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=2><li>在 <code>seata-order</code> 子项目中升级业务方法：<ol><li>使用 <code>@GlobalTransactional(rollbackFor = Exception.class)</code> 开启全局事务。</li><li>可以和 <code>@Transactional(rollbackFor = Exception.class)</code> 本地事务共存。</li></ol></li></ol><p><code>com.lsx.service.OrderServiceImpl</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Service</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>OrderServiceImpl</span> <span style=color:#66d9ef>implements</span> OrderService {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Autowired</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> OrderMapper orderMapper;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Autowired</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> ProductFeign productFeign;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@GlobalTransactional</span>(rollbackFor <span style=color:#f92672>=</span> Exception.<span style=color:#a6e22e>class</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>insert</span>(Order order) {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 添加订单表记录</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (orderMapper.<span style=color:#a6e22e>insert</span>(order) <span style=color:#f92672>&lt;=</span> 0) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RuntimeException(<span style=color:#e6db74>&#34;订单记录添加失败&#34;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 远程调用扣减库存</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (productFeign.<span style=color:#a6e22e>updateStock</span>(order.<span style=color:#a6e22e>getProductId</span>(), order.<span style=color:#a6e22e>getNumber</span>()) <span style=color:#f92672>&lt;=</span> 0) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RuntimeException(<span style=color:#e6db74>&#34;扣减库存失败&#34;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> 1;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></div><svg id="btt-button" class="arrow-logo" xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 384 512" onclick="scrollToTop()" title="Go to top"><path d="M177 159.7l136 136c9.4 9.4 9.4 24.6.0 33.9l-22.6 22.6c-9.4 9.4-24.6 9.4-33.9.0L160 255.9l-96.4 96.4c-9.4 9.4-24.6 9.4-33.9.0L7 329.7c-9.4-9.4-9.4-24.6.0-33.9l136-136c9.4-9.5 24.6-9.5 34-.1z"/></svg>
<script>let backToTopButton=document.getElementById("btt-button");window.onscroll=function(){scrollFunction()};function scrollFunction(){document.body.scrollTop>20||document.documentElement.scrollTop>20?backToTopButton.style.display="block":backToTopButton.style.display="none"}function scrollToTop(){window.scrollTo(0,0)}</script></div></main><footer class=footer><span>&copy; 2024 The Marauders</span>
<span>Made with &#10084;&#65039; using <a target=_blank href=https://github.com/gokarna-theme/gokarna-hugo>Gokarna</a></span></footer></body></html>