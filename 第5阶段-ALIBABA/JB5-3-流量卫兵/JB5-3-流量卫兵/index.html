<!doctype html><html lang=en><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><style>:root{--accent-color:#FF4D4D}</style><title>JB5-3-流量卫兵</title>
<meta name=description content="[!NOTE] Java道经第5卷 - 第3阶 - 流量卫兵 v5-3-alibaba-sentinel
S01. Jmeter压测工具 心法: Jmeter压测工具
Jmeter是Apache组织基于Java开发的压力测试工具。 E01. Jmeter工具安装 武技: 安装Jmeter压测工具
1. 安装压测工具 确 …"><meta name=keywords content='blog,lsx2216,hugo'><meta property="og:url" content="https://lsx2216.netlify.app/%E7%AC%AC5%E9%98%B6%E6%AE%B5-ALIBABA/JB5-3-%E6%B5%81%E9%87%8F%E5%8D%AB%E5%85%B5/JB5-3-%E6%B5%81%E9%87%8F%E5%8D%AB%E5%85%B5/"><meta property="og:type" content="website"><meta property="og:title" content="JB5-3-流量卫兵"><meta property="og:description" content="[!NOTE] Java道经第5卷 - 第3阶 - 流量卫兵 v5-3-alibaba-sentinel
S01. Jmeter压测工具 心法: Jmeter压测工具
Jmeter是Apache组织基于Java开发的压力测试工具。 E01. Jmeter工具安装 武技: 安装Jmeter压测工具
1. 安装压测工具 确 …"><meta property="og:image" content="https://lsx2216.netlify.app/assets/images/user.jpg"><meta property="og:image:secure_url" content="https://lsx2216.netlify.app/assets/images/user.jpg"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="JB5-3-流量卫兵"><meta name=twitter:description content="[!NOTE] Java道经第5卷 - 第3阶 - 流量卫兵 v5-3-alibaba-sentinel
S01. Jmeter压测工具 心法: Jmeter压测工具
Jmeter是Apache组织基于Java开发的压力测试工具。 E01. Jmeter工具安装 武技: 安装Jmeter压测工具
1. 安装压测工具 确 …"><meta property="twitter:domain" content="https://lsx2216.netlify.app/%E7%AC%AC5%E9%98%B6%E6%AE%B5-ALIBABA/JB5-3-%E6%B5%81%E9%87%8F%E5%8D%AB%E5%85%B5/JB5-3-%E6%B5%81%E9%87%8F%E5%8D%AB%E5%85%B5/"><meta property="twitter:url" content="https://lsx2216.netlify.app/%E7%AC%AC5%E9%98%B6%E6%AE%B5-ALIBABA/JB5-3-%E6%B5%81%E9%87%8F%E5%8D%AB%E5%85%B5/JB5-3-%E6%B5%81%E9%87%8F%E5%8D%AB%E5%85%B5/"><meta name=twitter:image content="https://lsx2216.netlify.app/assets/images/user.jpg"><link rel=canonical href=https://lsx2216.netlify.app/%E7%AC%AC5%E9%98%B6%E6%AE%B5-ALIBABA/JB5-3-%E6%B5%81%E9%87%8F%E5%8D%AB%E5%85%B5/JB5-3-%E6%B5%81%E9%87%8F%E5%8D%AB%E5%85%B5/><link rel=stylesheet type=text/css href=/css/normalize.min.css media=print><link rel=stylesheet type=text/css href=/css/main.min.css><link id=dark-theme rel=stylesheet href=/css/dark.min.css><script src=/js/bundle.min.3eb19cb61dde9e37b9522867f3e024aeb68e26ab8e03252e46e365abcb19acf7.js integrity="sha256-PrGcth3enje5Uihn8+AkrraOJquOAyUuRuNlq8sZrPc="></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css integrity=sha384-Xi8rHCmBmhbuyyhbI88391ZKP2dmfnOl4rT9ZfRI7mLTdk1wblIUnrIq35nqwEvC crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.js integrity=sha384-X/XCfMm41VSsqRNQgDerQczD69XqmjOOOwYQvr/uuC+j4OPoNhVgjdGFwhvN02Ja crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],throwOnError:!1})})</script>    <link rel="shortcut icon" href="/assets/images/user.jpg" type="image/x-icon">
</head><body><script>setThemeByUserPref()</script><header class=header><nav class=header-nav><div class=avatar><a href=https://lsx2216.netlify.app/><img src=/assets/images/user.jpg alt=avatar></a></div><div class=nav-title><a class=nav-brand href=https://lsx2216.netlify.app/>lsx2216</a></div><div class=nav-links><div class=nav-link><a href=https://lsx2216.netlify.app/ aria-label><span data-feather=home></span> Home</a></div><div class=nav-link><a href=https://lsx2216.netlify.app/projects/ aria-label><span data-feather=code></span> Projects</a></div><div class=nav-link><a href=https://github.com aria-label=github><span data-feather=github></span></a></div><span class=nav-icons-divider></span><div class="nav-link dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target">theme</span>
<a aria-hidden=true role=switch><span class=theme-toggle-icon data-feather=moon></span></a></div><div class=nav-link id=hamburger-menu-toggle><span class="sr-only hamburger-menu-toggle-screen-reader-target">menu</span>
<a aria-checked=false aria-labelledby=hamburger-menu-toggle id=hamburger-menu-toggle-target role=switch><span data-feather=menu></span></a></div><ul class="nav-hamburger-list visibility-hidden"><li class=nav-item><a href=https://lsx2216.netlify.app/><span data-feather=home></span> Home</a></li><li class=nav-item><a href=https://lsx2216.netlify.app/projects/><span data-feather=code></span> Projects</a></li><li class=nav-item><a href=https://github.com><span data-feather=github></span></a></li><li class="nav-item dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target">theme</span>
<a role=switch><span class=theme-toggle-icon data-feather=moon></span></a></li></ul></div></nav></header><main id=content><div class="post container"><div class=post-header-section><h1>JB5-3-流量卫兵</h1></div><div class=post-content><blockquote><p>[!NOTE] Java道经第5卷 - 第3阶 - 流量卫兵
v5-3-alibaba-sentinel</p></blockquote><h1 id=s01-jmeter压测工具>S01. Jmeter压测工具</h1><blockquote><p>心法: Jmeter压测工具</p></blockquote><ul><li>Jmeter是Apache组织基于Java开发的压力测试工具。</li></ul><h2 id=e01-jmeter工具安装>E01. Jmeter工具安装</h2><blockquote><p>武技: 安装Jmeter压测工具</p></blockquote><h3 id=1-安装压测工具>1. 安装压测工具</h3><ol><li>确认 <code>JAVA_HOME</code> 配置是否正确。</li><li>安装Jmeter压测工具 <code>apache-jmeter-5.2.1.zip</code>: 解压缩即可。</li><li>启动Jmeter压测工具:<ol><li>双击启动 <code>@\bin\jmeter.bat</code> 文件启动Jmeter压测工具。</li><li>关闭CMD窗口时，视为关闭Jmeter压测工具。</li></ol></li></ol><h3 id=2-调整语言环境>2. 调整语言环境</h3><ol><li>点击 <code>Options -> Choose Language</code> 项。</li><li>选择 <code>Chinese(Simplified) 简体中文</code> 项。</li></ol><h2 id=e02-jmeter压测流程>E02. Jmeter压测流程</h2><blockquote><p>武技: Jmeter压测工具使用流程</p></blockquote><pre tabindex=0><code class=language-mermaid data-lang=mermaid>flowchart LR

n1[&#34;添加线程组&#34;]
--&gt; n2[&#34;添加HTTP请求&#34;]
--&gt; n3[&#34;添加结果树&#34;]
--&gt; n4[&#34;启动测试&#34;]
</code></pre><h3 id=1-添加线程组>1. 添加线程组</h3><blockquote><p>心法：线程组用于设置线程相关信息</p></blockquote><ul><li>右键 <code>Test Plan</code>: 依次选择 <code>添加 -> 线程(用户) -> 线程组</code> 进入线程组配置界面。</li></ul><table><thead><tr><th>相关项</th><th>描述</th><th>示例</th></tr></thead><tbody><tr><td>名称</td><td>名称随意，唯一即可</td><td><code>openfeign-order</code></td></tr><tr><td>线程数</td><td>一共要启动多少个线程</td><td><code>2</code></td></tr><tr><td>RampUp时间（秒）</td><td>全部线程需要在多少秒内启动完毕设置 <code>-1</code> 表示系统自动配置</td><td><code>-1</code></td></tr><tr><td>循环测试</td><td>每个线程要循环执行多少次勾选 <code>永远</code> 表示一直执行不停止</td><td><code>3</code></td></tr></tbody></table><h3 id=2-添加http请求>2. 添加HTTP请求</h3><blockquote><p>心法：HTTP请求用于设置请求路径</p></blockquote><ul><li>右键 <code>线程组</code>: 依次选择 <code>添加 -> 取样器 -> HTTP请求</code> 进入HTTP请求配置界面。</li></ul><table><thead><tr><th>相关项</th><th>描述</th><th>示例</th></tr></thead><tbody><tr><td>名称</td><td>名称随意，唯一即可</td><td><code>getById</code></td></tr><tr><td>协议</td><td>请求协议</td><td><code>http</code></td></tr><tr><td>服务器名称或IP</td><td>服务器名称或IP</td><td><code>localhost</code></td></tr><tr><td>端口号</td><td>端口号</td><td><code>8083</code></td></tr><tr><td>HTTP请求</td><td>请求方式</td><td><code>GET</code></td></tr><tr><td>路径</td><td>请求地址</td><td><code>/api/v1/getById/1</code></td></tr></tbody></table><h3 id=3-添加结果树>3. 添加结果树</h3><blockquote><p>心法：结果树用于展示压测结果</p></blockquote><ul><li>右键 <code>线程组</code>: 依次选择 <code>添加 -> 监听器 -> 观察结果树</code> 添加一个结果树。</li></ul><h3 id=4-启动压力测试>4. 启动压力测试</h3><ol><li>右键 <code>线程组</code> 选择 <code>启动</code>：启动指定线程组的压力测试。</li><li>点击工具栏的 <code>启动按钮</code> 会启动当前全部线程组的压力测试。</li></ol><h1 id=s02-sentinel概念入门>S02. Sentinel概念入门</h1><blockquote><p>心法: Sentinel流量防卫兵</p></blockquote><ul><li>Sentinel是阿里巴巴开源的一款服务容错方案，以流量为切入点, 从流量控制、熔断降级、系统负载保护等多个维度来保护服务的稳定性。</li></ul><table><thead><tr><th>Sentinel特点</th><th>描述</th></tr></thead><tbody><tr><td>丰富的应用场景</td><td>Sentinel 承接了阿里巴巴近10年的双11大促流量的核心场景如秒杀，消息削峰填谷，集群流量控制，实时熔断下游不可用应用等</td></tr><tr><td>完备的实时监控</td><td>Sentinel 提供了实时的监控功能，可直接在管控太查看单台机器秒级数据甚至500台以下规模的集群的汇总运行情况</td></tr><tr><td>广泛的开源生态</td><td>Sentinel 提供开箱即用的与其它开源框架/库的整合模块如与 SpringCloud、Dubbo、gRPC 等技术的整合</td></tr><tr><td>完善的SPI扩展点</td><td>Sentinel 提供简单易用、完善的 Service Provider Interface 扩展接口，用于拓展功能如定制规则管理、适配动态数据源等</td></tr></tbody></table><h2 id=e01-常见防卫手段>E01. 常见防卫手段</h2><blockquote><p>心法: 雪崩效应</p></blockquote><ul><li>由于网络，硬件或自身系统等原因，服务无法保证100%可用。</li><li>当某个服务挂掉时会导致上游任务堆积，多条线程阻塞占满内存，最终瘫痪整个服务，这就是雪崩效应。</li><li>Sentinel的设计初衷就是保证系统雪落而不雪崩，常用的防卫手段包括超时，隔离，限流，熔断，降级等。</li></ul><h3 id=1-超时时间>1. 超时时间</h3><blockquote><p>心法：为每个下游服务设置一个最大响应时间，超时则立刻断开请求，释放线程。</p></blockquote><ul><li>在上游服务调用下游服务的时候，设置一个最大响应时间，超时就立刻断开请求，释放掉线程。</li></ul><h3 id=2-服务隔离>2. 服务隔离</h3><blockquote><p>心法：当服务故障时，立刻将其隔离，避免扩散给上游服务，导致雪崩。</p></blockquote><ul><li>服务隔离有线程池隔离和信号量隔离两种方案，对比如下：</li></ul><table><thead><tr><th>对比项</th><th>线程池隔离</th><th>信号量隔离</th></tr></thead><tbody><tr><td>隔离方式</td><td>为每个微服务单独建立一个线程池对超出线程池限制的线程直接返回fallback兜底数据</td><td>设定一个信号量对超出信号量限制的线程直接返回fallback兜底数据</td></tr><tr><td>是否可以异步调用下游服务</td><td>每个服务都包含多条线程可以异步调用下游服务</td><td>没有单独的线程池只能一个线程同步调用下游服务</td></tr><tr><td>CPU资源消耗情况</td><td>线程频繁切换消耗CPU资源</td><td>一个线程执行到底，无线程切换开销</td></tr><tr><td>适用场景</td><td>高并发且请求处理耗时较长的场景</td><td>高并发且请求处理耗时较短的场景</td></tr></tbody></table><h3 id=3-请求限流>3. 请求限流</h3><blockquote><p>心法：主动对系统的输入流量和输出流量进行限制，以保证系统的稳定运行。</p></blockquote><ul><li>限制系统的输入和输出的流量以保证系统的稳定运行，一旦达到设定的某阈值就开启限流。</li><li>对超出流量限制的请求直接返回fallback兜底数据。</li></ul><h3 id=4-被动熔断>4. 被动熔断</h3><ul><li>当下游服务出现故障时，上游服务可以暂时熔断对下游服务的调用转而返回fallback兜底数据以保全大局。</li><li>每隔一段时间重新尝试调用。</li></ul><table><thead><tr><th>服务熔断状态</th><th>中文</th><th>描述</th></tr></thead><tbody><tr><td><code>Closed</code></td><td>熔断关闭状态</td><td>服务没有故障时，熔断器所处的状态，对调用方的调用不做任何限制</td></tr><tr><td><code>Open</code></td><td>熔断开启状态</td><td>后续对该服务接口的调用不再经过网络，直接执行本地的fallback方法</td></tr><tr><td><code>Half-Open</code></td><td>半熔断状态</td><td>尝试恢复服务调用，允许有限的流量调用该服务，并监控调用成功率。如果成功率达到预期，则说明服务已恢复，进入熔断关闭状态。如果成功率仍旧很低，则重新进入熔断关闭状态。</td></tr></tbody></table><h3 id=5-主动降级>5. 主动降级</h3><ul><li>特殊情况下，可以主动对某些不重要的服务降级，返回fallback兜底数据以暂时让出资源给其他重要的服务。</li></ul><h2 id=e02-单机容器搭建>E02. 单机容器搭建</h2><blockquote><p>武技: 在Docker中搭建Sentinel单机容器</p></blockquote><h3 id=1-创建运行容器>1. 创建运行容器</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 拉取镜像（二选一）</span>
</span></span><span style=display:flex><span>docker pull bladex/sentinel-dashboard:1.8.0;
</span></span><span style=display:flex><span>docker pull registry.cn-hangzhou.aliyuncs.com/lsx/sentinel:1.8.0;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 创建并运行容器</span>
</span></span><span style=display:flex><span>docker run -d --name sentinel --network my-net -p 8858:8858 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	registry.cn-hangzhou.aliyuncs.com/lsx/sentinel:1.8.0;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 查看容器</span>
</span></span><span style=display:flex><span>docker ps --format <span style=color:#e6db74>&#34;{{.ID}}\t{{.Names}}\t{{.Ports}}&#34;</span>
</span></span><span style=display:flex><span>docker logs sentinel --tail <span style=color:#ae81ff>30</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 永久开放8858端口</span>
</span></span><span style=display:flex><span>firewall-cmd --add-port<span style=color:#f92672>=</span>8858/tcp --permanent
</span></span><span style=display:flex><span>firewall-cmd --reload
</span></span></code></pre></div><h3 id=2-访问单机容器>2. 访问单机容器</h3><ul><li>在Window主机访问 <a href=http://192.168.40.77:8858>Sentinel单机容器</a>：使用 <code>sentinel/sentinel</code> 账号登录。</li></ul><h2 id=e03-开发订单服务>E03. 开发订单服务</h2><blockquote><p>武技: 创建 <code>v5-3-alibaba-sentinel</code> 子项目，以及 <code>sentinel-order</code> 子项目</p></blockquote><h3 id=1-引入三方依赖>1. 引入三方依赖</h3><ol><li>在父项目中锁定版本：</li></ol><p><code>pom.xml</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#f92672>&lt;spring-boot-version&gt;</span>2.3.12.RELEASE<span style=color:#f92672>&lt;/spring-boot-version&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;spring-cloud-version&gt;</span>Hoxton.SR12<span style=color:#f92672>&lt;/spring-cloud-version&gt;</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;spring-cloud-alibaba-version&gt;</span>2.2.9.RELEASE<span style=color:#f92672>&lt;/spring-cloud-alibaba-version&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;lombok-version&gt;</span>1.18.24<span style=color:#f92672>&lt;/lombok-version&gt;</span>
</span></span></code></pre></div><ol start=2><li>在父项目中管理依赖：</li></ol><p><code>pom.xml</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#75715e>&lt;!--lombok--&gt;</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>  
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;groupId&gt;</span>org.projectlombok<span style=color:#f92672>&lt;/groupId&gt;</span>  
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;artifactId&gt;</span>lombok<span style=color:#f92672>&lt;/artifactId&gt;</span>  
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;version&gt;</span>${lombok-version}<span style=color:#f92672>&lt;/version&gt;</span>  
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;scope&gt;</span>provided<span style=color:#f92672>&lt;/scope&gt;</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;!--spring-boot-starter-parent--&gt;</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>  
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;groupId&gt;</span>org.springframework.boot<span style=color:#f92672>&lt;/groupId&gt;</span>  
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;artifactId&gt;</span>spring-boot-starter-parent<span style=color:#f92672>&lt;/artifactId&gt;</span>  
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;version&gt;</span>${spring-boot-version}<span style=color:#f92672>&lt;/version&gt;</span>  
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;type&gt;</span>pom<span style=color:#f92672>&lt;/type&gt;</span>  
</span></span><span style=display:flex><span>	<span style=color:#f92672>&lt;scope&gt;</span>import<span style=color:#f92672>&lt;/scope&gt;</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;!--spring-cloud-dependencies--&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>&lt;groupId&gt;</span>org.springframework.cloud<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>&lt;artifactId&gt;</span>spring-cloud-dependencies<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>&lt;version&gt;</span>${spring-cloud-version}<span style=color:#f92672>&lt;/version&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>&lt;type&gt;</span>pom<span style=color:#f92672>&lt;/type&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>&lt;scope&gt;</span>import<span style=color:#f92672>&lt;/scope&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;!--spring-cloud-alibaba-dependencies--&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>&lt;groupId&gt;</span>com.alibaba.cloud<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>&lt;artifactId&gt;</span>spring-cloud-alibaba-dependencies<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>&lt;version&gt;</span>${spring-cloud-alibaba-version}<span style=color:#f92672>&lt;/version&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>&lt;type&gt;</span>pom<span style=color:#f92672>&lt;/type&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>&lt;scope&gt;</span>import<span style=color:#f92672>&lt;/scope&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span></code></pre></div><ol start=3><li>在子项目中引入依赖:</li></ol><p><code>pom.xml</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#75715e>&lt;!--lombok--&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>&lt;groupId&gt;</span>org.projectlombok<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>&lt;artifactId&gt;</span>lombok<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;!--spring-boot-starter-web--&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;groupId&gt;</span>org.springframework.boot<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;artifactId&gt;</span>spring-boot-starter-web<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;!--spring-cloud-starter-alibaba-nacos-discovery--&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;groupId&gt;</span>com.alibaba.cloud<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;artifactId&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;!--spring-cloud-starter-openfeign--&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>&lt;groupId&gt;</span>org.springframework.cloud<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>&lt;artifactId&gt;</span>spring-cloud-starter-openfeign<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;!--spring-cloud-starter-alibaba-sentinel--&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;groupId&gt;</span>com.alibaba.cloud<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;artifactId&gt;</span>spring-cloud-starter-alibaba-sentinel<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span></code></pre></div><h3 id=2-开发启动类>2. 开发启动类</h3><p><code>com.lsx.SentinelOrderApp</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@SpringBootApplication</span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SentinelOrderApp</span> {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span>(String<span style=color:#f92672>[]</span> args) {  
</span></span><span style=display:flex><span>        SpringApplication.<span style=color:#a6e22e>run</span>(SentinelOrderApp.<span style=color:#a6e22e>class</span>, args);  
</span></span><span style=display:flex><span>    }  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=3-开发配置类>3. 开发配置类</h3><ol><li>开发Nacos配置类：</li></ol><p><code>com.lsx.config.NacosConfig</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@EnableDiscoveryClient</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Configuration</span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>NacosConfig</span> {  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=2><li>开发OpenFeign配置类：</li></ol><p><code>com.lsx.config.OpenFeignConfig</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@EnableFeignClients</span>(basePackages <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;com.lsx.feign&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Configuration</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>OpenFeignConfig</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>	 * OpenFeign提供了日志打印功能，用于对OpenFeign接口的调用情况进行监控和输出
</span></span></span><span style=display:flex><span><span style=color:#75715e>	 *
</span></span></span><span style=display:flex><span><span style=color:#75715e>	 * &lt;p&gt;Logger.Level.NONE: 不显示任何日志，默认值
</span></span></span><span style=display:flex><span><span style=color:#75715e>	 * &lt;p&gt;Logger.Level.BASIC: 仅记录请求方法、URL、响应状态码及执行时间
</span></span></span><span style=display:flex><span><span style=color:#75715e>	 * &lt;p&gt;Logger.Level.HEADERS: 除了BASIC中定义的信息之外，还有请求和响应的头信息
</span></span></span><span style=display:flex><span><span style=color:#75715e>	 * &lt;p&gt;Logger.Level.FULL: 除了HEADERS中定义的信息之外，还有请求和响应的正文及元数据
</span></span></span><span style=display:flex><span><span style=color:#75715e>	 */</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span>	Logger.<span style=color:#a6e22e>Level</span> <span style=color:#a6e22e>feignLoggerLevel</span>() {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> Logger.<span style=color:#a6e22e>Level</span>.<span style=color:#a6e22e>FULL</span>;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=4-开发主配项>4. 开发主配项</h3><p><code>classpath:application.yml</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>server</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>port</span>: <span style=color:#ae81ff>8087</span> <span style=color:#75715e># 端口号  </span>
</span></span><span style=display:flex><span><span style=color:#f92672>spring</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>application</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>name</span>: <span style=color:#ae81ff>sentinel-order</span> <span style=color:#75715e># 项目名称  </span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>cloud</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>nacos</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>discovery</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>server-addr</span>: <span style=color:#ae81ff>192.168.40.77</span>:<span style=color:#ae81ff>8848</span> <span style=color:#75715e># Nacos服务地址，集群用逗号分隔</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>sentinel</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>transport</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>port</span>: <span style=color:#ae81ff>8888</span> <span style=color:#75715e># Sentinel跟控制台交流的内部端口号，随意指定一个未使用的端口即可</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>dashboard</span>: <span style=color:#ae81ff>192.168.40.77</span>:<span style=color:#ae81ff>8858</span> <span style=color:#75715e># Sentinel管控台端口号</span>
</span></span><span style=display:flex><span><span style=color:#f92672>logging</span>:  
</span></span><span style=display:flex><span>  <span style=color:#f92672>level</span>:  
</span></span><span style=display:flex><span>    <span style=color:#f92672>com.lsx.feign</span>: <span style=color:#ae81ff>debug</span> <span style=color:#75715e># 配置指定包的日志等级</span>
</span></span></code></pre></div><h3 id=5-启动微服务>5. 启动微服务</h3><ul><li>启动项目，<a href=http://192.168.40.77:8848/nacos>访问Nacos</a>，在 <code>服务管理 -> 服务列表</code> 中观察微服务是否注册成功。</li></ul><h2 id=e04-开发降级方法>E04. 开发降级方法</h2><blockquote><p>心法：什么是Sentinel资源？</p></blockquote><ul><li>资源就是Sentinel要保护的东西，它可以是 Java 应用程序中的任何内容，如一个服务，一个方法，甚至一段代码。</li><li>微服务中的任何控制方法都可以视为一个Sentinel资源。</li></ul><h3 id=1-降级方法要求>1. 降级方法要求</h3><blockquote><p>心法: Sentinel降级方法</p></blockquote><ul><li>Sentinel资源在爆发流控异常，熔断异常，授权异常或系统异常时，会执行资源上指定的FallBack降级方法。</li><li>FallBack降级方法中一般会捕获和处理对应的异常，然后返回兜底数据。</li></ul><table><thead><tr><th>降级方法的元素</th><th>对应编写要求</th></tr></thead><tbody><tr><td>修饰符</td><td>必须被 <code>public static</code> 修饰</td></tr><tr><td>方法名</td><td>方法名随意</td></tr><tr><td>形参</td><td>必须和资源方法的形参一致，支持额外的 <code>Throwable e</code> 参数</td></tr><tr><td>返回值</td><td>必须和资源方法的返回值一致</td></tr></tbody></table><h3 id=2-开发降级方法>2. 开发降级方法</h3><blockquote><p>武技：开发通用无参降级方法</p></blockquote><p><code>com.lsx.fallback.SentinelFallback -> fallback()</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SentinelFallback</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/** 通用无参降级方法 */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> String <span style=color:#a6e22e>fallback</span>(Throwable e) {
</span></span><span style=display:flex><span>        String exceptionMessage <span style=color:#f92672>=</span> e.<span style=color:#a6e22e>getMessage</span>();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (e <span style=color:#66d9ef>instanceof</span> FlowException) {
</span></span><span style=display:flex><span>            exceptionMessage <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;FlowException流控异常: 您访问的太快或当前访问人数过多，请稍后重试..&#34;</span>;
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (e <span style=color:#66d9ef>instanceof</span> DegradeException) {
</span></span><span style=display:flex><span>            exceptionMessage <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;DegradeException熔断异常: 服务器响应超时或失败次数过多，请稍后重试..&#34;</span>;
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (e <span style=color:#66d9ef>instanceof</span> AuthorityException) {
</span></span><span style=display:flex><span>            exceptionMessage <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;AuthorityException授权异常: 您无权访问该资源，请联系管理员..&#34;</span>;
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (e <span style=color:#66d9ef>instanceof</span> SystemBlockException) {
</span></span><span style=display:flex><span>            exceptionMessage <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;SystemBlockException系统异常: 系统限制，Sentinel熔断降级..&#34;</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(exceptionMessage);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> exceptionMessage;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=e05-数据持久配置>E05. 数据持久配置</h2><blockquote><p>心法: Sentinel持久操作</p></blockquote><ul><li>Sentinel管控台中设置的规则默认存放内存，重启微服务就会重置，建议将其持久化到硬盘文件:<ul><li>Sentinel管控台通过API将规则推送至Sentinel客户端并更新到内存。</li><li>Sentinel客户端将内存中的规则持久化到本地JSON文件。</li></ul></li><li>每次重启微服务时，Sentinel都会读取本地文件中的规则并自动配置。</li></ul><blockquote><p>武技: 持久化Sentinel规则到本地JSON文件</p></blockquote><h3 id=1-开发配置类>1. 开发配置类</h3><ol><li>开发持久化配置类 <code>FilePersistenceConfig</code>: 仅修改规则存放位置为 <code>D:/idea/sentinel-rule/sentinel-order</code> 即可，其余代码拷贝。</li></ol><p><code>com.lsx.config.FilePersistenceConfig</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>import</span> com.alibaba.csp.sentinel.command.handler.ModifyParamFlowRulesCommandHandler;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> com.alibaba.csp.sentinel.datasource.*;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> com.alibaba.csp.sentinel.init.InitFunc;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> com.alibaba.csp.sentinel.slots.block.authority.AuthorityRule;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> com.alibaba.csp.sentinel.slots.block.authority.AuthorityRuleManager;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> com.alibaba.csp.sentinel.slots.block.degrade.DegradeRule;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> com.alibaba.csp.sentinel.slots.block.degrade.DegradeRuleManager;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> com.alibaba.csp.sentinel.slots.block.flow.FlowRule;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> com.alibaba.csp.sentinel.slots.block.flow.FlowRuleManager;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> com.alibaba.csp.sentinel.slots.block.flow.param.ParamFlowRule;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> com.alibaba.csp.sentinel.slots.block.flow.param.ParamFlowRuleManager;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> com.alibaba.csp.sentinel.slots.system.SystemRule;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> com.alibaba.csp.sentinel.slots.system.SystemRuleManager;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> com.alibaba.csp.sentinel.transport.util.WritableDataSourceRegistry;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> com.alibaba.fastjson.JSON;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> com.alibaba.fastjson.TypeReference;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> lombok.SneakyThrows;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.io.File;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.util.List;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@SuppressWarnings</span>(<span style=color:#e6db74>&#34;all&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>FilePersistenceConfig</span> <span style=color:#66d9ef>implements</span> InitFunc {
</span></span><span style=display:flex><span>    <span style=color:#75715e>/** 规则存放位置 */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> String RULE_DIR <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;D:/idea/sentinel-rule/sentinel-order&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>init</span>() <span style=color:#66d9ef>throws</span> Exception {
</span></span><span style=display:flex><span>        String flowRulePath <span style=color:#f92672>=</span> RULE_DIR <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;/flow-rule.json&#34;</span>;
</span></span><span style=display:flex><span>        String degradeRulePath <span style=color:#f92672>=</span> RULE_DIR <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;/degrade-rule.json&#34;</span>;
</span></span><span style=display:flex><span>        String systemRulePath <span style=color:#f92672>=</span> RULE_DIR <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;/system-rule.json&#34;</span>;
</span></span><span style=display:flex><span>        String authorityRulePath <span style=color:#f92672>=</span> RULE_DIR <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;/authority-rule.json&#34;</span>;
</span></span><span style=display:flex><span>        String paramFlowRulePath <span style=color:#f92672>=</span> RULE_DIR <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;/param-flow-rule.json&#34;</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>mkdirIfNotExits</span>(RULE_DIR);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>createFileIfNotExits</span>(flowRulePath);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>createFileIfNotExits</span>(degradeRulePath);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>createFileIfNotExits</span>(systemRulePath);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>createFileIfNotExits</span>(authorityRulePath);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>createFileIfNotExits</span>(paramFlowRulePath);
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 流控降级规则</span>
</span></span><span style=display:flex><span>        ReadableDataSource<span style=color:#f92672>&lt;</span>String, List<span style=color:#f92672>&lt;</span>FlowRule<span style=color:#f92672>&gt;&gt;</span> flowRuleRds
</span></span><span style=display:flex><span>                <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> FileRefreshableDataSource<span style=color:#f92672>&lt;&gt;</span>(flowRulePath, flowRuleListParser);
</span></span><span style=display:flex><span>        FlowRuleManager.<span style=color:#a6e22e>register2Property</span>(flowRuleRds.<span style=color:#a6e22e>getProperty</span>());
</span></span><span style=display:flex><span>        WritableDataSource<span style=color:#f92672>&lt;</span>List<span style=color:#f92672>&lt;</span>FlowRule<span style=color:#f92672>&gt;&gt;</span> flowRuleWds
</span></span><span style=display:flex><span>                <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> FileWritableDataSource<span style=color:#f92672>&lt;&gt;</span>(flowRulePath, <span style=color:#66d9ef>this</span>::encodeJson);
</span></span><span style=display:flex><span>        WritableDataSourceRegistry.<span style=color:#a6e22e>registerFlowDataSource</span>(flowRuleWds);
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 熔断降级规则</span>
</span></span><span style=display:flex><span>        ReadableDataSource<span style=color:#f92672>&lt;</span>String, List<span style=color:#f92672>&lt;</span>DegradeRule<span style=color:#f92672>&gt;&gt;</span> degradeRuleRds
</span></span><span style=display:flex><span>                <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> FileRefreshableDataSource<span style=color:#f92672>&lt;&gt;</span>(degradeRulePath, degradeRuleListParser);
</span></span><span style=display:flex><span>        DegradeRuleManager.<span style=color:#a6e22e>register2Property</span>(degradeRuleRds.<span style=color:#a6e22e>getProperty</span>());
</span></span><span style=display:flex><span>        WritableDataSource<span style=color:#f92672>&lt;</span>List<span style=color:#f92672>&lt;</span>DegradeRule<span style=color:#f92672>&gt;&gt;</span> degradeRuleWds
</span></span><span style=display:flex><span>                <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> FileWritableDataSource<span style=color:#f92672>&lt;&gt;</span>(degradeRulePath, <span style=color:#66d9ef>this</span>::encodeJson);
</span></span><span style=display:flex><span>        WritableDataSourceRegistry.<span style=color:#a6e22e>registerDegradeDataSource</span>(degradeRuleWds);
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 系统降级规则</span>
</span></span><span style=display:flex><span>        ReadableDataSource<span style=color:#f92672>&lt;</span>String, List<span style=color:#f92672>&lt;</span>SystemRule<span style=color:#f92672>&gt;&gt;</span> systemRuleRds
</span></span><span style=display:flex><span>                <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> FileRefreshableDataSource<span style=color:#f92672>&lt;&gt;</span>(systemRulePath, systemRuleListParser);
</span></span><span style=display:flex><span>        SystemRuleManager.<span style=color:#a6e22e>register2Property</span>(systemRuleRds.<span style=color:#a6e22e>getProperty</span>());
</span></span><span style=display:flex><span>        WritableDataSource<span style=color:#f92672>&lt;</span>List<span style=color:#f92672>&lt;</span>SystemRule<span style=color:#f92672>&gt;&gt;</span> systemRuleWds
</span></span><span style=display:flex><span>                <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> FileWritableDataSource<span style=color:#f92672>&lt;&gt;</span>(systemRulePath, <span style=color:#66d9ef>this</span>::encodeJson);
</span></span><span style=display:flex><span>        WritableDataSourceRegistry.<span style=color:#a6e22e>registerSystemDataSource</span>(systemRuleWds);
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 授权降级规则</span>
</span></span><span style=display:flex><span>        ReadableDataSource<span style=color:#f92672>&lt;</span>String, List<span style=color:#f92672>&lt;</span>AuthorityRule<span style=color:#f92672>&gt;&gt;</span> authorityRuleRds
</span></span><span style=display:flex><span>                <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> FileRefreshableDataSource<span style=color:#f92672>&lt;&gt;</span>(authorityRulePath, authorityRuleListParser);
</span></span><span style=display:flex><span>        AuthorityRuleManager.<span style=color:#a6e22e>register2Property</span>(authorityRuleRds.<span style=color:#a6e22e>getProperty</span>());
</span></span><span style=display:flex><span>        WritableDataSource<span style=color:#f92672>&lt;</span>List<span style=color:#f92672>&lt;</span>AuthorityRule<span style=color:#f92672>&gt;&gt;</span> authorityRuleWds
</span></span><span style=display:flex><span>                <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> FileWritableDataSource<span style=color:#f92672>&lt;&gt;</span>(authorityRulePath, <span style=color:#66d9ef>this</span>::encodeJson);
</span></span><span style=display:flex><span>        WritableDataSourceRegistry.<span style=color:#a6e22e>registerAuthorityDataSource</span>(authorityRuleWds);
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 热点降级规则</span>
</span></span><span style=display:flex><span>        ReadableDataSource<span style=color:#f92672>&lt;</span>String, List<span style=color:#f92672>&lt;</span>ParamFlowRule<span style=color:#f92672>&gt;&gt;</span> paramFlowRuleRds
</span></span><span style=display:flex><span>                <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> FileRefreshableDataSource<span style=color:#f92672>&lt;&gt;</span>(paramFlowRulePath, paramFlowRuleListParser);
</span></span><span style=display:flex><span>        ParamFlowRuleManager.<span style=color:#a6e22e>register2Property</span>(paramFlowRuleRds.<span style=color:#a6e22e>getProperty</span>());
</span></span><span style=display:flex><span>        WritableDataSource<span style=color:#f92672>&lt;</span>List<span style=color:#f92672>&lt;</span>ParamFlowRule<span style=color:#f92672>&gt;&gt;</span> paramFlowRuleWds
</span></span><span style=display:flex><span>                <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> FileWritableDataSource<span style=color:#f92672>&lt;&gt;</span>(paramFlowRulePath, <span style=color:#66d9ef>this</span>::encodeJson);
</span></span><span style=display:flex><span>        ModifyParamFlowRulesCommandHandler.<span style=color:#a6e22e>setWritableDataSource</span>(paramFlowRuleWds);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Converter<span style=color:#f92672>&lt;</span>String, List<span style=color:#f92672>&lt;</span>FlowRule<span style=color:#f92672>&gt;&gt;</span> flowRuleListParser <span style=color:#f92672>=</span> source <span style=color:#f92672>-&gt;</span> JSON.<span style=color:#a6e22e>parseObject</span>(source,
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>new</span> TypeReference<span style=color:#f92672>&lt;</span>List<span style=color:#f92672>&lt;</span>FlowRule<span style=color:#f92672>&gt;&gt;</span>() {
</span></span><span style=display:flex><span>            });
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Converter<span style=color:#f92672>&lt;</span>String, List<span style=color:#f92672>&lt;</span>DegradeRule<span style=color:#f92672>&gt;&gt;</span> degradeRuleListParser <span style=color:#f92672>=</span> source <span style=color:#f92672>-&gt;</span>
</span></span><span style=display:flex><span>            JSON.<span style=color:#a6e22e>parseObject</span>(source, <span style=color:#66d9ef>new</span> TypeReference<span style=color:#f92672>&lt;</span>List<span style=color:#f92672>&lt;</span>DegradeRule<span style=color:#f92672>&gt;&gt;</span>() {
</span></span><span style=display:flex><span>            });
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Converter<span style=color:#f92672>&lt;</span>String, List<span style=color:#f92672>&lt;</span>SystemRule<span style=color:#f92672>&gt;&gt;</span> systemRuleListParser <span style=color:#f92672>=</span> source <span style=color:#f92672>-&gt;</span>
</span></span><span style=display:flex><span>            JSON.<span style=color:#a6e22e>parseObject</span>(source, <span style=color:#66d9ef>new</span> TypeReference<span style=color:#f92672>&lt;</span>List<span style=color:#f92672>&lt;</span>SystemRule<span style=color:#f92672>&gt;&gt;</span>() {
</span></span><span style=display:flex><span>            });
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Converter<span style=color:#f92672>&lt;</span>String, List<span style=color:#f92672>&lt;</span>AuthorityRule<span style=color:#f92672>&gt;&gt;</span> authorityRuleListParser <span style=color:#f92672>=</span> source <span style=color:#f92672>-&gt;</span>
</span></span><span style=display:flex><span>            JSON.<span style=color:#a6e22e>parseObject</span>(source, <span style=color:#66d9ef>new</span> TypeReference<span style=color:#f92672>&lt;</span>List<span style=color:#f92672>&lt;</span>AuthorityRule<span style=color:#f92672>&gt;&gt;</span>() {
</span></span><span style=display:flex><span>            });
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Converter<span style=color:#f92672>&lt;</span>String, List<span style=color:#f92672>&lt;</span>ParamFlowRule<span style=color:#f92672>&gt;&gt;</span> paramFlowRuleListParser <span style=color:#f92672>=</span> source <span style=color:#f92672>-&gt;</span>
</span></span><span style=display:flex><span>            JSON.<span style=color:#a6e22e>parseObject</span>(source, <span style=color:#66d9ef>new</span> TypeReference<span style=color:#f92672>&lt;</span>List<span style=color:#f92672>&lt;</span>ParamFlowRule<span style=color:#f92672>&gt;&gt;</span>() {
</span></span><span style=display:flex><span>            });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>mkdirIfNotExits</span>(String filePath) {
</span></span><span style=display:flex><span>        File file <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> File(filePath);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>file.<span style=color:#a6e22e>exists</span>()) {
</span></span><span style=display:flex><span>            file.<span style=color:#a6e22e>mkdirs</span>();
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@SneakyThrows</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>createFileIfNotExits</span>(String filePath) {
</span></span><span style=display:flex><span>        File file <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> File(filePath);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>file.<span style=color:#a6e22e>exists</span>()) {
</span></span><span style=display:flex><span>            file.<span style=color:#a6e22e>createNewFile</span>();
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> String <span style=color:#a6e22e>encodeJson</span>(T t) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> JSON.<span style=color:#a6e22e>toJSONString</span>(t);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=2-开发initfunc>2. 开发InitFunc</h3><ol><li>在resources下开发 <code>META-INF/services</code> 目录（固定）:</li><li>在目录中开发 <code>com.alibaba.csp.sentinel.init.InitFunc</code> 文件（固定）。</li><li>在文件中拷贝持久化配置类的类全名 <code>com.lsx.config.FilePersistenceConfig</code>。</li></ol><h1 id=s03-sentinel流控降级>S03. Sentinel流控降级</h1><blockquote><p>心法: Sentinel流控降级</p></blockquote><ul><li>流控降级是因为资源外部原因而触发的，比如限制请求数量，请求线程数量等。</li><li>当前Sentinel版本不支持链路流控模式:<ul><li>链路模式：当从某个接口过来的资源达到限流条件时，开启限流。</li></ul></li></ul><h2 id=e01-qps-直接-快速失败>E01. QPS-直接-快速失败</h2><blockquote><p>心法: QPS-直接-快速失败组合</p></blockquote><table><thead><tr><th>设置项</th><th>值</th><th>描述</th></tr></thead><tbody><tr><td>流控类型</td><td><code>QPS</code></td><td>当每秒请求数超过此值时触发限流，比较常用。</td></tr><tr><td>流控模式</td><td><code>直接</code></td><td>对自己设置流控规则，触发规则则自己被限流，默认值。</td></tr><tr><td>流控效果</td><td><code>快速失败</code></td><td>直接失败，抛出异常，简单粗暴，默认值。</td></tr></tbody></table><blockquote><p>武技: 测试 QPS类型 + 直接模式 + 快速失败的流控规则</p></blockquote><h3 id=1-开发控制方法>1. 开发控制方法</h3><p><code>com.lsx.controller.FlowController -> qpsDirectFail()</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RestController</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RequestMapping</span>(<span style=color:#e6db74>&#34;/api/v1/flow&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>FlowController</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/** 当资源 `qpsDirectFail` 降级时，执行SentinelFallback类的fallback()方法 */</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@SentinelResource</span>(value <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;qpsDirectFail&#34;</span>,
</span></span><span style=display:flex><span>            fallbackClass <span style=color:#f92672>=</span> SentinelFallback.<span style=color:#a6e22e>class</span>,
</span></span><span style=display:flex><span>            fallback <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;fallback&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@GetMapping</span>(<span style=color:#e6db74>&#34;/qpsDirectFail&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>qpsDirectFail</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;资源qpsDirectFail调用成功&#34;</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=2-添加流控规则>2. 添加流控规则</h3><ul><li>在Sentinel管控台对资源 <code>qpsDirectFail</code> 新增流控规则:</li></ul><table><thead><tr><th>配置项</th><th>描述</th><th>示例</th></tr></thead><tbody><tr><td>资源名</td><td>对应 <code>@SentinelResource</code> 中的 <code>value</code> 值</td><td><code>qpsDirectFail</code></td></tr><tr><td>针对来源</td><td>针对哪个或哪些微服务进行限制，<code>default</code> 表示针对所有微服务</td><td><code>sentinel-order</code></td></tr><tr><td>阈值类型</td><td>根据什么来决定是否对资源进行降级</td><td><code>QPS</code></td></tr><tr><td>单机阈值</td><td>当QPS超过多少时将资源进行降级</td><td><code>4</code></td></tr><tr><td>流控模式</td><td>针对哪个资源进行判断，<code>直接</code> 表示仅针对当前资源</td><td><code>直接</code></td></tr><tr><td>流控效果</td><td>当资源降级后，执行什么效果，<code>快速失败</code> 表示立刻返回Fallback数据</td><td><code>快速失败</code></td></tr></tbody></table><h3 id=3-压测资源方法>3. 压测资源方法</h3><blockquote><p>武技：使用Jmeter压测 <code>localhost:8070/api/v1/flow/qpsDirectFail</code> 请求</p></blockquote><ol><li>配置100个线程在20s内全部启动（每秒启动5个线程），每个线程各发1次请求：<ol><li>根据 <code>100/20 = 5</code> 得出：1秒内最多同时有5个线程请求资源，即QPS峰值为5。</li></ol></li><li>观察Sentinel实时监控：<ol><li>大部分请求的通过的QPS为4，拒绝QPS为1。</li><li>大部分请求每隔4次通过就会被拒绝一次，并爆发 <code>FlowException</code> 异常。</li></ol></li><li>如果实时监控不显示内容，则可能是Windows主机时间和虚拟机时间不同步。</li></ol><h2 id=e02-qps-直接-缓慢失败>E02. QPS-直接-缓慢失败</h2><blockquote><p>心法: QPS-直接-缓慢失败组合</p></blockquote><table><thead><tr><th>设置项</th><th>值</th><th>描述</th></tr></thead><tbody><tr><td>流控类型</td><td><code>QPS</code></td><td>当每秒请求数超过此值时触发限流，比较常用。</td></tr><tr><td>流控模式</td><td><code>直接</code></td><td>对自己设置流控规则，触发规则则自己被限流，默认值。</td></tr><tr><td>流控效果</td><td><code>Warm Up</code></td><td>起始阈值为指定阈值的1/3然后在指定的预热时间内缓慢增长到指定阈值该效果用于缓冲突发流量，避免服务器瞬间被冲垮</td></tr></tbody></table><blockquote><p>武技: 测试 QPS类型 + 直接模式 + 缓慢失败的流控规则</p></blockquote><h3 id=1-开发控制方法-1>1. 开发控制方法</h3><p><code>com.lsx.controller.FlowController -> qpsDirectWarmUp()</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RestController</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RequestMapping</span>(<span style=color:#e6db74>&#34;/api/v1/flow&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>FlowController</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/** 当资源 `qpsDirectWarmUp` 降级时，执行SentinelFallback类的fallback()方法 */</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@SentinelResource</span>(value <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;qpsDirectWarmUp&#34;</span>,
</span></span><span style=display:flex><span>            fallbackClass <span style=color:#f92672>=</span> SentinelFallback.<span style=color:#a6e22e>class</span>,
</span></span><span style=display:flex><span>            fallback <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;fallback&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@GetMapping</span>(<span style=color:#e6db74>&#34;/qpsDirectWarmUp&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>qpsDirectWarmUp</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;资源qpsDirectWarmUp调用成功&#34;</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=2-添加流控规则-1>2. 添加流控规则</h3><ul><li>在Sentinel管控台对资源 <code>qpsDirectWarmUp</code> 新增流控规则:</li></ul><table><thead><tr><th>配置项</th><th>描述</th><th>示例</th></tr></thead><tbody><tr><td>资源名</td><td>对应 <code>@SentinelResource</code> 中的 <code>value</code> 值</td><td><code>qpsDirectWarmUp</code></td></tr><tr><td>针对来源</td><td>针对哪个或哪些微服务进行限制，<code>default</code> 表示针对所有微服务</td><td><code>sentinel-order</code></td></tr><tr><td>阈值类型</td><td>根据什么来决定是否对资源进行降级</td><td><code>QPS</code></td></tr><tr><td>单机阈值</td><td>当QPS超过多少时将资源进行降级</td><td><code>5</code></td></tr><tr><td>流控模式</td><td>针对哪个资源进行判断，<code>直接</code> 表示仅针对当前资源</td><td><code>直接</code></td></tr><tr><td>流控效果</td><td>当资源降级后，执行什么效果<code>WarmUp</code> 表示使用热启动模式返回FallBack数据</td><td><code>WarmUp</code></td></tr><tr><td>预热时常</td><td>5秒内，单机阈值从 <code>5*1/3</code> 开始，慢慢增长到 <code>5</code>仅WarmUp效果下可设置</td><td><code>5</code></td></tr></tbody></table><h3 id=3-压测资源方法-1>3. 压测资源方法</h3><blockquote><p>武技：使用Jmeter压测 <code>localhost:8070/api/v1/flow/qpsDirectWarmUp</code> 请求</p></blockquote><ol><li>配置100个线程在20s内全部启动（每秒启动5个线程），每个线程各发1次请求：<ol><li>根据 <code>100/20 = 5</code> 得出：1秒内最多同时有5个线程请求资源，即QPS峰值为5。</li></ol></li><li>观察Sentinel实时监控:<ol><li>随预热过程，QPS阈值从1逐渐开放到5，拒绝的请求逐渐变少。</li><li>越来越少的请求爆发 <code>FlowException</code> 异常。</li></ol></li><li>如果实时监控不显示内容，则可能是Windows主机时间和虚拟机时间不同步。</li></ol><h2 id=e03-qps-直接-匀速排队>E03. QPS-直接-匀速排队</h2><blockquote><p>心法: QPS-直接-匀速排队组合</p></blockquote><table><thead><tr><th>设置项</th><th>值</th><th>描述</th></tr></thead><tbody><tr><td>流控类型</td><td><code>QPS</code></td><td>当每秒请求数超过此值时触发限流，比较常用。</td></tr><tr><td>流控模式</td><td><code>直接</code></td><td>对自己设置流控规则，触发规则则自己被限流，默认值。</td></tr><tr><td>流控效果</td><td><code>排队等待</code></td><td>让全部请求进入一个队列中，按照阈值允许的时间间隔匀速通过。后面的请求必须等前面的请求执行完毕后才能执行，此为排队效果。若后面的请求等待时间超出指定时间，则会被拒绝，返回FallBack数据。</td></tr></tbody></table><h3 id=1-开发控制方法-2>1. 开发控制方法</h3><blockquote><p>武技：测试 QPS类型 + 直接模式 + 匀速排队的流控规则</p></blockquote><p><code>com.lsx.controller.FlowController -> qpsDirectLineUp()</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RestController</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RequestMapping</span>(<span style=color:#e6db74>&#34;/api/v1/flow&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>FlowController</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/** 当资源 `qpsDirectLineUp` 降级时，执行SentinelFallback类的fallback()方法 */</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@SentinelResource</span>(value <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;qpsDirectLineUp&#34;</span>,
</span></span><span style=display:flex><span>            fallbackClass <span style=color:#f92672>=</span> SentinelFallback.<span style=color:#a6e22e>class</span>,
</span></span><span style=display:flex><span>            fallback <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;fallback&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@GetMapping</span>(<span style=color:#e6db74>&#34;/qpsDirectLineUp&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>qpsDirectLineUp</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;资源qpsDirectLineUp调用成功&#34;</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=2-添加流控规则-2>2. 添加流控规则</h3><ul><li>在Sentinel管控台对资源 <code>qpsDirectLineUp</code> 新增流控规则:</li></ul><table><thead><tr><th>配置项</th><th>描述</th><th>示例</th></tr></thead><tbody><tr><td>资源名</td><td>对应 <code>@SentinelResource</code> 中的 <code>value</code> 值</td><td><code>qpsDirectLineUp</code></td></tr><tr><td>针对来源</td><td>针对哪个或哪些微服务进行限制，<code>default</code> 表示针对所有微服务</td><td><code>sentinel-order</code></td></tr><tr><td>阈值类型</td><td>根据什么来决定是否对资源进行降级</td><td><code>QPS</code></td></tr><tr><td>单机阈值</td><td>当QPS超过多少时将资源进行降级</td><td><code>4</code></td></tr><tr><td>流控模式</td><td>针对哪个资源进行判断，<code>直接</code> 表示仅针对当前资源</td><td><code>直接</code></td></tr><tr><td>流控效果</td><td>当资源降级后，执行什么效果<code>排队等待</code> 表示请求排队通过，若等待超时则返回FallBack数据</td><td><code>排队等待</code></td></tr><tr><td>超时时间</td><td>等待超时时间，单位毫秒，仅排队效果下可设置</td><td><code>5000</code></td></tr></tbody></table><h3 id=3-压测资源方法-2>3. 压测资源方法</h3><blockquote><p>武技：使用Jmeter压测 <code>localhost:8070/api/v1/flow/qpsDirectLineUp</code> 请求</p></blockquote><ol><li>配置100个线程在20s内全部启动（每秒启动5个线程），每个线程各发1次请求：<ol><li>根据 <code>100/20 = 5</code> 得出：1秒内最多同时有5个线程请求资源，即QPS峰值为5。</li></ol></li><li>观察Sentinel实时监控:<ol><li>大部分请求的通过QPS保持在4，说明溢出的QPS请求进入了等待队列中进行排队。</li><li>可能会有一小部分请求因等待超时而被拒绝，爆发 <code>FlowException</code> 异常。</li></ol></li><li>如果实时监控不显示内容，则可能是Windows主机时间和虚拟机时间不同步。</li></ol><h2 id=e04-qps-关联-快速失败>E04. QPS-关联-快速失败</h2><blockquote><p>心法: QPS-关联-快速失败组合</p></blockquote><table><thead><tr><th>设置项</th><th>值</th><th>描述</th></tr></thead><tbody><tr><td>流控类型</td><td><code>QPS</code></td><td>当每秒请求数超过此值时触发限流，比较常用。</td></tr><tr><td>流控模式</td><td><code>关联</code></td><td>当关联的资源触发规则时，将自己限流，即自己优先级比关联资源高。</td></tr><tr><td>流控效果</td><td><code>快速失败</code></td><td>直接失败，抛出异常，简单粗暴，默认值。</td></tr></tbody></table><h3 id=1-开发控制方法-3>1. 开发控制方法</h3><blockquote><p>武技: 测试 QPS类型 + 关联模式 + 快速失败的流控规则</p></blockquote><p><code>com.lsx.controller.FlowController -> qpsRelation01()/qpsRelation02()</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RestController</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RequestMapping</span>(<span style=color:#e6db74>&#34;/api/v1/flow&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>FlowController</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/** 当资源 `qpsRelation01` 降级时，执行SentinelFallback类的fallback()方法 */</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@SentinelResource</span>(value <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;qpsRelation01&#34;</span>,
</span></span><span style=display:flex><span>            fallbackClass <span style=color:#f92672>=</span> SentinelFallback.<span style=color:#a6e22e>class</span>,
</span></span><span style=display:flex><span>            fallback <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;fallback&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@GetMapping</span>(<span style=color:#e6db74>&#34;/qpsRelation01&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>qpsRelation01</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;资源qpsRelation01调用成功&#34;</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/** 当资源 `qpsRelation02` 降级时，执行SentinelFallback类的fallback()方法 */</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@SentinelResource</span>(value <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;qpsRelation02&#34;</span>,
</span></span><span style=display:flex><span>            fallbackClass <span style=color:#f92672>=</span> SentinelFallback.<span style=color:#a6e22e>class</span>,
</span></span><span style=display:flex><span>            fallback <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;fallback&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@RequestMapping</span>(<span style=color:#e6db74>&#34;/qpsRelation02&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>qpsRelation02</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;资源qpsRelation02调用成功&#34;</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=2-添加流控规则-3>2. 添加流控规则</h3><ul><li>在Sentinel管控台对资源 <code>qpsRelation01</code> 新增流控规则:</li></ul><table><thead><tr><th>配置项</th><th>描述</th><th>示例</th></tr></thead><tbody><tr><td>资源名</td><td>对应 <code>@SentinelResource</code> 中的 <code>value</code> 值</td><td><code>qpsRelation01</code></td></tr><tr><td>针对来源</td><td>针对哪个或哪些微服务进行限制，<code>default</code> 表示针对所有微服务</td><td><code>sentinel-order</code></td></tr><tr><td>阈值类型</td><td>根据什么来决定是否对资源进行降级</td><td><code>QPS</code></td></tr><tr><td>单机阈值</td><td>当QPS超过多少时将资源进行降级</td><td><code>1</code></td></tr><tr><td>流控模式</td><td>针对哪个资源进行判断<code>关联</code> 表示需要同时针对当前资源以及其关联的资源一起判断</td><td><code>关联</code></td></tr><tr><td>关联资源</td><td>当前资源所关联的资源名称，仅关联模式下可设置</td><td><code>qpsRelation02</code></td></tr><tr><td>流控效果</td><td>当资源降级后，执行什么效果，<code>快速失败</code> 表示立刻返回Fallback数据</td><td><code>快速失败</code></td></tr></tbody></table><h3 id=3-压测资源方法-3>3. 压测资源方法</h3><blockquote><p>武技：使用Jmeter压测 <code>localhost:8070/api/v1/flow/qpsRelation02</code> 请求</p></blockquote><ol><li>配置1个线程在1s内启动，发送无限次请求。</li><li>因为没有对资源 <code>qpsRelation02</code> 设置QPS限制，所以该资源不会被降级处理，一直访问成功。</li><li>但是 <code>qpsRelation01</code> 被设置了QPS规则，且两个资源共享QPS规则。</li><li>所以此时使用浏览器访问 <code>qpsRelation01</code> 资源的请求，会发现访问失败。</li><li>资源 <code>qpsRelation01</code> 被降级处理，爆发 <code>FlowException</code> 异常。</li></ol><h2 id=e05-线程-直接-快速失败>E05. 线程-直接-快速失败</h2><blockquote><p>心法: 线程-直接-快速失败组合</p></blockquote><table><thead><tr><th>设置项</th><th>值</th><th>描述</th></tr></thead><tbody><tr><td>流控类型</td><td><code>线程数</code></td><td>并发线程数超过此值时触发限流。</td></tr><tr><td>流控模式</td><td><code>直接</code></td><td>对自己设置流控规则，触发规则则自己被限流，默认值。</td></tr><tr><td>流控效果</td><td><code>快速失败</code></td><td>直接失败，抛出异常，简单粗暴，默认值。</td></tr></tbody></table><blockquote><p>武技: 测试线程数类型 + 直接模式 + 快速失败的流控规则</p></blockquote><h3 id=1-开发控制方法-4>1. 开发控制方法</h3><p><code>com.lsx.controller.FlowController -> threadDirect()</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RestController</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RequestMapping</span>(<span style=color:#e6db74>&#34;/api/v1/flow&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>FlowController</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/** 当资源 `threadDirect` 降级时，执行SentinelFallback类的fallback()方法 */</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@SentinelResource</span>(value <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;threadDirect&#34;</span>,
</span></span><span style=display:flex><span>            fallbackClass <span style=color:#f92672>=</span> SentinelFallback.<span style=color:#a6e22e>class</span>,
</span></span><span style=display:flex><span>            fallback <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;fallback&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@RequestMapping</span>(<span style=color:#e6db74>&#34;/threadDirect&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>threadDirect</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;资源threadDirect用成功&#34;</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=2-添加流控规则-4>2. 添加流控规则</h3><ul><li>在Sentinel管控台对资源 <code>threadDirect</code> 新增流控规则:</li></ul><table><thead><tr><th>配置项</th><th>描述</th><th>示例</th></tr></thead><tbody><tr><td>资源名</td><td>对应 <code>@SentinelResource</code> 中的 <code>value</code> 值</td><td><code>threadDirect</code></td></tr><tr><td>针对来源</td><td>针对哪个或哪些微服务进行限制，<code>default</code> 表示针对所有微服务</td><td><code>sentinel-order</code></td></tr><tr><td>阈值类型</td><td>根据什么来决定是否对资源进行降级</td><td><code>线程</code></td></tr><tr><td>单机阈值</td><td>当访问该资源的线程并发数超过多少时将资源进行降级</td><td><code>2</code></td></tr><tr><td>流控模式</td><td>针对哪个资源进行判断，<code>直接</code> 表示仅针对当前资源</td><td><code>直接</code></td></tr><tr><td>流控效果</td><td>当资源降级后，执行什么效果，<code>快速失败</code> 表示立刻返回Fallback数据阈值类型为线程时，只能默认使用 <code>快速失败</code> 流控效果</td><td><code>快速失败</code></td></tr></tbody></table><h3 id=3-压测资源方法-4>3. 压测资源方法</h3><blockquote><p>武技：使用Jmeter压测 <code>localhost:8070/api/v1/flow/threadDirect</code> 请求</p></blockquote><ol><li>配置3个线程在1s内全部启动，无限发送请求。</li><li>发现该资源因线程并发数过高而被降级，IDEA控制台爆发 <code>FlowException</code> 异常。</li></ol><h1 id=s04-sentinel熔断降级>S04. Sentinel熔断降级</h1><blockquote><p>心法: Sentinel熔断降级</p></blockquote><ul><li>熔断降级是因为资源内部原因而触发的，比如资源运行太耗时，运行有异常等。</li></ul><h2 id=e01-响应时间过长>E01. 响应时间过长</h2><blockquote><p>心法: 响应时间过长-熔断</p></blockquote><ul><li>选择以慢调用比例作为阈值，需要设置 <code>最大RT</code> ，即最大的响应时间，请求的响应时间大于该值则统计为慢调用。</li><li>当请求数目大于设置的 <code>最小请求数</code>，并且慢调用的比例大于 <code>阈值</code> 时，接下来的 <code>熔断时长</code> 内请求会自动被熔断:<ul><li>阈值范围是0到1之间的浮点数，包括两端值。</li><li>在 <code>熔断时长</code> 内，任何访问该资源的请求都立刻得到FallBack数据，超时后方可尝试恢复访问。</li></ul></li><li>经过 <code>熔断时长</code> 后熔断器会进入HALF-OPEN探测恢复状态:<ul><li>若接下来的一个请求响应时间小于设置的 <code>最大RT</code> 则结束熔断。</li><li>若接下来的一个请求响应时间大于设置的 <code>最大RT</code> 则会再次被熔断。</li></ul></li><li>允许设置的 <code>最大RT</code> 上限为4900ms，超出都视为4900ms:<ul><li>启动时添加 <code>-Dcsp.sentinel.statistic.max.rt=</code> 配置可以突破上限。</li></ul></li></ul><blockquote><p>武技: 测试RT熔断降级规则</p></blockquote><h3 id=1-开发控制方法-5>1. 开发控制方法</h3><p><code>com.lsx.controller.DegradeController -> rt()</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RestController</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RequestMapping</span>(<span style=color:#e6db74>&#34;/api/v1/degrade&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>DegradeController</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/** 当资源 `rt` 降级时，执行SentinelFallback类的fallback()方法 */</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@SentinelResource</span>(value <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;rt&#34;</span>,
</span></span><span style=display:flex><span>            fallbackClass <span style=color:#f92672>=</span> SentinelFallback.<span style=color:#a6e22e>class</span>,
</span></span><span style=display:flex><span>            fallback <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;fallback&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@RequestMapping</span>(<span style=color:#e6db74>&#34;/rt&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@SneakyThrows</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>rt</span>() {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 睡眠1s以模拟业务耗时</span>
</span></span><span style=display:flex><span>        TimeUnit.<span style=color:#a6e22e>SECONDS</span>.<span style=color:#a6e22e>sleep</span>(1L);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;资源rt调用成功&#34;</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=2-添加降级规则>2. 添加降级规则</h3><ul><li>在Sentinel管控台对资源 <code>rt</code> 新增降级规则:</li></ul><table><thead><tr><th>配置项</th><th>描述</th><th>示例</th></tr></thead><tbody><tr><td>资源名</td><td>对应 <code>@SentinelResource</code> 中的 <code>value</code> 值</td><td><code>rt</code></td></tr><tr><td>熔断策略</td><td>根据什么来决定是否对资源进行降级</td><td><code>慢调用比例</code></td></tr><tr><td>最大RT</td><td>当一次调用超过了多少毫秒就被视为是一次慢调用</td><td><code>500</code></td></tr><tr><td>比例阈值</td><td>当慢调用比例超过百分之多少时对资源进行降级，值为0~1的小数</td><td><code>1</code></td></tr><tr><td>熔断时长</td><td>资源被降级后的多少秒内，均返回FallBack数据，超时后恢复访问</td><td><code>2</code></td></tr><tr><td>最小请求数</td><td>当请求数量少于多少时，不进行降级</td><td><code>5</code></td></tr></tbody></table><h3 id=3-压测资源方法-5>3. 压测资源方法</h3><blockquote><p>武技：使用Jmeter压测 <code>localhost:8070/api/v1/degrade/rt</code> 请求</p></blockquote><ol><li>配置10个线程在1s内全部启动，每个线程各发10次请求。</li><li>发现资源方法因平均响应时间太慢而被降级，IDEA控制台爆发 <code>DegradeException</code> 异常。</li><li>2s后重新发送请求，发现资源方法已经恢复正常访问。</li></ol><h2 id=e02-异常比例过大>E02. 异常比例过大</h2><blockquote><p>心法: 异常比例过大-熔断</p></blockquote><ul><li>当请求数大于设置的 <code>最小请求数</code>，并且异常的比例大于 <code>阈值</code>，则接下来的熔断时长内请求会自动被熔断:<ul><li>阈值范围是0到1之间的浮点数，包括两端值。</li></ul></li><li>经过 <code>熔断时长</code> 后熔断器会进入HALF-OPEN探测恢复状态:<ul><li>若接下来的一个请求成功完成且没有错误，则结束熔断。</li><li>若接下来的一个请求仍然爆发异常，否则会再次被熔断。</li></ul></li></ul><h3 id=1-开发控制方法-6>1. 开发控制方法</h3><blockquote><p>武技: 测试异常比例熔断降级规则</p></blockquote><p><code>com.lsx.controller.DegradeController -> exRatio()</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RestController</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RequestMapping</span>(<span style=color:#e6db74>&#34;/api/v1/degrade&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>DegradeController</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>int</span> exRatioNum <span style=color:#f92672>=</span> 0;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/** 当资源 `exRatio` 降级时，执行SentinelFallback类的fallback()方法 */</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@SentinelResource</span>(value <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;exRatio&#34;</span>,
</span></span><span style=display:flex><span>            fallbackClass <span style=color:#f92672>=</span> SentinelFallback.<span style=color:#a6e22e>class</span>,
</span></span><span style=display:flex><span>            fallback <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;fallback&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@RequestMapping</span>(<span style=color:#e6db74>&#34;/exRatio&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Result <span style=color:#a6e22e>exRatio</span>() {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 配合计数器属性，每访问到第3次就抛出一个异常，以模拟0.33的异常率</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#f92672>++</span>exRatioNum <span style=color:#f92672>%</span> 3 <span style=color:#f92672>==</span> 0) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RuntimeException(<span style=color:#e6db74>&#34;资源exRatio人为异常&#34;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> Result.<span style=color:#a6e22e>success</span>(<span style=color:#e6db74>&#34;资源exRatio调用成功&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=2-添加降级规则-1>2. 添加降级规则</h3><ul><li>在Sentinel管控台对资源 <code>exRatio</code> 新增降级规则:</li></ul><table><thead><tr><th>配置项</th><th>描述</th><th>示例</th></tr></thead><tbody><tr><td>资源名</td><td>对应 <code>@SentinelResource</code> 中的 <code>value</code> 值</td><td><code>exRatio</code></td></tr><tr><td>熔断策略</td><td>根据什么来决定是否对资源进行降级</td><td><code>异常比例</code></td></tr><tr><td>比例阈值</td><td>当异常比例超过百分之多少时对资源进行降级，值为0~1的小数</td><td><code>0.3</code></td></tr><tr><td>熔断时长</td><td>资源被降级后的多少秒内，均返回FallBack数据，超时后恢复访问</td><td><code>2</code></td></tr><tr><td>最小请求数</td><td>当请求数量少于多少时，不进行降级</td><td><code>5</code></td></tr></tbody></table><h3 id=3-压测资源方法-6>3. 压测资源方法</h3><blockquote><p>武技：使用Jmeter压测 <code>localhost:8070/api/v1/degrade/exRatio</code> 请求</p></blockquote><ol><li>配置10个线程在1s内全部启动，每个线程各发10次请求。</li><li>发现资源方法因异常率太高而被降级，IDEA控制台爆发 <code>DegradeException</code> 异常。</li><li>2s后重新发送请求，发现资源方法已经恢复正常访问。</li></ol><h2 id=e03-异常数量过多>E03. 异常数量过多</h2><blockquote><p>心法: 异常数量过多-熔断</p></blockquote><ul><li>当异常数目超过 <code>阈值</code> 之后会自动进行熔断。</li><li>经过 <code>熔断时长</code> 后熔断器会进入HALF-OPEN探测恢复状态:<ul><li>若接下来的一个请求成功完成且没有错误，则结束熔断。</li><li>若接下来的一个请求仍然爆发异常，否则会再次被熔断。</li></ul></li></ul><h3 id=1-开发控制方法-7>1. 开发控制方法</h3><blockquote><p>武技: 测试异常数量熔断降级规则</p></blockquote><p><code>com.lsx.controller.DegradeController -> exCount()</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RestController</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RequestMapping</span>(<span style=color:#e6db74>&#34;/api/v1/degrade&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>DegradeController</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>int</span> exCountNum <span style=color:#f92672>=</span> 0;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/** 当资源 `ex-count` 降级时，执行SentinelFallback类的fallback()方法 */</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@SentinelResource</span>(value <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;exCount&#34;</span>,
</span></span><span style=display:flex><span>            fallbackClass <span style=color:#f92672>=</span> SentinelFallback.<span style=color:#a6e22e>class</span>,
</span></span><span style=display:flex><span>            fallback <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;fallback&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@RequestMapping</span>(<span style=color:#e6db74>&#34;/exCount&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>exCount</span>() {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 配合计数器属性，每访问到第3次就抛出一个异常</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#f92672>++</span>exCountNum <span style=color:#f92672>%</span> 3 <span style=color:#f92672>==</span> 0) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RuntimeException(<span style=color:#e6db74>&#34;资源exCount人为异常&#34;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;资源exCount调用成功&#34;</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=2-添加降级规则-2>2. 添加降级规则</h3><ul><li>在Sentinel管控台对资源 <code>exCount</code> 新增降级规则:</li></ul><table><thead><tr><th>配置项</th><th>描述</th><th>示例</th></tr></thead><tbody><tr><td>资源名</td><td>对应 <code>@SentinelResource</code> 中的 <code>value</code> 值</td><td><code>exCount</code></td></tr><tr><td>熔断策略</td><td>根据什么来决定是否对资源进行降级</td><td><code>异常数</code></td></tr><tr><td>异常数</td><td>当异常数超过多少时对资源进行降级</td><td><code>3</code></td></tr><tr><td>熔断时长</td><td>资源被降级后的多少秒内，均返回FallBack数据，超时后恢复访问</td><td><code>2</code></td></tr><tr><td>最小请求数</td><td>当请求数量少于多少时，不进行降级</td><td><code>5</code></td></tr></tbody></table><h3 id=3-压测资源方法-7>3. 压测资源方法</h3><blockquote><p>武技：使用Jmeter压测 <code>localhost:8070/api/v1/degrade/exCount</code> 请求</p></blockquote><ol><li>配置10个线程在1s内全部启动，每个线程各发10次请求。</li><li>发现资源方法因异常数量太高而被降级，IDEA控制台爆发 <code>DegradeException</code> 异常。</li><li>70s后重新发送请求，发现资源方法已经恢复正常访问。</li></ol><h1 id=s05-sentinel热点降级>S05. Sentinel热点降级</h1><blockquote><p>心法: Sentinel热点降级</p></blockquote><ul><li>热点降级规则粒度更细，可以根据控制方法的形参对方法进行降级规则控制。</li></ul><h2 id=e01-开发降级方法>E01. 开发降级方法</h2><blockquote><p>武技: 开发热点降级方法</p></blockquote><ol><li>重载降级方法 <code>SentinelFallback -> fallback()</code></li></ol><p><code>com.lsx.fallback.SentineFallback -> fallback()</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SentinelFallback</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ..</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> String <span style=color:#a6e22e>fallback</span>(String name, Integer age, Throwable e) {
</span></span><span style=display:flex><span>        String exceptionMessage <span style=color:#f92672>=</span> e.<span style=color:#a6e22e>getMessage</span>();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (e <span style=color:#66d9ef>instanceof</span> ParamFlowException) {
</span></span><span style=display:flex><span>            exceptionMessage <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;热点异常: 访问受限&#34;</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> exceptionMessage;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=e02-热点降级规则>E02. 热点降级规则</h2><blockquote><p>武技: 测试热点降级规则</p></blockquote><h3 id=1-开发控制方法-8>1. 开发控制方法</h3><ol><li>开发控制方法 <code>SentinelController -> param()</code>:<ul><li>对方法参数分别标记 <code>@RequestParam(required = false)</code> 以便于不传值测试。</li></ul></li></ol><p><code>com.lsx.controller.ParamController -> param()</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RestController</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RequestMapping</span>(<span style=color:#e6db74>&#34;/api/v1/param&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ParamController</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/** 当资源 `param` 降级时，执行SentinelFallback类的有参fallback()方法 */</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@SentinelResource</span>(value <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;param&#34;</span>,
</span></span><span style=display:flex><span>            fallbackClass <span style=color:#f92672>=</span> SentinelFallback.<span style=color:#a6e22e>class</span>,
</span></span><span style=display:flex><span>            fallback <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;fallback&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@RequestMapping</span>(<span style=color:#e6db74>&#34;/param&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>param</span>(String name, Integer age) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;资源param调用成功：&#34;</span> <span style=color:#f92672>+</span> name <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; &#34;</span> <span style=color:#f92672>+</span> age;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=2-添加热点规则>2. 添加热点规则</h3><ul><li>在Sentinel管控台对资源 <code>param</code> 新增热点规则:</li></ul><table><thead><tr><th>配置项</th><th>描述</th><th>示例</th></tr></thead><tbody><tr><td>资源名</td><td>对应 <code>@SentinelResource</code> 中的 <code>value</code> 值</td><td><code>param</code></td></tr><tr><td>限流模式</td><td>只能选择QPS模式</td><td><code>QPS</code></td></tr><tr><td>单机阈值</td><td>当QPS超过多少时将资源进行降级</td><td><code>1</code></td></tr><tr><td>统计时间窗口</td><td>以多少秒内的统计结果为准</td><td><code>1</code></td></tr></tbody></table><h3 id=3-访问资源方法>3. 访问资源方法</h3><blockquote><p>武技：浏览器访问 <code>localhost:8070/api/v1/param/param</code>:</p></blockquote><ul><li>不携带参数，直接可以访问成功。</li><li>携带 <code>age=18</code> 参数: 请求中没携带0号参数 <code>name</code>，不降级。</li><li>携带 <code>name=admin</code> 参数: 请求中携带了0号参数 <code>name</code>，QPS超过阈值时降级。</li><li>携带 <code>name=admin&amp;age=18</code> 参数: 请求中携带了0号参数 <code>name</code>，QPS超过阈值时降级。</li></ul><h1 id=s06-sentinel授权降级>S06. Sentinel授权降级</h1><blockquote><p>心法: Sentinel授权降级</p></blockquote><ul><li>授权规则用于对调用来源设置黑白名单，需要调用方在请求参数，或请求头中额外传递一个授权标识变量:<ul><li>授权标识变量是需要自行约定的。</li><li>若调用方未传递授权标识变量，或传递授权标识变量为空字符串，均视为忽略授权规则影响。</li></ul></li><li>配置白名单时: 只有白名单内的来源可以访问我，其余都不行。</li><li>配置黑名单时: 黑名单内的来源都不可以访问我，其余都可以。</li></ul><h2 id=e01-开发授权配置类>E01. 开发授权配置类</h2><blockquote><p>心法: 授权配置类</p></blockquote><ul><li>授权降级配置类主要用于:<ul><li>拦截请求，以获取请求参数或请求头中的授权标识变量。</li><li>将授权标识变量交给Sentinel进行下一步处理。</li></ul></li><li>授权降级配置类不是拦截器类，不负责阻止请求。</li></ul><blockquote><p>武技: 开发授权降级配置类</p></blockquote><ol><li>开发授权降级配置类 <code>AuthConfig</code>：重写 <code>RequestOriginParser -> parseOrigin()</code> 方法。</li></ol><p><code>com.lsx.config.AuthConfig</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Component</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>AuthConfig</span> <span style=color:#66d9ef>implements</span> RequestOriginParser {
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> String AUTH_FLAG <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;auth-flag&#34;</span>;
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>parseOrigin</span>(HttpServletRequest httpServletRequest) {
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 从请求参数中尝试获取authFlag标识</span>
</span></span><span style=display:flex><span>        String authFlag <span style=color:#f92672>=</span> httpServletRequest.<span style=color:#a6e22e>getParameter</span>(AUTH_FLAG);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>null</span> <span style=color:#f92672>==</span> authFlag) {
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 从请求头中尝试获取authFlag标识</span>
</span></span><span style=display:flex><span>            authFlag <span style=color:#f92672>=</span> httpServletRequest.<span style=color:#a6e22e>getHeader</span>(AUTH_FLAG);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 返回authFlag标识</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> authFlag;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=e02-设置授权白名单>E02. 设置授权白名单</h2><blockquote><p>武技: 测试白名单授权规则</p></blockquote><h3 id=1-开发控制方法-9>1. 开发控制方法</h3><p><code>com.lsx.controller.AuthController -> whiteAuth()</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RestController</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RequestMapping</span>(<span style=color:#e6db74>&#34;/api/v1/auth&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>AuthController</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/** 当资源 `whiteAuth` 降级时，执行SentinelFallback类的fallback()方法 */</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@SentinelResource</span>(value <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;whiteAuth&#34;</span>,
</span></span><span style=display:flex><span>            fallbackClass <span style=color:#f92672>=</span> SentinelFallback.<span style=color:#a6e22e>class</span>,
</span></span><span style=display:flex><span>            fallback <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;fallback&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@RequestMapping</span>(<span style=color:#e6db74>&#34;/whiteAuth&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>whiteAuth</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;资源whiteAuth调用成功&#34;</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=2-添加授权规则>2. 添加授权规则</h3><ul><li>在Sentinel管控台对资源 <code>whiteAuth</code> 新增授权规则:</li></ul><table><thead><tr><th>配置项</th><th>描述</th><th>示例</th></tr></thead><tbody><tr><td>资源名</td><td>对应 <code>@SentinelResource</code> 中的 <code>value</code> 值</td><td><code>whiteAuth</code></td></tr><tr><td>流控应用</td><td>参数值列表</td><td><code>a,b</code></td></tr><tr><td>授权类型</td><td>白名单：只有携带了 <code>authFlag=a</code> 或 <code>authFlag=b</code> 参数的请求可以访问该资源</td><td><code>白名单</code></td></tr></tbody></table><h3 id=3-访问资源方法-1>3. 访问资源方法</h3><blockquote><p>武技：浏览器访问 <code>localhost:8070/api/v1/auth/whiteAuth</code>:</p></blockquote><ul><li>不携带参数，直接可以访问成功。</li><li>携带 <code>?auth-flag=a</code> 参数，访问成功。</li><li>携带 <code>?auth-flag=c</code> 参数，访问失败，降级并爆发 <code>AuthorityException</code> 异常。</li></ul><h2 id=e03-设置授权黑名单>E03. 设置授权黑名单</h2><blockquote><p>武技: 测试黑名单授权规则</p></blockquote><h3 id=1-开发控制方法-10>1. 开发控制方法</h3><p><code>com.lsx.controller.AuthController -> blackAuth()</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RestController</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RequestMapping</span>(<span style=color:#e6db74>&#34;/api/v1/auth&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>AuthController</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/** 当资源 `blackAuth` 降级时，执行SentinelFallback类的fallback()方法 */</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@SentinelResource</span>(value <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;blackAuth&#34;</span>,
</span></span><span style=display:flex><span>            fallbackClass <span style=color:#f92672>=</span> SentinelFallback.<span style=color:#a6e22e>class</span>,
</span></span><span style=display:flex><span>            fallback <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;fallback&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@RequestMapping</span>(<span style=color:#e6db74>&#34;/blackAuth&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>blackAuth</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;资源blackAuth调用成功&#34;</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=2-添加降级规则-3>2. 添加降级规则</h3><ul><li>在Sentinel管控台对资源 <code>blackAuth</code> 新增降级规则:</li></ul><table><thead><tr><th>配置项</th><th>描述</th><th>示例</th></tr></thead><tbody><tr><td>资源名</td><td>对应 <code>@SentinelResource</code> 中的 <code>value</code> 值</td><td><code>blackAuth</code></td></tr><tr><td>流控应用</td><td>参数值列表</td><td><code>a,b</code></td></tr><tr><td>授权类型</td><td>黑名单：只有携带了 <code>authFlag=a</code> 或 <code>authFlag=b</code> 参数的请求不可以访问该资源</td><td><code>黑名单</code></td></tr></tbody></table><h3 id=3-访问资源方法-2>3. 访问资源方法</h3><blockquote><p>武技：浏览器访问 <code>localhost:8070/api/v1/auth/blackAuth</code>:</p></blockquote><ul><li>不携带参数，直接可以访问成功。</li><li>携带 <code>?auth-flag=a</code> 参数，访问成功。</li><li>携带 <code>?auth-flag=c</code> 参数，访问失败，降级并爆发 <code>AuthorityException</code> 异常。</li></ul><h1 id=s07-sentinel远程容错>S07. Sentinel远程容错</h1><blockquote><p>心法: Sentinel远程容错</p></blockquote><ul><li>Sentinel无法直接对远程调用过程进行保护，需要额外和OpenFeign进行整合。</li><li>此时当下游服务调用失败时，就可以返回fallback兜底数据，而不是直接爆发500错误。</li></ul><h2 id=e01-开发商品服务>E01. 开发商品服务</h2><blockquote><p>武技: 创建 <code>v5-3-alibaba-sentinel</code> 子项目，以及 <code>sentinel-product</code> 子项目</p></blockquote><h3 id=1-添加三方依赖>1. 添加三方依赖</h3><ol><li>在父项目中锁定版本：</li></ol><p><code>pom.xml</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#f92672>&lt;spring-boot-version&gt;</span>2.3.12.RELEASE<span style=color:#f92672>&lt;/spring-boot-version&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;spring-cloud-version&gt;</span>Hoxton.SR12<span style=color:#f92672>&lt;/spring-cloud-version&gt;</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;spring-cloud-alibaba-version&gt;</span>2.2.9.RELEASE<span style=color:#f92672>&lt;/spring-cloud-alibaba-version&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;lombok-version&gt;</span>1.18.24<span style=color:#f92672>&lt;/lombok-version&gt;</span>
</span></span></code></pre></div><ol start=2><li>在父项目中管理依赖：</li></ol><p><code>pom.xml</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#75715e>&lt;!--lombok--&gt;</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>  
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;groupId&gt;</span>org.projectlombok<span style=color:#f92672>&lt;/groupId&gt;</span>  
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;artifactId&gt;</span>lombok<span style=color:#f92672>&lt;/artifactId&gt;</span>  
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;version&gt;</span>${lombok-version}<span style=color:#f92672>&lt;/version&gt;</span>  
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;scope&gt;</span>provided<span style=color:#f92672>&lt;/scope&gt;</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;!--spring-boot-starter-parent--&gt;</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>  
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;groupId&gt;</span>org.springframework.boot<span style=color:#f92672>&lt;/groupId&gt;</span>  
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;artifactId&gt;</span>spring-boot-starter-parent<span style=color:#f92672>&lt;/artifactId&gt;</span>  
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;version&gt;</span>${spring-boot-version}<span style=color:#f92672>&lt;/version&gt;</span>  
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;type&gt;</span>pom<span style=color:#f92672>&lt;/type&gt;</span>  
</span></span><span style=display:flex><span>	<span style=color:#f92672>&lt;scope&gt;</span>import<span style=color:#f92672>&lt;/scope&gt;</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;!--spring-cloud-dependencies--&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>&lt;groupId&gt;</span>org.springframework.cloud<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>&lt;artifactId&gt;</span>spring-cloud-dependencies<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>&lt;version&gt;</span>${spring-cloud-version}<span style=color:#f92672>&lt;/version&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>&lt;type&gt;</span>pom<span style=color:#f92672>&lt;/type&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>&lt;scope&gt;</span>import<span style=color:#f92672>&lt;/scope&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;!--spring-cloud-alibaba-dependencies--&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>&lt;groupId&gt;</span>com.alibaba.cloud<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>&lt;artifactId&gt;</span>spring-cloud-alibaba-dependencies<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>&lt;version&gt;</span>${spring-cloud-alibaba-version}<span style=color:#f92672>&lt;/version&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>&lt;type&gt;</span>pom<span style=color:#f92672>&lt;/type&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>&lt;scope&gt;</span>import<span style=color:#f92672>&lt;/scope&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span></code></pre></div><ol start=3><li>在子项目中引入依赖：</li></ol><p><code>pom.xml</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#75715e>&lt;!--lombok--&gt;</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>  
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;groupId&gt;</span>org.projectlombok<span style=color:#f92672>&lt;/groupId&gt;</span>  
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;artifactId&gt;</span>lombok<span style=color:#f92672>&lt;/artifactId&gt;</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>  
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;!--spring-boot-starter-web--&gt;</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>  
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;groupId&gt;</span>org.springframework.boot<span style=color:#f92672>&lt;/groupId&gt;</span>  
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;artifactId&gt;</span>spring-boot-starter-web<span style=color:#f92672>&lt;/artifactId&gt;</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>  
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;!--spring-cloud-starter-alibaba-nacos-discovery--&gt;</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>  
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;groupId&gt;</span>com.alibaba.cloud<span style=color:#f92672>&lt;/groupId&gt;</span>  
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;artifactId&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span style=color:#f92672>&lt;/artifactId&gt;</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>  
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;!--spring-cloud-starter-openfeign--&gt;</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>  
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;groupId&gt;</span>org.springframework.cloud<span style=color:#f92672>&lt;/groupId&gt;</span>  
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;artifactId&gt;</span>spring-cloud-starter-openfeign<span style=color:#f92672>&lt;/artifactId&gt;</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>  
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;!--spring-cloud-starter-alibaba-sentinel--&gt;</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>  
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;groupId&gt;</span>com.alibaba.cloud<span style=color:#f92672>&lt;/groupId&gt;</span>  
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;artifactId&gt;</span>spring-cloud-starter-alibaba-sentinel<span style=color:#f92672>&lt;/artifactId&gt;</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span></code></pre></div><h3 id=2-开发启动类-1>2. 开发启动类</h3><p><code>com.lsx.SentinelProductApp</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@SpringBootApplication</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SentinelProductApp</span> {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span>(String<span style=color:#f92672>[]</span> args) {  
</span></span><span style=display:flex><span>        SpringApplication.<span style=color:#a6e22e>run</span>(SentinelProductApp.<span style=color:#a6e22e>class</span>, args);  
</span></span><span style=display:flex><span>    }  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=3-开发配置类-1>3. 开发配置类</h3><ol><li>开发Nacos配置类：</li></ol><p><code>com.lsx.config.NacosConfig</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@EnableDiscoveryClient</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Configuration</span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>NacosConfig</span> {  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=2><li>开发OpenFeign配置类：</li></ol><p><code>com.lsx.config.OpenFeignConfig</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@EnableFeignClients</span>(basePackages <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;com.lsx.feign&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Configuration</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>OpenFeignConfig</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>	 * OpenFeign提供了日志打印功能，用于对OpenFeign接口的调用情况进行监控和输出
</span></span></span><span style=display:flex><span><span style=color:#75715e>	 *
</span></span></span><span style=display:flex><span><span style=color:#75715e>	 * &lt;p&gt;Logger.Level.NONE: 不显示任何日志，默认值
</span></span></span><span style=display:flex><span><span style=color:#75715e>	 * &lt;p&gt;Logger.Level.BASIC: 仅记录请求方法、URL、响应状态码及执行时间
</span></span></span><span style=display:flex><span><span style=color:#75715e>	 * &lt;p&gt;Logger.Level.HEADERS: 除了BASIC中定义的信息之外，还有请求和响应的头信息
</span></span></span><span style=display:flex><span><span style=color:#75715e>	 * &lt;p&gt;Logger.Level.FULL: 除了HEADERS中定义的信息之外，还有请求和响应的正文及元数据
</span></span></span><span style=display:flex><span><span style=color:#75715e>	 */</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span>	Logger.<span style=color:#a6e22e>Level</span> <span style=color:#a6e22e>feignLoggerLevel</span>() {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> Logger.<span style=color:#a6e22e>Level</span>.<span style=color:#a6e22e>FULL</span>;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=4-开发主配项-1>4. 开发主配项</h3><p><code>classpath:application.yml</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span><span style=color:#f92672>server</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>port</span>: <span style=color:#ae81ff>8088</span> <span style=color:#75715e># 端口号  </span>
</span></span><span style=display:flex><span><span style=color:#f92672>spring</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>application</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>name</span>: <span style=color:#ae81ff>sentinel-product</span> <span style=color:#75715e># 项目名称  </span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>cloud</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>nacos</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>discovery</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>server-addr</span>: <span style=color:#ae81ff>192.168.40.77</span>:<span style=color:#ae81ff>8848</span> <span style=color:#75715e># nacos地址  </span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>sentinel</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>transport</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>port</span>: <span style=color:#ae81ff>8888</span> <span style=color:#75715e># Sentinel跟控制台交流的内部端口号，随意指定一个未使用的端口即可</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>dashboard</span>: <span style=color:#ae81ff>192.168.40.77</span>:<span style=color:#ae81ff>8858</span> <span style=color:#75715e># Sentinel管控台端口号</span>
</span></span><span style=display:flex><span><span style=color:#f92672>logging</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>level</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>com.lsx.feign</span>: <span style=color:#ae81ff>debug</span> <span style=color:#75715e># 配置指定包的日志等级</span>
</span></span></code></pre></div><h2 id=e02-开发远程调用>E02. 开发远程调用</h2><blockquote><p>武技: 测试OpenFeign远程调用效果</p></blockquote><h3 id=1-商品控制器类>1. 商品控制器类</h3><ol><li>在 <code>sentinel-product</code> 子项目中开发控制器类：</li></ol><p><code>com.lsx.controller.ProductController</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RestController</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RequestMapping</span>(<span style=color:#e6db74>&#34;/api/v1/product&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ProductController</span> {  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@GetMapping</span>(<span style=color:#e6db74>&#34;/getById/{id}&#34;</span>)  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>getById</span>(<span style=color:#a6e22e>@PathVariable</span> Long id) {  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> id <span style=color:#f92672>==</span> 1L <span style=color:#f92672>?</span> <span style=color:#e6db74>&#34;小米手机&#34;</span> : <span style=color:#e6db74>&#34;苹果手机&#34;</span>;  
</span></span><span style=display:flex><span>    }  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=2-开发远程接口>2. 开发远程接口</h3><ol><li>在 <code>openfeign-order</code> 子项目中开发远程调用接口：</li></ol><p><code>com.lsx.feign.ProductFeign</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@FeignClient</span>(<span style=color:#e6db74>&#34;sentinel-product&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>ProductFeign</span> {
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * 远程: 通过商品主键查询一条商品记录
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * 
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param id 商品主键
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @return 一条商品记录
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@GetMapping</span>(<span style=color:#e6db74>&#34;/api/v1/product/getById/{id}&#34;</span>)  
</span></span><span style=display:flex><span>    String <span style=color:#a6e22e>getById</span>(<span style=color:#a6e22e>@PathVariable</span>(<span style=color:#e6db74>&#34;id&#34;</span>) Long id);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=3-订单控制器类>3. 订单控制器类</h3><ol><li>在 <code>sentinel-order</code> 子项目中开发控制器类：</li></ol><p><code>com.lsx.controller.ProductFeign</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RestController</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RequestMapping</span>(<span style=color:#e6db74>&#34;/api/v1/order&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>OrderController</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Autowired</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> ProductFeign productFeign;
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@GetMapping</span>(<span style=color:#e6db74>&#34;/getById/{id}&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>getById</span>(<span style=color:#a6e22e>@PathVariable</span> Long id) {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 查询订单中的商品名称：假设1号订单购买了1号商品，2号订单中购买了2号商品</span>
</span></span><span style=display:flex><span>		Long productId <span style=color:#f92672>=</span> id <span style=color:#f92672>==</span> 1L <span style=color:#f92672>?</span> 1L : 2L;
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 远程调用商品微服务中的对应方法</span>
</span></span><span style=display:flex><span>		String productName <span style=color:#f92672>=</span> productFeign.<span style=color:#a6e22e>getById</span>(productId);
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> id <span style=color:#f92672>==</span> 1L <span style=color:#f92672>?</span> <span style=color:#e6db74>&#34;1号订单：&#34;</span> <span style=color:#f92672>+</span> productName : <span style=color:#e6db74>&#34;2号订单：&#34;</span> <span style=color:#f92672>+</span> productName;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=3><li><a href=http://localhost:8087/api/v1/order/getById/2>访问控制方法</a></li></ol><h2 id=e03-开发远程容错>E03. 开发远程容错</h2><blockquote><p>武技: OpenFeign整合Sentinel熔断降级</p></blockquote><h3 id=1-开发主配项>1. 开发主配项</h3><ol><li>在 <code>sentinel-order</code> 子项目中开发主配项：</li></ol><p><code>classpath:application.yml</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>feign</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>sentinel</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>enabled</span>: <span style=color:#66d9ef>true</span> <span style=color:#75715e># 开启Sentinel和Feign的整合</span>
</span></span></code></pre></div><h3 id=2-开发降级方法-1>2. 开发降级方法</h3><ol><li>在 <code>sentinel-order</code> 子项目中开发降级方法：<ol><li>降级类必须重写 <code>ProductFeign -> getById()</code> 远程接口方法以返回兜底数据。</li></ol></li></ol><p><code>com.lsx.fallback.ProductFeignFallback -> getById()</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Component</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ProductFeignFallback</span> <span style=color:#66d9ef>implements</span> ProductFeign {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>getById</span>(Long id) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;远程调用商品微服务失败，请联系管理员。&#34;</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=3-升级远程接口>3. 升级远程接口</h3><ol><li>在 <code>sentinel-order</code> 子项目中升级远程接口：在 <code>@FeignClient</code> 注解中，使用 <code>fallback</code> 属性指定降级类。</li></ol><p><code>com.lsx.feign.ProductFeign</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@FeignClient</span>(value <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;sentinel-product&#34;</span>, fallback <span style=color:#f92672>=</span> ProductFeignFallback.<span style=color:#a6e22e>class</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>ProductFeign</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * 远程: 通过商品主键查询一条商品记录
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * 
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param id 商品主键
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @return 一条商品记录
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@GetMapping</span>(<span style=color:#e6db74>&#34;/api/v1/product/getById/{id}&#34;</span>)
</span></span><span style=display:flex><span>    String <span style=color:#a6e22e>getById</span>(<span style=color:#a6e22e>@PathVariable</span>(<span style=color:#e6db74>&#34;id&#34;</span>) Long id);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=4-测试远程容错>4. 测试远程容错</h3><ol><li>主动下线商品微服务后，<a href=http://localhost:8070/api/v1/order/getById/1>访问下单接口</a>：远程调用失败，返回兜底数据。</li></ol></div><svg id="btt-button" class="arrow-logo" xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 384 512" onclick="scrollToTop()" title="Go to top"><path d="M177 159.7l136 136c9.4 9.4 9.4 24.6.0 33.9l-22.6 22.6c-9.4 9.4-24.6 9.4-33.9.0L160 255.9l-96.4 96.4c-9.4 9.4-24.6 9.4-33.9.0L7 329.7c-9.4-9.4-9.4-24.6.0-33.9l136-136c9.4-9.5 24.6-9.5 34-.1z"/></svg>
<script>let backToTopButton=document.getElementById("btt-button");window.onscroll=function(){scrollFunction()};function scrollFunction(){document.body.scrollTop>20||document.documentElement.scrollTop>20?backToTopButton.style.display="block":backToTopButton.style.display="none"}function scrollToTop(){window.scrollTo(0,0)}</script></div></main><footer class=footer><span>&copy; 2024 The Marauders</span>
<span>Made with &#10084;&#65039; using <a target=_blank href=https://github.com/gokarna-theme/gokarna-hugo>Gokarna</a></span></footer></body></html>