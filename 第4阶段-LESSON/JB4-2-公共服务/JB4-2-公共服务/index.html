<!doctype html><html lang=en><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><style>:root{--accent-color:#FF4D4D}</style><title>JB4-2-公共服务</title>
<meta name=description content="[!NOTE] Java道经第4卷 - 第2阶 - 公共服务 lesson-common &amp;amp; lesson-mybatis-flex &amp;amp; lesson-search
S01. 开发公共子项目 心法: 公共项目
公共项目用于提取多个子项目之间相同的代码，比如自己封装的Util工具，ORM实体类等。 公共项 …"><meta name=keywords content='blog,lsx2216,hugo'><meta property="og:url" content="https://lsx2216.netlify.app/%E7%AC%AC4%E9%98%B6%E6%AE%B5-LESSON/JB4-2-%E5%85%AC%E5%85%B1%E6%9C%8D%E5%8A%A1/JB4-2-%E5%85%AC%E5%85%B1%E6%9C%8D%E5%8A%A1/"><meta property="og:type" content="website"><meta property="og:title" content="JB4-2-公共服务"><meta property="og:description" content="[!NOTE] Java道经第4卷 - 第2阶 - 公共服务 lesson-common &amp;amp; lesson-mybatis-flex &amp;amp; lesson-search
S01. 开发公共子项目 心法: 公共项目
公共项目用于提取多个子项目之间相同的代码，比如自己封装的Util工具，ORM实体类等。 公共项 …"><meta property="og:image" content="https://lsx2216.netlify.app/assets/images/user.jpg"><meta property="og:image:secure_url" content="https://lsx2216.netlify.app/assets/images/user.jpg"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="JB4-2-公共服务"><meta name=twitter:description content="[!NOTE] Java道经第4卷 - 第2阶 - 公共服务 lesson-common &amp;amp; lesson-mybatis-flex &amp;amp; lesson-search
S01. 开发公共子项目 心法: 公共项目
公共项目用于提取多个子项目之间相同的代码，比如自己封装的Util工具，ORM实体类等。 公共项 …"><meta property="twitter:domain" content="https://lsx2216.netlify.app/%E7%AC%AC4%E9%98%B6%E6%AE%B5-LESSON/JB4-2-%E5%85%AC%E5%85%B1%E6%9C%8D%E5%8A%A1/JB4-2-%E5%85%AC%E5%85%B1%E6%9C%8D%E5%8A%A1/"><meta property="twitter:url" content="https://lsx2216.netlify.app/%E7%AC%AC4%E9%98%B6%E6%AE%B5-LESSON/JB4-2-%E5%85%AC%E5%85%B1%E6%9C%8D%E5%8A%A1/JB4-2-%E5%85%AC%E5%85%B1%E6%9C%8D%E5%8A%A1/"><meta name=twitter:image content="https://lsx2216.netlify.app/assets/images/user.jpg"><link rel=canonical href=https://lsx2216.netlify.app/%E7%AC%AC4%E9%98%B6%E6%AE%B5-LESSON/JB4-2-%E5%85%AC%E5%85%B1%E6%9C%8D%E5%8A%A1/JB4-2-%E5%85%AC%E5%85%B1%E6%9C%8D%E5%8A%A1/><link rel=stylesheet type=text/css href=/css/normalize.min.css media=print><link rel=stylesheet type=text/css href=/css/main.min.css><link id=dark-theme rel=stylesheet href=/css/dark.min.css><script src=/js/bundle.min.3eb19cb61dde9e37b9522867f3e024aeb68e26ab8e03252e46e365abcb19acf7.js integrity="sha256-PrGcth3enje5Uihn8+AkrraOJquOAyUuRuNlq8sZrPc="></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css integrity=sha384-Xi8rHCmBmhbuyyhbI88391ZKP2dmfnOl4rT9ZfRI7mLTdk1wblIUnrIq35nqwEvC crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.js integrity=sha384-X/XCfMm41VSsqRNQgDerQczD69XqmjOOOwYQvr/uuC+j4OPoNhVgjdGFwhvN02Ja crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],throwOnError:!1})})</script>    <link rel="shortcut icon" href="/assets/images/user.jpg" type="image/x-icon">
</head><body><script>setThemeByUserPref()</script><header class=header><nav class=header-nav><div class=avatar><a href=https://lsx2216.netlify.app/><img src=/assets/images/user.jpg alt=avatar></a></div><div class=nav-title><a class=nav-brand href=https://lsx2216.netlify.app/>lsx2216</a></div><div class=nav-links><div class=nav-link><a href=https://lsx2216.netlify.app/ aria-label><span data-feather=home></span> Home</a></div><div class=nav-link><a href=https://lsx2216.netlify.app/projects/ aria-label><span data-feather=code></span> Projects</a></div><div class=nav-link><a href=https://github.com aria-label=github><span data-feather=github></span></a></div><span class=nav-icons-divider></span><div class="nav-link dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target">theme</span>
<a aria-hidden=true role=switch><span class=theme-toggle-icon data-feather=moon></span></a></div><div class=nav-link id=hamburger-menu-toggle><span class="sr-only hamburger-menu-toggle-screen-reader-target">menu</span>
<a aria-checked=false aria-labelledby=hamburger-menu-toggle id=hamburger-menu-toggle-target role=switch><span data-feather=menu></span></a></div><ul class="nav-hamburger-list visibility-hidden"><li class=nav-item><a href=https://lsx2216.netlify.app/><span data-feather=home></span> Home</a></li><li class=nav-item><a href=https://lsx2216.netlify.app/projects/><span data-feather=code></span> Projects</a></li><li class=nav-item><a href=https://github.com><span data-feather=github></span></a></li><li class="nav-item dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target">theme</span>
<a role=switch><span class=theme-toggle-icon data-feather=moon></span></a></li></ul></div></nav></header><main id=content><div class="post container"><div class=post-header-section><h1>JB4-2-公共服务</h1></div><div class=post-content><blockquote><p>[!NOTE] Java道经第4卷 - 第2阶 - 公共服务
lesson-common & lesson-mybatis-flex & lesson-search</p></blockquote><h1 id=s01-开发公共子项目>S01. 开发公共子项目</h1><blockquote><p>心法: 公共项目</p></blockquote><ul><li>公共项目用于提取多个子项目之间相同的代码，比如自己封装的Util工具，ORM实体类等。</li><li>公共项目建议使用 <code>xxx-common</code> 格式命名。</li></ul><blockquote><p>武技: 创建公共子项目</p></blockquote><ol><li>在子项目 <code>lesson-common</code> 中添加依赖:<ul><li><code>&lt;optional>true&lt;/optional></code> 表示默认情况下，不会向调用方传递依赖，防止冲突。</li></ul></li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#75715e>&lt;!--junit--&gt;</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>  
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;groupId&gt;</span>junit<span style=color:#f92672>&lt;/groupId&gt;</span>  
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;artifactId&gt;</span>junit<span style=color:#f92672>&lt;/artifactId&gt;</span>  
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;optional&gt;</span>true<span style=color:#f92672>&lt;/optional&gt;</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>  
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;!--lombok--&gt;</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>  
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;groupId&gt;</span>org.projectlombok<span style=color:#f92672>&lt;/groupId&gt;</span>  
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;artifactId&gt;</span>lombok<span style=color:#f92672>&lt;/artifactId&gt;</span>  
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;optional&gt;</span>true<span style=color:#f92672>&lt;/optional&gt;</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>  
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;!--hutool--&gt;</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>  
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;groupId&gt;</span>cn.hutool<span style=color:#f92672>&lt;/groupId&gt;</span>  
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;artifactId&gt;</span>hutool-all<span style=color:#f92672>&lt;/artifactId&gt;</span>  
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;optional&gt;</span>true<span style=color:#f92672>&lt;/optional&gt;</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>  
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;!--spring-boot-starter-web--&gt;</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>  
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;groupId&gt;</span>org.springframework.boot<span style=color:#f92672>&lt;/groupId&gt;</span>  
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;artifactId&gt;</span>spring-boot-starter-web<span style=color:#f92672>&lt;/artifactId&gt;</span>  
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;optional&gt;</span>true<span style=color:#f92672>&lt;/optional&gt;</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;!--java-jwt--&gt;</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>  
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;groupId&gt;</span>com.auth0<span style=color:#f92672>&lt;/groupId&gt;</span>  
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;artifactId&gt;</span>java-jwt<span style=color:#f92672>&lt;/artifactId&gt;</span>  
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;optional&gt;</span>true<span style=color:#f92672>&lt;/optional&gt;</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;!--mybatis-flex-spring-boot-starter--&gt;</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>  
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;groupId&gt;</span>com.mybatis-flex<span style=color:#f92672>&lt;/groupId&gt;</span>  
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;artifactId&gt;</span>mybatis-flex-spring-boot-starter<span style=color:#f92672>&lt;/artifactId&gt;</span>  
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;optional&gt;</span>true<span style=color:#f92672>&lt;/optional&gt;</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;!--spring-boot-starter-data-redis--&gt;</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>  
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;groupId&gt;</span>org.springframework.boot<span style=color:#f92672>&lt;/groupId&gt;</span>  
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;artifactId&gt;</span>spring-boot-starter-data-redis<span style=color:#f92672>&lt;/artifactId&gt;</span>  
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;optional&gt;</span>true<span style=color:#f92672>&lt;/optional&gt;</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span></code></pre></div><h2 id=e01-封装常用工具>E01. 封装常用工具</h2><blockquote><p>武技: 在子项目 <code>lesson-common</code> 中封装常用工具类</p></blockquote><ol><li><a href=../../%E7%AC%AC3%E9%98%B6%E6%AE%B5-SSM/JB3-3-SpringMVC/res/%E5%B0%81%E8%A3%85Result%E5%93%8D%E5%BA%94%E7%B1%BB.md>封装Result响应类</a></li><li><a href=../../%E7%AC%AC3%E9%98%B6%E6%AE%B5-SSM/JB3-4-SpringBoot/res/%E5%B0%81%E8%A3%85JWT%E5%B7%A5%E5%85%B7%E7%B1%BB.md>封装JWT工具类</a></li><li><a href=../../%E7%AC%AC3%E9%98%B6%E6%AE%B5-SSM/JB3-4-SpringBoot/res/%E5%B0%81%E8%A3%85MinIO%E5%B7%A5%E5%85%B7%E7%B1%BB.md>封装MinIO工具类</a></li></ol><h2 id=e02-统一跨域处理>E02. 统一跨域处理</h2><blockquote><p>武技: 在 <code>lesson-common</code> 项目中开发跨域配置类</p></blockquote><ol><li>开发CORS配置类 <code>CorsConfig</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> com.lsx.config;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Configuration</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>CorsConfig</span> <span style=color:#66d9ef>implements</span> WebMvcConfigurer {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>addCorsMappings</span>(CorsRegistry registry) {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 允许跨域访问我所有的URL路径</span>
</span></span><span style=display:flex><span>        registry.<span style=color:#a6e22e>addMapping</span>(<span style=color:#e6db74>&#34;/**&#34;</span>)
</span></span><span style=display:flex><span>                <span style=color:#75715e>// 允许所有的请求来源对我进行跨域访问</span>
</span></span><span style=display:flex><span>                .<span style=color:#a6e22e>allowedOrigins</span>(<span style=color:#e6db74>&#34;*&#34;</span>)
</span></span><span style=display:flex><span>                <span style=color:#75715e>// 允许发送Cookie信息</span>
</span></span><span style=display:flex><span>                .<span style=color:#a6e22e>allowCredentials</span>(<span style=color:#66d9ef>true</span>)
</span></span><span style=display:flex><span>                <span style=color:#75715e>// 允许所有的请求类型对我进行跨域访问，单独设置时必须使用大写字母</span>
</span></span><span style=display:flex><span>                .<span style=color:#a6e22e>allowedMethods</span>(<span style=color:#e6db74>&#34;*&#34;</span>)
</span></span><span style=display:flex><span>                <span style=color:#75715e>// 允许请求中携带任意的Header信息</span>
</span></span><span style=display:flex><span>                .<span style=color:#a6e22e>allowedHeaders</span>(<span style=color:#e6db74>&#34;*&#34;</span>)
</span></span><span style=display:flex><span>                <span style=color:#75715e>// 设置预检请求的超时时间，默认1800秒</span>
</span></span><span style=display:flex><span>                .<span style=color:#a6e22e>maxAge</span>(3600 <span style=color:#f92672>*</span> 24);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=e03-统一响应处理>E03. 统一响应处理</h2><blockquote><p>武技: 在 <code>lesson-common</code> 项目中开发统一响应处理类</p></blockquote><ol><li>开发响应处理类 <code>ResultAdvice</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> com.lsx.component;  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Slf4j</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RestControllerAdvice</span>(basePackages <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#34;com.lsx.controller&#34;</span>})  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ResultAdvice</span> <span style=color:#66d9ef>implements</span> ResponseBodyAdvice<span style=color:#f92672>&lt;</span>Object<span style=color:#f92672>&gt;</span> {  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>/** 该方法在控制方法返回数据前执行 */</span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>supports</span>(MethodParameter param, Class<span style=color:#f92672>&lt;?</span> <span style=color:#66d9ef>extends</span> HttpMessageConverter<span style=color:#f92672>&lt;?&gt;&gt;</span> aClass) {  
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 仅在该方法返回true时，才会进入 beforeBodyWrite 方法进行下一步操作  </span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>;    
</span></span><span style=display:flex><span>	}  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>/** 该方法在控制方法响应数据前执行 */</span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Object <span style=color:#a6e22e>beforeBodyWrite</span>(Object o, MethodParameter methodParameter, MediaType mediaType,  
</span></span><span style=display:flex><span>                                  Class<span style=color:#f92672>&lt;?</span> <span style=color:#66d9ef>extends</span> HttpMessageConverter<span style=color:#f92672>&lt;?&gt;&gt;</span> aClass,  
</span></span><span style=display:flex><span>                                  ServerHttpRequest serverHttpRequest,  
</span></span><span style=display:flex><span>                                  ServerHttpResponse serverHttpResponse) {  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 若返回值是null，则直接返回失败信息  </span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span>(ObjectUtil.<span style=color:#a6e22e>isNull</span>(o)){  
</span></span><span style=display:flex><span>		    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> Result(ResultCode.<span style=color:#a6e22e>FAILED</span>, <span style=color:#e6db74>&#34;响应数据为空&#34;</span>);  
</span></span><span style=display:flex><span>		}  
</span></span><span style=display:flex><span>		  
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 若Jackson使用字符串转换器，使用JSON封装一下再直接返回字符串，避免爆发转换异常  </span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> (aClass <span style=color:#f92672>==</span> StringHttpMessageConverter.<span style=color:#a6e22e>class</span>) {  
</span></span><span style=display:flex><span>		    <span style=color:#66d9ef>return</span> JSONUtil.<span style=color:#a6e22e>toJsonStr</span>(o);  
</span></span><span style=display:flex><span>		}  
</span></span><span style=display:flex><span>		  
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 若返回值已经是Result类型则直接返回  </span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span>(o <span style=color:#66d9ef>instanceof</span> Result){  
</span></span><span style=display:flex><span>		    <span style=color:#66d9ef>return</span> o;  
</span></span><span style=display:flex><span>		}  
</span></span><span style=display:flex><span>		  
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 若返回值是Boolean类型，则返回成功或失败的信息  </span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span>(o <span style=color:#66d9ef>instanceof</span> Boolean){  
</span></span><span style=display:flex><span>		    <span style=color:#66d9ef>boolean</span> result <span style=color:#f92672>=</span> (Boolean)o;  
</span></span><span style=display:flex><span>		    <span style=color:#66d9ef>return</span> result <span style=color:#f92672>?</span> <span style=color:#66d9ef>new</span> Result(ResultCode.<span style=color:#a6e22e>SUCCESS</span>) : <span style=color:#66d9ef>new</span> Result(ResultCode.<span style=color:#a6e22e>FAILED</span>, <span style=color:#e6db74>&#34;操作失败&#34;</span>);  
</span></span><span style=display:flex><span>		}  
</span></span><span style=display:flex><span>		  
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 将返回值封装为Result类型后响应  </span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> Result(o);  
</span></span><span style=display:flex><span>    }  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=e04-封装常量类>E04. 封装常量类</h2><blockquote><p>武技: 在 <code>lesson-common</code> 项目中封装常量类</p></blockquote><h3 id=1-bannerconst>1. BannerConst</h3><p><code>com.lsx.constant.BannerConst</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>BannerConst</span> {  
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>    <span style=color:#75715e>/** 横幅上传目录 */</span>  
</span></span><span style=display:flex><span>    String BANNER_DIR <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;banner&#34;</span>;  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>/** 横幅默认图片 */</span>  
</span></span><span style=display:flex><span>    String DEFAULT_BANNER <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;default-banner.jpg&#34;</span>;  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=2-reportconst>2. ReportConst</h3><p><code>com.lsx.constant.ReportConst</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>ReportConst</span> {  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>/** 举报类型为课程 */</span>  
</span></span><span style=display:flex><span>    Integer COURSE_TYPE <span style=color:#f92672>=</span> 0;  
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>/** 举报类型为评论 */</span>  
</span></span><span style=display:flex><span>    Integer COMMENT_TYPE <span style=color:#f92672>=</span> 1;  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=3-couponsconst>3. CouponsConst</h3><p><code>com.lsx.constant.CouponsConst</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>CouponsConst</span> {  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>/** 优惠卷可用状态 */</span>  
</span></span><span style=display:flex><span>    Integer AVAILABLE <span style=color:#f92672>=</span> 0;
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>    <span style=color:#75715e>/** 优惠卷不可用状态 */</span>  
</span></span><span style=display:flex><span>    Integer NOT_AVAILABLE <span style=color:#f92672>=</span> 1;  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=4-orderconst>4. OrderConst</h3><p><code>com.lsx.constant.OrderConst</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>OrderConst</span> {  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/** 订单状态: 未付款 */</span>  
</span></span><span style=display:flex><span>    Integer UNPAID <span style=color:#f92672>=</span> 0;  
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>/** 订单状态: 已付款 */</span>  
</span></span><span style=display:flex><span>    Integer PAID <span style=color:#f92672>=</span> 1;  
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>/** 订单状态: 已发货 */</span>  
</span></span><span style=display:flex><span>    Integer SENT_OUT <span style=color:#f92672>=</span> 2;  
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>/** 订单状态: 已退款 */</span>  
</span></span><span style=display:flex><span>    Integer REFUNDED <span style=color:#f92672>=</span> 3;  
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>/** 支付方式: 未支付 */</span>  
</span></span><span style=display:flex><span>    Integer NO_PAY <span style=color:#f92672>=</span> 0;  
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>/** 支付方式: 支付宝 */</span>  
</span></span><span style=display:flex><span>    Integer ALI_PAY <span style=color:#f92672>=</span> 1;  
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>/** 支付方式: 微信支付 */</span>  
</span></span><span style=display:flex><span>    Integer WECHAT_PAY <span style=color:#f92672>=</span> 2;  
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>/** 支付方式: 其他支付 */</span>  
</span></span><span style=display:flex><span>    Integer OTHER_PAY <span style=color:#f92672>=</span> 3;  
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>/** 报表名称 */</span>  
</span></span><span style=display:flex><span>    String EXCEL_FILE_NAME <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;订单统计表.xlsx&#34;</span>;  
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>/** 报表Sheet名称 */</span>  
</span></span><span style=display:flex><span>    String EXCEL_SHEET_NAME <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;sheet001&#34;</span>;  
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=5-courseconst>5. CourseConst</h3><p><code>com.lsx.constant.CourseConst</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>CourseConst</span> {  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>/** 摘要图上传目录 */</span>  
</span></span><span style=display:flex><span>	String SUMMARY_DIR <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;summary&#34;</span>;    
</span></span><span style=display:flex><span>	    
</span></span><span style=display:flex><span>	<span style=color:#75715e>/** 摘要默认图片 */</span>  
</span></span><span style=display:flex><span>	String DEFAULT_SUMMARY <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;default-summary.jpg&#34;</span>;    
</span></span><span style=display:flex><span>	    
</span></span><span style=display:flex><span>	<span style=color:#75715e>/** 课程封面图上传目录 */</span>  
</span></span><span style=display:flex><span>	String COVER_DIR <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;cover&#34;</span>;    
</span></span><span style=display:flex><span>	    
</span></span><span style=display:flex><span>	<span style=color:#75715e>/** 课程封面默认图片 */</span>  
</span></span><span style=display:flex><span>	String DEFAULT_COVER <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;default-cover.jpg&#34;</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=6-episodeconst>6. EpisodeConst</h3><p><code>com.lsx.constant.EpisodeConst</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>EpisodeConst</span> {  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>	<span style=color:#75715e>/** 集次视频上传目录 */</span>  
</span></span><span style=display:flex><span>	String VIDEO_DIR <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;video&#34;</span>;  
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#75715e>/** 集次默认视频 */</span>  
</span></span><span style=display:flex><span>	String DEFAULT_VIDEO <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;default-video.mp4&#34;</span>;  
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#75715e>/** 集次视频封面图上传目录 */</span>  
</span></span><span style=display:flex><span>	String VIDEO_COVER_DIR <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;videoCover&#34;</span>;  
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#75715e>/** 集次默认视频封面图 */</span>  
</span></span><span style=display:flex><span>	String DEFAULT_VIDEO_COVER <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;default-video-cover.jpg&#34;</span>;  
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#75715e>/** 报表名称 */</span>  
</span></span><span style=display:flex><span>	String EXCEL_FILE_NAME <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;视频统计表.xlsx&#34;</span>;  
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#75715e>/** 报表Sheet名称 */</span>  
</span></span><span style=display:flex><span>	String EXCEL_SHEET_NAME <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;sheet001&#34;</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=7-memberconst>7. MemberConst</h3><p><code>com.lsx.constant.MemberConst</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>MemberConst</span> {  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>/** 会员状态: 正常 */</span>  
</span></span><span style=display:flex><span>    Integer NORMAL <span style=color:#f92672>=</span> 0;  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>/** 会员状态: 已冻结 */</span>  
</span></span><span style=display:flex><span>    Integer FROZEN <span style=color:#f92672>=</span> 1;  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>/** 会员性别: 女 */</span>  
</span></span><span style=display:flex><span>	Integer FEMALE <span style=color:#f92672>=</span> 0;  
</span></span><span style=display:flex><span>	  
</span></span><span style=display:flex><span>	<span style=color:#75715e>/** 会员性别: 男 */</span>  
</span></span><span style=display:flex><span>	Integer MALE <span style=color:#f92672>=</span> 1;  
</span></span><span style=display:flex><span>	  
</span></span><span style=display:flex><span>	<span style=color:#75715e>/** 会员性别: 保密 */</span>  
</span></span><span style=display:flex><span>	Integer SECRET <span style=color:#f92672>=</span> 2;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/** 报表名称 */</span>  
</span></span><span style=display:flex><span>    String EXCEL_FILE_NAME <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;会员统计表.xlsx&#34;</span>;  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>/** 报表Sheet名称 */</span>  
</span></span><span style=display:flex><span>    String EXCEL_SHEET_NAME <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;sheet001&#34;</span>;  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>/** 默认密码 */</span>  
</span></span><span style=display:flex><span>	String DEFAULT_PASSWORD <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;123456789&#34;</span>;  
</span></span><span style=display:flex><span>	  
</span></span><span style=display:flex><span>	<span style=color:#75715e>/** 管理员角色ID */</span>  
</span></span><span style=display:flex><span>	Long ADMIN_ROLE <span style=color:#f92672>=</span> 1L;  
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>    <span style=color:#75715e>/** 会员角色ID: 普通会员 */</span>
</span></span><span style=display:flex><span>    Long NORMAL_ROLE <span style=color:#f92672>=</span> 2L;
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>	<span style=color:#75715e>/** 运营角色ID */</span>  
</span></span><span style=display:flex><span>	Long OPERATIONS_ROLE <span style=color:#f92672>=</span> 3L;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/** 会员默认头像: 12生肖图 */</span>
</span></span><span style=display:flex><span>    List<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;</span> DEFAULT_AVATARS <span style=color:#f92672>=</span> Arrays.<span style=color:#a6e22e>asList</span>(
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;鼠.png&#34;</span>, <span style=color:#e6db74>&#34;牛.png&#34;</span>, <span style=color:#e6db74>&#34;虎.png&#34;</span>, <span style=color:#e6db74>&#34;兔.png&#34;</span>, <span style=color:#e6db74>&#34;龙.png&#34;</span>, <span style=color:#e6db74>&#34;蛇.png&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;马.png&#34;</span>, <span style=color:#e6db74>&#34;羊.png&#34;</span>, <span style=color:#e6db74>&#34;猴.png&#34;</span>, <span style=color:#e6db74>&#34;鸡.png&#34;</span>, <span style=color:#e6db74>&#34;狗.png&#34;</span>, <span style=color:#e6db74>&#34;猪.png&#34;</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=7-permissionconst>7. PermissionConst</h3><p><code>com.lsx.constant.PermissionConst</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>PermissionConst</span> {  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>/** 根权限ID */</span>  
</span></span><span style=display:flex><span>    Long ROOT_ID <span style=color:#f92672>=</span> 0L;  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=e05-封装通用vo>E05. 封装通用VO</h2><blockquote><p>武技: 在 <code>lesson-common</code> 项目中封装通用分页VO实体类</p></blockquote><p><code>com.lsx.vo.PageVO</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> com.lsx.vo;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Data</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>PageVO</span><span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>implements</span> Serializable {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> List<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> records;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>long</span> pageNumber;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>long</span> pageSize;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>long</span> totalPage;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>long</span> totalRow;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h1 id=s02-开发数据子项目>S02. 开发数据子项目</h1><blockquote><p>心法: <a href=https://mybatis-flex.com/>MyBatisFlex</a></p></blockquote><ul><li>MyBatisFlex是一个优雅的 MyBatis 增强框架，更轻量、更灵活、以及更高的性能。</li><li>更轻量：MyBatisFlex除了MyBatis本身，再无任何第三方依赖，因此自主性，把控性和稳定性都更高。</li><li>更灵活：MyBatisFlex提供QueryWrapper，支持关联查询，多表查询，逻辑删除、乐观锁更新等功能。</li><li>高性能：MyBatisFlex没有任何MyBatis拦截器，且不支持SQL Parse，因此会带来指数级的性能增长：<ul><li>SQL Parse: 是Python的非验证SQL解析器，它提供对SQL语句的解析、拆分和格式化的支持。</li></ul></li></ul><blockquote><p>武技: 开发子项目 <code>lesson-mybatis-flex</code></p></blockquote><ol><li>在子项目中引入依赖:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#75715e>&lt;!--lombok--&gt;</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>  
</span></span><span style=display:flex><span>	<span style=color:#f92672>&lt;groupId&gt;</span>org.projectlombok<span style=color:#f92672>&lt;/groupId&gt;</span>  
</span></span><span style=display:flex><span>	<span style=color:#f92672>&lt;artifactId&gt;</span>lombok<span style=color:#f92672>&lt;/artifactId&gt;</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>   
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;!--mysql-connector-j--&gt;</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>  
</span></span><span style=display:flex><span>	<span style=color:#f92672>&lt;groupId&gt;</span>com.mysql<span style=color:#f92672>&lt;/groupId&gt;</span>  
</span></span><span style=display:flex><span>	<span style=color:#f92672>&lt;artifactId&gt;</span>mysql-connector-j<span style=color:#f92672>&lt;/artifactId&gt;</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>   
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;!--mybatis-flex-spring-boot-starter--&gt;</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>  
</span></span><span style=display:flex><span>	<span style=color:#f92672>&lt;groupId&gt;</span>com.mybatis-flex<span style=color:#f92672>&lt;/groupId&gt;</span>  
</span></span><span style=display:flex><span>	<span style=color:#f92672>&lt;artifactId&gt;</span>mybatis-flex-spring-boot-starter<span style=color:#f92672>&lt;/artifactId&gt;</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>  
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;!--mybatis-flex-codegen--&gt;</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>  
</span></span><span style=display:flex><span>	<span style=color:#f92672>&lt;groupId&gt;</span>com.mybatis-flex<span style=color:#f92672>&lt;/groupId&gt;</span>  
</span></span><span style=display:flex><span>	<span style=color:#f92672>&lt;artifactId&gt;</span>mybatis-flex-codegen<span style=color:#f92672>&lt;/artifactId&gt;</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>  
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;!--HikariCP--&gt;</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>  
</span></span><span style=display:flex><span>	<span style=color:#f92672>&lt;groupId&gt;</span>com.zaxxer<span style=color:#f92672>&lt;/groupId&gt;</span>  
</span></span><span style=display:flex><span>	<span style=color:#f92672>&lt;artifactId&gt;</span>HikariCP<span style=color:#f92672>&lt;/artifactId&gt;</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span></code></pre></div><ol start=2><li>添加主配项 <code>classpath:application.properties</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-properties data-lang=properties><span style=display:flex><span><span style=color:#75715e>############################# App ##############################  </span>
</span></span><span style=display:flex><span><span style=color:#75715e>#端口号#  </span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>server.port</span><span style=color:#f92672>=</span><span style=color:#e6db74>5166  </span>
</span></span><span style=display:flex><span><span style=color:#75715e>############################# DataSource ##############################  </span>
</span></span><span style=display:flex><span><span style=color:#75715e>#驱动串，连接串，账号，密码，连接池类#  </span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.datasource.driver-class-name</span><span style=color:#f92672>=</span><span style=color:#e6db74>com.mysql.cj.jdbc.Driver  </span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.datasource.url</span><span style=color:#f92672>=</span><span style=color:#e6db74>jdbc:mysql://192.168.40.77:3306/lesson?\  </span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>serverTimezone</span><span style=color:#f92672>=</span><span style=color:#e6db74>Asia/Shanghai&amp;useUnicode=true&amp;characterEncoding=utf-8spring.datasource.username=lsx  </span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.datasource.password</span><span style=color:#f92672>=</span><span style=color:#e6db74>lsx  </span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.datasource.type</span><span style=color:#f92672>=</span><span style=color:#e6db74>com.zaxxer.hikari.HikariDataSource  </span>
</span></span><span style=display:flex><span><span style=color:#75715e>############################# MyBatisFlex ##############################  </span>
</span></span><span style=display:flex><span><span style=color:#75715e>#实体类别名包扫描，下划线自动转驼峰，控制台打印SQL#  </span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>mybatis-flex.type-aliases-package</span><span style=color:#f92672>=</span><span style=color:#e6db74>com.lsx.entity  </span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>mybatis-flex.configuration.map-underscore-to-camel-case</span><span style=color:#f92672>=</span><span style=color:#e6db74>true  </span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>mybatis-flex.configuration.log-impl</span><span style=color:#f92672>=</span><span style=color:#e6db74>org.apache.ibatis.logging.stdout.StdOutImpl</span>
</span></span></code></pre></div><ol start=3><li>开发启动类 <code>LessonMybatisFlexApp</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> com.lsx;  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.mybatis.spring.annotation.MapperScan;  
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.boot.SpringApplication;  
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.boot.autoconfigure.SpringBootApplication;  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@MapperScan</span>(<span style=color:#e6db74>&#34;com.lsx.mapper&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@SpringBootApplication</span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>LessonMybatisFlexApp</span> {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span>(String<span style=color:#f92672>[]</span> args) {  
</span></span><span style=display:flex><span>        SpringApplication.<span style=color:#a6e22e>run</span>(LessonMybatisFlexApp.<span style=color:#a6e22e>class</span>, args);  
</span></span><span style=display:flex><span>    }  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=4><li>开发生成器类 <code>CodegenForLessonAdmin</code>:<ul><li><code>TableDef</code> 对象: 一个用于操作表及表字段的辅助类。</li></ul></li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> com.lsx.gen;  
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> com.mybatisflex.codegen.Generator;  
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> com.mybatisflex.codegen.config.GlobalConfig;  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>
</span></span><span style=display:flex><span> <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>CodegenForLessonAdmin</span> {  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>/** MySQL主机地址 */</span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> String MYSQL_HOST <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;192.168.40.77:3306&#34;</span>;  
</span></span><span style=display:flex><span>    <span style=color:#75715e>/** 数据库名 */</span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> String DB_NAME <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;lesson&#34;</span>;  
</span></span><span style=display:flex><span>    <span style=color:#75715e>/** 数据库账号 */</span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> String MYSQL_USERNAME <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;lsx&#34;</span>;  
</span></span><span style=display:flex><span>    <span style=color:#75715e>/** 数据库密码 */</span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> String MYSQL_PASSWORD <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;lsx&#34;</span>;  
</span></span><span style=display:flex><span>    <span style=color:#75715e>/** 作者 */</span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> String AUTHOR <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;lsx&#34;</span>;  
</span></span><span style=display:flex><span>    <span style=color:#75715e>/** 子模块名: 指定生成到哪个子项目中 */</span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> String MODULE_NAME <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;lesson-admin&#34;</span>;  
</span></span><span style=display:flex><span>    <span style=color:#75715e>/** 根包 */</span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> String BASE_PACKAGE <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;com.lsx&#34;</span>;  
</span></span><span style=display:flex><span>    <span style=color:#75715e>/** 数据库表名前缀 */</span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> String<span style=color:#f92672>[]</span> TABLE_PREFIX <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#34;ums_&#34;</span>, <span style=color:#e6db74>&#34;pms_&#34;</span>, <span style=color:#e6db74>&#34;oms_&#34;</span>, <span style=color:#e6db74>&#34;cms_&#34;</span>};  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span>(String<span style=color:#f92672>[]</span> args) {  
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 将 BigDecimal 类型转为 Double 类型    </span>
</span></span><span style=display:flex><span>        JdbcTypeMapping.<span style=color:#a6e22e>registerMapping</span>(BigDecimal.<span style=color:#a6e22e>class</span>, Double.<span style=color:#a6e22e>class</span>);  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>new</span> Generator(getDataSource(), getGlobalConfig()).<span style=color:#a6e22e>generate</span>();  
</span></span><span style=display:flex><span>    } 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**  
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * 获取MyBatisFlex生成器配置对象  
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *  
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @return MyBatisFlex生成器配置对象  
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> GlobalConfig <span style=color:#a6e22e>getGlobalConfig</span>() {  
</span></span><span style=display:flex><span>        GlobalConfig globalConfig <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> GlobalConfig();  
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 注释配置: 作者    </span>
</span></span><span style=display:flex><span>        globalConfig.<span style=color:#a6e22e>getJavadocConfig</span>().<span style=color:#a6e22e>setAuthor</span>(AUTHOR);  
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 包配置: src目录，mapper配置文件目录，根包    </span>
</span></span><span style=display:flex><span>        globalConfig.<span style=color:#a6e22e>getPackageConfig</span>()  
</span></span><span style=display:flex><span>                .<span style=color:#a6e22e>setSourceDir</span>(MODULE_NAME <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;/src/main/java&#34;</span>)  
</span></span><span style=display:flex><span>                .<span style=color:#a6e22e>setMapperXmlPath</span>(MODULE_NAME <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;/src/main/resources/mapper&#34;</span>)  
</span></span><span style=display:flex><span>                .<span style=color:#a6e22e>setBasePackage</span>(BASE_PACKAGE);  
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 策略配置: 表前缀，数据库名，忽略哪些表    </span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 可调用 setGenerateTable() 来指定生成哪些表: 未配置时，默认生成指定数据库下的所有表  </span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 可调用 setUnGenerateTable() 来指定排除哪些表: 未配置时，不排除任何表  </span>
</span></span><span style=display:flex><span>        globalConfig.<span style=color:#a6e22e>getStrategyConfig</span>()  
</span></span><span style=display:flex><span>                .<span style=color:#a6e22e>setTablePrefix</span>(TABLE_PREFIX)  
</span></span><span style=display:flex><span>                .<span style=color:#a6e22e>setGenerateSchema</span>(DB_NAME);  
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 生成实体类，辅助类，Mapper接口，Mapper配置，Service接口，Service实现类和Controller控制器  </span>
</span></span><span style=display:flex><span>        globalConfig.<span style=color:#a6e22e>enableEntity</span>().<span style=color:#a6e22e>setWithLombok</span>(<span style=color:#66d9ef>true</span>);  
</span></span><span style=display:flex><span>        globalConfig.<span style=color:#a6e22e>enableTableDef</span>();
</span></span><span style=display:flex><span>        globalConfig.<span style=color:#a6e22e>enableMapper</span>();  
</span></span><span style=display:flex><span>        globalConfig.<span style=color:#a6e22e>enableMapperXml</span>();  
</span></span><span style=display:flex><span>        globalConfig.<span style=color:#a6e22e>enableService</span>();  
</span></span><span style=display:flex><span>		globalConfig.<span style=color:#a6e22e>enableServiceImpl</span>()  
</span></span><span style=display:flex><span>		        .<span style=color:#a6e22e>setSuperClass</span>(CacheableServiceImpl.<span style=color:#a6e22e>class</span>)  
</span></span><span style=display:flex><span>		        .<span style=color:#a6e22e>setCacheExample</span>(<span style=color:#66d9ef>true</span>);
</span></span><span style=display:flex><span>        globalConfig.<span style=color:#a6e22e>enableController</span>();  
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 返回MyBatisFlex生成器配置对象  </span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> globalConfig;  
</span></span><span style=display:flex><span>    }  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>/***  
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * 获取Hikari数据源对象  
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *  
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @return Hikari数据源对象  
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> DataSource <span style=color:#a6e22e>getDataSource</span>() {  
</span></span><span style=display:flex><span>        HikariDataSource dataSource <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HikariDataSource();  
</span></span><span style=display:flex><span>        dataSource.<span style=color:#a6e22e>setUsername</span>(MYSQL_USERNAME);  
</span></span><span style=display:flex><span>        dataSource.<span style=color:#a6e22e>setPassword</span>(MYSQL_PASSWORD);  
</span></span><span style=display:flex><span>		dataSource.<span style=color:#a6e22e>setJdbcUrl</span>(<span style=color:#e6db74>&#34;jdbc:mysql://&#34;</span> <span style=color:#f92672>+</span> MYSQL_HOST <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;/&#34;</span> <span style=color:#f92672>+</span> DB_NAME  
</span></span><span style=display:flex><span>		        <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;?serverTimezone=Asia/Shanghai&#34;</span>  
</span></span><span style=display:flex><span>		        <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;&amp;useUnicode=true&amp;characterEncoding=utf-8&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> dataSource;  
</span></span><span style=display:flex><span>    }   
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=5><li>开发生成器类 <code>CodegenForLessonServer</code>:<ul><li><code>TableDef</code> 对象: 一个用于操作表及表字段的辅助类。</li></ul></li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> com.lsx.gen;  
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> com.mybatisflex.codegen.Generator;  
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> com.mybatisflex.codegen.config.GlobalConfig;  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>CodegenForLessonServer</span> {  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>/** MySQL主机地址 */</span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> String MYSQL_HOST <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;192.168.40.77:3306&#34;</span>;  
</span></span><span style=display:flex><span>    <span style=color:#75715e>/** 数据库名 */</span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> String DB_NAME <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;lesson&#34;</span>;  
</span></span><span style=display:flex><span>    <span style=color:#75715e>/** 数据库账号 */</span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> String MYSQL_USERNAME <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;lsx&#34;</span>;  
</span></span><span style=display:flex><span>    <span style=color:#75715e>/** 数据库密码 */</span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> String MYSQL_PASSWORD <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;lsx&#34;</span>;  
</span></span><span style=display:flex><span>    <span style=color:#75715e>/** 作者 */</span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> String AUTHOR <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;lsx&#34;</span>;  
</span></span><span style=display:flex><span>    <span style=color:#75715e>/** 子模块名: 指定生成到哪个子项目中 */</span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> String MODULE_NAME <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;lesson-server&#34;</span>;  
</span></span><span style=display:flex><span>    <span style=color:#75715e>/** 根包 */</span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> String BASE_PACKAGE <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;com.lsx&#34;</span>;  
</span></span><span style=display:flex><span>    <span style=color:#75715e>/** 数据库表名前缀 */</span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> String<span style=color:#f92672>[]</span> TABLE_PREFIX <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#34;ums_&#34;</span>, <span style=color:#e6db74>&#34;pms_&#34;</span>, <span style=color:#e6db74>&#34;oms_&#34;</span>, <span style=color:#e6db74>&#34;cms_&#34;</span>};  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span>(String<span style=color:#f92672>[]</span> args) {  
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 将 BigDecimal 类型转为 Double 类型    </span>
</span></span><span style=display:flex><span>        JdbcTypeMapping.<span style=color:#a6e22e>registerMapping</span>(BigDecimal.<span style=color:#a6e22e>class</span>, Double.<span style=color:#a6e22e>class</span>);  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>new</span> Generator(getDataSource(), getGlobalConfig()).<span style=color:#a6e22e>generate</span>();  
</span></span><span style=display:flex><span>    } 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**  
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * 获取MyBatisFlex生成器配置对象  
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *  
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @return MyBatisFlex生成器配置对象  
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> GlobalConfig <span style=color:#a6e22e>getGlobalConfig</span>() {  
</span></span><span style=display:flex><span>        GlobalConfig globalConfig <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> GlobalConfig();  
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 注释配置: 作者    </span>
</span></span><span style=display:flex><span>        globalConfig.<span style=color:#a6e22e>getJavadocConfig</span>().<span style=color:#a6e22e>setAuthor</span>(AUTHOR);  
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 包配置: src目录，mapper配置文件目录，根包    </span>
</span></span><span style=display:flex><span>        globalConfig.<span style=color:#a6e22e>getPackageConfig</span>()  
</span></span><span style=display:flex><span>                .<span style=color:#a6e22e>setSourceDir</span>(MODULE_NAME <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;/src/main/java&#34;</span>)  
</span></span><span style=display:flex><span>                .<span style=color:#a6e22e>setMapperXmlPath</span>(MODULE_NAME <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;/src/main/resources/mapper&#34;</span>)  
</span></span><span style=display:flex><span>                .<span style=color:#a6e22e>setBasePackage</span>(BASE_PACKAGE);  
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 策略配置: 表前缀，数据库名，忽略哪些表    </span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 可调用 setGenerateTable() 来指定生成哪些表: 未配置时，默认生成指定数据库下的所有表  </span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 可调用 setUnGenerateTable() 来指定排除哪些表: 未配置时，不排除任何表  </span>
</span></span><span style=display:flex><span>        globalConfig.<span style=color:#a6e22e>getStrategyConfig</span>()  
</span></span><span style=display:flex><span>                .<span style=color:#a6e22e>setTablePrefix</span>(TABLE_PREFIX)  
</span></span><span style=display:flex><span>                .<span style=color:#a6e22e>setGenerateSchema</span>(DB_NAME);  
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 生成实体类，辅助类，Mapper接口，Mapper配置，Service接口，Service实现类和Controller控制器  </span>
</span></span><span style=display:flex><span>        globalConfig.<span style=color:#a6e22e>enableEntity</span>().<span style=color:#a6e22e>setWithLombok</span>(<span style=color:#66d9ef>true</span>);  
</span></span><span style=display:flex><span>        globalConfig.<span style=color:#a6e22e>enableTableDef</span>();
</span></span><span style=display:flex><span>        globalConfig.<span style=color:#a6e22e>enableMapper</span>();  
</span></span><span style=display:flex><span>        globalConfig.<span style=color:#a6e22e>enableMapperXml</span>();  
</span></span><span style=display:flex><span>        globalConfig.<span style=color:#a6e22e>enableService</span>();  
</span></span><span style=display:flex><span>        globalConfig.<span style=color:#a6e22e>enableServiceImpl</span>().<span style=color:#a6e22e>setCacheExample</span>(<span style=color:#66d9ef>true</span>);
</span></span><span style=display:flex><span>        globalConfig.<span style=color:#a6e22e>enableController</span>();  
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 返回MyBatisFlex生成器配置对象  </span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> globalConfig;  
</span></span><span style=display:flex><span>    }  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>/***  
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * 获取Hikari数据源对象  
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *  
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @return Hikari数据源对象  
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> DataSource <span style=color:#a6e22e>getDataSource</span>() {  
</span></span><span style=display:flex><span>        HikariDataSource dataSource <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HikariDataSource();  
</span></span><span style=display:flex><span>        dataSource.<span style=color:#a6e22e>setUsername</span>(MYSQL_USERNAME);  
</span></span><span style=display:flex><span>        dataSource.<span style=color:#a6e22e>setPassword</span>(MYSQL_PASSWORD);  
</span></span><span style=display:flex><span>		dataSource.<span style=color:#a6e22e>setJdbcUrl</span>(<span style=color:#e6db74>&#34;jdbc:mysql://&#34;</span> <span style=color:#f92672>+</span> MYSQL_HOST <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;/&#34;</span> <span style=color:#f92672>+</span> DB_NAME  
</span></span><span style=display:flex><span>		        <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;?serverTimezone=Asia/Shanghai&#34;</span>  
</span></span><span style=display:flex><span>		        <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;&amp;useUnicode=true&amp;characterEncoding=utf-8&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> dataSource;  
</span></span><span style=display:flex><span>    }   
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=6><li>开发生成器类 `Codegen:<ul><li><code>TableDef</code> 对象: 一个用于操作表及表字段的辅助类。</li></ul></li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> com.lsx.gen;  
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> com.mybatisflex.codegen.Generator;  
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> com.mybatisflex.codegen.config.GlobalConfig;  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Codegen</span> {  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>/** MySQL主机地址 */</span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> String MYSQL_HOST <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;192.168.40.77:3306&#34;</span>;  
</span></span><span style=display:flex><span>    <span style=color:#75715e>/** 数据库名 */</span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> String DB_NAME <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;lesson&#34;</span>;  
</span></span><span style=display:flex><span>    <span style=color:#75715e>/** 数据库账号 */</span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> String MYSQL_USERNAME <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;lsx&#34;</span>;  
</span></span><span style=display:flex><span>    <span style=color:#75715e>/** 数据库密码 */</span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> String MYSQL_PASSWORD <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;lsx&#34;</span>;  
</span></span><span style=display:flex><span>    <span style=color:#75715e>/** 作者 */</span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> String AUTHOR <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;lsx&#34;</span>;  
</span></span><span style=display:flex><span>    <span style=color:#75715e>/** 子模块名: 指定生成到哪个子项目中 */</span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> String MODULE_NAME <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;lesson-mybatis-flex&#34;</span>;  
</span></span><span style=display:flex><span>    <span style=color:#75715e>/** 根包 */</span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> String BASE_PACKAGE <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;com.lsx&#34;</span>;  
</span></span><span style=display:flex><span>    <span style=color:#75715e>/** 数据库表名前缀 */</span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> String<span style=color:#f92672>[]</span> TABLE_PREFIX <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#34;ums_&#34;</span>, <span style=color:#e6db74>&#34;pms_&#34;</span>, <span style=color:#e6db74>&#34;oms_&#34;</span>, <span style=color:#e6db74>&#34;cms_&#34;</span>};  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span>(String<span style=color:#f92672>[]</span> args) {  
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 将 BigDecimal 类型转为 Double 类型    </span>
</span></span><span style=display:flex><span>        JdbcTypeMapping.<span style=color:#a6e22e>registerMapping</span>(BigDecimal.<span style=color:#a6e22e>class</span>, Double.<span style=color:#a6e22e>class</span>);  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>new</span> Generator(getDataSource(), getGlobalConfig()).<span style=color:#a6e22e>generate</span>();  
</span></span><span style=display:flex><span>    } 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**  
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * 获取MyBatisFlex生成器配置对象  
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *  
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @return MyBatisFlex生成器配置对象  
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> GlobalConfig <span style=color:#a6e22e>getGlobalConfig</span>() {  
</span></span><span style=display:flex><span>        GlobalConfig globalConfig <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> GlobalConfig();  
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 注释配置: 作者    </span>
</span></span><span style=display:flex><span>        globalConfig.<span style=color:#a6e22e>getJavadocConfig</span>().<span style=color:#a6e22e>setAuthor</span>(AUTHOR);  
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 包配置: src目录，mapper配置文件目录，根包    </span>
</span></span><span style=display:flex><span>        globalConfig.<span style=color:#a6e22e>getPackageConfig</span>()  
</span></span><span style=display:flex><span>                .<span style=color:#a6e22e>setSourceDir</span>(MODULE_NAME <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;/src/main/java&#34;</span>)  
</span></span><span style=display:flex><span>                .<span style=color:#a6e22e>setMapperXmlPath</span>(MODULE_NAME <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;/src/main/resources/mapper&#34;</span>)  
</span></span><span style=display:flex><span>                .<span style=color:#a6e22e>setBasePackage</span>(BASE_PACKAGE);  
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 策略配置: 表前缀，数据库名，忽略哪些表    </span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 可调用 setGenerateTable() 来指定生成哪些表: 未配置时，默认生成指定数据库下的所有表  </span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 可调用 setUnGenerateTable() 来指定排除哪些表: 未配置时，不排除任何表  </span>
</span></span><span style=display:flex><span>        globalConfig.<span style=color:#a6e22e>getStrategyConfig</span>()  
</span></span><span style=display:flex><span>                .<span style=color:#a6e22e>setTablePrefix</span>(TABLE_PREFIX)  
</span></span><span style=display:flex><span>                .<span style=color:#a6e22e>setGenerateSchema</span>(DB_NAME);  
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 生成实体类，辅助类，Mapper接口，Mapper配置，Service接口，Service实现类和Controller控制器  </span>
</span></span><span style=display:flex><span>        globalConfig.<span style=color:#a6e22e>enableEntity</span>().<span style=color:#a6e22e>setWithLombok</span>(<span style=color:#66d9ef>true</span>);  
</span></span><span style=display:flex><span>        globalConfig.<span style=color:#a6e22e>enableTableDef</span>();
</span></span><span style=display:flex><span>        globalConfig.<span style=color:#a6e22e>enableMapper</span>();  
</span></span><span style=display:flex><span>        globalConfig.<span style=color:#a6e22e>enableMapperXml</span>();  
</span></span><span style=display:flex><span>        globalConfig.<span style=color:#a6e22e>enableService</span>();  
</span></span><span style=display:flex><span>        globalConfig.<span style=color:#a6e22e>enableServiceImpl</span>().<span style=color:#a6e22e>setCacheExample</span>(<span style=color:#66d9ef>true</span>);
</span></span><span style=display:flex><span>        globalConfig.<span style=color:#a6e22e>enableController</span>();  
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 返回MyBatisFlex生成器配置对象  </span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> globalConfig;  
</span></span><span style=display:flex><span>    }  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>/***  
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * 获取Hikari数据源对象  
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *  
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @return Hikari数据源对象  
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> DataSource <span style=color:#a6e22e>getDataSource</span>() {  
</span></span><span style=display:flex><span>        HikariDataSource dataSource <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HikariDataSource();  
</span></span><span style=display:flex><span>        dataSource.<span style=color:#a6e22e>setUsername</span>(MYSQL_USERNAME);  
</span></span><span style=display:flex><span>        dataSource.<span style=color:#a6e22e>setPassword</span>(MYSQL_PASSWORD);  
</span></span><span style=display:flex><span>		dataSource.<span style=color:#a6e22e>setJdbcUrl</span>(<span style=color:#e6db74>&#34;jdbc:mysql://&#34;</span> <span style=color:#f92672>+</span> MYSQL_HOST <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;/&#34;</span> <span style=color:#f92672>+</span> DB_NAME  
</span></span><span style=display:flex><span>		        <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;?serverTimezone=Asia/Shanghai&#34;</span>  
</span></span><span style=display:flex><span>		        <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;&amp;useUnicode=true&amp;characterEncoding=utf-8&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> dataSource;  
</span></span><span style=display:flex><span>    }   
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=7><li>生成代码后:<ul><li>将 <code>entity</code> 整包移动到 <code>lesson-common</code> 子项目的对应位置中，以便复用。</li><li>后续，将其他资源分别移动到 <code>lesson-admin</code> 和 <code>lesson-server</code> 中。</li></ul></li></ol><h2 id=e01-新增方法>E01. 新增方法</h2><blockquote><p>心法: MybatisFlex生成的Mapper接口的新增方法</p></blockquote><table><thead><tr><th>接口方法</th><th>描述</th><th>是否忽略null字段</th></tr></thead><tbody><tr><td><code>insert(entity)</code></td><td>单条插入，主键自增</td><td>不忽略</td></tr><tr><td><code>insertSelective(entity)</code></td><td>单条插入，主键自增</td><td>忽略</td></tr><tr><td><code>insert(entity, ignoreNulls)</code></td><td>单条插入，主键自增</td><td>由参数2决定</td></tr><tr><td><code>insertWithPk(entity)</code></td><td>单条插入带主键的数据</td><td>不忽略</td></tr><tr><td><code>insertSelectiveWithPk(entity)</code></td><td>单条插入带主键的数据</td><td>忽略</td></tr><tr><td><code>insertWithPk(entity, ignoreNulls)</code></td><td>单条插入带主键的数据</td><td>由参数2决定</td></tr><tr><td><code>insertBatch(entities)</code></td><td>批量插入，根据第1条数据构建SQL字段</td><td>不忽略</td></tr><tr><td><code>insertBatch(entities, size)</code></td><td>批量插入，按 <code>size</code> 切分</td><td>不忽略</td></tr><tr><td><code>insertOrUpdate(entity)</code></td><td>存在主键则更新，不存在主键则插入</td><td>不忽略</td></tr><tr><td><code>insertOrUpdateSelective(entity)</code></td><td>存在主键则更新，不存在主键则插入</td><td>忽略</td></tr><tr><td><code>insertOrUpdate(entity, ignoreNulls)</code></td><td>存在主键则更新，不存在主键则插入</td><td>由参数2决定</td></tr></tbody></table><blockquote><p>武技: 测试MybatisFlex生成的Mapper接口的新增方法</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> com.lsx.mapper;  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RunWith</span>(SpringRunner.<span style=color:#a6e22e>class</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@SpringBootTest</span>(classes <span style=color:#f92672>=</span> LessonMybatisFlexApp.<span style=color:#a6e22e>class</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>BannerMapperTest</span> {  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Autowired</span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> BannerMapper bannerMapper;  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Test</span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>insert</span>() {  
</span></span><span style=display:flex><span>        Banner banner <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Banner();  
</span></span><span style=display:flex><span>        banner.<span style=color:#a6e22e>setUrl</span>(<span style=color:#e6db74>&#34;url&#34;</span>);  
</span></span><span style=display:flex><span>        banner.<span style=color:#a6e22e>setInfo</span>(<span style=color:#e6db74>&#34;info&#34;</span>);  
</span></span><span style=display:flex><span>        banner.<span style=color:#a6e22e>setWeight</span>(999L);  
</span></span><span style=display:flex><span>        banner.<span style=color:#a6e22e>setCreated</span>(LocalDateTime.<span style=color:#a6e22e>now</span>());  
</span></span><span style=display:flex><span>        banner.<span style=color:#a6e22e>setUpdated</span>(LocalDateTime.<span style=color:#a6e22e>now</span>());  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 不忽略null值插入，主键自增  </span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 忽略null值使用 bannerMapper.insert(banner, true)        </span>
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(bannerMapper.<span style=color:#a6e22e>insert</span>(banner));  
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(banner);  
</span></span><span style=display:flex><span>    }  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Test</span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>insertBatch</span>() {  
</span></span><span style=display:flex><span>        List<span style=color:#f92672>&lt;</span>Banner<span style=color:#f92672>&gt;</span> list <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ArrayList<span style=color:#f92672>&lt;&gt;</span>();  
</span></span><span style=display:flex><span>        list.<span style=color:#a6e22e>add</span>(Banner.<span style=color:#a6e22e>builder</span>()  
</span></span><span style=display:flex><span>                .<span style=color:#a6e22e>info</span>(<span style=color:#e6db74>&#34;url2&#34;</span>)  
</span></span><span style=display:flex><span>                .<span style=color:#a6e22e>url</span>(<span style=color:#e6db74>&#34;url2&#34;</span>)  
</span></span><span style=display:flex><span>                .<span style=color:#a6e22e>weight</span>(222L)  
</span></span><span style=display:flex><span>                .<span style=color:#a6e22e>created</span>(LocalDateTime.<span style=color:#a6e22e>now</span>())  
</span></span><span style=display:flex><span>                .<span style=color:#a6e22e>updated</span>(LocalDateTime.<span style=color:#a6e22e>now</span>())  
</span></span><span style=display:flex><span>                .<span style=color:#a6e22e>build</span>());  
</span></span><span style=display:flex><span>        list.<span style=color:#a6e22e>add</span>(Banner.<span style=color:#a6e22e>builder</span>()  
</span></span><span style=display:flex><span>                .<span style=color:#a6e22e>info</span>(<span style=color:#e6db74>&#34;url3&#34;</span>)  
</span></span><span style=display:flex><span>                .<span style=color:#a6e22e>url</span>(<span style=color:#e6db74>&#34;url3&#34;</span>)  
</span></span><span style=display:flex><span>                .<span style=color:#a6e22e>weight</span>(333L)  
</span></span><span style=display:flex><span>                .<span style=color:#a6e22e>created</span>(LocalDateTime.<span style=color:#a6e22e>now</span>())  
</span></span><span style=display:flex><span>                .<span style=color:#a6e22e>updated</span>(LocalDateTime.<span style=color:#a6e22e>now</span>())  
</span></span><span style=display:flex><span>                .<span style=color:#a6e22e>build</span>());  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 批量插入不忽略null值  </span>
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(bannerMapper.<span style=color:#a6e22e>insertBatch</span>(list,1));  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 批量插入无法看到主键回注效果  </span>
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(list);  
</span></span><span style=display:flex><span>    }  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=e02-删除方法>E02. 删除方法</h2><blockquote><p>心法: MybatisFlex生成的Mapper接口的删除方法</p></blockquote><table><thead><tr><th>接口方法</th><th>描述</th></tr></thead><tbody><tr><td><code>deleteById(id)</code></td><td>单条删除，按主键删除</td></tr><tr><td><code>delete(entity)</code></td><td>单条删除，按实体类中的主键删除</td></tr><tr><td><code>deleteBatchByIds(ids)</code></td><td>批量删除，按主键数组删除</td></tr><tr><td><code>deleteBatchByIds(ids, size)</code></td><td>批量删除，按 <code>size</code> 切分</td></tr><tr><td><code>deleteByQuery(queryWrapper)</code></td><td>条件删除，按QueryWrapper条件删除</td></tr></tbody></table><blockquote><p>武技: 测试MybatisFlex生成的Mapper接口的删除方法</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> com.lsx.mapper;    
</span></span><span style=display:flex><span><span style=color:#f92672>import static</span> com.lsx.entity.table.BannerTableDef.BANNER;  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RunWith</span>(SpringRunner.<span style=color:#a6e22e>class</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@SpringBootTest</span>(classes <span style=color:#f92672>=</span> LessonMybatisFlexApp.<span style=color:#a6e22e>class</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>BannerMapperTest</span> {  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Autowired</span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> BannerMapper bannerMapper;  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Test</span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>deleteById</span>(){  
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(bannerMapper.<span style=color:#a6e22e>deleteById</span>(17L));  
</span></span><span style=display:flex><span>    }  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Test</span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>deleteBatchByIds</span>(){  
</span></span><span style=display:flex><span>        List<span style=color:#f92672>&lt;</span>Long<span style=color:#f92672>&gt;</span> ids <span style=color:#f92672>=</span> List.<span style=color:#a6e22e>of</span>(13L, 14L, 15L, 16L);  
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(bannerMapper.<span style=color:#a6e22e>deleteBatchByIds</span>(ids, 2));  
</span></span><span style=display:flex><span>    }  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Test</span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>deleteByQuery</span>(){  
</span></span><span style=display:flex><span>        QueryWrapper queryWrapper <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> QueryWrapper();  
</span></span><span style=display:flex><span>        queryWrapper.<span style=color:#a6e22e>where</span>(BANNER.<span style=color:#a6e22e>ID</span>.<span style=color:#a6e22e>le</span>(11));  
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(bannerMapper.<span style=color:#a6e22e>deleteByQuery</span>(queryWrapper));  
</span></span><span style=display:flex><span>    }  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=e03-修改方法>E03. 修改方法</h2><blockquote><p>心法: MybatisFlex生成的Mapper接口的修改方法</p></blockquote><table><thead><tr><th>接口方法</th><th>描述</th></tr></thead><tbody><tr><td><code>update(entity)</code></td><td>按主键修改数据，忽略null值</td></tr><tr><td><code>update(entity, ignoreNulls)</code></td><td>按主键修改数据，指定是否忽略null值</td></tr><tr><td><code>updateByQuery(entity, queryWrapper)</code></td><td>按QueryWrapper条件修改</td></tr><tr><td><code>updateByQuery(entity, ignoreNulls, queryWrapper)</code></td><td>按QueryWrapper条件修改，指定是否忽略null值</td></tr></tbody></table><blockquote><p>武技: 测试MybatisFlex生成的Mapper接口的修改方法</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> com.lsx.mapper;  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RunWith</span>(SpringRunner.<span style=color:#a6e22e>class</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@SpringBootTest</span>(classes <span style=color:#f92672>=</span> LessonMybatisFlexApp.<span style=color:#a6e22e>class</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>BannerMapperTest</span> {  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Autowired</span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> BannerMapper bannerMapper;  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Test</span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>update</span>() {  
</span></span><span style=display:flex><span>        Banner banner <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Banner();  
</span></span><span style=display:flex><span>        banner.<span style=color:#a6e22e>setId</span>(18L);  
</span></span><span style=display:flex><span>        banner.<span style=color:#a6e22e>setUrl</span>(<span style=color:#e6db74>&#34;url2&#34;</span>);  
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 忽略null值按主键修改  </span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 不忽略null值使用 bannerMapper.update(banner, false)        </span>
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(bannerMapper.<span style=color:#a6e22e>update</span>(banner));  
</span></span><span style=display:flex><span>    }  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Test</span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>updateByQuery</span>() {  
</span></span><span style=display:flex><span>	    <span style=color:#75715e>// 修改字段</span>
</span></span><span style=display:flex><span>        Banner banner <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Banner();  
</span></span><span style=display:flex><span>        banner.<span style=color:#a6e22e>setUrl</span>(<span style=color:#e6db74>&#34;url4&#34;</span>);  
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 修改条件</span>
</span></span><span style=display:flex><span>        QueryWrapper queryWrapper <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> QueryWrapper();  
</span></span><span style=display:flex><span>        queryWrapper.<span style=color:#a6e22e>where</span>(BANNER.<span style=color:#a6e22e>ID</span>.<span style=color:#a6e22e>eq</span>(18L));  
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 忽略null值，按QueryWrapper条件修改  </span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 不忽略null值使用 bannerMapper.updateByCondition(banner, false, queryWrapper)        </span>
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(bannerMapper.<span style=color:#a6e22e>updateByQuery</span>(banner, queryWrapper));  
</span></span><span style=display:flex><span>    }  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=e04-查询方法>E04. 查询方法</h2><blockquote><p>心法: MybatisFlex生成的Mapper接口的查询方法</p></blockquote><table><thead><tr><th>接口方法</th><th>描述</th></tr></thead><tbody><tr><td><code>selectOneById(id)</code></td><td>单条查询，按主键查询</td></tr><tr><td><code>selectOneByEntityId(entity)</code></td><td>单条查询，按实体类中的主键查询</td></tr><tr><td><code>selectOneByQuery(queryWrapper)</code></td><td>单条查询，按QueryWrapper条件查询</td></tr><tr><td><code>selectListByIds(ids)</code></td><td>批量查询，按主键数组查询</td></tr><tr><td><code>selectListByQuery(queryWrapper)</code></td><td>批量查询，按QueryWrapper条件查询</td></tr><tr><td><code>selectAll()</code></td><td>全量查询，查询全部数据</td></tr><tr><td><code>selectObjectByQuery(queryWrapper)</code></td><td>单字段查询，返回1个结果，需使用 <code>select()</code> 设置1个查询字段</td></tr><tr><td><code>selectObjectListByQuery(queryWrapper)</code></td><td>单字段查询，返回1列结果，需使用 <code>select()</code> 设置1个查询字段</td></tr><tr><td><code>selectCountByQuery(queryWrapper)</code></td><td>行数查询，返回结果集条目数</td></tr></tbody></table><blockquote><p>武技: 测试MybatisFlex生成的Mapper接口的查询方法</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> com.lsx.mapper;  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RunWith</span>(SpringRunner.<span style=color:#a6e22e>class</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@SpringBootTest</span>(classes <span style=color:#f92672>=</span> LessonMybatisFlexApp.<span style=color:#a6e22e>class</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>BannerMapperTest</span> {  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Autowired</span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> BannerMapper bannerMapper;  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Test</span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>selectOneById</span>() {  
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(bannerMapper.<span style=color:#a6e22e>selectOneById</span>(1L));  
</span></span><span style=display:flex><span>    }  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Test</span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>selectOneByQuery</span>() {  
</span></span><span style=display:flex><span>        QueryWrapper queryWrapper <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> QueryWrapper();  
</span></span><span style=display:flex><span>        queryWrapper.<span style=color:#a6e22e>where</span>(BANNER.<span style=color:#a6e22e>ID</span>.<span style=color:#a6e22e>eq</span>(1L));  
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(bannerMapper.<span style=color:#a6e22e>selectOneByQuery</span>(queryWrapper));  
</span></span><span style=display:flex><span>    }  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Test</span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>selectListByIds</span>() {  
</span></span><span style=display:flex><span>        bannerMapper.<span style=color:#a6e22e>selectListByIds</span>(List.<span style=color:#a6e22e>of</span>(1L, 2L)).<span style=color:#a6e22e>forEach</span>(System.<span style=color:#a6e22e>out</span>::println);  
</span></span><span style=display:flex><span>    }  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Test</span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>selectListByQuery</span>() {  
</span></span><span style=display:flex><span>        QueryWrapper queryWrapper <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> QueryWrapper();  
</span></span><span style=display:flex><span>        queryWrapper.<span style=color:#a6e22e>where</span>(BANNER.<span style=color:#a6e22e>ID</span>.<span style=color:#a6e22e>gt</span>(2L)).<span style=color:#a6e22e>orderBy</span>(BANNER.<span style=color:#a6e22e>WEIGHT</span>.<span style=color:#a6e22e>asc</span>());
</span></span><span style=display:flex><span>        bannerMapper.<span style=color:#a6e22e>selectListByQuery</span>(queryWrapper).<span style=color:#a6e22e>forEach</span>(System.<span style=color:#a6e22e>out</span>::println);  
</span></span><span style=display:flex><span>    }  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Test</span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>selectAll</span>() {  
</span></span><span style=display:flex><span>        bannerMapper.<span style=color:#a6e22e>selectAll</span>().<span style=color:#a6e22e>forEach</span>(System.<span style=color:#a6e22e>out</span>::println);  
</span></span><span style=display:flex><span>    }  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Test</span>  
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>selectObjectByQuery</span>() {  
</span></span><span style=display:flex><span>	    QueryWrapper queryWrapper <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> QueryWrapper();  
</span></span><span style=display:flex><span>	    queryWrapper.<span style=color:#a6e22e>select</span>(BANNER.<span style=color:#a6e22e>URL</span>).<span style=color:#a6e22e>where</span>(BANNER.<span style=color:#a6e22e>ID</span>.<span style=color:#a6e22e>eq</span>(1L));  
</span></span><span style=display:flex><span>	    System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(bannerMapper.<span style=color:#a6e22e>selectObjectByQuery</span>(queryWrapper));  
</span></span><span style=display:flex><span>	}  
</span></span><span style=display:flex><span>	  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Test</span>  
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>selectObjectListByQuery</span>() {  
</span></span><span style=display:flex><span>	    QueryWrapper queryWrapper <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> QueryWrapper();  
</span></span><span style=display:flex><span>	    queryWrapper.<span style=color:#a6e22e>select</span>(BANNER.<span style=color:#a6e22e>URL</span>);  
</span></span><span style=display:flex><span>	    System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(bannerMapper.<span style=color:#a6e22e>selectObjectListByQuery</span>(queryWrapper));  
</span></span><span style=display:flex><span>	}  
</span></span><span style=display:flex><span>	  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Test</span>  
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>selectCountByQuery</span>() {  
</span></span><span style=display:flex><span>	    QueryWrapper queryWrapper <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> QueryWrapper();  
</span></span><span style=display:flex><span>	    System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(bannerMapper.<span style=color:#a6e22e>selectCountByQuery</span>(queryWrapper));  
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=e05-分页查询>E05. 分页查询</h2><blockquote><p>心法: MybatisFlex生成的Mapper接口的分页查询方法</p></blockquote><table><thead><tr><th>接口方法</th><th>描述</th></tr></thead><tbody><tr><td><code>paginate(pageNumber, pageSize, queryWrapper)</code></td><td>分页查询</td></tr></tbody></table><blockquote><p>武技: 测试MybatisFlex生成的Mapper接口的分页查询方法</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> com.lsx.mapper;  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RunWith</span>(SpringRunner.<span style=color:#a6e22e>class</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@SpringBootTest</span>(classes <span style=color:#f92672>=</span> LessonMybatisFlexApp.<span style=color:#a6e22e>class</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>BannerMapperTest</span> {  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Autowired</span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> BannerMapper bannerMapper;  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Test</span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>page</span>() {  
</span></span><span style=display:flex><span>        QueryWrapper queryWrapper <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> QueryWrapper();  
</span></span><span style=display:flex><span>        Integer pageNum <span style=color:#f92672>=</span> 2;  
</span></span><span style=display:flex><span>        Integer pageSize <span style=color:#f92672>=</span> 2;  
</span></span><span style=display:flex><span>        Page<span style=color:#f92672>&lt;</span>Banner<span style=color:#f92672>&gt;</span> pageInfo <span style=color:#f92672>=</span> bannerMapper.<span style=color:#a6e22e>paginate</span>(pageNum, pageSize, queryWrapper);  
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;pageNum: &#34;</span> <span style=color:#f92672>+</span> pageInfo.<span style=color:#a6e22e>getPageNumber</span>());  
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;pageSize: &#34;</span> <span style=color:#f92672>+</span> pageInfo.<span style=color:#a6e22e>getPageSize</span>());  
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;total: &#34;</span> <span style=color:#f92672>+</span> pageInfo.<span style=color:#a6e22e>getTotalRow</span>());  
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;pages: &#34;</span> <span style=color:#f92672>+</span> pageInfo.<span style=color:#a6e22e>getTotalPage</span>());  
</span></span><span style=display:flex><span>        pageInfo.<span style=color:#a6e22e>getRecords</span>().<span style=color:#a6e22e>forEach</span>(System.<span style=color:#a6e22e>out</span>::println);  
</span></span><span style=display:flex><span>    } 
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=e06-一对多查询>E06. 一对多查询</h2><blockquote><p>心法: MybatisFlex生成的Mapper接口的一对多关联查询</p></blockquote><ul><li>关联查询时，需要使用 <code>**WithRelations**</code> 的API方法才能生效，如 <code>selectOneWithRelationsByQuery</code> 等。</li><li>关联查询时，默认递归深度为3，可以在查询前通过 <code>RelationManager.setMaxDepth(N)</code> 调整为 <code>N</code> 值。</li></ul><blockquote><p>武技: 测试MybatisFlex生成的Mapper接口的一对多关联查询</p></blockquote><ol><li>在实体类 <code>Course</code> 中埋一个 <code>List&lt;Season></code> 属性，表示1对N关系:<ul><li><code>selfField = "本表主键"</code>: 可省略。</li><li><code>targetField = "他表外键</code>: 不可省略。</li></ul></li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> com.lsx.entity;  
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Data</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Builder</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@NoArgsConstructor</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@AllArgsConstructor</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Table</span>(value <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;pms_course&#34;</span>, schema <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;lesson&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Course</span> <span style=color:#66d9ef>implements</span> Serializable {  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>/** 1个课程中 包括 N个季 */</span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@RelationOneToMany</span>(selfField <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;id&#34;</span>, targetField <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;fkCourseId&#34;</span>)  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> List<span style=color:#f92672>&lt;</span>Season<span style=color:#f92672>&gt;</span> seasons;  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=2><li>在实体类 <code>Season</code> 中埋一个 <code>List&lt;Episode></code> 属性，表示1对N关系:<ul><li><code>selfField = "本表主键"</code>: 可省略。</li><li><code>targetField = "他表外键</code>: 不可省略。</li></ul></li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> com.lsx.entity;  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Data</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Builder</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@NoArgsConstructor</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@AllArgsConstructor</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Table</span>(value <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;pms_season&#34;</span>, schema <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;lesson&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Season</span> <span style=color:#66d9ef>implements</span> Serializable {  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>/** 1个季中 包括 N个集 */</span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@RelationOneToMany</span>(targetField <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;fkSeasonId&#34;</span>)  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> List<span style=color:#f92672>&lt;</span>Episode<span style=color:#f92672>&gt;</span> episodes;  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=3><li>测试一对多联查:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> com.lsx.mapper;  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RunWith</span>(SpringRunner.<span style=color:#a6e22e>class</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@SpringBootTest</span>(classes <span style=color:#f92672>=</span> LessonMybatisFlexApp.<span style=color:#a6e22e>class</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>CourseMapperTest</span> {  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Autowired</span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> CourseMapper courseMapper;  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Test</span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>selectOneWithRelationsById</span>() {  
</span></span><span style=display:flex><span>        Course course <span style=color:#f92672>=</span> courseMapper.<span style=color:#a6e22e>selectOneWithRelationsById</span>(1L);  
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;课程: &#34;</span> <span style=color:#f92672>+</span> course);  
</span></span><span style=display:flex><span>        course.<span style=color:#a6e22e>getSeasons</span>().<span style=color:#a6e22e>forEach</span>(s <span style=color:#f92672>-&gt;</span>{  
</span></span><span style=display:flex><span>            System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;季次: &#34;</span> <span style=color:#f92672>+</span> s);  
</span></span><span style=display:flex><span>            season.<span style=color:#a6e22e>getEpisodes</span>().<span style=color:#a6e22e>forEach</span>(e <span style=color:#f92672>-&gt;</span> System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;\t集次: &#34;</span> <span style=color:#f92672>+</span> e));  
</span></span><span style=display:flex><span>        });  
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=e07-多对一查询>E07. 多对一查询</h2><blockquote><p>心法: MybatisFlex生成的Mapper接口的多对一关联查询</p></blockquote><ul><li>关联查询时，需要使用 <code>**WithRelations**</code> 的API方法才能生效，如 <code>selectOneWithRelationsByQuery</code> 等。</li><li>关联查询时，默认递归深度为3，可以在查询前通过 <code>RelationManager.setMaxDepth(N)</code> 调整为 <code>N</code> 值。</li></ul><blockquote><p>武技: 测试MybatisFlex生成的Mapper接口的多对一关联查询</p></blockquote><ol><li>在实体类 <code>Episode</code> 中埋一个 <code>Season</code> 属性，表示N对1关系:<ul><li><code>selfField = "本表的外键"</code>: 不可省略。</li><li><code>targetField = "他表的主键</code>: 可省略。</li></ul></li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> com.lsx.entity;  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#75715e>/** @author lsx*/</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Data</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Builder</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@NoArgsConstructor</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@AllArgsConstructor</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Table</span>(value <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;pms_episode&#34;</span>, schema <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;lesson&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Episode</span> <span style=color:#66d9ef>implements</span> Serializable {  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>/** N个集 对应 1个季 */</span>  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@RelationManyToOne</span>(selfField <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;fkSeasonId&#34;</span>, targetField <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;id&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Season season;  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=2><li>测试多对一联查:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> com.lsx.mapper;  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RunWith</span>(SpringRunner.<span style=color:#a6e22e>class</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@SpringBootTest</span>(classes <span style=color:#f92672>=</span> LessonMybatisFlexApp.<span style=color:#a6e22e>class</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>EpisodeMapperTest</span> {  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Autowired</span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> EpisodeMapper episodeMapper;  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Test</span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>selectOneWithRelationsById</span>() {  
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 递归深度为1，默认为3  </span>
</span></span><span style=display:flex><span>        RelationManager.<span style=color:#a6e22e>setMaxDepth</span>(1);  
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(episodeMapper.<span style=color:#a6e22e>selectOneWithRelationsById</span>(1L));  
</span></span><span style=display:flex><span>    }  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=e08-多对多查询>E08. 多对多查询</h2><blockquote><p>心法: MybatisFlex生成的Mapper接口的多对多关联查询</p></blockquote><ul><li>关联查询时，需要使用 <code>**WithRelations**</code> 的API方法才能生效，如 <code>selectOneWithRelationsByQuery</code> 等。</li><li>关联查询时，默认递归深度为3，可以在查询前通过 <code>RelationManager.setMaxDepth(N)</code> 调整为 <code>N</code> 值。</li></ul><blockquote><p>武技: 测试MybatisFlex生成的Mapper接口的多对多关联查询</p></blockquote><ol><li>在实体类 <code>Member</code> 中埋一个 <code>List&lt;Member></code> 属性，表示N对N关系:<ul><li><code>selfField = "本表的主键"</code>: 可省略。</li><li><code>targetField = "他表的主键</code>: 可省略。</li><li><code>joinTable = "中间表表名</code>: 不可省略。</li><li><code>joinSelfColumn = "本表对应的中间表外键</code>: 不可省略。</li><li><code>joinTargetColumn = "他表对应的中间表外键</code>: 不可省略。</li></ul></li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> com.lsx.entity;  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Data</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Builder</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@NoArgsConstructor</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@AllArgsConstructor</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Table</span>(value <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;ums_member&#34;</span>, schema <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;lesson&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Member</span> <span style=color:#66d9ef>implements</span> Serializable {  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/** 1个会员对应N个粉丝，1个粉丝对应N个会员 */</span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@RelationManyToMany</span>(  
</span></span><span style=display:flex><span>		    selfField <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;id&#34;</span>,  
</span></span><span style=display:flex><span>			targetField <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;id&#34;</span>,
</span></span><span style=display:flex><span>            joinTable <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;ums_member_fan&#34;</span>,  
</span></span><span style=display:flex><span>            joinSelfColumn <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;fk_member_id&#34;</span>,  
</span></span><span style=display:flex><span>            joinTargetColumn <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;fk_fan_id&#34;</span>  
</span></span><span style=display:flex><span>    )  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> List<span style=color:#f92672>&lt;</span>Member<span style=color:#f92672>&gt;</span> fans;    
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=2><li>测试多对多联查:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> com.lsx.mapper;  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RunWith</span>(SpringRunner.<span style=color:#a6e22e>class</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@SpringBootTest</span>(classes <span style=color:#f92672>=</span> LessonMybatisFlexApp.<span style=color:#a6e22e>class</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MemberMapperTest</span> {  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Autowired</span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> MemberMapper memberMapper;  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Test</span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>selectOneWithRelationsById</span>() {  
</span></span><span style=display:flex><span>        Member member <span style=color:#f92672>=</span> memberMapper.<span style=color:#a6e22e>selectOneWithRelationsById</span>(4L);  
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;会员: &#34;</span> <span style=color:#f92672>+</span> member);  
</span></span><span style=display:flex><span>        member.<span style=color:#a6e22e>getFans</span>().<span style=color:#a6e22e>forEach</span>(m <span style=color:#f92672>-&gt;</span> System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;\t粉丝: &#34;</span> <span style=color:#f92672>+</span> m));  
</span></span><span style=display:flex><span>    }   
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h1 id=s03-开发搜索子服务>S03. 开发搜索子服务</h1><h2 id=e01-初始项目>E01. 初始项目</h2><blockquote><p>武技: 创建 <code>lesson-search</code> 子项目，并整合ES中间件</p></blockquote><h3 id=1-第三方依赖>1. 第三方依赖</h3><p><code>pom.xml</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#75715e>&lt;!--junit--&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;groupId&gt;</span>junit<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;artifactId&gt;</span>junit<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;!--lombok--&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;groupId&gt;</span>org.projectlombok<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;artifactId&gt;</span>lombok<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;!--hutool--&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;groupId&gt;</span>cn.hutool<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;artifactId&gt;</span>hutool-all<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;!--引入自己的公共项目--&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;groupId&gt;</span>com.lsx<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;artifactId&gt;</span>lesson-common<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;version&gt;</span>1.0-SNAPSHOT<span style=color:#f92672>&lt;/version&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;!--spring-boot-starter-web--&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;groupId&gt;</span>org.springframework.boot<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;artifactId&gt;</span>spring-boot-starter-web<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;!--spring-boot-starter-test--&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;groupId&gt;</span>org.springframework.boot<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;artifactId&gt;</span>spring-boot-starter-test<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;scope&gt;</span>test<span style=color:#f92672>&lt;/scope&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;!--spring-boot-starter-data-elasticsearch--&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;groupId&gt;</span>org.springframework.boot<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;artifactId&gt;</span>spring-boot-starter-data-elasticsearch<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span></code></pre></div><h3 id=2-开发主配项>2. 开发主配项</h3><p><code>classpath:application.properties</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-properties data-lang=properties><span style=display:flex><span><span style=color:#75715e>############################# App ##############################</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#端口号，项目名称，日志配置文件#</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>server.port</span><span style=color:#f92672>=</span><span style=color:#e6db74>5003</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.application.name</span><span style=color:#f92672>=</span><span style=color:#e6db74>lesson-search</span>
</span></span><span style=display:flex><span><span style=color:#75715e>############################# ElasticsearchRestTemplate ##############################</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 指定ES服务器，集群用逗号分隔</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.elasticsearch.rest.uris</span><span style=color:#f92672>=</span><span style=color:#e6db74>http://192.168.40.77:9200</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 忽略CustomConversions的日志警告</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>logging.level.org.springframework.data.convert.CustomConversions</span><span style=color:#f92672>=</span><span style=color:#e6db74>ERROR</span>
</span></span></code></pre></div><h3 id=3-开发启动类>3. 开发启动类</h3><p><code>com.lsx.LessonSearchApp</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@SpringBootApplication</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>LessonSearchApp</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span>(String<span style=color:#f92672>[]</span> args) {
</span></span><span style=display:flex><span>        SpringApplication.<span style=color:#a6e22e>run</span>(LessonSearchApp.<span style=color:#a6e22e>class</span>, args);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=e02-同步数据>E02. 同步数据</h2><blockquote><p>武技: 使用Logstash增量同步MySQL中的课程表</p></blockquote><h3 id=1-创建es索引>1. 创建ES索引</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#75715e># 重建 lesson-course 索引，在body中粘贴 `mapping{}` 内容</span>
</span></span><span style=display:flex><span><span style=color:#75715e># `title` 字段需要在 `fields` 同级额外添加 `&#34;analyzer&#34; : &#34;ik_max_word&#34;` 配置</span>
</span></span><span style=display:flex><span><span style=color:#75715e># `title` 字段需要在 `fields` 同级额外添加 `&#34;search_analyzer&#34; : &#34;ik_smart&#34;` 配置</span>
</span></span><span style=display:flex><span>PUT lesson-course
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;mappings&#34;</span> <span style=color:#960050;background-color:#1e0010>:</span> {
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;properties&#34;</span> <span style=color:#960050;background-color:#1e0010>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;id&#34;</span> <span style=color:#960050;background-color:#1e0010>:</span> { <span style=color:#e6db74>&#34;type&#34;</span> <span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#e6db74>&#34;long&#34;</span> },
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;title&#34;</span> <span style=color:#960050;background-color:#1e0010>:</span> {
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;type&#34;</span> <span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#e6db74>&#34;text&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;fields&#34;</span> <span style=color:#960050;background-color:#1e0010>:</span> { <span style=color:#e6db74>&#34;keyword&#34;</span> <span style=color:#960050;background-color:#1e0010>:</span> { <span style=color:#e6db74>&#34;type&#34;</span> <span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#e6db74>&#34;keyword&#34;</span>, <span style=color:#e6db74>&#34;ignore_above&#34;</span> <span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#ae81ff>256</span> }},
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;analyzer&#34;</span> <span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#e6db74>&#34;ik_max_word&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;search_analyzer&#34;</span> <span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#e6db74>&#34;ik_smart&#34;</span>
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;cover&#34;</span> <span style=color:#960050;background-color:#1e0010>:</span> {
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;type&#34;</span> <span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#e6db74>&#34;text&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;fields&#34;</span> <span style=color:#960050;background-color:#1e0010>:</span> { <span style=color:#e6db74>&#34;keyword&#34;</span> <span style=color:#960050;background-color:#1e0010>:</span> { <span style=color:#e6db74>&#34;type&#34;</span> <span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#e6db74>&#34;keyword&#34;</span>, <span style=color:#e6db74>&#34;ignore_above&#34;</span> <span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#ae81ff>256</span> }}
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;nickname&#34;</span> <span style=color:#960050;background-color:#1e0010>:</span> {
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;type&#34;</span> <span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#e6db74>&#34;text&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#34;fields&#34;</span> <span style=color:#960050;background-color:#1e0010>:</span> { <span style=color:#e6db74>&#34;keyword&#34;</span> <span style=color:#960050;background-color:#1e0010>:</span> { <span style=color:#e6db74>&#34;type&#34;</span> <span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#e6db74>&#34;keyword&#34;</span>, <span style=color:#e6db74>&#34;ignore_above&#34;</span> <span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#ae81ff>256</span> }}
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>		<span style=color:#e6db74>&#34;price&#34;</span> <span style=color:#960050;background-color:#1e0010>:</span> { <span style=color:#e6db74>&#34;type&#34;</span> <span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#e6db74>&#34;float&#34;</span> },
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;star&#34;</span> <span style=color:#960050;background-color:#1e0010>:</span> { <span style=color:#e6db74>&#34;type&#34;</span> <span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#e6db74>&#34;long&#34;</span> },
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;updated&#34;</span> <span style=color:#960050;background-color:#1e0010>:</span> { <span style=color:#e6db74>&#34;type&#34;</span> <span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#e6db74>&#34;date&#34;</span> }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 测试 lesson-course 索引的分词效果</span>
</span></span><span style=display:flex><span>GET lesson-course/_analyze
</span></span><span style=display:flex><span>{ 
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;text&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#e6db74>&#34;JB1-2-Java基础学习&#34;</span>, 
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;analyzer&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#e6db74>&#34;ik_smart&#34;</span> 
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=2-同步表数据>2. 同步表数据</h3><ol><li>创建相关目录：</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 创建Logstash相关目录</span>
</span></span><span style=display:flex><span>mkdir -p /opt/logstash-lesson-course/conf;
</span></span></code></pre></div><ol start=2><li>将 <code>mysql-connector-java-8.0.16.jar</code> 拷贝到 <code>/opt/logstash-lesson-course/</code> 下。</li><li>创建 <code>logstash.yml</code> 配置文件：</li></ol><p><code>touch /opt/logstash-lesson-course/conf/logstash.yml</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># 允许任意主机访问</span>
</span></span><span style=display:flex><span><span style=color:#f92672>http.host</span>: <span style=color:#e6db74>&#34;0.0.0.0&#34;</span>
</span></span><span style=display:flex><span><span style=color:#75715e># ES服务地址</span>
</span></span><span style=display:flex><span><span style=color:#f92672>xpack.monitoring.elasticsearch.hosts</span>: [ <span style=color:#e6db74>&#34;http://192.168.40.77:9200&#34;</span> ]
</span></span></code></pre></div><ol start=4><li>创建 <code>logstash.conf</code> 配置文件：</li></ol><p><code>touch /opt/logstash-lesson-course/conf/logstash.conf</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-properties data-lang=properties><span style=display:flex><span><span style=color:#75715e># logstash 输入模块，从日志或数据库中采集数据</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>input</span> <span style=color:#e6db74>{</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>jdbc</span> <span style=color:#e6db74>{</span>
</span></span><span style=display:flex><span>	    <span style=color:#75715e># MySQL驱动包</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>jdbc_driver_library</span> <span style=color:#f92672>=</span><span style=color:#e6db74>&gt; &#34;/data/mysql-connector-java-8.0.16.jar&#34;</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e># MySQL数据源</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>jdbc_driver_class</span> <span style=color:#f92672>=</span><span style=color:#e6db74>&gt; &#34;com.mysql.cj.jdbc.Driver&#34;</span>
</span></span><span style=display:flex><span>	  	<span style=color:#a6e22e>jdbc_connection_string</span> <span style=color:#f92672>=</span><span style=color:#e6db74>&gt; &#34;jdbc:mysql://192.168.40.77:3306/lesson?characterEncoding=UTF-8&amp;autoReconnect=true&amp;serverTimezone=Asia/Shanghai&#34;</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>jdbc_user</span> <span style=color:#f92672>=</span><span style=color:#e6db74>&gt; &#34;lsx&#34;</span>
</span></span><span style=display:flex><span>	    <span style=color:#a6e22e>jdbc_password</span> <span style=color:#f92672>=</span><span style=color:#e6db74>&gt; &#34;lsx&#34;</span>
</span></span><span style=display:flex><span>	    <span style=color:#75715e># 数据库重连尝试次数</span>
</span></span><span style=display:flex><span>	    <span style=color:#a6e22e>connection_retry_attempts</span> <span style=color:#f92672>=</span><span style=color:#e6db74>&gt; &#34;3&#34;</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e># 是否校验数据库连接：默认false不校验</span>
</span></span><span style=display:flex><span>	    <span style=color:#a6e22e>jdbc_validate_connection</span> <span style=color:#f92672>=</span><span style=color:#e6db74>&gt; &#34;true&#34;</span>
</span></span><span style=display:flex><span>	    <span style=color:#75715e># 校验数据库连接的超时时间：默认3600ms</span>
</span></span><span style=display:flex><span>	    <span style=color:#a6e22e>jdbc_validation_timeout</span> <span style=color:#f92672>=</span><span style=color:#e6db74>&gt; &#34;3600&#34;</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e># 查询语句：通过哪条SQL语句采集数据库记录</span>
</span></span><span style=display:flex><span>	    <span style=color:#a6e22e>statement</span> <span style=color:#f92672>=</span><span style=color:#e6db74>&gt; &#34;select pc.id, pc.price, pc.star, pc.cover, pc.title, um.nickname, pc.updated from lesson.pms_course pc join lesson.ums_member um on pc.fk_member_id = um.id where pc.updated &gt; :sql_last_value&#34;</span>
</span></span><span style=display:flex><span>	    <span style=color:#75715e># 开启分页查询：默认false不开启</span>
</span></span><span style=display:flex><span>	    <span style=color:#a6e22e>jdbc_paging_enabled</span> <span style=color:#f92672>=</span><span style=color:#e6db74>&gt; &#34;true&#34;</span>
</span></span><span style=display:flex><span>	    <span style=color:#75715e># 单次分页查询条数：默认100000</span>
</span></span><span style=display:flex><span>	    <span style=color:#a6e22e>jdbc_page_size</span> <span style=color:#f92672>=</span><span style=color:#e6db74>&gt; &#34;500&#34;</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e># 同步频率：默认 &#34;* * * * *&#34;，表示每分钟同步一次 </span>
</span></span><span style=display:flex><span>		<span style=color:#75715e># CORN表达式：&#34;分 时 天 月 年&#34;</span>
</span></span><span style=display:flex><span>	    <span style=color:#a6e22e>schedule</span> <span style=color:#f92672>=</span><span style=color:#e6db74>&gt; &#34;* * * * *&#34;</span>
</span></span><span style=display:flex><span>	    <span style=color:#75715e># SQL日志等级: 可选 fatal, error, warn, info, debug，默认info；</span>
</span></span><span style=display:flex><span>	    <span style=color:#a6e22e>sql_log_level</span> <span style=color:#f92672>=</span><span style=color:#e6db74>&gt; warn</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># 是否将字段名转换为小写：默认true</span>
</span></span><span style=display:flex><span>	    <span style=color:#a6e22e>lowercase_column_names</span> <span style=color:#f92672>=</span><span style=color:#e6db74>&gt; false</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>############## 增量同步相关配置 ############## </span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e># 开启自定义标识列：false时，标识列默认为当前timestamp的值</span>
</span></span><span style=display:flex><span>	    <span style=color:#a6e22e>use_column_value</span> <span style=color:#f92672>=</span><span style=color:#e6db74>&gt; true</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e># 标识列：用于增量同步，需是数据库字段</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>tracking_column</span> <span style=color:#f92672>=</span><span style=color:#e6db74>&gt; &#34;updated&#34;</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e># 标识列类型：可选 numeric 和 timestamp，默认numeric</span>
</span></span><span style=display:flex><span>	    <span style=color:#a6e22e>tracking_column_type</span> <span style=color:#f92672>=</span><span style=color:#e6db74>&gt; timestamp</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># true：将上次执行结果中的标识列记录在TXT文件中</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># false：不记录</span>
</span></span><span style=display:flex><span>	    <span style=color:#a6e22e>record_last_run</span> <span style=color:#f92672>=</span><span style=color:#e6db74>&gt; true</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e># TXT文件</span>
</span></span><span style=display:flex><span>	    <span style=color:#a6e22e>last_run_metadata_path</span> <span style=color:#f92672>=</span><span style=color:#e6db74>&gt; &#34;/data/last_id.txt&#34;</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e># 是否清除TXT文件记录：增量同步时此配置字段必须设置为false</span>
</span></span><span style=display:flex><span>	    <span style=color:#a6e22e>clean_run</span> <span style=color:#f92672>=</span><span style=color:#e6db74>&gt; false</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>  }</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 过滤移除 @timestamp 和 @version 属性</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>filter</span> <span style=color:#e6db74>{</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>mutate</span> <span style=color:#e6db74>{</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>remove_field</span> <span style=color:#f92672>=</span><span style=color:#e6db74>&gt; [&#34;@timestamp&#34;]</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>	}</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>mutate</span> <span style=color:#e6db74>{</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>remove_field</span> <span style=color:#f92672>=</span><span style=color:#e6db74>&gt; [&#34;@version&#34;]</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>	}</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># logstash 输出模块，将采集好的数据同步至 ES</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>output</span> <span style=color:#e6db74>{</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>elasticsearch</span> <span style=color:#e6db74>{</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e># ES主机地址</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>hosts</span> <span style=color:#f92672>=</span><span style=color:#e6db74>&gt; [&#34;http://192.168.40.77:9200&#34;]</span>
</span></span><span style=display:flex><span>	    <span style=color:#75715e># ES索引名称：名称随意</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>index</span> <span style=color:#f92672>=</span><span style=color:#e6db74>&gt; &#34;lesson-course&#34;</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e># 文档索引：建议使用数据库表主键，该值会注入文档的 _id 字段，缺省时随机生成，会造成数据重复</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>document_id</span> <span style=color:#f92672>=</span><span style=color:#e6db74>&gt; &#34;%{id}&#34;</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>	}</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>stdout</span> <span style=color:#e6db74>{</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>codec</span> <span style=color:#f92672>=</span><span style=color:#e6db74>&gt; json_lines</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>	}</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>}</span>
</span></span></code></pre></div><ol start=5><li>提升两个配置文件的权限：</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 提升两个配置文件权限</span>
</span></span><span style=display:flex><span>chmod -R <span style=color:#ae81ff>777</span> /opt/logstash-lesson-course;
</span></span></code></pre></div><ol start=6><li>创建运行容器</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 创建并运行Logstash容器</span>
</span></span><span style=display:flex><span>docker run -d --name logstash-lesson-course --network my-net -p 4960:4560 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	-v /opt/logstash-lesson-course/conf/logstash.yml:/usr/share/logstash/config/logstash.yml <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	-v /opt/logstash-lesson-course/conf/logstash.conf:/usr/share/logstash/pipeline/logstash.conf <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	-v /opt/logstash-lesson-course:/data <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	logstash:7.11.2
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 查看运行的容器</span>
</span></span><span style=display:flex><span>docker ps --format <span style=color:#e6db74>&#34;{{.ID}}\t{{.Names}}\t{{.Ports}}&#34;</span>
</span></span><span style=display:flex><span>docker logs logstash-lesson-course --tail <span style=color:#ae81ff>30</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 永久开放4960端口</span>
</span></span><span style=display:flex><span>firewall-cmd --add-port<span style=color:#f92672>=</span>4960/tcp --permanent
</span></span><span style=display:flex><span>firewall-cmd --reload
</span></span></code></pre></div><ol start=7><li>在Kibana中添加索引模式 <code>lesson-course</code>，然后查看数据是否已经同步到ES中。</li></ol><h2 id=e03-业务开发>E03. 业务开发</h2><h3 id=1-开发doc实体>1. 开发DOC实体</h3><ol><li>开发DOC实体类：</li></ol><p><code>com.lsx.es.CourseDoc</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Data</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Document</span>(indexName <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;lesson-course&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>CourseDoc</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Id</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Long id;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Field</span>(type <span style=color:#f92672>=</span> FieldType.<span style=color:#a6e22e>Text</span>, analyzer <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;ik_max_word&#34;</span>, searchAnalyzer <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;ik_smart&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String title;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Field</span>(type <span style=color:#f92672>=</span> FieldType.<span style=color:#a6e22e>Keyword</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String cover;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Field</span>(type <span style=color:#f92672>=</span> FieldType.<span style=color:#a6e22e>Text</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String nickname;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Field</span>(type <span style=color:#f92672>=</span> FieldType.<span style=color:#a6e22e>Double</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Double price;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Field</span>(type <span style=color:#f92672>=</span> FieldType.<span style=color:#a6e22e>Date</span>, format <span style=color:#f92672>=</span> DateFormat.<span style=color:#a6e22e>custom</span>,
</span></span><span style=display:flex><span>            pattern <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;yyyy-MM-dd&#39;T&#39;HH:mm:ss.SSS&#39;Z&#39;&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> LocalDateTime updated;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Field</span>(type <span style=color:#f92672>=</span> FieldType.<span style=color:#a6e22e>Integer</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Integer star;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=2-开发业务接口>2. 开发业务接口</h3><ol><li>开发业务方法：</li></ol><p><code>com.lsx.service.CourseService -> searchByTitle()</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> com.lsx.service;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>CourseService</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * 根据课程标题模糊分页搜索课程
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param page  分页实体类
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param title 课程标题
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @return 分页信息
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    PageVO<span style=color:#f92672>&lt;</span>CourseDoc<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>searchByTitle</span>(PageVO<span style=color:#f92672>&lt;</span>Course<span style=color:#f92672>&gt;</span> page, String title);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=2><li>重写业务方法：</li></ol><p><code>com.lsx.service.impl.CourseServiceImpl -> searchByTitle()</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Service</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>CourseServiceImpl</span> <span style=color:#66d9ef>implements</span> CourseService {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Autowired</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> ElasticsearchRestTemplate elasticsearchRestTemplate;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> PageVO<span style=color:#f92672>&lt;</span>CourseDoc<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>searchByTitle</span>(PageVO<span style=color:#f92672>&lt;</span>Course<span style=color:#f92672>&gt;</span> page, String title) {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>long</span> pageNumber <span style=color:#f92672>=</span> page.<span style=color:#a6e22e>getPageNumber</span>();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>long</span> pageSize <span style=color:#f92672>=</span> page.<span style=color:#a6e22e>getPageSize</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 参数处理: 对pageNum进行最小边界保护，规避ES报错，注意ES的分页是从0开始的</span>
</span></span><span style=display:flex><span>        pageNumber <span style=color:#f92672>=</span> pageNumber <span style=color:#f92672>-</span> 1;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (pageNumber <span style=color:#f92672>&lt;</span> 0) pageNumber <span style=color:#f92672>=</span> 0;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// ES: 按标题分页搜索课程</span>
</span></span><span style=display:flex><span>        List<span style=color:#f92672>&lt;</span>CourseDoc<span style=color:#f92672>&gt;</span> courseDocs <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>searchByTitleFromEs</span>(title, pageNumber, pageSize);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// ES: 按标题分页搜索课程数量</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>long</span> total <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>countByTitleFromEs</span>(title);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 组装VO并返回</span>
</span></span><span style=display:flex><span>        PageVO<span style=color:#f92672>&lt;</span>CourseDoc<span style=color:#f92672>&gt;</span> result <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> PageVO<span style=color:#f92672>&lt;&gt;</span>();
</span></span><span style=display:flex><span>        result.<span style=color:#a6e22e>setPageNumber</span>(pageNumber <span style=color:#f92672>+</span> 1);
</span></span><span style=display:flex><span>        result.<span style=color:#a6e22e>setPageSize</span>(pageSize);
</span></span><span style=display:flex><span>        result.<span style=color:#a6e22e>setTotalRow</span>(total);
</span></span><span style=display:flex><span>        result.<span style=color:#a6e22e>setTotalPage</span>(total <span style=color:#f92672>/</span> pageSize <span style=color:#f92672>+</span> (total <span style=color:#f92672>%</span> pageSize <span style=color:#f92672>==</span> 0 <span style=color:#f92672>?</span> 0 : 1));
</span></span><span style=display:flex><span>        result.<span style=color:#a6e22e>setRecords</span>(courseDocs);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> result;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * 从ES中，按标题分页搜索课程，返回符合条件的的课程个数
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param title 课程标题
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @return 返回符合条件的的课程个数
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Long <span style=color:#a6e22e>countByTitleFromEs</span>(String title) {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 构建本地搜索器: 绑定条件查询器</span>
</span></span><span style=display:flex><span>        Query query <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> NativeSearchQueryBuilder()
</span></span><span style=display:flex><span>                .<span style=color:#a6e22e>withQuery</span>(QueryBuilders.<span style=color:#a6e22e>matchQuery</span>(<span style=color:#e6db74>&#34;title&#34;</span>, title))
</span></span><span style=display:flex><span>                .<span style=color:#a6e22e>build</span>();
</span></span><span style=display:flex><span>        <span style=color:#75715e>// ES: 按标题分页搜索课程，返回符合条件的的课程</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> elasticsearchRestTemplate.<span style=color:#a6e22e>count</span>(query, CourseDoc.<span style=color:#a6e22e>class</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * 从ES中，按标题分页搜索课程
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param title      课程标题
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param pageNumber 当前第几页
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param pageSize   每页多少条
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @return 符合条件的ES数据
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> List<span style=color:#f92672>&lt;</span>CourseDoc<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>searchByTitleFromEs</span>(String title, <span style=color:#66d9ef>long</span> pageNumber, <span style=color:#66d9ef>long</span> pageSize) {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        List<span style=color:#f92672>&lt;</span>CourseDoc<span style=color:#f92672>&gt;</span> result <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ArrayList<span style=color:#f92672>&lt;&gt;</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 构建本地搜索器: 条件查询器，分页数据，结果集按分数倒序，符和条件的词语倾斜高亮</span>
</span></span><span style=display:flex><span>        Query query <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> NativeSearchQueryBuilder()
</span></span><span style=display:flex><span>                .<span style=color:#a6e22e>withQuery</span>(QueryBuilders.<span style=color:#a6e22e>matchQuery</span>(<span style=color:#e6db74>&#34;title&#34;</span>, title))
</span></span><span style=display:flex><span>                .<span style=color:#a6e22e>withPageable</span>(PageRequest.<span style=color:#a6e22e>of</span>((<span style=color:#66d9ef>int</span>) pageNumber, (<span style=color:#66d9ef>int</span>) pageSize))
</span></span><span style=display:flex><span>                .<span style=color:#a6e22e>withSort</span>(SortBuilders.<span style=color:#a6e22e>fieldSort</span>(<span style=color:#e6db74>&#34;_score&#34;</span>).<span style=color:#a6e22e>order</span>(SortOrder.<span style=color:#a6e22e>DESC</span>))
</span></span><span style=display:flex><span>                .<span style=color:#a6e22e>withHighlightFields</span>(<span style=color:#66d9ef>new</span> HighlightBuilder.<span style=color:#a6e22e>Field</span>(<span style=color:#e6db74>&#34;title&#34;</span>))
</span></span><span style=display:flex><span>                .<span style=color:#a6e22e>build</span>();
</span></span><span style=display:flex><span>        <span style=color:#75715e>// ES: 按条件搜索数据</span>
</span></span><span style=display:flex><span>        SearchHits<span style=color:#f92672>&lt;</span>CourseDoc<span style=color:#f92672>&gt;</span> searchHits <span style=color:#f92672>=</span> elasticsearchRestTemplate.<span style=color:#a6e22e>search</span>(query, CourseDoc.<span style=color:#a6e22e>class</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 若搜索成功，则将结果转为List类型的数据并返回</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>searchHits.<span style=color:#a6e22e>isEmpty</span>()) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>for</span> (SearchHit<span style=color:#f92672>&lt;</span>CourseDoc<span style=color:#f92672>&gt;</span> searchHit : searchHits) {
</span></span><span style=display:flex><span>                result.<span style=color:#a6e22e>add</span>(searchHit.<span style=color:#a6e22e>getContent</span>());
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> result;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=3><li>测试业务方法：</li></ol><p><code>service.CourseServiceTest -> searchByTitle()</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RunWith</span>(SpringRunner.<span style=color:#a6e22e>class</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>@SpringBootTest</span>(classes <span style=color:#f92672>=</span> LessonSearchApp.<span style=color:#a6e22e>class</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>CourseServiceTest</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Autowired</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> CourseService courseService;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>searchByTitle</span>() {
</span></span><span style=display:flex><span>        PageVO<span style=color:#f92672>&lt;</span>Course<span style=color:#f92672>&gt;</span> pageVo <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> PageVO<span style=color:#f92672>&lt;&gt;</span>();
</span></span><span style=display:flex><span>        pageVo.<span style=color:#a6e22e>setPageNumber</span>(1L);
</span></span><span style=display:flex><span>        pageVo.<span style=color:#a6e22e>setPageSize</span>(10L);
</span></span><span style=display:flex><span>        PageVO<span style=color:#f92672>&lt;</span>CourseDoc<span style=color:#f92672>&gt;</span> result <span style=color:#f92672>=</span> courseService.<span style=color:#a6e22e>searchByTitle</span>(pageVo, <span style=color:#e6db74>&#34;服务&#34;</span>);
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;pageNum: &#34;</span> <span style=color:#f92672>+</span> result.<span style=color:#a6e22e>getPageNumber</span>());
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;pageSize: &#34;</span> <span style=color:#f92672>+</span> result.<span style=color:#a6e22e>getPageSize</span>());
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;total: &#34;</span> <span style=color:#f92672>+</span> result.<span style=color:#a6e22e>getTotalRow</span>());
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;records: &#34;</span>);
</span></span><span style=display:flex><span>        result.<span style=color:#a6e22e>getRecords</span>().<span style=color:#a6e22e>forEach</span>(System.<span style=color:#a6e22e>out</span>::println);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=3-开发控制方法>3. 开发控制方法</h3><ol start=4><li>开发控制方法 <code>VideoController -> searchByVideoTitle()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> com.lsx.controller;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RestController</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RequestMapping</span>(<span style=color:#e6db74>&#34;/api/v1/video&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>VideoController</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Autowired</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> VideoService videoService;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@GetMapping</span>(<span style=color:#e6db74>&#34;/searchByVideoTitle&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Result <span style=color:#a6e22e>searchByVideoTitle</span>(<span style=color:#a6e22e>@RequestParam</span> Integer pageNum, <span style=color:#a6e22e>@RequestParam</span> Integer pageSize,
</span></span><span style=display:flex><span>                                     <span style=color:#a6e22e>@RequestParam</span> String videoTitle) {
</span></span><span style=display:flex><span>        VideoSearchVo result <span style=color:#f92672>=</span> videoService.<span style=color:#a6e22e>searchByVideoTitle</span>(pageNum, pageSize, videoTitle);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> Result(result);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=5><li>访问控制方法 <code>VideoController -> searchByVideoTitle()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#75715e>## 按视频标题搜索视频</span>
</span></span><span style=display:flex><span>GET http<span style=color:#960050;background-color:#1e0010>:</span>//localhost<span style=color:#960050;background-color:#1e0010>:</span><span style=color:#ae81ff>5003</span>/api/v1/video/searchByVideoTitle<span style=color:#66d9ef>?</span>pageNum=<span style=color:#ae81ff>1</span>&amp;pageSize=<span style=color:#ae81ff>10</span>&amp;videoTitle=JB
</span></span><span style=display:flex><span>Accept<span style=color:#960050;background-color:#1e0010>:</span> application/json
</span></span></code></pre></div><h2 id=e04-部署项目>E04. 部署项目</h2><blockquote><p>武技：在Docker中部署 <code>lesson-search</code> 项目</p></blockquote><h3 id=1-打包项目>1. 打包项目</h3><ol><li>将主配中的全部IP地址由 <code>localhost</code> 改为 <code>192.168.40.77</code> 虚拟机地址。</li><li>在子项目 <code>lesson-search</code> 中添加打包插件：</li></ol><p><code>pom.xml</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#75715e>&lt;!--项目打包--&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;build&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>&lt;!--最终Jar包名--&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;finalName&gt;</span>lesson-search<span style=color:#f92672>&lt;/finalName&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;plugins&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>&lt;!--SpringBoot打包插件--&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;plugin&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>&lt;groupId&gt;</span>org.springframework.boot<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>&lt;artifactId&gt;</span>spring-boot-maven-plugin<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>&lt;version&gt;</span>2.4.8<span style=color:#f92672>&lt;/version&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>&lt;!--配置启动类--&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>&lt;configuration&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>&lt;mainClass&gt;</span>com.lsx.LessonSearchApp<span style=color:#f92672>&lt;/mainClass&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>&lt;/configuration&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>&lt;!--打包本项目全部依赖包到最终Jar包内--&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>&lt;executions&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>&lt;execution&gt;</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&lt;goals&gt;</span>
</span></span><span style=display:flex><span>                        <span style=color:#f92672>&lt;goal&gt;</span>repackage<span style=color:#f92672>&lt;/goal&gt;</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&lt;/goals&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>&lt;/execution&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>&lt;/executions&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;/plugin&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;/plugins&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/build&gt;</span>
</span></span></code></pre></div><ol start=3><li>打包父项目（然后打包子项目）：</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#75715e># 打包父项目</span>
</span></span><span style=display:flex><span>cd D:\workspace\java\lesson-project
</span></span><span style=display:flex><span>mvn clean install -Dmaven.test.skip=true
</span></span></code></pre></div><h3 id=2-创建容器>2. 创建容器</h3><ol><li>创建相关目录：</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 创建相关目录</span>
</span></span><span style=display:flex><span>mkdir -p /opt/app/lesson/lesson-search;
</span></span><span style=display:flex><span>chmod -R <span style=color:#ae81ff>777</span> /opt/app/lesson;
</span></span></code></pre></div><ol start=2><li>将Jar包 <code>lesson-search.jar</code> 拷贝到 <code>/opt/app/lesson/lesson-search</code> 目录中。</li><li>创建DockerFile：</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 开发节点的Dockerfile文件</span>
</span></span><span style=display:flex><span>cd /opt/app/lesson/lesson-search;
</span></span><span style=display:flex><span>touch Dockerfile;
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#39;FROM openjdk:11&#39;</span> &gt;&gt; Dockerfile;
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#39;MAINTAINER lsx&#39;</span> &gt;&gt; Dockerfile;
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#39;ADD lesson-search.jar lesson-search.jar&#39;</span> &gt;&gt; Dockerfile;
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#39;EXPOSE 5003&#39;</span> &gt;&gt; Dockerfile;
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#39;CMD [&#34;nohup&#34;, &#34;java&#34;, &#34;-jar&#34;, &#34;lesson-search.jar&#34;, &#34;&amp;&#34;]&#39;</span> &gt;&gt; Dockerfile;
</span></span></code></pre></div><ol start=4><li>构建镜像：</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 根据Dockerfile文件制作镜像: 必须在Dockerfile文件同级目录下</span>
</span></span><span style=display:flex><span>docker build -t lesson-search:v1.0 .
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 查看镜像</span>
</span></span><span style=display:flex><span>docker images
</span></span></code></pre></div><ol start=5><li>创建容器：</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 创建并运行节点容器</span>
</span></span><span style=display:flex><span>docker run --name lesson-search --network my-net -p 5003:5003 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	-e TZ<span style=color:#f92672>=</span>Asia/Shanghai <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	-d lesson-search:v1.0;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 查看节点容器</span>
</span></span><span style=display:flex><span>docker ps --format <span style=color:#e6db74>&#34;{{.ID}}\t{{.Names}}\t{{.Ports}}&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 永久开放5003端口</span>
</span></span><span style=display:flex><span>firewall-cmd --add-port<span style=color:#f92672>=</span>5003/tcp --permanent
</span></span><span style=display:flex><span>firewall-cmd --reload
</span></span></code></pre></div><ol start=6><li>在Windows机器上 <a href="http://192.168.40.77:5003/api/v1/course/searchByTitle?pageNumber=1&amp;pageSize=5&amp;title=%E6%9C%8D%E5%8A%A1">访问容器</a></li></ol><h1 id=s04-开发通信子服务>S04. 开发通信子服务</h1><blockquote><p>武技: 创建子项目 <code>lesson-websocket</code> 做为通信服务子项目</p></blockquote><ol><li>在子项目中添加依赖:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#75715e>&lt;!--lombok--&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;groupId&gt;</span>org.projectlombok<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;artifactId&gt;</span>lombok<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;!--spring-boot-starter-websocket--&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;groupId&gt;</span>org.springframework.boot<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;artifactId&gt;</span>spring-boot-starter-websocket<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span></code></pre></div><ol start=2><li>开发主配文件:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-properties data-lang=properties><span style=display:flex><span><span style=color:#75715e>############################# App ##############################</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#端口号，项目名，静态资源目录#</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>server.port</span><span style=color:#f92672>=</span><span style=color:#e6db74>5055</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.application.name</span><span style=color:#f92672>=</span><span style=color:#e6db74>lesson-websocket</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.resources.static-locations</span><span style=color:#f92672>=</span><span style=color:#e6db74>classpath:/templates/</span>
</span></span></code></pre></div><ol start=3><li>开发启动类 <code>LessonWebSocketApp</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> com.lsx;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@SpringBootApplication</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>LessonWebSocketApp</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span>(String<span style=color:#f92672>[]</span> args) {
</span></span><span style=display:flex><span>        SpringApplication.<span style=color:#a6e22e>run</span>(LessonWebSocketApp.<span style=color:#a6e22e>class</span>, args);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=e01-开发服务端>E01. 开发服务端</h2><blockquote><p>武技: 在子项目 <code>lesson-websocket</code> 中开发弹幕服务的服务类</p></blockquote><ol><li>开发WS服务端类 <code>DanMuServer</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> com.lsx.server;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> javax.websocket.Session;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Slf4j</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Component</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@ServerEndpoint</span>(<span style=color:#e6db74>&#34;/danmu/{userId}&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>DanMuServer</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/** 用于存储每个WS客户端的Session实例: ConcurrentHashMap保证线程安全，static保证实例唯一 */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> Map<span style=color:#f92672>&lt;</span>Integer, Session<span style=color:#f92672>&gt;</span> CLIENTS <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ConcurrentHashMap<span style=color:#f92672>&lt;&gt;</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * 当WS客户端上线时触发
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param userId  WS客户端唯一标识
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param session 每个WS客户端连入WS服务端时，都会生成独有的session对象
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@OnOpen</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onOpen</span>(<span style=color:#a6e22e>@PathParam</span>(<span style=color:#e6db74>&#34;userId&#34;</span>) Integer userId, Session session) {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 将客户端唯一标识及其Session实例存入Map</span>
</span></span><span style=display:flex><span>        CLIENTS.<span style=color:#a6e22e>put</span>(userId, session);
</span></span><span style=display:flex><span>        log.<span style=color:#a6e22e>info</span>(<span style=color:#e6db74>&#34;{} 号用户上线了&#34;</span>, userId);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * 当WS客户端下线时触发
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param userId  WS客户端唯一标识
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param session 每个WS客户端连入WS服务端时，都会生成独有的session对象
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@OnClose</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onClose</span>(<span style=color:#a6e22e>@PathParam</span>(<span style=color:#e6db74>&#34;userId&#34;</span>) Integer userId, Session session) {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 从Map中移除该客户端和及其Session实例</span>
</span></span><span style=display:flex><span>        CLIENTS.<span style=color:#a6e22e>remove</span>(userId);
</span></span><span style=display:flex><span>        log.<span style=color:#a6e22e>info</span>(<span style=color:#e6db74>&#34;{} 号用户下线了&#34;</span>, userId);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * 当WS客户端连接WS服务端异常时触发
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param userId  WS客户端唯一标识
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param e       异常实例
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param session 每个WS客户端连入WS服务端时，都会生成独有的session对象
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@OnError</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onError</span>(<span style=color:#a6e22e>@PathParam</span>(<span style=color:#e6db74>&#34;userId&#34;</span>) Integer userId, Throwable e, Session session) {
</span></span><span style=display:flex><span>        log.<span style=color:#a6e22e>error</span>(<span style=color:#e6db74>&#34;{} 号用户连接或者通信异常&#34;</span>, userId, e);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * 当WS服务端接收到消息的时候触发: 对Map中的全部在线的WS客户端群发消息
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param userId  WS客户端唯一标识
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param msg     消息内容
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param session 每个WS客户端连入WS服务端时，都会生成独有的session对象
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@OnMessage</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onMessage</span>(<span style=color:#a6e22e>@PathParam</span>(<span style=color:#e6db74>&#34;userId&#34;</span>) Integer userId, String msg, Session session) {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 遍历Map容器并向所有在线的客户端推送该消息</span>
</span></span><span style=display:flex><span>        CLIENTS.<span style=color:#a6e22e>keySet</span>().<span style=color:#a6e22e>forEach</span>(key <span style=color:#f92672>-&gt;</span> CLIENTS.<span style=color:#a6e22e>get</span>(key).<span style=color:#a6e22e>getAsyncRemote</span>().<span style=color:#a6e22e>sendText</span>(msg));
</span></span><span style=display:flex><span>        log.<span style=color:#a6e22e>info</span>(<span style=color:#e6db74>&#34;{} 号用户发来消息: {}&#34;</span>, userId, msg);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=2><li>管理WS服务端配置类: 用于扫描 <code>@ServerEndpoint</code> 注解:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> com.lsx.config;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Configuration</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>DanMuServerConfig</span> {
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>/** 该bean会自动扫描@ServerEndpoint注解并使其生效 */</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> ServerEndpointExporter <span style=color:#a6e22e>serverEndpointExporter</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> ServerEndpointExporter();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=e02-开发客户端>E02. 开发客户端</h2><blockquote><p>武技: 在子项目 <code>lesson-websocket</code> 中开发弹幕服务的客户端页面</p></blockquote><ol><li>开发 <code>classpath:templates/jack.html</code> 客户端测试页面:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span><span style=color:#75715e>&lt;!DOCTYPE html&gt;</span>
</span></span><span style=display:flex><span>&lt;<span style=color:#f92672>html</span> <span style=color:#a6e22e>lang</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;en&#34;</span>&gt;
</span></span><span style=display:flex><span>&lt;<span style=color:#f92672>head</span>&gt;
</span></span><span style=display:flex><span>    &lt;<span style=color:#f92672>meta</span> <span style=color:#a6e22e>charset</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;UTF-8&#34;</span>&gt;
</span></span><span style=display:flex><span>    &lt;<span style=color:#f92672>title</span>&gt;Jack&lt;/<span style=color:#f92672>title</span>&gt;
</span></span><span style=display:flex><span>&lt;/<span style=color:#f92672>head</span>&gt;
</span></span><span style=display:flex><span>&lt;<span style=color:#f92672>body</span>&gt;
</span></span><span style=display:flex><span>&lt;<span style=color:#f92672>h1</span>&gt;WS客户端 - 1号用户Jack&lt;/<span style=color:#f92672>h1</span>&gt;
</span></span><span style=display:flex><span>&lt;<span style=color:#f92672>button</span> <span style=color:#a6e22e>type</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;button&#34;</span> <span style=color:#a6e22e>onclick</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;socket.close()&#34;</span>&gt;下线&lt;/<span style=color:#f92672>button</span>&gt;
</span></span><span style=display:flex><span>&lt;<span style=color:#f92672>button</span> <span style=color:#a6e22e>type</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;button&#34;</span> <span style=color:#a6e22e>onclick</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;socket.send(&#39;大家好，我是Jack&#39;)&#34;</span>&gt;群发 &#34;大家好，我是Jack&#34;&lt;/<span style=color:#f92672>button</span>&gt;
</span></span><span style=display:flex><span>&lt;<span style=color:#f92672>section</span> <span style=color:#a6e22e>id</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;screen&#34;</span> <span style=color:#a6e22e>style</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;height: 200px; border: 1px solid red;text-align: center&#34;</span>&gt;&lt;/<span style=color:#f92672>section</span>&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>&lt;<span style=color:#f92672>script</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>screen</span>, <span style=color:#a6e22e>socket</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>onload</span> <span style=color:#f92672>=</span> () =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>screen</span> <span style=color:#f92672>=</span> document.<span style=color:#a6e22e>querySelector</span>(<span style=color:#e6db74>&#39;#screen&#39;</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>WebSocket</span>) {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>show</span>(<span style=color:#e6db74>&#39;当前浏览器不支持WebSocket!&#39;</span>);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 使用ws://协议连接S端，并传递Jack的用户ID过去
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>socket</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>WebSocket</span>(<span style=color:#e6db74>&#39;ws://localhost:5055/barrage/1&#39;</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>socket</span>.<span style=color:#a6e22e>onopen</span> <span style=color:#f92672>=</span> () =&gt; <span style=color:#a6e22e>show</span>(<span style=color:#e6db74>&#39;1号用户Jack上线了&#39;</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>socket</span>.<span style=color:#a6e22e>onclose</span> <span style=color:#f92672>=</span> () =&gt; <span style=color:#a6e22e>show</span>(<span style=color:#e6db74>&#39;1号用户Jack下线了&#39;</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>socket</span>.<span style=color:#a6e22e>onerror</span> <span style=color:#f92672>=</span> () =&gt; <span style=color:#a6e22e>show</span>(<span style=color:#e6db74>&#39;1号用户Jack连接或通信异常&#39;</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>socket</span>.<span style=color:#a6e22e>onmessage</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>resp</span> =&gt; <span style=color:#a6e22e>show</span>(<span style=color:#a6e22e>resp</span>.<span style=color:#a6e22e>data</span>);
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/** 向屏幕展示内容，自带换行 */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>show</span>(<span style=color:#a6e22e>content</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>screen</span>.<span style=color:#a6e22e>innerHTML</span> <span style=color:#f92672>+=</span> <span style=color:#a6e22e>content</span>;
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>screen</span>.<span style=color:#a6e22e>innerHTML</span> <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#39;&lt;br/&gt;&#39;</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>&lt;/<span style=color:#f92672>script</span>&gt;
</span></span><span style=display:flex><span>&lt;/<span style=color:#f92672>body</span>&gt;
</span></span><span style=display:flex><span>&lt;/<span style=color:#f92672>html</span>&gt;
</span></span></code></pre></div><ol start=2><li>开发 <code>classpath:templates/rose.html</code> 客户端测试页面:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span><span style=color:#75715e>&lt;!DOCTYPE html&gt;</span>
</span></span><span style=display:flex><span>&lt;<span style=color:#f92672>html</span> <span style=color:#a6e22e>lang</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;en&#34;</span>&gt;
</span></span><span style=display:flex><span>&lt;<span style=color:#f92672>head</span>&gt;
</span></span><span style=display:flex><span>    &lt;<span style=color:#f92672>meta</span> <span style=color:#a6e22e>charset</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;UTF-8&#34;</span>&gt;
</span></span><span style=display:flex><span>    &lt;<span style=color:#f92672>title</span>&gt;Rose&lt;/<span style=color:#f92672>title</span>&gt;
</span></span><span style=display:flex><span>&lt;/<span style=color:#f92672>head</span>&gt;
</span></span><span style=display:flex><span>&lt;<span style=color:#f92672>body</span>&gt;
</span></span><span style=display:flex><span>&lt;<span style=color:#f92672>h1</span>&gt;WS客户端 - 2号用户Rose&lt;/<span style=color:#f92672>h1</span>&gt;
</span></span><span style=display:flex><span>&lt;<span style=color:#f92672>button</span> <span style=color:#a6e22e>type</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;button&#34;</span> <span style=color:#a6e22e>onclick</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;socket.close()&#34;</span>&gt;下线&lt;/<span style=color:#f92672>button</span>&gt;
</span></span><span style=display:flex><span>&lt;<span style=color:#f92672>button</span> <span style=color:#a6e22e>type</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;button&#34;</span> <span style=color:#a6e22e>onclick</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;socket.send(&#39;大家好，我是Rose&#39;)&#34;</span>&gt;群发 &#34;大家好，我是Rose&#34;&lt;/<span style=color:#f92672>button</span>&gt;
</span></span><span style=display:flex><span>&lt;<span style=color:#f92672>section</span> <span style=color:#a6e22e>id</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;screen&#34;</span> <span style=color:#a6e22e>style</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;height: 200px; border: 1px solid red;text-align: center&#34;</span>&gt;&lt;/<span style=color:#f92672>section</span>&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>&lt;<span style=color:#f92672>script</span>&gt;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>screen</span>, <span style=color:#a6e22e>socket</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>onload</span> <span style=color:#f92672>=</span> () =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>screen</span> <span style=color:#f92672>=</span> document.<span style=color:#a6e22e>querySelector</span>(<span style=color:#e6db74>&#39;#screen&#39;</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>WebSocket</span>) {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>show</span>(<span style=color:#e6db74>&#39;当前浏览器不支持WebSocket!&#39;</span>);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 使用ws://协议连接S端，并传递Rose的用户ID过去
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>socket</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>WebSocket</span>(<span style=color:#e6db74>&#39;ws://localhost:5055/barrage/2&#39;</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>socket</span>.<span style=color:#a6e22e>onopen</span> <span style=color:#f92672>=</span> () =&gt; <span style=color:#a6e22e>show</span>(<span style=color:#e6db74>&#39;2号用户Rose上线了&#39;</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>socket</span>.<span style=color:#a6e22e>onclose</span> <span style=color:#f92672>=</span> () =&gt; <span style=color:#a6e22e>show</span>(<span style=color:#e6db74>&#39;2号用户Rose下线了&#39;</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>socket</span>.<span style=color:#a6e22e>onerror</span> <span style=color:#f92672>=</span> () =&gt; <span style=color:#a6e22e>show</span>(<span style=color:#e6db74>&#39;2号用户Rose连接或通信异常&#39;</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>socket</span>.<span style=color:#a6e22e>onmessage</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>resp</span> =&gt; <span style=color:#a6e22e>show</span>(<span style=color:#a6e22e>resp</span>.<span style=color:#a6e22e>data</span>);
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/** 向屏幕展示内容，自带换行 */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>show</span>(<span style=color:#a6e22e>content</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>screen</span>.<span style=color:#a6e22e>innerHTML</span> <span style=color:#f92672>+=</span> <span style=color:#a6e22e>content</span>;
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>screen</span>.<span style=color:#a6e22e>innerHTML</span> <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#39;&lt;br/&gt;&#39;</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>&lt;/<span style=color:#f92672>script</span>&gt;
</span></span><span style=display:flex><span>&lt;/<span style=color:#f92672>body</span>&gt;
</span></span><span style=display:flex><span>&lt;/<span style=color:#f92672>html</span>&gt;
</span></span></code></pre></div><ol start=3><li>启动项目并访问 <a href=http://localhost:5001/jack.html>jack.html</a> 和 <a href=http://localhost:5001/rose.html>rose.html</a></li></ol><h2 id=e03-部署项目>E03. 部署项目</h2><blockquote><p>武技：在Docker中部署 <code>lesson-websocket</code> 项目</p></blockquote><h3 id=1-打包项目-1>1. 打包项目</h3><ol><li>将主配中的全部IP地址由 <code>localhost</code> 改为 <code>192.168.40.77</code> 虚拟机地址。</li><li>在子项目 <code>lesson-websocket</code> 中添加打包插件：</li></ol><p><code>pom.xml</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#75715e>&lt;!--项目打包--&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;build&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>&lt;!--最终Jar包名--&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;finalName&gt;</span>lesson-websocket<span style=color:#f92672>&lt;/finalName&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;plugins&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>&lt;!--SpringBoot打包插件--&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;plugin&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>&lt;groupId&gt;</span>org.springframework.boot<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>&lt;artifactId&gt;</span>spring-boot-maven-plugin<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>&lt;version&gt;</span>2.4.8<span style=color:#f92672>&lt;/version&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>&lt;!--配置启动类--&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>&lt;configuration&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>&lt;mainClass&gt;</span>com.lsx.LessonWebSocketApp<span style=color:#f92672>&lt;/mainClass&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>&lt;/configuration&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>&lt;!--打包本项目全部依赖包到最终Jar包内--&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>&lt;executions&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>&lt;execution&gt;</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&lt;goals&gt;</span>
</span></span><span style=display:flex><span>                        <span style=color:#f92672>&lt;goal&gt;</span>repackage<span style=color:#f92672>&lt;/goal&gt;</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&lt;/goals&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>&lt;/execution&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>&lt;/executions&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;/plugin&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;/plugins&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/build&gt;</span>
</span></span></code></pre></div><ol start=3><li>打包父项目（然后打包子项目）：</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 打包父项目</span>
</span></span><span style=display:flex><span>cd D:<span style=color:#ae81ff>\w</span>orkspace<span style=color:#ae81ff>\j</span>ava<span style=color:#ae81ff>\l</span>esson-project
</span></span><span style=display:flex><span>mvn clean install -Dmaven.test.skip<span style=color:#f92672>=</span>true
</span></span></code></pre></div><h3 id=2-创建容器-1>2. 创建容器</h3><ol><li>创建相关目录：</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 创建相关目录</span>
</span></span><span style=display:flex><span>mkdir -p /opt/app/lesson/lesson-websocket;
</span></span><span style=display:flex><span>chmod -R <span style=color:#ae81ff>777</span> /opt/app/lesson;
</span></span></code></pre></div><ol start=2><li>将Jar包 <code>lesson-websocket.jar</code> 拷贝到 <code>/opt/app/lesson/lesson-websocket</code> 目录中。</li><li>创建DockerFile：</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 开发节点的Dockerfile文件</span>
</span></span><span style=display:flex><span>cd /opt/app/lesson/lesson-websocket;
</span></span><span style=display:flex><span>touch Dockerfile;
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#39;FROM openjdk:11&#39;</span> &gt;&gt; Dockerfile;
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#39;MAINTAINER lsx&#39;</span> &gt;&gt; Dockerfile;
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#39;ADD lesson-websocket.jar lesson-websocket.jar&#39;</span> &gt;&gt; Dockerfile;
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#39;EXPOSE 5055&#39;</span> &gt;&gt; Dockerfile;
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#39;CMD [&#34;nohup&#34;, &#34;java&#34;, &#34;-jar&#34;, &#34;lesson-websocket.jar&#34;, &#34;&amp;&#34;]&#39;</span> &gt;&gt; Dockerfile;
</span></span></code></pre></div><ol start=4><li>构建镜像：</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 根据Dockerfile文件制作镜像: 必须在Dockerfile文件同级目录下</span>
</span></span><span style=display:flex><span>docker build -t lesson-websocket:v1.0 .
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 查看镜像</span>
</span></span><span style=display:flex><span>docker images
</span></span></code></pre></div><ol start=5><li>创建容器：</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 创建并运行节点容器</span>
</span></span><span style=display:flex><span>docker run --name lesson-websocket --network my-net -p 5055:5055 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	-e TZ<span style=color:#f92672>=</span>Asia/Shanghai <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	-d lesson-websocket:v1.0;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 查看节点容器</span>
</span></span><span style=display:flex><span>docker ps --format <span style=color:#e6db74>&#34;{{.ID}}\t{{.Names}}\t{{.Ports}}&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 永久开放5055端口</span>
</span></span><span style=display:flex><span>firewall-cmd --add-port<span style=color:#f92672>=</span>5055/tcp --permanent
</span></span><span style=display:flex><span>firewall-cmd --reload
</span></span></code></pre></div><ol start=6><li>使用 <a href=http://coolaf.com/tool/chattest>WebSocket在线工具</a> 测试连接情况。</li><li>输入 <code>ws://192.168.40.77:5055/barrage/1</code> 进行连接测试。</li></ol></div><svg id="btt-button" class="arrow-logo" xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 384 512" onclick="scrollToTop()" title="Go to top"><path d="M177 159.7l136 136c9.4 9.4 9.4 24.6.0 33.9l-22.6 22.6c-9.4 9.4-24.6 9.4-33.9.0L160 255.9l-96.4 96.4c-9.4 9.4-24.6 9.4-33.9.0L7 329.7c-9.4-9.4-9.4-24.6.0-33.9l136-136c9.4-9.5 24.6-9.5 34-.1z"/></svg>
<script>let backToTopButton=document.getElementById("btt-button");window.onscroll=function(){scrollFunction()};function scrollFunction(){document.body.scrollTop>20||document.documentElement.scrollTop>20?backToTopButton.style.display="block":backToTopButton.style.display="none"}function scrollToTop(){window.scrollTo(0,0)}</script></div></main><footer class=footer><span>&copy; 2024 The Marauders</span>
<span>Made with &#10084;&#65039; using <a target=_blank href=https://github.com/gokarna-theme/gokarna-hugo>Gokarna</a></span></footer></body></html>