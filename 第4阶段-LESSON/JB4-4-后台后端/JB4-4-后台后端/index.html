<!doctype html><html lang=en><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><style>:root{--accent-color:#FF4D4D}</style><title>JB4-4-后台后端</title>
<meta name=description content="[!NOTE] Java道经第4卷 - 第4阶 - 后台后端 lesson-admin
S01. 搭建项目环境 武技: 创建 lesson-admin 子项目并搭建基础环境
在子项目引入依赖: &amp;lt;!--公共项目--&amp;gt; &amp;lt;dependency&amp;gt; …"><meta name=keywords content='blog,lsx2216,hugo'><meta property="og:url" content="https://lsx2216.netlify.app/%E7%AC%AC4%E9%98%B6%E6%AE%B5-LESSON/JB4-4-%E5%90%8E%E5%8F%B0%E5%90%8E%E7%AB%AF/JB4-4-%E5%90%8E%E5%8F%B0%E5%90%8E%E7%AB%AF/"><meta property="og:type" content="website"><meta property="og:title" content="JB4-4-后台后端"><meta property="og:description" content="[!NOTE] Java道经第4卷 - 第4阶 - 后台后端 lesson-admin
S01. 搭建项目环境 武技: 创建 lesson-admin 子项目并搭建基础环境
在子项目引入依赖: &amp;lt;!--公共项目--&amp;gt; &amp;lt;dependency&amp;gt; …"><meta property="og:image" content="https://lsx2216.netlify.app/assets/images/user.jpg"><meta property="og:image:secure_url" content="https://lsx2216.netlify.app/assets/images/user.jpg"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="JB4-4-后台后端"><meta name=twitter:description content="[!NOTE] Java道经第4卷 - 第4阶 - 后台后端 lesson-admin
S01. 搭建项目环境 武技: 创建 lesson-admin 子项目并搭建基础环境
在子项目引入依赖: &amp;lt;!--公共项目--&amp;gt; &amp;lt;dependency&amp;gt; …"><meta property="twitter:domain" content="https://lsx2216.netlify.app/%E7%AC%AC4%E9%98%B6%E6%AE%B5-LESSON/JB4-4-%E5%90%8E%E5%8F%B0%E5%90%8E%E7%AB%AF/JB4-4-%E5%90%8E%E5%8F%B0%E5%90%8E%E7%AB%AF/"><meta property="twitter:url" content="https://lsx2216.netlify.app/%E7%AC%AC4%E9%98%B6%E6%AE%B5-LESSON/JB4-4-%E5%90%8E%E5%8F%B0%E5%90%8E%E7%AB%AF/JB4-4-%E5%90%8E%E5%8F%B0%E5%90%8E%E7%AB%AF/"><meta name=twitter:image content="https://lsx2216.netlify.app/assets/images/user.jpg"><link rel=canonical href=https://lsx2216.netlify.app/%E7%AC%AC4%E9%98%B6%E6%AE%B5-LESSON/JB4-4-%E5%90%8E%E5%8F%B0%E5%90%8E%E7%AB%AF/JB4-4-%E5%90%8E%E5%8F%B0%E5%90%8E%E7%AB%AF/><link rel=stylesheet type=text/css href=/css/normalize.min.css media=print><link rel=stylesheet type=text/css href=/css/main.min.css><link id=dark-theme rel=stylesheet href=/css/dark.min.css><script src=/js/bundle.min.3eb19cb61dde9e37b9522867f3e024aeb68e26ab8e03252e46e365abcb19acf7.js integrity="sha256-PrGcth3enje5Uihn8+AkrraOJquOAyUuRuNlq8sZrPc="></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css integrity=sha384-Xi8rHCmBmhbuyyhbI88391ZKP2dmfnOl4rT9ZfRI7mLTdk1wblIUnrIq35nqwEvC crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.js integrity=sha384-X/XCfMm41VSsqRNQgDerQczD69XqmjOOOwYQvr/uuC+j4OPoNhVgjdGFwhvN02Ja crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],throwOnError:!1})})</script>    <link rel="shortcut icon" href="/assets/images/user.jpg" type="image/x-icon">
</head><body><script>setThemeByUserPref()</script><header class=header><nav class=header-nav><div class=avatar><a href=https://lsx2216.netlify.app/><img src=/assets/images/user.jpg alt=avatar></a></div><div class=nav-title><a class=nav-brand href=https://lsx2216.netlify.app/>lsx2216</a></div><div class=nav-links><div class=nav-link><a href=https://lsx2216.netlify.app/ aria-label><span data-feather=home></span> Home</a></div><div class=nav-link><a href=https://lsx2216.netlify.app/projects/ aria-label><span data-feather=code></span> Projects</a></div><div class=nav-link><a href=https://github.com aria-label=github><span data-feather=github></span></a></div><span class=nav-icons-divider></span><div class="nav-link dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target">theme</span>
<a aria-hidden=true role=switch><span class=theme-toggle-icon data-feather=moon></span></a></div><div class=nav-link id=hamburger-menu-toggle><span class="sr-only hamburger-menu-toggle-screen-reader-target">menu</span>
<a aria-checked=false aria-labelledby=hamburger-menu-toggle id=hamburger-menu-toggle-target role=switch><span data-feather=menu></span></a></div><ul class="nav-hamburger-list visibility-hidden"><li class=nav-item><a href=https://lsx2216.netlify.app/><span data-feather=home></span> Home</a></li><li class=nav-item><a href=https://lsx2216.netlify.app/projects/><span data-feather=code></span> Projects</a></li><li class=nav-item><a href=https://github.com><span data-feather=github></span></a></li><li class="nav-item dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target">theme</span>
<a role=switch><span class=theme-toggle-icon data-feather=moon></span></a></li></ul></div></nav></header><main id=content><div class="post container"><div class=post-header-section><h1>JB4-4-后台后端</h1></div><div class=post-content><blockquote><p>[!NOTE] Java道经第4卷 - 第4阶 - 后台后端
lesson-admin</p></blockquote><h1 id=s01-搭建项目环境>S01. 搭建项目环境</h1><blockquote><p>武技: 创建 <code>lesson-admin</code> 子项目并搭建基础环境</p></blockquote><ol><li>在子项目引入依赖:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#75715e>&lt;!--公共项目--&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;groupId&gt;</span>com.lsx<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;artifactId&gt;</span>lesson-common<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;version&gt;</span>1.0-SNAPSHOT<span style=color:#f92672>&lt;/version&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;!--junit--&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;groupId&gt;</span>junit<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;artifactId&gt;</span>junit<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;!--lombok--&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;groupId&gt;</span>org.projectlombok<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;artifactId&gt;</span>lombok<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;!--hutool--&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;groupId&gt;</span>cn.hutool<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;artifactId&gt;</span>hutool-all<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;!--spring-boot-starter-web--&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;groupId&gt;</span>org.springframework.boot<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;artifactId&gt;</span>spring-boot-starter-web<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;!--spring-boot-starter-test--&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;groupId&gt;</span>org.springframework.boot<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;artifactId&gt;</span>spring-boot-starter-test<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;scope&gt;</span>test<span style=color:#f92672>&lt;/scope&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;!--spring-boot-starter-aop--&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;groupId&gt;</span>org.springframework.boot<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;artifactId&gt;</span>spring-boot-starter-aop<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;!--mysql-connector-j--&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;groupId&gt;</span>com.mysql<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;artifactId&gt;</span>mysql-connector-j<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;!--spring-boot-starter-cache--&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;groupId&gt;</span>org.springframework.boot<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;artifactId&gt;</span>spring-boot-starter-cache<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;!--springdoc-openapi-ui--&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;groupId&gt;</span>org.springdoc<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;artifactId&gt;</span>springdoc-openapi-ui<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;!--knife4j-springdoc-ui--&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;groupId&gt;</span>com.github.xiaoymin<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;artifactId&gt;</span>knife4j-springdoc-ui<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;!--hibernate-validator--&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;groupId&gt;</span>org.hibernate.validator<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;artifactId&gt;</span>hibernate-validator<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;!--jwt--&gt;</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>  
</span></span><span style=display:flex><span>	<span style=color:#f92672>&lt;groupId&gt;</span>com.auth0<span style=color:#f92672>&lt;/groupId&gt;</span>  
</span></span><span style=display:flex><span>	<span style=color:#f92672>&lt;artifactId&gt;</span>java-jwt<span style=color:#f92672>&lt;/artifactId&gt;</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;!--minio--&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;groupId&gt;</span>io.minio<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;artifactId&gt;</span>minio<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;!--easyexcel--&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;groupId&gt;</span>com.alibaba<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;artifactId&gt;</span>easyexcel<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;!--mybatis-flex-spring-boot-starter--&gt;</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>  
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;groupId&gt;</span>com.mybatis-flex<span style=color:#f92672>&lt;/groupId&gt;</span>  
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;artifactId&gt;</span>mybatis-flex-spring-boot-starter<span style=color:#f92672>&lt;/artifactId&gt;</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;!--HikariCP--&gt;</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>  
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;groupId&gt;</span>com.zaxxer<span style=color:#f92672>&lt;/groupId&gt;</span>  
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;artifactId&gt;</span>HikariCP<span style=color:#f92672>&lt;/artifactId&gt;</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;!--spring-boot-starter-data-redis--&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;groupId&gt;</span>org.springframework.boot<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;artifactId&gt;</span>spring-boot-starter-data-redis<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>&lt;!--logstash-logback-encoder--&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;groupId&gt;</span>net.logstash.logback<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;artifactId&gt;</span>logstash-logback-encoder<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span></code></pre></div><ol start=2><li>开发主配项 <code>classpath:application.properties</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-properties data-lang=properties><span style=display:flex><span><span style=color:#75715e>############################# App ##############################  </span>
</span></span><span style=display:flex><span><span style=color:#75715e>#端口号，项目名称#  </span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>server.port</span><span style=color:#f92672>=</span><span style=color:#e6db74>5266    </span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.application.name</span><span style=color:#f92672>=</span><span style=color:#e6db74>lesson-admin </span>
</span></span><span style=display:flex><span><span style=color:#75715e>############################# DataSource ##############################  </span>
</span></span><span style=display:flex><span><span style=color:#75715e>#驱动串，连接串，账号，密码，连接池类#  </span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.datasource.driver-class-name</span><span style=color:#f92672>=</span><span style=color:#e6db74>com.mysql.cj.jdbc.Driver  </span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.datasource.url</span><span style=color:#f92672>=</span><span style=color:#e6db74>jdbc:mysql://192.168.40.77:3306/lesson?\  </span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>serverTimezone</span><span style=color:#f92672>=</span><span style=color:#e6db74>Asia/Shanghai&amp;useUnicode=true&amp;characterEncoding=utf-8spring.datasource.username=lsx  </span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.datasource.password</span><span style=color:#f92672>=</span><span style=color:#e6db74>lsx  </span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.datasource.type</span><span style=color:#f92672>=</span><span style=color:#e6db74>com.zaxxer.hikari.HikariDataSource  </span>
</span></span><span style=display:flex><span><span style=color:#75715e>############################# MyBatisFlex ##############################  </span>
</span></span><span style=display:flex><span><span style=color:#75715e>#实体类别名包扫描，下划线自动转驼峰，控制台打印SQL#  </span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>mybatis-flex.type-aliases-package</span><span style=color:#f92672>=</span><span style=color:#e6db74>com.lsx.entity  </span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>mybatis-flex.configuration.map-underscore-to-camel-case</span><span style=color:#f92672>=</span><span style=color:#e6db74>true  </span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>mybatis-flex.configuration.log-impl</span><span style=color:#f92672>=</span><span style=color:#e6db74>org.apache.ibatis.logging.stdout.StdOutImpl  </span>
</span></span><span style=display:flex><span><span style=color:#75715e>############################# MinIO ##############################  </span>
</span></span><span style=display:flex><span><span style=color:#75715e>#总量无限制，单个文件限制1GB#  </span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.servlet.multipart.max-file-size</span><span style=color:#f92672>=</span><span style=color:#e6db74>-1  </span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.servlet.multipart.max-request-size</span><span style=color:#f92672>=</span><span style=color:#e6db74>1GB</span>
</span></span><span style=display:flex><span><span style=color:#75715e>############################# Logback ##############################  </span>
</span></span><span style=display:flex><span><span style=color:#75715e>#根目录日志等级，控制台格式，文件格式，文件名，文件滚动名，最长时效（天），单个文件最大值，总文件最大值#  </span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>logging.level.root</span><span style=color:#f92672>=</span><span style=color:#e6db74>INFO  </span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>logging.pattern.console</span><span style=color:#f92672>=</span><span style=color:#e6db74>%d{yyyy-MM-dd HH:mm:ss.SSS} %-5p %4.15(%t) %c{1}.%M:%L %msg%n  </span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>logging.pattern.file</span><span style=color:#f92672>=</span><span style=color:#e6db74>%d{yyyy-MM-dd HH:mm:ss.SSS} %-5p %4.15(%t) %c{1}.%M:%L %msg%n  </span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>logging.file.name</span><span style=color:#f92672>=</span><span style=color:#e6db74>log/lesson-admin.log  </span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>logging.pattern.rolling-file-name</span><span style=color:#f92672>=</span><span style=color:#e6db74>log/lesson-admin.%d.%i.log  </span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>logging.file.max-history</span><span style=color:#f92672>=</span><span style=color:#e6db74>7  </span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>logging.file.max-size</span><span style=color:#f92672>=</span><span style=color:#e6db74>10MB  </span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>logging.file.total-size-cap</span><span style=color:#f92672>=</span><span style=color:#e6db74>0 </span>
</span></span><span style=display:flex><span><span style=color:#75715e>############################# StringRedisTemplate ##############################</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#RedisIP，Redis端口，超时毫秒数，最大连接，最大阻塞时间，最大空闲，最小空闲#</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.redis.host</span><span style=color:#f92672>=</span><span style=color:#e6db74>192.168.40.77</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.redis.port</span><span style=color:#f92672>=</span><span style=color:#e6db74>6379</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.redis.timeout</span><span style=color:#f92672>=</span><span style=color:#e6db74>3000ms</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.redis.jedis.pool.max-active</span><span style=color:#f92672>=</span><span style=color:#e6db74>8</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.redis.jedis.pool.max-wait</span><span style=color:#f92672>=</span><span style=color:#e6db74>-1ms</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.redis.jedis.pool.max-idle</span><span style=color:#f92672>=</span><span style=color:#e6db74>8</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>spring.redis.jedis.pool.min-idle</span><span style=color:#f92672>=</span><span style=color:#e6db74>0</span>
</span></span></code></pre></div><ol start=3><li>开发配置类 <code>MyBatisFlexConfig</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> com.lsx.config;  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@MapperScan</span>(<span style=color:#e6db74>&#34;com.lsx.mapper&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Configuration</span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MyBatisFlexConfig</span> {  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=4><li>开发启动类 <code>LessonAdminApp</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> com.lsx;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@SpringBootApplication</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>LessonAdminApp</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span>(String<span style=color:#f92672>[]</span> args) {
</span></span><span style=display:flex><span>        SpringApplication.<span style=color:#a6e22e>run</span>(LessonAdminApp.<span style=color:#a6e22e>class</span>, args);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=e01-整合文档框架>E01. 整合文档框架</h2><blockquote><p>武技: 在子项目 <code>lesson-admin</code> 中整合 SpringDoc + Knife4j</p></blockquote><ol><li>开发主配项 <code>classpath:application.properties</code>:<ul><li>SpringDoc会自动添加 <code>server.servlet.context-path</code> 配置的请求前缀（若有）。</li></ul></li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-properties data-lang=properties><span style=display:flex><span><span style=color:#75715e>############################# SpringDoc ##############################  </span>
</span></span><span style=display:flex><span><span style=color:#75715e>#启用SpringDoc，包扫描，分组名，分组规则，包扫描# </span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>springdoc.api-docs.enabled</span><span style=color:#f92672>=</span><span style=color:#e6db74>true</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>springdoc.packages-to-scan</span><span style=color:#f92672>=</span><span style=color:#e6db74>com.lsx.controller</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>springdoc.group-configs[0].group</span><span style=color:#f92672>=</span><span style=color:#e6db74>v1</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>springdoc.group-configs[0].paths-to-match</span><span style=color:#f92672>=</span><span style=color:#e6db74>/api/v1/**</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>springdoc.group-configs[1].group</span><span style=color:#f92672>=</span><span style=color:#e6db74>test</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>springdoc.group-configs[1].paths-to-match</span><span style=color:#f92672>=</span><span style=color:#e6db74>/test/**</span>
</span></span></code></pre></div><ol start=2><li>开发常量属性 <code>SpringDocConst</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> com.lsx.constant;  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>SpringDocConst</span> {  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>/** 后台地址 */</span>  
</span></span><span style=display:flex><span>    String ADMIN_URL <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;http//localhost:5266&#34;</span>;  
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>/** 后台作者 */</span>  
</span></span><span style=display:flex><span>    String ADMIN_NAME <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;lsx&#34;</span>;  
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>/** 后台标题 */</span>  
</span></span><span style=display:flex><span>    String ADMIN_TITLE <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;李氏云课堂-后台&#34;</span>;  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>/** 后台版本 */</span>  
</span></span><span style=display:flex><span>    String ADMIN_VERSION <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;v1.0.0&#34;</span>;   
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>	<span style=color:#75715e>/** 后台描述 */</span>  
</span></span><span style=display:flex><span>	String ADMIN_DESCRIPTION <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Lesson后台仅允许管理员用户访问，&#34;</span> <span style=color:#f92672>+</span>  
</span></span><span style=display:flex><span>	        <span style=color:#e6db74>&#34;包含对全部用户记录，全部视频记录及其章节记录，全部订单记录&#34;</span> <span style=color:#f92672>+</span>  
</span></span><span style=display:flex><span>	        <span style=color:#e6db74>&#34;等进行统一管理，数据分析以及数据打印，包含对用户头像文件，视&#34;</span> <span style=color:#f92672>+</span>  
</span></span><span style=display:flex><span>	        <span style=color:#e6db74>&#34;频媒体文件，封面图片，摘要图片等文件的统一管理，数据分析以及&#34;</span> <span style=color:#f92672>+</span>  
</span></span><span style=display:flex><span>	        <span style=color:#e6db74>&#34;数据打印，包含对前后台项目日志数据的统一管理，数据分析以及数据打印。&#34;</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=3><li>开发SpringDoc配置类 <code>SpringDocConfig</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> com.lsx.config;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> io.swagger.v3.oas.models.OpenAPI;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> io.swagger.v3.oas.models.info.Contact;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> io.swagger.v3.oas.models.info.Info;
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Configuration</span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SpringDocConfig</span> {    
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>/** 通用信息Bean */</span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Bean</span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> OpenAPI <span style=color:#a6e22e>commonInfo</span>() {    
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 联系对象    </span>
</span></span><span style=display:flex><span>		Contact contact <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Contact()    
</span></span><span style=display:flex><span>		        .<span style=color:#a6e22e>name</span>(SpringDocConst.<span style=color:#a6e22e>ADMIN_NAME</span>)  
</span></span><span style=display:flex><span>		        .<span style=color:#a6e22e>url</span>(SpringDocConst.<span style=color:#a6e22e>ADMIN_URL</span>);  
</span></span><span style=display:flex><span>		              
</span></span><span style=display:flex><span>	    <span style=color:#75715e>// 展板信息    </span>
</span></span><span style=display:flex><span>		Info info <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Info()  
</span></span><span style=display:flex><span>				.<span style=color:#a6e22e>title</span>(SpringDocConst.<span style=color:#a6e22e>ADMIN_TITLE</span>)  
</span></span><span style=display:flex><span>		        .<span style=color:#a6e22e>description</span>(SpringDocConst.<span style=color:#a6e22e>ADMIN_DESCRIPTION</span>)  
</span></span><span style=display:flex><span>		        .<span style=color:#a6e22e>version</span>(SpringDocConst.<span style=color:#a6e22e>ADMIN_VERSION</span>)  
</span></span><span style=display:flex><span>		        .<span style=color:#a6e22e>contact</span>(contact);    
</span></span><span style=display:flex><span>		                
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> OpenAPI().<span style=color:#a6e22e>info</span>(info);  
</span></span><span style=display:flex><span>    }    
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=4><li>开发控制器类 <code>SpringDocController</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> com.lsx.controller.test;  
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> io.swagger.v3.oas.annotations.Operation;  
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> io.swagger.v3.oas.annotations.Parameter;  
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> io.swagger.v3.oas.annotations.media.Schema;  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Tag</span>(name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;PigController&#34;</span>, description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;猪的控制器&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RestController</span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SpringDocController</span> {    
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Operation</span>(summary <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;分页查询猪&#34;</span>, description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;用于分页查询猪的控制方法&#34;</span>)  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@GetMapping</span>(<span style=color:#e6db74>&#34;/test/springDoc/page&#34;</span>)  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Object <span style=color:#a6e22e>page</span>(<span style=color:#a6e22e>@RequestParam</span> <span style=color:#a6e22e>@Parameter</span>(description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;显示第几页&#34;</span>) Integer pageNum,  
</span></span><span style=display:flex><span>                       <span style=color:#a6e22e>@RequestParam</span> <span style=color:#a6e22e>@Parameter</span>(description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;每页多少条&#34;</span>) Integer pageSize) {    
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> Map.<span style=color:#a6e22e>of</span>(<span style=color:#e6db74>&#34;参数pageNum&#34;</span>, pageNum, <span style=color:#e6db74>&#34;参数pageSize&#34;</span>, pageSize);  
</span></span><span style=display:flex><span>    }    
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Operation</span>(summary <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;查询一只猪&#34;</span>, description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;用于查询一只猪的控制方法&#34;</span>)    
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@GetMapping</span>(<span style=color:#e6db74>&#34;/test/springDoc/selectById/{id}&#34;</span>)    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Object <span style=color:#a6e22e>selectById</span>(<span style=color:#a6e22e>@PathVariable</span> <span style=color:#a6e22e>@Parameter</span>(description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;猪的主键&#34;</span>) Long id) {  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> Map.<span style=color:#a6e22e>of</span>(<span style=color:#e6db74>&#34;参数id&#34;</span>, id);    
</span></span><span style=display:flex><span>}    
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Operation</span>(summary <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;添加一只猪&#34;</span>, description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;用于添加一只猪的控制方法&#34;</span>)    
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@PostMapping</span>(<span style=color:#e6db74>&#34;/test/springDoc/insert&#34;</span>)  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Object <span style=color:#a6e22e>insert</span>(<span style=color:#a6e22e>@RequestBody</span> PigDTO pigDTO) {    
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> Map.<span style=color:#a6e22e>of</span>(<span style=color:#e6db74>&#34;参数pigName&#34;</span>, pigDTO.<span style=color:#a6e22e>getName</span>());  
</span></span><span style=display:flex><span>    }    
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Schema</span>(name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;猪的DTO实体&#34;</span>, description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;猪的DTO实体，包含猪表的全部可操作属性&#34;</span>)  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Data</span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>PigDTO</span> <span style=color:#66d9ef>implements</span> Serializable {  
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>@Schema</span>(description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;猪的名字&#34;</span>, required <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>, example <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;佩奇&#34;</span>)    
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>private</span> String name;  
</span></span><span style=display:flex><span>    }    
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=5><li>访问 <a href=http://localhost:5266/doc.html>SpringDoc文档页面</a></li></ol><h2 id=e02-整合缓存框架>E02. 整合缓存框架</h2><blockquote><p>武技: 在子项目 <code>lesson-admin</code> 中整合SpringCache缓存</p></blockquote><ol><li>开发SpringCache配置类 <code>SpringCacheConfig</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> com.lsx.config;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@EnableCaching</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Configuration</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SpringCacheConfig</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/** 缓存有效期，单位分钟 */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>long</span> TTL <span style=color:#f92672>=</span> 30L;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Autowired</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> RedisConnectionFactory connectionFactory;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> CacheManager <span style=color:#a6e22e>cacheManager</span>() {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Jackson核心对象</span>
</span></span><span style=display:flex><span>        ObjectMapper objectMapper <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ObjectMapper();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Jackson序列化器: 用于相互转换Java对象和JSON字符串，默认使用JDK的序列化方式（中文有乱码）</span>
</span></span><span style=display:flex><span>        Jackson2JsonRedisSerializer<span style=color:#f92672>&lt;</span>Object<span style=color:#f92672>&gt;</span> serializer <span style=color:#f92672>=</span> 
</span></span><span style=display:flex><span>	        <span style=color:#66d9ef>new</span> Jackson2JsonRedisSerializer<span style=color:#f92672>&lt;&gt;</span>(Object.<span style=color:#a6e22e>class</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 设置LocalDateTime序列化方式</span>
</span></span><span style=display:flex><span>        objectMapper.<span style=color:#a6e22e>registerModule</span>(<span style=color:#66d9ef>new</span> JavaTimeModule());
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 设置objectMapper的访问权限: Jackson库可以访问Java对象的任何属性</span>
</span></span><span style=display:flex><span>        objectMapper.<span style=color:#a6e22e>setVisibility</span>(PropertyAccessor.<span style=color:#a6e22e>ALL</span>, JsonAutoDetect.<span style=color:#a6e22e>Visibility</span>.<span style=color:#a6e22e>ANY</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>/*
</span></span></span><span style=display:flex><span><span style=color:#75715e>         * 设置Jackson在序列化和反序列化过程中，对Java泛型的默认处理方案
</span></span></span><span style=display:flex><span><span style=color:#75715e>         *
</span></span></span><span style=display:flex><span><span style=color:#75715e>         * param1: 一个用于验证泛型类型的对象
</span></span></span><span style=display:flex><span><span style=color:#75715e>         * param2: 表示在序列化和反序列化过程中，将Java泛型类型信息作为属性进行处理
</span></span></span><span style=display:flex><span><span style=color:#75715e>         * param3: 表示在JSON数据中，将Java泛型类型信息作为属性进行存储
</span></span></span><span style=display:flex><span><span style=color:#75715e>         */</span>
</span></span><span style=display:flex><span>        objectMapper.<span style=color:#a6e22e>activateDefaultTyping</span>(objectMapper.<span style=color:#a6e22e>getPolymorphicTypeValidator</span>(),
</span></span><span style=display:flex><span>                ObjectMapper.<span style=color:#a6e22e>DefaultTyping</span>.<span style=color:#a6e22e>NON_FINAL</span>,
</span></span><span style=display:flex><span>                JsonTypeInfo.<span style=color:#a6e22e>As</span>.<span style=color:#a6e22e>PROPERTY</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 设置 serializer 使用 objectMapper 来序列化和反序列化对象</span>
</span></span><span style=display:flex><span>        serializer.<span style=color:#a6e22e>setObjectMapper</span>(objectMapper);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 配置redis缓存管理对象: 设置缓存过期时间，value值的序列化方式和对Null值的处理方案</span>
</span></span><span style=display:flex><span>        RedisCacheConfiguration config <span style=color:#f92672>=</span> RedisCacheConfiguration.<span style=color:#a6e22e>defaultCacheConfig</span>()
</span></span><span style=display:flex><span>                .<span style=color:#a6e22e>entryTtl</span>(Duration.<span style=color:#a6e22e>ofMinutes</span>(TTL))
</span></span><span style=display:flex><span>                .<span style=color:#a6e22e>serializeValuesWith</span>(RedisSerializationContext.<span style=color:#a6e22e>SerializationPair</span>
</span></span><span style=display:flex><span>	                .<span style=color:#a6e22e>fromSerializer</span>(serializer))
</span></span><span style=display:flex><span>                .<span style=color:#a6e22e>disableCachingNullValues</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 创建并返回Cache管理器</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> RedisCacheManager.<span style=color:#a6e22e>builder</span>(connectionFactory).<span style=color:#a6e22e>cacheDefaults</span>(config).<span style=color:#a6e22e>build</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=2><li>开发业务类 <code>SpringCacheService</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> com.lsx.service.test;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Service</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@CacheConfig</span>(cacheNames <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;test&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SpringCacheService</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Cacheable</span>(key <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;#id&#34;</span>, condition <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;#id != null&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>select</span>(Long id) {
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;模拟: 发送SQL&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;数据: id = &#34;</span> <span style=color:#f92672>+</span> id;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=3><li>测试业务类 <code>SpringCacheServiceTest</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> com.lsx.service;  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RunWith</span>(SpringRunner.<span style=color:#a6e22e>class</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@SpringBootTest</span>(classes <span style=color:#f92672>=</span> LessonAdminApp.<span style=color:#a6e22e>class</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SpringCacheServiceTest</span> {  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Autowired</span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> SpringCacheService springCacheService;  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Test</span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>select</span>(){  
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(springCacheService.<span style=color:#a6e22e>select</span>(1L));  
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(springCacheService.<span style=color:#a6e22e>select</span>(1L));  
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(springCacheService.<span style=color:#a6e22e>select</span>(2L));  
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(springCacheService.<span style=color:#a6e22e>select</span>(2L));  
</span></span><span style=display:flex><span>    }  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=e03-全局异常处理>E03. 全局异常处理</h2><blockquote><p>武技: 在子项目 <code>lesson-admin</code> 中整合全局异常处理器</p></blockquote><ol><li>开发自定义异常类 <code>ServiceException</code>, 用于业务异常的手动抛出:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> com.lsx.exception;  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ServiceException</span> <span style=color:#66d9ef>extends</span> RuntimeException {  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>ServiceException</span>(String message) {  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>super</span>(message);  
</span></span><span style=display:flex><span>    }  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=2><li>开发全局异常处理方法 <code>ExceptionAdvice -> serviceException() & exception()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> com.lsx.component;  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Slf4j</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RestControllerAdvice</span>(basePackages <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#34;com.lsx.controller&#34;</span>})  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ExceptionAdvice</span> {  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@ExceptionHandler</span>(ServiceException.<span style=color:#a6e22e>class</span>)  
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> Object <span style=color:#a6e22e>serviceException</span>(ServiceException e) {  
</span></span><span style=display:flex><span>	    log.<span style=color:#a6e22e>error</span>(<span style=color:#e6db74>&#34;业务异常: &#34;</span> <span style=color:#f92672>+</span> e.<span style=color:#a6e22e>getMessage</span>());  
</span></span><span style=display:flex><span>	    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> Result(ResultCode.<span style=color:#a6e22e>FAILED</span>, e.<span style=color:#a6e22e>getMessage</span>());  
</span></span><span style=display:flex><span>	}  
</span></span><span style=display:flex><span>	  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@ExceptionHandler</span>(Exception.<span style=color:#a6e22e>class</span>)  
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> Object <span style=color:#a6e22e>exception</span>(Exception e) {    
</span></span><span style=display:flex><span>	    log.<span style=color:#a6e22e>error</span>(<span style=color:#e6db74>&#34;其他异常: &#34;</span> <span style=color:#f92672>+</span> e.<span style=color:#a6e22e>getMessage</span>());    
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> Result(ResultCode.<span style=color:#a6e22e>FAILED</span>);  
</span></span><span style=display:flex><span>	}    
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=3><li>开发控制器类 <code>ExceptionController</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> com.lsx.controller.test;  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RestController</span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ExceptionController</span> {  
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@GetMapping</span>(<span style=color:#e6db74>&#34;/test/exception/{num}&#34;</span>)  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Object <span style=color:#a6e22e>exception</span>(<span style=color:#a6e22e>@PathVariable</span> Integer num) {  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (num <span style=color:#f92672>==</span> 0) {  
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RuntimeException(<span style=color:#e6db74>&#34;未知异常&#34;</span>);  
</span></span><span style=display:flex><span>        }  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (num <span style=color:#f92672>==</span> 1) {  
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> serviceException(<span style=color:#e6db74>&#34;除数不能为0&#34;</span>);  
</span></span><span style=display:flex><span>        }  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> Map.<span style=color:#a6e22e>of</span>(<span style=color:#e6db74>&#34;name&#34;</span>, <span style=color:#e6db74>&#34;zhaosi&#34;</span>);  
</span></span><span style=display:flex><span>    }  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=e04-整合参数校验>E04. 整合参数校验</h2><blockquote><p>武技: 在子项目 <code>lesson-admin</code> 中整合HibernateValidator参数校验器</p></blockquote><ol><li>开发全局异常处理方法 <code>ExceptionAdvice -> methodArgumentNotValidException()</code>:<ul><li>方法位置要写在 <code>exception()</code> 之上。</li></ul></li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> com.lsx.component;  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Slf4j</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RestControllerAdvice</span>(basePackages <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#34;com.lsx.controller&#34;</span>})  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ExceptionAdvice</span> {  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@ExceptionHandler</span>(MethodArgumentNotValidException.<span style=color:#a6e22e>class</span>)  
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> Object <span style=color:#a6e22e>methodArgumentNotValidException</span>(MethodArgumentNotValidException e) {  
</span></span><span style=display:flex><span>	  
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 获取bindingResult中所有属性错误信息集合中的第一个属性错误  </span>
</span></span><span style=display:flex><span>		FieldError firstFieldError <span style=color:#f92672>=</span> e.<span style=color:#a6e22e>getBindingResult</span>().<span style=color:#a6e22e>getFieldErrors</span>().<span style=color:#a6e22e>get</span>(0);  
</span></span><span style=display:flex><span>	  
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 异常信息 : &#34;xxx实例的xxx属性校验失败: xxx异常信息&#34;  </span>
</span></span><span style=display:flex><span>		String message <span style=color:#f92672>=</span> String.<span style=color:#a6e22e>format</span>(<span style=color:#e6db74>&#34;%s实例的%s属性校验失败: %s&#34;</span>,  
</span></span><span style=display:flex><span>				firstFieldError.<span style=color:#a6e22e>getObjectName</span>(),  
</span></span><span style=display:flex><span>				firstFieldError.<span style=color:#a6e22e>getField</span>(),  
</span></span><span style=display:flex><span>				firstFieldError.<span style=color:#a6e22e>getDefaultMessage</span>());  
</span></span><span style=display:flex><span>	  
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 记录日志  </span>
</span></span><span style=display:flex><span>		log.<span style=color:#a6e22e>error</span>(message);  
</span></span><span style=display:flex><span>		
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 响应  </span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> Result(ResultCode.<span style=color:#a6e22e>VALIDATE_FAILED</span>, message);  
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@ExceptionHandler</span>(Exception.<span style=color:#a6e22e>class</span>)  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Object <span style=color:#a6e22e>exception</span>(Exception e) {    
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 略</span>
</span></span><span style=display:flex><span>    }    
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=2><li>开发控制方法 <code>HibernateValidatorController -> hibernateValidator()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> com.lsx.controller.test;  
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.web.bind.annotation.RequestBody;  
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> javax.validation.constraints.NotEmpty;  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Slf4j</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RestController</span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>HibernateValidatorController</span> {  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@PostMapping</span>(<span style=color:#e6db74>&#34;/test/hibernateValidator&#34;</span>)  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Object <span style=color:#a6e22e>hibernateValidator</span>(<span style=color:#a6e22e>@RequestBody</span> <span style=color:#a6e22e>@Validated</span> DogDTO dto) {  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;添加成功&#34;</span> <span style=color:#f92672>+</span> dto;  
</span></span><span style=display:flex><span>    }  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Data</span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>DogDTO</span> <span style=color:#66d9ef>implements</span> Serializable {  
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>@NotEmpty</span>(message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;狗子名不能为空&#34;</span>)  
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>@Size</span>(min <span style=color:#f92672>=</span> 2, max <span style=color:#f92672>=</span> 10, message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;狗子名必须在2个字符到10个字符之间&#34;</span>)  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>private</span> String name;  
</span></span><span style=display:flex><span>    }  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=3><li>访问控制方法 <code>HibernateValidatorController -> hibernateValidator()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-http data-lang=http><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>### 测试 HibernateValidatorController -&gt; hibernateValidator() 方法
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>POST http://localhost:5266/test/hibernateValidator
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>Content-Type: application/json
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>{
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>  &#34;name&#34;: &#34;哈哈哈哈哈哈士奇&#34;
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>}
</span></span></span></code></pre></div><h2 id=e05-整合报表打印>E05. 整合报表打印</h2><blockquote><p>武技: 在 <code>lesson-admin</code> 子项目整合EasyExcel功能</p></blockquote><ol><li><a href=../../%E7%AC%AC3%E9%98%B6%E6%AE%B5-SSM/JB3-4-SpringBoot/res/%E5%B0%81%E8%A3%85Excel%E5%B7%A5%E5%85%B7%E7%B1%BB.md>封装Excel工具类</a><ul><li>前台项目不需要打印Excel报表，所以该工具类在 <code>lesson-admin</code> 中单独引入即可。</li></ul></li><li>开发控制器类 <code>EasyExcelController</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> com.lsx.controller.test;  
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> com.alibaba.excel.annotation.format.DateTimeFormat;  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RestController</span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>EasyExcelController</span> {  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@SneakyThrows</span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@GetMapping</span>(<span style=color:#e6db74>&#34;/test/excel&#34;</span>)  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>excel</span>(HttpServletResponse resp) {  
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 准备Excel数据  </span>
</span></span><span style=display:flex><span>        List<span style=color:#f92672>&lt;</span>DogExcel<span style=color:#f92672>&gt;</span> result <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ArrayList<span style=color:#f92672>&lt;&gt;</span>();  
</span></span><span style=display:flex><span>        result.<span style=color:#a6e22e>add</span>(<span style=color:#66d9ef>new</span> DogExcel(<span style=color:#e6db74>&#34;小白&#34;</span>, 1, <span style=color:#66d9ef>new</span> Date()));  
</span></span><span style=display:flex><span>        result.<span style=color:#a6e22e>add</span>(<span style=color:#66d9ef>new</span> DogExcel(<span style=color:#e6db74>&#34;小黑&#34;</span>, 2, <span style=color:#66d9ef>new</span> Date()));  
</span></span><span style=display:flex><span>        result.<span style=color:#a6e22e>add</span>(<span style=color:#66d9ef>new</span> DogExcel(<span style=color:#e6db74>&#34;小黄&#34;</span>, 3, <span style=color:#66d9ef>new</span> Date()));  
</span></span><span style=display:flex><span>        String fileName <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;狗子统计表.xlsx&#34;</span>;  
</span></span><span style=display:flex><span>        String sheetName <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;sheet01&#34;</span>;  
</span></span><span style=display:flex><span>        EasyExcelUtil.<span style=color:#a6e22e>download</span>(resp, fileName, sheetName, DogExcel.<span style=color:#a6e22e>class</span>, result);  
</span></span><span style=display:flex><span>    }  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@ColumnWidth</span>(20)  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Data</span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@AllArgsConstructor</span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>DogExcel</span> <span style=color:#66d9ef>implements</span> Serializable {  
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>@ExcelProperty</span>(value <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#34;狗子统计表&#34;</span>, <span style=color:#e6db74>&#34;狗子姓名&#34;</span>})  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>private</span> String name;  
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>@ExcelProperty</span>(value <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#34;狗子统计表&#34;</span>, <span style=color:#e6db74>&#34;狗子年龄&#34;</span>})  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>private</span> Integer age;  
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>@ExcelProperty</span>(value <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#34;狗子统计表&#34;</span>, <span style=color:#e6db74>&#34;创建日期&#34;</span>})  
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>@DateTimeFormat</span>(<span style=color:#e6db74>&#34;yyyy/MM/dd HH:mm:ss&#34;</span>)  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>private</span> Date created;  
</span></span><span style=display:flex><span>    }  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=3><li><a href=http://localhost:5266/test/excel>访问EasyExcelController</a></li></ol><h2 id=e06-开发业务切面>E06. 开发业务切面</h2><blockquote><p>心法: <code>lesson-admin</code> 业务层切面任务</p></blockquote><table><thead><tr><th>通知</th><th>任务</th></tr></thead><tbody><tr><td>前置通知</td><td>判断业务方法参数中是否存在null值，存在则直接抛出异常</td></tr><tr><td>后置通知</td><td>记录业务方法的调用日志</td></tr><tr><td>返回通知</td><td>无</td></tr><tr><td>异常通知</td><td>AOP中的异常通知比全局异常处理类优先级高，建议将处理异常的工作让给全局异常处理类来做</td></tr></tbody></table><blockquote><p>武技: 在子项目 <code>lesson-admin</code> 中开发业务层的AOP代码</p></blockquote><ol><li>开发切面类 <code>ServiceAspect</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> com.lsx.component;  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Component</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Aspect</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Slf4j</span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ServiceAspect</span> {  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@SneakyThrows</span>  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Around</span>(<span style=color:#e6db74>&#34;execution(public * com.lsx.service.impl.*.*(..))&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> Object <span style=color:#a6e22e>aroundAdvice</span>(ProceedingJoinPoint pjp) {  
</span></span><span style=display:flex><span>	  
</span></span><span style=display:flex><span>	    <span style=color:#75715e>// 获取方法参数  </span>
</span></span><span style=display:flex><span>	    Object<span style=color:#f92672>[]</span> args <span style=color:#f92672>=</span> pjp.<span style=color:#a6e22e>getArgs</span>();  
</span></span><span style=display:flex><span>	  
</span></span><span style=display:flex><span>	    <span style=color:#75715e>// 获取类名: 截取最后一个点和最后一个@之间的内容  </span>
</span></span><span style=display:flex><span>	    String className <span style=color:#f92672>=</span> pjp.<span style=color:#a6e22e>getTarget</span>().<span style=color:#a6e22e>toString</span>();  
</span></span><span style=display:flex><span>	    <span style=color:#66d9ef>int</span> lastPoint <span style=color:#f92672>=</span> className.<span style=color:#a6e22e>lastIndexOf</span>(<span style=color:#e6db74>&#34;.&#34;</span>) <span style=color:#f92672>+</span> 1;  
</span></span><span style=display:flex><span>	    <span style=color:#66d9ef>int</span> lastAt <span style=color:#f92672>=</span> className.<span style=color:#a6e22e>lastIndexOf</span>(<span style=color:#e6db74>&#34;@&#34;</span>);  
</span></span><span style=display:flex><span>	    className <span style=color:#f92672>=</span> className.<span style=color:#a6e22e>substring</span>(lastPoint, lastAt);  
</span></span><span style=display:flex><span>	  
</span></span><span style=display:flex><span>	    <span style=color:#75715e>// 获取方法名  </span>
</span></span><span style=display:flex><span>	    String methodName <span style=color:#f92672>=</span> pjp.<span style=color:#a6e22e>getSignature</span>().<span style=color:#a6e22e>getName</span>();  
</span></span><span style=display:flex><span>	  
</span></span><span style=display:flex><span>	    <span style=color:#75715e>// 前置通知: 记录日志  </span>
</span></span><span style=display:flex><span>	    log.<span style=color:#a6e22e>info</span>(<span style=color:#e6db74>&#34;进入业务方法 {}.{}()，参数: {}&#34;</span>, className, methodName, Arrays.<span style=color:#a6e22e>toString</span>(args));  
</span></span><span style=display:flex><span>	  
</span></span><span style=display:flex><span>	    <span style=color:#75715e>// 前置通知: 检查参数中是否存在空值  </span>
</span></span><span style=display:flex><span>	    <span style=color:#66d9ef>if</span> (ObjectUtil.<span style=color:#a6e22e>hasNull</span>(args)) {  
</span></span><span style=display:flex><span>	        String msg <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;业务方法 &#34;</span> <span style=color:#f92672>+</span> className <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;.&#34;</span> <span style=color:#f92672>+</span> methodName <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;() 中存在null值参数&#34;</span>;  
</span></span><span style=display:flex><span>	        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> ServiceException(msg);  
</span></span><span style=display:flex><span>	    }  
</span></span><span style=display:flex><span>	  
</span></span><span style=display:flex><span>	    <span style=color:#75715e>// 调用目标方法  </span>
</span></span><span style=display:flex><span>	    Object returnValue <span style=color:#f92672>=</span> pjp.<span style=color:#a6e22e>proceed</span>(args);  
</span></span><span style=display:flex><span>	  
</span></span><span style=display:flex><span>	    <span style=color:#75715e>// 后置通知: 记录日志  </span>
</span></span><span style=display:flex><span>	    log.<span style=color:#a6e22e>info</span>(<span style=color:#e6db74>&#34;离开业务方法 {}.{}()，结果: {}&#34;</span>, className, methodName, returnValue);  
</span></span><span style=display:flex><span>	  
</span></span><span style=display:flex><span>	    <span style=color:#75715e>// 返回目标方法的返回值  </span>
</span></span><span style=display:flex><span>	    <span style=color:#66d9ef>return</span> returnValue;  
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=2><li>测试任一业务方法，故意传递null值参数，查看是否执行AOP代码。</li></ol><h2 id=e07-开发控制切面>E07. 开发控制切面</h2><blockquote><p>心法: <code>lesson-admin</code> 控制层切面任务</p></blockquote><table><thead><tr><th>通知</th><th>任务</th></tr></thead><tbody><tr><td>前置通知</td><td>记录请求日志</td></tr><tr><td>后置通知</td><td>无</td></tr><tr><td>返回通知</td><td>无</td></tr><tr><td>异常通知</td><td>AOP中的异常通知比全局异常处理类优先级高，建议将处理异常的工作让给全局异常处理类来做</td></tr></tbody></table><blockquote><p>武技: 在子项目 <code>lesson-admin</code> 中开发控制层的AOP代码</p></blockquote><ol><li>开发DTO实体类 <code>RequestLogDTO</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> com.lsx.dto;  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Data</span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>RequestLogDTO</span> <span style=color:#66d9ef>implements</span> Serializable {  
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**请求地址*/</span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String url;  
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**请求时间*/</span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String requestTime;  
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**请求方式*/</span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String requestMethod;  
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**来源地址*/</span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String remoteAddress;  
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**类全名称*/</span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String className;  
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**方法名称*/</span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String methodName;  
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**方法形参*/</span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String parameters;  
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**响应数据*/</span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Object responseData;  
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**请求耗时*/</span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String spendTime;  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=2><li>开发切面类 <code>ControllerAspect</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> com.lsx.component;  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Slf4j</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Aspect</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Component</span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ControllerAspect</span> {  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@SuppressWarnings</span>(<span style=color:#e6db74>&#34;all&#34;</span>)  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@SneakyThrows</span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Around</span>(<span style=color:#e6db74>&#34;execution(public * com.lsx.controller.*.*(..))&#34;</span>)  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Object <span style=color:#a6e22e>aroundAdvice</span>(ProceedingJoinPoint pjp) {  
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 获取请求对象  </span>
</span></span><span style=display:flex><span>        HttpServletRequest request <span style=color:#f92672>=</span> ((ServletRequestAttributes) RequestContextHolder  
</span></span><span style=display:flex><span>                .<span style=color:#a6e22e>getRequestAttributes</span>()).<span style=color:#a6e22e>getRequest</span>();  
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 构建控制器日志DTO实体: 包含本次请求的日志信息  </span>
</span></span><span style=display:flex><span>        RequestLogDTO requestLogDTO <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> RequestLogDTO();  
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 请求时间  </span>
</span></span><span style=display:flex><span>        requestLogDTO.<span style=color:#a6e22e>setRequestTime</span>(DateUtil.<span style=color:#a6e22e>now</span>());  
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 开启计时器  </span>
</span></span><span style=display:flex><span>        TimeInterval timer <span style=color:#f92672>=</span> DateUtil.<span style=color:#a6e22e>timer</span>(<span style=color:#66d9ef>true</span>);  
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 执行业务方法  </span>
</span></span><span style=display:flex><span>        Object result <span style=color:#f92672>=</span> pjp.<span style=color:#a6e22e>proceed</span>(pjp.<span style=color:#a6e22e>getArgs</span>());  
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 停止计时器，获得总耗时  </span>
</span></span><span style=display:flex><span>        requestLogDTO.<span style=color:#a6e22e>setSpendTime</span>(timer.<span style=color:#a6e22e>intervalPretty</span>());  
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 设置请求URL，请求方式，请求地址，类名，方法名，参数，响应数据等  </span>
</span></span><span style=display:flex><span>        requestLogDTO.<span style=color:#a6e22e>setUrl</span>(request.<span style=color:#a6e22e>getRequestURL</span>().<span style=color:#a6e22e>toString</span>());  
</span></span><span style=display:flex><span>        requestLogDTO.<span style=color:#a6e22e>setRequestMethod</span>(request.<span style=color:#a6e22e>getMethod</span>());  
</span></span><span style=display:flex><span>        requestLogDTO.<span style=color:#a6e22e>setRemoteAddress</span>(request.<span style=color:#a6e22e>getRemoteAddr</span>());  
</span></span><span style=display:flex><span>        requestLogDTO.<span style=color:#a6e22e>setClassName</span>(pjp.<span style=color:#a6e22e>getSignature</span>().<span style=color:#a6e22e>getDeclaringTypeName</span>());  
</span></span><span style=display:flex><span>        requestLogDTO.<span style=color:#a6e22e>setMethodName</span>(pjp.<span style=color:#a6e22e>getSignature</span>().<span style=color:#a6e22e>getName</span>());  
</span></span><span style=display:flex><span>        requestLogDTO.<span style=color:#a6e22e>setParameters</span>(JSONUtil.<span style=color:#a6e22e>toJsonStr</span>(pjp.<span style=color:#a6e22e>getArgs</span>()));  
</span></span><span style=display:flex><span>        requestLogDTO.<span style=color:#a6e22e>setResponseData</span>(result);  
</span></span><span style=display:flex><span>        log.<span style=color:#a6e22e>info</span>(<span style=color:#e6db74>&#34;请求日志: &#34;</span> <span style=color:#f92672>+</span> requestLogDTO);  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> result;  
</span></span><span style=display:flex><span>    }  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=3><li>测试任一控制方法，查看是否成功记录请求日志。</li></ol><h2 id=e08-启用定时任务>E08. 启用定时任务</h2><blockquote><p>心法: 在子项目 <code>lesson-admin</code> 中启用定时任务</p></blockquote><ol><li>开发定时任务配置类 <code>ScheduledConfig</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> com.lsx.config;  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@EnableScheduling</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Configuration</span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ScheduledConfig</span> {  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h1 id=s02-开发横幅接口>S02. 开发横幅接口</h1><blockquote><p>心法: Banner接口文档</p></blockquote><ul><li>前缀 <code>/api/v1/banner</code>:</li></ul><table><thead><tr><th></th><th>接口</th><th>类型</th><th>描述</th><th>请求参数</th><th>必要参数</th></tr></thead><tbody><tr><td>1</td><td><code>save</code></td><td>POST</td><td>添加一条记录</td><td><code>@RequestBody BannerInsertDTO dto</code></td><td></td></tr><tr><td>2</td><td><code>getInfo/{id}</code></td><td>GET</td><td>根据主键查询</td><td><code>@PathVariable Long id</code></td><td><code>id</code></td></tr><tr><td>3</td><td><code>update</code></td><td>POST</td><td>根据主键修改</td><td><code>@RequestBody BannerUpdateDTO dto</code></td><td><code>id</code></td></tr><tr><td>4</td><td><code>remove/{id}</code></td><td>POST</td><td>根据主键删除</td><td><code>@PathVariable Long id</code></td><td><code>id</code></td></tr><tr><td>5</td><td><code>removeBatch</code></td><td>POST</td><td>根据主键批删</td><td><code>@RequestParam List&lt;Long> ids</code></td><td><code>ids</code></td></tr><tr><td>6</td><td><code>page</code></td><td>GET</td><td>全量数据分页</td><td><code>Page&lt;Banner> page</code></td><td><code>pageNumber</code><code>pageSize</code></td></tr><tr><td>7</td><td><code>upload/{id}</code></td><td>POST</td><td>上传横幅图片</td><td><code>@RequestParam MultipartFile bannerFile</code><code>@PathVariable Long id</code></td><td><code>bannerFile</code><code>id</code></td></tr></tbody></table><h2 id=e01-添加一条记录>E01. 添加一条记录</h2><blockquote><p>心法: 业务流程</p></blockquote><pre tabindex=0><code class=language-mermaid data-lang=mermaid>graph LR

n1[主键&lt;br/&gt;置空] 
--&gt; n2[设置&lt;br/&gt;默认图片地址]
--&gt; n3[设置当前创建时间&lt;br/&gt;设置当前修改时间] 
--&gt; n4[添加&lt;br/&gt;记录]
--&gt; n5[逐出&lt;br/&gt;缓存]
--&gt; n6[返回&lt;br/&gt;布尔结果]
</code></pre><blockquote><p>武技: 添加一条横幅记录</p></blockquote><ol><li>开发DTO实体类 <code>BannerInsertDTO</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> com.lsx.dto;  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Schema</span>(name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;横幅添加DTO&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Data</span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>BannerInsertDTO</span> <span style=color:#66d9ef>implements</span> Serializable {  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Size</span>(min <span style=color:#f92672>=</span> 1, max <span style=color:#f92672>=</span> 512, message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;描述长度必须在1~512之间&#34;</span>)  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Schema</span>(description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;描述&#34;</span>)  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String info;  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Range</span>(min <span style=color:#f92672>=</span> 0, message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;权重最小为0&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Long weight;  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=2><li>重写业务方法 <code>BannerServiceImpl -> save()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@CacheEvict</span>(allEntries <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>save</span>(Banner entity) {  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 清空主键  </span>
</span></span><span style=display:flex><span>	entity.<span style=color:#a6e22e>setId</span>(<span style=color:#66d9ef>null</span>);  
</span></span><span style=display:flex><span>	  
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 设置默认图片地址  </span>
</span></span><span style=display:flex><span>	entity.<span style=color:#a6e22e>setUrl</span>(BannerConst.<span style=color:#a6e22e>DEFAULT_BANNER</span>);  
</span></span><span style=display:flex><span>	  
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 设置创建时间和修改时间为当前时间  </span>
</span></span><span style=display:flex><span>	entity.<span style=color:#a6e22e>setCreated</span>(LocalDateTime.<span style=color:#a6e22e>now</span>());  
</span></span><span style=display:flex><span>	entity.<span style=color:#a6e22e>setUpdated</span>(LocalDateTime.<span style=color:#a6e22e>now</span>());  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>super</span>.<span style=color:#a6e22e>save</span>(entity); 
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=3><li>重写控制方法 <code>BannerController -> save()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Operation</span>(summary <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;添加一条记录&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@PostMapping</span>(<span style=color:#e6db74>&#34;save&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>save</span>(<span style=color:#a6e22e>@RequestBody</span> <span style=color:#a6e22e>@Validated</span> BannerInsertDTO dto) {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> bannerService.<span style=color:#a6e22e>save</span>(BeanUtil.<span style=color:#a6e22e>copyProperties</span>(dto, Banner.<span style=color:#a6e22e>class</span>));  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=e02-根据主键查询>E02. 根据主键查询</h2><blockquote><p>心法: 业务流程</p></blockquote><pre tabindex=0><code class=language-mermaid data-lang=mermaid>graph LR

n1[根据主键&lt;br/&gt;查询横幅] --&gt; f{是否&lt;br/&gt;存在}
	f --是--&gt; n2[加入缓存] --&gt; n2a[返回结果]
	f --否--&gt; n3[返回空值]
</code></pre><blockquote><p>武技: 根据主键查询一条横幅记录</p></blockquote><ol><li>重写业务方法 <code>BannerServiceImpl -> getById()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Cacheable</span>(key <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;#id&#34;</span>, unless <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;#result == null&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Banner <span style=color:#a6e22e>getById</span>(Serializable id) {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>super</span>.<span style=color:#a6e22e>getById</span>(id);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=2><li>重写控制方法 <code>BannerController -> getInfo()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Operation</span>(summary <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;根据主键查询&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@GetMapping</span>(<span style=color:#e6db74>&#34;getInfo/{id}&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Banner <span style=color:#a6e22e>getInfo</span>(<span style=color:#a6e22e>@PathVariable</span> Long id) {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> bannerService.<span style=color:#a6e22e>getById</span>(id);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=e03-根据主键修改>E03. 根据主键修改</h2><blockquote><p>心法: 业务流程</p></blockquote><pre tabindex=0><code class=language-mermaid data-lang=mermaid>graph LR

	n1[设置&lt;br/&gt;当前修改时间]
--&gt; n2[置空&lt;br/&gt;创建时间]
--&gt; n3[修改&lt;br/&gt;记录]
--&gt; n4[逐出&lt;br/&gt;缓存]
--&gt; n5[返回&lt;br/&gt;布尔结果]
</code></pre><blockquote><p>武技: 根据主键修改一条横幅记录</p></blockquote><ol><li>开发DTO实体类 <code>BannerUpdateDTO</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> com.lsx.dto;   
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Schema</span>(name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;横幅修改DTO&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Data</span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>BannerUpdateDTO</span> <span style=color:#66d9ef>implements</span> Serializable {  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@NotNull</span>(message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;主键不能为空&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Schema</span>(description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;主键&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> Long id;  
</span></span><span style=display:flex><span>	  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Size</span>(min <span style=color:#f92672>=</span> 1, max <span style=color:#f92672>=</span> 512, message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;描述长度必须在1~256之间&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Schema</span>(description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;描述&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> String info;  
</span></span><span style=display:flex><span>	  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Range</span>(min <span style=color:#f92672>=</span> 1, message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;权重必须大于0&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Schema</span>(description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;权重，数字越小越优先&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> Long weight;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=2><li>重写业务方法 <code>BannerServiceImpl -> updateById()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@CacheEvict</span>(allEntries <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>updateById</span>(Banner entity) {  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 设置最后修改时间为当前时间  </span>
</span></span><span style=display:flex><span>    entity.<span style=color:#a6e22e>setUpdated</span>(LocalDateTime.<span style=color:#a6e22e>now</span>());  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 不允许修改创建时间  </span>
</span></span><span style=display:flex><span>    entity.<span style=color:#a6e22e>setCreated</span>(<span style=color:#66d9ef>null</span>);  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 修改记录  </span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>super</span>.<span style=color:#a6e22e>updateById</span>(entity);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=3><li>重写控制方法 <code>BannerController -> update()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Operation</span>(summary <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;根据主键修改&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@PostMapping</span>(<span style=color:#e6db74>&#34;update&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>update</span>(<span style=color:#a6e22e>@RequestBody</span> <span style=color:#a6e22e>@Validated</span> BannerUpdateDTO dto) {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> bannerService.<span style=color:#a6e22e>updateById</span>(BeanUtil.<span style=color:#a6e22e>copyProperties</span>(dto, Banner.<span style=color:#a6e22e>class</span>));  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=e04-根据主键删除>E04. 根据主键删除</h2><blockquote><p>心法: 业务流程</p></blockquote><pre tabindex=0><code class=language-mermaid data-lang=mermaid>graph LR

n1[根据主键&lt;br/&gt;删除横幅记录]
--&gt; n2[逐出&lt;br/&gt;缓存]
--&gt; n3[返回&lt;br/&gt;布尔结果]
</code></pre><blockquote><p>武技: 根据主键删除一条横幅记录</p></blockquote><ol><li>重写业务方法 <code>BannerServiceImpl -> removeById()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@CacheEvict</span>(allEntries <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>removeById</span>(Serializable id) {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>super</span>.<span style=color:#a6e22e>removeById</span>(id);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=2><li>重写控制方法 <code>BannerController -> remove()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Operation</span>(summary <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;根据主键删除&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@PostMapping</span>(<span style=color:#e6db74>&#34;remove/{id}&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>remove</span>(<span style=color:#a6e22e>@PathVariable</span> Long id) {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> bannerService.<span style=color:#a6e22e>removeById</span>(id);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=e05-根据主键批删>E05. 根据主键批删</h2><blockquote><p>心法: 业务流程</p></blockquote><pre tabindex=0><code class=language-mermaid data-lang=mermaid>graph LR

n1[根据主键列表&lt;br/&gt;批量删除横幅记录]
--&gt; n2[逐出&lt;br/&gt;缓存]
--&gt; n3[返回&lt;br/&gt;布尔结果]
</code></pre><blockquote><p>武技: 根据主键列表批量删除横幅记录</p></blockquote><ol><li>重写业务方法 <code>BannerServiceImpl -> removeByIds()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@CacheEvict</span>(allEntries <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>removeByIds</span>(Collection<span style=color:#f92672>&lt;?</span> <span style=color:#66d9ef>extends</span> Serializable<span style=color:#f92672>&gt;</span> ids) {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>super</span>.<span style=color:#a6e22e>removeByIds</span>(ids);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=2><li>重写控制方法 <code>BannerController -> removeBatch()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Operation</span>(summary <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;根据主键批删&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@PostMapping</span>(<span style=color:#e6db74>&#34;removeBatch&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>removeBatch</span>(<span style=color:#a6e22e>@RequestParam</span> List<span style=color:#f92672>&lt;</span>Long<span style=color:#f92672>&gt;</span> ids) {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> bannerService.<span style=color:#a6e22e>removeByIds</span>(ids);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=e06-全量数据分页>E06. 全量数据分页</h2><blockquote><p>心法: 业务流程</p></blockquote><pre tabindex=0><code class=language-mermaid data-lang=mermaid>graph LR

n1[分页查询&lt;br/&gt;横幅记录] 
--&gt; n2[根据权重升序&lt;br/&gt;根据主键降序] 
--&gt; n3[加入&lt;br/&gt;缓存]
--&gt; n4[返回&lt;br/&gt;分页结果]
</code></pre><blockquote><p>武技: 分页查询横幅记录</p></blockquote><ol><li>重写业务方法 <code>BannerServiceImpl -> page()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Cacheable</span>(key <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;#root.methodName + &#39;:&#39; + #page.getPageSize() + &#39;:&#39; + #page.getPageNumber()&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Page<span style=color:#f92672>&lt;</span>Banner<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>page</span>(Page<span style=color:#f92672>&lt;</span>Banner<span style=color:#f92672>&gt;</span> page) {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>super</span>.<span style=color:#a6e22e>page</span>(page, QueryWrapper.<span style=color:#a6e22e>create</span>().<span style=color:#a6e22e>orderBy</span>(BANNER.<span style=color:#a6e22e>WEIGHT</span>.<span style=color:#a6e22e>asc</span>(), BANNER.<span style=color:#a6e22e>ID</span>.<span style=color:#a6e22e>desc</span>()));  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=2><li>重写控制方法 <code>BannerController -> page()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Operation</span>(summary <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;全量数据分页&#34;</span>, description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;根据权重字段升序，权重相同根据ID降序&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@GetMapping</span>(<span style=color:#e6db74>&#34;page&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Page<span style=color:#f92672>&lt;</span>Banner<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>page</span>(Page<span style=color:#f92672>&lt;</span>Banner<span style=color:#f92672>&gt;</span> page) {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> bannerService.<span style=color:#a6e22e>page</span>(page);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=e07-上传横幅图片>E07. 上传横幅图片</h2><blockquote><p>心法: 业务流程</p></blockquote><pre tabindex=0><code class=language-mermaid data-lang=mermaid>graph LR

ex1[抛出异常&lt;br/&gt;触发回滚]
ex2[抛出异常&lt;br/&gt;触发回滚]
ex3[抛出异常&lt;br/&gt;触发回滚]

1[P1] 
--&gt; n1[根据主键&lt;br/&gt;查询横幅] 
--&gt; f1{是否&lt;br/&gt;存在}
	f1 --否--&gt; ex1
	f1 --是--&gt; P2

2[P2] 
--&gt; n2[获取&lt;br/&gt;旧图片] 
--&gt; n3[随机&lt;br/&gt;新文件名] 
--&gt; n4[更新&lt;br/&gt;横幅记录] 
--&gt; f2{是否&lt;br/&gt;成功}
	f2 --否--&gt; ex2
	f2 --是--&gt; P3

3[P3] 
--&gt; f3{是否使用&lt;br/&gt;默认图片}
	f3 --否--&gt; n5[删除&lt;br/&gt;旧图] --&gt; n6[上传&lt;br/&gt;新图] --&gt; f4{是否&lt;br/&gt;成功}
		f4 --否--&gt; ex3
		f4 --是--&gt; n7[返回&lt;br/&gt;新文件名]
	f3 --是--&gt; n6
</code></pre><blockquote><p>武技: 开发上传横幅图片接口</p></blockquote><ol><li>开发业务方法 <code>BannerService -> upload()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/**  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * 上传横幅图片  
</span></span></span><span style=display:flex><span><span style=color:#75715e> *  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param bannerFile 横幅图片文件  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param id         横幅主键  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @return 文件名  
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>  
</span></span><span style=display:flex><span>String <span style=color:#a6e22e>upload</span>(MultipartFile bannerFile, Long id);
</span></span></code></pre></div><ol start=2><li>实现业务方法 <code>BannerServiceImpl -> upload()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Transactional</span>(rollbackFor <span style=color:#f92672>=</span> Exception.<span style=color:#a6e22e>class</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Override</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@CacheEvict</span>(allEntries <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>upload</span>(MultipartFile bannerFile, Long id) {  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 判断横幅是否存在  </span>
</span></span><span style=display:flex><span>    Banner banner <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>getById</span>(id);  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 获取旧的横幅图片名称（提前备份）  </span>
</span></span><span style=display:flex><span>    String oldFilename <span style=color:#f92672>=</span> banner.<span style=color:#a6e22e>getUrl</span>();  
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 随机新文件名</span>
</span></span><span style=display:flex><span>    String newFilename <span style=color:#f92672>=</span> MinioUtil.<span style=color:#a6e22e>randomFilename</span>(bannerFile);  
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 更新数据库记录  </span>
</span></span><span style=display:flex><span>    banner.<span style=color:#a6e22e>setUrl</span>(newFilename);  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>updateById</span>(banner)) {  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> ServiceException(<span style=color:#e6db74>&#34;横幅图片地址更新失败&#34;</span>);  
</span></span><span style=display:flex><span>    }  
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 从MINIO中删除非默认的横幅图片  </span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>StrUtil.<span style=color:#a6e22e>equals</span>(BannerConst.<span style=color:#a6e22e>DEFAULT_BANNER</span>, oldFilename)) {  
</span></span><span style=display:flex><span>        MinioUtil.<span style=color:#a6e22e>delete</span>(oldFilename, BannerConst.<span style=color:#a6e22e>BANNER_DIR</span>, MinioConst.<span style=color:#a6e22e>BUCKET_NAME</span>);  
</span></span><span style=display:flex><span>    }  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 向MINIO中上传新的横幅图片  </span>
</span></span><span style=display:flex><span>    MinioUtil.<span style=color:#a6e22e>upload</span>(bannerFile, newFilename, BannerConst.<span style=color:#a6e22e>BANNER_DIR</span>, MinioConst.<span style=color:#a6e22e>BUCKET_NAME</span>);  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 返回文件名  </span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> newFilename;  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=3><li>开发控制方法 <code>BannerController -> upload()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Operation</span>(summary <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;上传横幅图片&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@PostMapping</span>(<span style=color:#e6db74>&#34;upload/{id}&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Result <span style=color:#a6e22e>upload</span>(<span style=color:#a6e22e>@RequestParam</span> MultipartFile bannerFile, <span style=color:#a6e22e>@PathVariable</span> Long id) {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> Result(bannerService.<span style=color:#a6e22e>upload</span>(bannerFile, id));  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h1 id=s03-开发评论接口>S03. 开发评论接口</h1><blockquote><p>心法: Comment接口文档</p></blockquote><ul><li>前缀 <code>/api/v1/comment</code>:</li></ul><table><thead><tr><th></th><th>接口</th><th>类型</th><th>描述</th><th>请求参数</th><th>必要参数</th></tr></thead><tbody><tr><td>1</td><td><code>getInfo/{id}</code></td><td>GET</td><td>根据主键查询</td><td><code>@PathVariable Long id</code></td><td><code>id</code></td></tr><tr><td>2</td><td><code>remove/{id}</code></td><td>POST</td><td>根据主键删除</td><td><code>@PathVariable Long id</code></td><td><code>id</code></td></tr><tr><td>3</td><td><code>removeBatch</code></td><td>POST</td><td>根据主键批删</td><td><code>@RequestParam List&lt;Long> ids</code></td><td><code>ids</code></td></tr><tr><td>4</td><td><code>page</code></td><td>GET</td><td>全量数据分页</td><td><code>Page&lt;Comment> page</code></td><td><code>pageNumber</code><code>pageSize</code></td></tr><tr><td>5</td><td><code>getSubComments/{id}</code></td><td>GET</td><td>全查二级评论</td><td><code>@PathVariable Long id</code></td><td><code>id</code></td></tr></tbody></table><h2 id=e01-根据主键查询>E01. 根据主键查询</h2><blockquote><p>心法: 业务流程</p></blockquote><pre tabindex=0><code class=language-mermaid data-lang=mermaid>graph LR

n1[根据主键&lt;br/&gt;查询评论] --&gt; f{是否&lt;br/&gt;存在}
	f --是--&gt; n2[加入缓存] --&gt; n2a[返回结果]
	f --否--&gt; n3[返回空值]
</code></pre><blockquote><p>武技: 根据主键查询一条评论记录，同时联查评论人信息</p></blockquote><ol><li>优化实体类 <code>Comment</code>:<ul><li>1条评论和只能对应1个评论人，1个评论人可以出现在多条评论中。</li></ul></li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/** 评论[N] : 评论人[1] */</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RelationManyToOne</span>(selfField <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;fkMemberId&#34;</span>, targetField <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;id&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> Member member; 
</span></span></code></pre></div><ol start=2><li>重写业务方法 <code>CommentServiceImpl -> getById()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Cacheable</span>(key <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;#id&#34;</span>, unless <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;#result == null&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Comment <span style=color:#a6e22e>getById</span>(Serializable id) {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> commentMapper.<span style=color:#a6e22e>selectOneWithRelationsById</span>(id);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=3><li>重写控制方法 <code>CommentController -> getInfo()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Operation</span>(summary <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;根据主键查询&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@GetMapping</span>(<span style=color:#e6db74>&#34;getInfo/{id}&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Comment <span style=color:#a6e22e>getInfo</span>(<span style=color:#a6e22e>@PathVariable</span> Long id) {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> commentService.<span style=color:#a6e22e>getById</span>(id);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=e02-根据主键删除>E02. 根据主键删除</h2><blockquote><p>心法: 业务流程</p></blockquote><pre tabindex=0><code class=language-mermaid data-lang=mermaid>graph LR

n1[删除目标评论的&lt;br/&gt;全部子评论]
--&gt; n2[删除&lt;br/&gt;目标评论]
--&gt; n3[逐出&lt;br/&gt;缓存]
--&gt; n4[返回&lt;br/&gt;布尔结果]
</code></pre><blockquote><p>武技: 根据主键删除一条评论记录，同时删除该评论的全部子评论</p></blockquote><ol><li>重写业务方法 <code>CommentServiceImpl -> removeById()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Transactional</span>(rollbackFor <span style=color:#f92672>=</span> Exception.<span style=color:#a6e22e>class</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Override</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@CacheEvict</span>(allEntries <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>removeById</span>(Serializable id) {  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 删除全部当前评论的子评论  </span>
</span></span><span style=display:flex><span>	QueryWrapper queryWrapper <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> QueryWrapper();  
</span></span><span style=display:flex><span>	queryWrapper.<span style=color:#a6e22e>where</span>(COMMENT.<span style=color:#a6e22e>FK_COMMENT_ID</span>.<span style=color:#a6e22e>eq</span>(id));  
</span></span><span style=display:flex><span>	commentMapper.<span style=color:#a6e22e>deleteByQuery</span>(queryWrapper);  
</span></span><span style=display:flex><span>	  
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 删除当前评论  </span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>super</span>.<span style=color:#a6e22e>removeById</span>(id);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=2><li>重写控制方法 <code>CommentController -> remove()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Operation</span>(summary <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;根据主键删除&#34;</span>, description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;同时删除该条评论的全部子评论&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@PostMapping</span>(<span style=color:#e6db74>&#34;remove/{id}&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>remove</span>(<span style=color:#a6e22e>@PathVariable</span> Long id) {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> commentService.<span style=color:#a6e22e>removeById</span>(id);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=e03-根据主键批删>E03. 根据主键批删</h2><blockquote><p>心法: 业务流程</p></blockquote><pre tabindex=0><code class=language-mermaid data-lang=mermaid>graph LR

n1[批量删除&lt;br/&gt;全部目标评论的&lt;br/&gt;全部子评论]
--&gt; n2[批量删除&lt;br/&gt;全部目标评论]
--&gt; n3[逐出&lt;br/&gt;缓存]
--&gt; n4[返回&lt;br/&gt;布尔结果]
</code></pre><blockquote><p>武技: 根据主键列表批量删除评论记录，同时删除每条评论的全部子评论</p></blockquote><ol><li>重写业务方法 <code>CommentServiceImpl -> removeByIds()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Transactional</span>(rollbackFor <span style=color:#f92672>=</span> Exception.<span style=color:#a6e22e>class</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Override</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@CacheEvict</span>(allEntries <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>removeByIds</span>(Collection<span style=color:#f92672>&lt;?</span> <span style=color:#66d9ef>extends</span> Serializable<span style=color:#f92672>&gt;</span> ids) {  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 批量删除全部当前评论的子评论  </span>
</span></span><span style=display:flex><span>	QueryWrapper queryWrapper <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> QueryWrapper();  
</span></span><span style=display:flex><span>	queryWrapper.<span style=color:#a6e22e>where</span>(COMMENT.<span style=color:#a6e22e>FK_COMMENT_ID</span>.<span style=color:#a6e22e>in</span>(ids));  
</span></span><span style=display:flex><span>	commentMapper.<span style=color:#a6e22e>deleteByQuery</span>(queryWrapper);  
</span></span><span style=display:flex><span>	  
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 批量删除当前评论  </span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>super</span>.<span style=color:#a6e22e>removeByIds</span>(ids);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=2><li>重写控制方法 <code>CommentController -> removeBatch()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Operation</span>(summary <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;根据主键批删&#34;</span>, description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;同时删除每条评论的全部子评论&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@PostMapping</span>(<span style=color:#e6db74>&#34;removeBatch&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>removeBatch</span>(<span style=color:#a6e22e>@RequestParam</span> List<span style=color:#f92672>&lt;</span>Long<span style=color:#f92672>&gt;</span> ids) {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> commentService.<span style=color:#a6e22e>removeByIds</span>(ids);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=e04-全量数据分页>E04. 全量数据分页</h2><blockquote><p>心法: 业务流程</p></blockquote><pre tabindex=0><code class=language-mermaid data-lang=mermaid>graph LR

n1[分页查询&lt;br/&gt;评论记录] 
--&gt; n2[根据创建时间降序&lt;br/&gt;根据主键降序] 
--&gt; n3[加入&lt;br/&gt;缓存]
--&gt; n4[返回&lt;br/&gt;分页结果]
</code></pre><blockquote><p>武技: 分页查询评论记录，同时联查评论人信息</p></blockquote><ol><li>重写业务方法 <code>CommentServiceImpl -> page()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Cacheable</span>(key <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;#root.methodName + &#39;:&#39; + #page.getPageSize() + &#39;:&#39; + #page.getPageNumber()&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Page<span style=color:#f92672>&lt;</span>Comment<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>page</span>(Page<span style=color:#f92672>&lt;</span>Comment<span style=color:#f92672>&gt;</span> page) {  
</span></span><span style=display:flex><span>	QueryWrapper queryWrapper <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> QueryWrapper();  
</span></span><span style=display:flex><span>	queryWrapper.<span style=color:#a6e22e>orderBy</span>(COMMENT.<span style=color:#a6e22e>CREATED</span>.<span style=color:#a6e22e>desc</span>(), COMMENT.<span style=color:#a6e22e>ID</span>.<span style=color:#a6e22e>desc</span>()); 
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> commentMapper.<span style=color:#a6e22e>paginateWithRelations</span>(page, queryWrapper);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=2><li>重写控制方法 <code>CommentController -> page()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Operation</span>(summary <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;全量数据分页&#34;</span>, description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;根据创建日期降序，同时联查评论人信息&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@GetMapping</span>(<span style=color:#e6db74>&#34;page&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Page<span style=color:#f92672>&lt;</span>Comment<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>page</span>(Page<span style=color:#f92672>&lt;</span>Comment<span style=color:#f92672>&gt;</span> page) {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> commentService.<span style=color:#a6e22e>page</span>(page);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=e05-全查二级评论>E05. 全查二级评论</h2><blockquote><p>心法: 业务流程</p></blockquote><pre tabindex=0><code class=language-mermaid data-lang=mermaid>graph LR

n1[查询目标评论的&lt;br/&gt;全部子评论]
--&gt; n2[根据创建时间&lt;br/&gt;降序] 
--&gt; n3[加入&lt;br/&gt;缓存]
--&gt; n4[返回&lt;br/&gt;全部子评论]
</code></pre><blockquote><p>武技: 查询指定评论的全部子评论</p></blockquote><ol><li>开发业务方法 <code>CommentService -> getSubComments()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/**  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * 查询指定评论的全部子评论  
</span></span></span><span style=display:flex><span><span style=color:#75715e> *  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param id 指定评论主键  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @return 该评价的全部子评价  
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>  
</span></span><span style=display:flex><span>List<span style=color:#f92672>&lt;</span>Comment<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>getSubComments</span>(Long id);
</span></span></code></pre></div><ol start=2><li>实现业务方法 <code>CommentServiceImpl -> getSubComments()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Cacheable</span>(key <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;#root.methodName + &#39;:&#39; + #id&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> List<span style=color:#f92672>&lt;</span>Comment<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>getSubComments</span>(Long id) {  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 查询该评论的全部子评论  </span>
</span></span><span style=display:flex><span>    QueryWrapper queryWrapper <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> QueryWrapper();  
</span></span><span style=display:flex><span>    queryWrapper.<span style=color:#a6e22e>where</span>(COMMENT.<span style=color:#a6e22e>FK_COMMENT_ID</span>.<span style=color:#a6e22e>eq</span>(id));  
</span></span><span style=display:flex><span>    queryWrapper.<span style=color:#a6e22e>orderBy</span>(COMMENT.<span style=color:#a6e22e>CREATED</span>.<span style=color:#a6e22e>desc</span>());  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> commentMapper.<span style=color:#a6e22e>selectListWithRelationsByQuery</span>(queryWrapper);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=3><li>开发控制方法 <code>CommentController -> getSubComments()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Operation</span>(summary <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;全查二级评论&#34;</span>, description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;根据创建日期降序，同时联查评论人信息&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@GetMapping</span>(<span style=color:#e6db74>&#34;getSubComments/{id}&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> List<span style=color:#f92672>&lt;</span>Comment<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>getSubComments</span>(<span style=color:#a6e22e>@PathVariable</span> Long id) {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> commentService.<span style=color:#a6e22e>getSubComments</span>(id);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h1 id=s04-开发举报接口>S04. 开发举报接口</h1><blockquote><p>心法: Report接口文档</p></blockquote><ul><li>前缀 <code>/api/v1/report</code>:</li></ul><table><thead><tr><th></th><th>接口</th><th>类型</th><th>描述</th><th>请求参数</th><th>必要参数</th></tr></thead><tbody><tr><td>1</td><td><code>getInfo/{id}</code></td><td>GET</td><td>根据主键查询</td><td><code>@PathVariable Long id</code></td><td><code>id</code></td></tr><tr><td>2</td><td><code>remove/{id}</code></td><td>POST</td><td>根据主键删除</td><td><code>@PathVariable Long id</code></td><td><code>id</code></td></tr><tr><td>3</td><td><code>removeBatch</code></td><td>POST</td><td>根据主键批删</td><td><code>@RequestParam List&lt;Long> ids</code></td><td><code>ids</code></td></tr><tr><td>4</td><td><code>page/{type}</code></td><td>GET</td><td>根据类型分页</td><td><code>Page&lt;Report> page</code><code>@PathVariable type</code></td><td><code>pageNumber</code><code>pageSize</code><code>type</code></td></tr></tbody></table><h2 id=e01-根据主键查询-1>E01. 根据主键查询</h2><blockquote><p>心法: 业务流程</p></blockquote><pre tabindex=0><code class=language-mermaid data-lang=mermaid>graph LR

n1[根据主键&lt;br/&gt;查询举报] --&gt; f{是否&lt;br/&gt;存在}
	f --是--&gt; n2[加入缓存] --&gt; n2a[返回结果]
	f --否--&gt; n3[返回空值]
</code></pre><blockquote><p>武技: 根据主键查询一条举报记录，同时联查举报人信息</p></blockquote><ol><li>优化实体类 <code>Report</code>:<ul><li>1条举报记录只能对应1个举报人，1个举报人可以对应N条举报记录。</li></ul></li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/** 举报[N] : 举报人[1] */</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RelationManyToOne</span>(selfField <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;fkMemberId&#34;</span>, targetField <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;id&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> Member member; 
</span></span></code></pre></div><ol start=2><li>重写业务方法 <code>ReportServiceImpl -> getById()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Cacheable</span>(key <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;#id&#34;</span>, unless <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;#result == null&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Report <span style=color:#a6e22e>getById</span>(Serializable id) {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> reportMapper.<span style=color:#a6e22e>selectOneWithRelationsById</span>(id);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=3><li>重写控制方法 <code>ReportController -> getInfo()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Operation</span>(summary <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;根据主键查询&#34;</span>, description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;同时联查举报人信息&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@GetMapping</span>(<span style=color:#e6db74>&#34;getInfo/{id}&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Report <span style=color:#a6e22e>getInfo</span>(<span style=color:#a6e22e>@PathVariable</span> Long id) {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> reportService.<span style=color:#a6e22e>getById</span>(id);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=e02-根据主键删除-1>E02. 根据主键删除</h2><blockquote><p>心法: 业务流程</p></blockquote><pre tabindex=0><code class=language-mermaid data-lang=mermaid>graph LR

n1[根据主键&lt;br/&gt;删除举报记录]
--&gt; n2[逐出&lt;br/&gt;缓存]
--&gt; n3[返回&lt;br/&gt;布尔结果]
</code></pre><blockquote><p>武技: 根据主键删除一条举报记录</p></blockquote><ol><li>重写业务方法 <code>ReportServiceImpl -> removeById()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@CacheEvict</span>(allEntries <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>removeById</span>(Serializable id) {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>super</span>.<span style=color:#a6e22e>removeById</span>(id);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=2><li>重写控制方法 <code>ReportController -> remove()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Operation</span>(summary <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;根据主键删除&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@PostMapping</span>(<span style=color:#e6db74>&#34;remove/{id}&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>remove</span>(<span style=color:#a6e22e>@PathVariable</span> Long id) {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> reportService.<span style=color:#a6e22e>removeById</span>(id);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=e03-根据主键批删-1>E03. 根据主键批删</h2><blockquote><p>心法: 业务流程</p></blockquote><pre tabindex=0><code class=language-mermaid data-lang=mermaid>graph LR

n1[根据主键列表&lt;br/&gt;批量删除举报记录]
--&gt; n2[逐出&lt;br/&gt;缓存]
--&gt; n3[返回&lt;br/&gt;布尔结果]
</code></pre><blockquote><p>武技: 根据主键列表批量删除举报记录</p></blockquote><ol><li>重写业务方法 <code>ReportServiceImpl -> removeByIds()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@CacheEvict</span>(allEntries <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>removeByIds</span>(Collection<span style=color:#f92672>&lt;?</span> <span style=color:#66d9ef>extends</span> Serializable<span style=color:#f92672>&gt;</span> ids) {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>super</span>.<span style=color:#a6e22e>removeByIds</span>(ids);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=2><li>重写控制方法 <code>ReportController -> removeBatch()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Operation</span>(summary <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;根据主键批删&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@PostMapping</span>(<span style=color:#e6db74>&#34;removeBatch&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>removeBatch</span>(<span style=color:#a6e22e>@RequestParam</span> List<span style=color:#f92672>&lt;</span>Long<span style=color:#f92672>&gt;</span> ids) {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> reportService.<span style=color:#a6e22e>removeByIds</span>(ids);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=e04-根据类型分页>E04. 根据类型分页</h2><blockquote><p>心法: 业务流程</p></blockquote><pre tabindex=0><code class=language-mermaid data-lang=mermaid>graph LR

n1[检查分类指标] --&gt; f{是否&lt;br/&gt;合法}
	f--否--&gt; ex[抛出异常]
	f--是--&gt; n2[分页查询&lt;br/&gt;举报记录] 
		--&gt; n3[根据创建时间降序&lt;br/&gt;根据主键降序] 
		--&gt; n4[加入&lt;br/&gt;缓存]
		--&gt; n5[返回&lt;br/&gt;分页结果]
</code></pre><blockquote><p>武技: 根据 type 字段，分类分页查询举报记录，同时联查评论人信息</p></blockquote><ol><li>开发业务接口 <code>ReportService -> page()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/**  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * 根据举报类型来分页查询对应的举报记录 
</span></span></span><span style=display:flex><span><span style=color:#75715e> *  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param page 分页信息  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param type 举报类型，0课程，1评论  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @return 分页信息  
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>  
</span></span><span style=display:flex><span>Page<span style=color:#f92672>&lt;</span>Report<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>page</span>(Page<span style=color:#f92672>&lt;</span>Report<span style=color:#f92672>&gt;</span> page, Integer type);
</span></span></code></pre></div><ol start=2><li>重写业务方法 <code>ReportServiceImpl -> page()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Cacheable</span>(key <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;#root.methodName + &#39;:&#39; + #type + &#39;:&#39; + #page.getPageSize() + &#39;:&#39; + #page.getPageNumber()&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Page<span style=color:#f92672>&lt;</span>Report<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>page</span>(Page<span style=color:#f92672>&lt;</span>Report<span style=color:#f92672>&gt;</span> page, Integer type) {  
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 检查 type 参数是否不合法  </span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>type.<span style=color:#a6e22e>equals</span>(ReportConst.<span style=color:#a6e22e>COURSE_TYPE</span>) <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span>type.<span style=color:#a6e22e>equals</span>(ReportConst.<span style=color:#a6e22e>COMMENT_TYPE</span>)) {  
</span></span><span style=display:flex><span>	    <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> ServiceException(<span style=color:#e6db74>&#34;type参数不合法&#34;</span>);  
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>    QueryWrapper queryWrapper <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> QueryWrapper();  
</span></span><span style=display:flex><span>    queryWrapper.<span style=color:#a6e22e>where</span>(REPORT.<span style=color:#a6e22e>TYPE</span>.<span style=color:#a6e22e>eq</span>(type));  
</span></span><span style=display:flex><span>    queryWrapper.<span style=color:#a6e22e>orderBy</span>(REPORT.<span style=color:#a6e22e>CREATED</span>.<span style=color:#a6e22e>desc</span>(), REPORT.<span style=color:#a6e22e>ID</span>.<span style=color:#a6e22e>desc</span>());
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> reportMapper.<span style=color:#a6e22e>paginateWithRelations</span>(page, queryWrapper);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=3><li>重写控制方法 <code>ReportController -> page()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Operation</span>(summary <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;根据类型分页&#34;</span>, 
</span></span><span style=display:flex><span>		   description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;根据创建日期降序，当type为0时，分页查询课程举报，当type为1时，分页查询评论举报&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>@GetMapping</span>(<span style=color:#e6db74>&#34;page/{type}&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Page<span style=color:#f92672>&lt;</span>Report<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>page</span>(Page<span style=color:#f92672>&lt;</span>Report<span style=color:#f92672>&gt;</span> page, <span style=color:#a6e22e>@PathVariable</span> Integer type) {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> reportService.<span style=color:#a6e22e>page</span>(page, type);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h1 id=s05-开发购物车接口>S05. 开发购物车接口</h1><blockquote><p>心法: Cart接口文档</p></blockquote><ul><li>前缀 <code>/api/v1/cart</code>:</li></ul><table><thead><tr><th></th><th>接口</th><th>类型</th><th>描述</th><th>请求参数</th><th>必要参数</th></tr></thead><tbody><tr><td>1</td><td><code>page</code></td><td>GET</td><td>全量数据分页</td><td><code>Page&lt;Cart> page</code></td><td><code>pageNumber</code><code>pageSize</code></td></tr><tr><td>2</td><td><code>pageMember/{memberId}</code></td><td>GET</td><td>根据会员分页</td><td><code>Page&lt;Cart> page</code><code>@PathVariable memberId</code></td><td><code>pageNumber</code><code>pageSize</code><code>memberId</code></td></tr><tr><td>3</td><td><code>pageCourse/{courseId}</code></td><td>GET</td><td>根据课程分页</td><td><code>Page&lt;Cart> page</code><code>@PathVariable courseId</code></td><td><code>pageNumber</code><code>pageSize</code><code>courseId</code></td></tr></tbody></table><h2 id=e01-全量数据分页>E01. 全量数据分页</h2><blockquote><p>心法: 业务流程</p></blockquote><pre tabindex=0><code class=language-mermaid data-lang=mermaid>graph LR

n1[分页查询&lt;br/&gt;购物车记录] 
--&gt; n2[加入&lt;br/&gt;缓存]
--&gt; n3[返回&lt;br/&gt;分页结果]
</code></pre><blockquote><p>武技: 分页查询全部购物车记录，同时联查会员信息和课程信息</p></blockquote><ol><li>优化实体类 <code>Cart</code>:<ul><li>1条购物车记录中只能对应1个会员，1个会员可以出现在N条购物车记录中。</li><li>1条购物车记录中只能对应1个课程，1个课程可以出现在N条购物车记录中。</li></ul></li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/** 购物车[N] : 会员[1] */</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RelationManyToOne</span>(selfField <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;fkMemberId&#34;</span>, targetField <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;id&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> Member member;  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#75715e>/** 购物车[N] : 课程[1] */</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RelationManyToOne</span>(selfField <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;fkCourseId&#34;</span>, targetField <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;id&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> Course course;
</span></span></code></pre></div><ol start=2><li>重写业务方法 <code>CartServiceImpl -> page()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Cacheable</span>(key <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;#root.methodName + &#39;:&#39; + #page.getPageSize() + &#39;:&#39; + #page.getPageNumber()&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Page<span style=color:#f92672>&lt;</span>Cart<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>page</span>(Page<span style=color:#f92672>&lt;</span>Cart<span style=color:#f92672>&gt;</span> page) {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> cartMapper.<span style=color:#a6e22e>paginateWithRelations</span>(page, <span style=color:#66d9ef>new</span> QueryWrapper());  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=3><li>重写控制方法 <code>CartController -> page()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Operation</span>(summary <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;全量数据分页&#34;</span>, description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;同时联查会员信息和课程信息&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>@GetMapping</span>(<span style=color:#e6db74>&#34;page&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Page<span style=color:#f92672>&lt;</span>Cart<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>page</span>(Page<span style=color:#f92672>&lt;</span>Cart<span style=color:#f92672>&gt;</span> page) {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> cartService.<span style=color:#a6e22e>page</span>(page);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=e02-根据会员分页>E02. 根据会员分页</h2><blockquote><p>心法: 业务流程</p></blockquote><pre tabindex=0><code class=language-mermaid data-lang=mermaid>graph LR

n1[根据会员主键&lt;br/&gt;分页查询购物车记录] 
--&gt; n2[加入&lt;br/&gt;缓存]
--&gt; n3[返回&lt;br/&gt;分页结果]
</code></pre><blockquote><p>武技: 根据会员主键分页查询全部购物车记录，同时联查会员和课程信息</p></blockquote><ol><li>开发业务接口 <code>CartService -> pageMember()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/**  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * 根据会员主键分页查询该会员的全部购物车记录  
</span></span></span><span style=display:flex><span><span style=color:#75715e> *  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param page     分页信息  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param memberId 会员主键  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @return 分页信息  
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>  
</span></span><span style=display:flex><span>Page<span style=color:#f92672>&lt;</span>Cart<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>pageMember</span>(Page<span style=color:#f92672>&lt;</span>Cart<span style=color:#f92672>&gt;</span> page, Long memberId);
</span></span></code></pre></div><ol start=2><li>重写业务方法 <code>CartServiceImpl -> pageMember()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Cacheable</span>(key <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;#root.methodName + &#39;:&#39; + #memberId + &#39;:&#39; + #page.getPageSize() + &#39;:&#39; + #page.getPageNumber()&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Page<span style=color:#f92672>&lt;</span>Cart<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>pageMember</span>(Page<span style=color:#f92672>&lt;</span>Cart<span style=color:#f92672>&gt;</span> page, Long memberId) {  
</span></span><span style=display:flex><span>    QueryWrapper queryWrapper <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> QueryWrapper();  
</span></span><span style=display:flex><span>    queryWrapper.<span style=color:#a6e22e>where</span>(CART.<span style=color:#a6e22e>FK_MEMBER_ID</span>.<span style=color:#a6e22e>eq</span>(memberId));  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> cartMapper.<span style=color:#a6e22e>paginateWithRelations</span>(page, queryWrapper);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=3><li>重写控制方法 <code>CartController -> pageMember()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Operation</span>(summary <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;根据会员分页&#34;</span>, description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;同时联查会员信息和课程信息&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@GetMapping</span>(<span style=color:#e6db74>&#34;pageMember/{memberId}&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Page<span style=color:#f92672>&lt;</span>Cart<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>pageMember</span>(Page<span style=color:#f92672>&lt;</span>Cart<span style=color:#f92672>&gt;</span> page, <span style=color:#a6e22e>@PathVariable</span> Long memberId) {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> cartService.<span style=color:#a6e22e>pageMember</span>(page, memberId);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=e03-根据课程分页>E03. 根据课程分页</h2><blockquote><p>心法: 业务流程</p></blockquote><pre tabindex=0><code class=language-mermaid data-lang=mermaid>graph LR

n1[根据课程主键&lt;br/&gt;分页查询购物车记录] 
--&gt; n2[加入&lt;br/&gt;缓存]
--&gt; n3[返回&lt;br/&gt;分页结果]
</code></pre><blockquote><p>武技: 根据课程主键分页查询全部购物车记录，同时联查会员和课程信息</p></blockquote><ol><li>开发业务接口 <code>CartService -> pageCourse()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/**  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * 根据课程主键分页查询该课程的全部购物车记录  
</span></span></span><span style=display:flex><span><span style=color:#75715e> *  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param page     分页信息  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param courseId 课程主键  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @return 分页信息  
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>  
</span></span><span style=display:flex><span>Page<span style=color:#f92672>&lt;</span>Cart<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>pageCourse</span>(Page<span style=color:#f92672>&lt;</span>Cart<span style=color:#f92672>&gt;</span> page, Long courseId);
</span></span></code></pre></div><ol start=2><li>重写业务方法 <code>CartServiceImpl -> pageCourse()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Cacheable</span>(key <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;#root.methodName + &#39;:&#39; + #courseId + &#39;:&#39; + #page.getPageSize() + &#39;:&#39; + #page.getPageNumber()&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Page<span style=color:#f92672>&lt;</span>Cart<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>pageCourse</span>(Page<span style=color:#f92672>&lt;</span>Cart<span style=color:#f92672>&gt;</span> page, Long courseId) {  
</span></span><span style=display:flex><span>    QueryWrapper queryWrapper <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> QueryWrapper();  
</span></span><span style=display:flex><span>    queryWrapper.<span style=color:#a6e22e>where</span>(CART.<span style=color:#a6e22e>FK_COURSE_ID</span>.<span style=color:#a6e22e>eq</span>(courseId));  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> cartMapper.<span style=color:#a6e22e>paginateWithRelations</span>(page, queryWrapper);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=2><li>重写控制方法 <code>CartController -> pageCourse()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Operation</span>(summary <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;根据课程分页&#34;</span>, description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;同时联查会员信息和课程信息&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@GetMapping</span>(<span style=color:#e6db74>&#34;pageCourse/{courseId}&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Page<span style=color:#f92672>&lt;</span>Cart<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>pageCourse</span>(Page<span style=color:#f92672>&lt;</span>Cart<span style=color:#f92672>&gt;</span> page, <span style=color:#a6e22e>@PathVariable</span> Long courseId) {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> cartService.<span style=color:#a6e22e>pageCourse</span>(page, courseId);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h1 id=s06-开发优惠卷接口>S06. 开发优惠卷接口</h1><blockquote><p>心法: Coupans接口文档</p></blockquote><ul><li>前缀 <code>/api/v1/coupans</code>:</li></ul><table><thead><tr><th></th><th>接口</th><th>类型</th><th>描述</th><th>请求参数</th><th>必要参数</th></tr></thead><tbody><tr><td>1</td><td><code>save</code></td><td>POST</td><td>添加一条记录</td><td><code>@RequestBody CoupansInsertDTO dto</code></td><td>全字段</td></tr><tr><td>2</td><td><code>getInfo/{id}</code></td><td>GET</td><td>根据主键查询</td><td><code>@PathVariable Long id</code></td><td><code>id</code></td></tr><tr><td>3</td><td><code>update</code></td><td>POST</td><td>根据主键修改</td><td><code>@RequestBody CoupansUpdateDTO dto</code></td><td><code>id</code></td></tr><tr><td>4</td><td><code>remove/{id}</code></td><td>POST</td><td>根据主键删除</td><td><code>@PathVariable Long id</code></td><td><code>id</code></td></tr><tr><td>5</td><td><code>removeBatch</code></td><td>POST</td><td>根据主键批删</td><td><code>@RequestParam List&lt;Long> ids</code></td><td><code>ids</code></td></tr><tr><td>6</td><td><code>page/{state}</code></td><td>GET</td><td>根据状态分页</td><td><code>Page&lt;Coupans> page</code><code>@PathVariable state</code></td><td><code>pageNumber</code><code>pageSize</code><code>state</code></td></tr></tbody></table><h2 id=e01-添加一条记录-1>E01. 添加一条记录</h2><blockquote><p>心法: 业务流程</p></blockquote><pre tabindex=0><code class=language-mermaid data-lang=mermaid>graph LR

n1[主键&lt;br/&gt;置空] 
--&gt; n2[设置&lt;br/&gt;优惠卷可用]
--&gt; n3[生成随机&lt;br/&gt;六位兑换码]
--&gt; f{生效时间&lt;br/&gt;失效时间&lt;br/&gt;是否合理}
	f --否--&gt; ex[抛出异常]
	f --是--&gt; n4[设置当前创建时间&lt;br/&gt;设置当前修改时间] 
		--&gt; n5[添加&lt;br/&gt;记录]
		--&gt; n6[逐出&lt;br/&gt;缓存]
		--&gt; n7[返回&lt;br/&gt;布尔结果]
</code></pre><blockquote><p>武技: 添加一条优惠卷记录</p></blockquote><ol><li>开发DTO实体类 <code>CouponsInsertDTO</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> com.lsx.dto;  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Schema</span>(name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;优惠卷添加DTO&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Data</span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>CouponsInsertDTO</span> <span style=color:#66d9ef>implements</span> Serializable {  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@NotEmpty</span>(message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;名称不能为空&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Size</span>(min <span style=color:#f92672>=</span> 1, max <span style=color:#f92672>=</span> 128, message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;名称长度必须在1~128之间&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Schema</span>(description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;名称&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> String name;  
</span></span><span style=display:flex><span>	  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@NotNull</span>(message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;优惠金额不能为空&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Range</span>(min <span style=color:#f92672>=</span> 0, message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;优惠金额最少为0&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Schema</span>(description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;优惠金额，单位分&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> Double value;  
</span></span><span style=display:flex><span>	  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@NotEmpty</span>(message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;满减条件文案不能为空&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Size</span>(min <span style=color:#f92672>=</span> 1, max <span style=color:#f92672>=</span> 128, message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;满减条件文案长度必须在1~128之间&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Schema</span>(description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;满减条件文案&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> String condition;  
</span></span><span style=display:flex><span>	  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@NotEmpty</span>(message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;描述信息不能为空&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Size</span>(min <span style=color:#f92672>=</span> 1, max <span style=color:#f92672>=</span> 128, message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;描述信息长度必须在1~128之间&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Schema</span>(description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;描述信息，优惠券可用时展示&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> String description;  
</span></span><span style=display:flex><span>	  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@NotEmpty</span>(message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;描述信息不能为空&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Size</span>(min <span style=color:#f92672>=</span> 1, max <span style=color:#f92672>=</span> 128, message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;描述信息长度必须在1~128之间&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Schema</span>(description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;描述信息，优惠券不可用时展示&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> String reason;  
</span></span><span style=display:flex><span>	  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@NotEmpty</span>(message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;优惠金额文案不能为空&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Size</span>(min <span style=color:#f92672>=</span> 1, max <span style=color:#f92672>=</span> 128, message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;优惠金额文案长度必须在1~128之间&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Schema</span>(description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;优惠金额文案&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> String valueDesc;  
</span></span><span style=display:flex><span>	  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@NotEmpty</span>(message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;优惠金额单位文案不能为空&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Size</span>(min <span style=color:#f92672>=</span> 1, max <span style=color:#f92672>=</span> 128, message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;优惠金额单位文案长度必须在1~128之间&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Schema</span>(description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;优惠金额单位文案&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> String unitDesc;  
</span></span><span style=display:flex><span>	  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Future</span>(message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;生效时间必须是一个未来的时间&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@NotNull</span>(message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;生效时间不能为空&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Schema</span>(description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;生效时间&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> LocalDateTime startAt;  
</span></span><span style=display:flex><span>	  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Future</span>(message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;失效时间必须是一个未来的时间&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@NotNull</span>(message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;失效时间不能为空&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Schema</span>(description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;失效时间&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> LocalDateTime endAt; 
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=2><li>重写业务方法 <code>CoupansServiceImpl -> save()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@CacheEvict</span>(allEntries <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>save</span>(Coupons entity) {  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 清空主键  </span>
</span></span><span style=display:flex><span>    entity.<span style=color:#a6e22e>setId</span>(<span style=color:#66d9ef>null</span>);  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 设置可用  </span>
</span></span><span style=display:flex><span>    entity.<span style=color:#a6e22e>setState</span>(CouponsConst.<span style=color:#a6e22e>AVAILABLE</span>);  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 生成兑换码  </span>
</span></span><span style=display:flex><span>    entity.<span style=color:#a6e22e>setCode</span>(RandomUtil.<span style=color:#a6e22e>randomString</span>(6));  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 判断生效时间和失效时间是否合理  </span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (entity.<span style=color:#a6e22e>getStartAt</span>().<span style=color:#a6e22e>isAfter</span>(entity.<span style=color:#a6e22e>getEndAt</span>())) {  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> ServiceException(<span style=color:#e6db74>&#34;生效时间不能在失效时间之后&#34;</span>);  
</span></span><span style=display:flex><span>    }  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 设置创建时间和修改时间为当前时间  </span>
</span></span><span style=display:flex><span>    entity.<span style=color:#a6e22e>setCreated</span>(LocalDateTime.<span style=color:#a6e22e>now</span>());  
</span></span><span style=display:flex><span>    entity.<span style=color:#a6e22e>setUpdated</span>(LocalDateTime.<span style=color:#a6e22e>now</span>());  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 添加记录  </span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>super</span>.<span style=color:#a6e22e>save</span>(entity);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=3><li>重写控制方法 <code>CouponsController -> save()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Operation</span>(summary <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;添加一条记录&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@PostMapping</span>(<span style=color:#e6db74>&#34;save&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>save</span>(<span style=color:#a6e22e>@RequestBody</span> <span style=color:#a6e22e>@Validated</span> CouponsInsertDTO dto) {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> couponsService.<span style=color:#a6e22e>save</span>(BeanUtil.<span style=color:#a6e22e>copyProperties</span>(dto, Coupons.<span style=color:#a6e22e>class</span>));  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=e02-根据主键查询-1>E02. 根据主键查询</h2><blockquote><p>心法: 业务流程</p></blockquote><pre tabindex=0><code class=language-mermaid data-lang=mermaid>graph LR

n1[根据主键&lt;br/&gt;查询优惠卷] --&gt; f{是否&lt;br/&gt;存在}
	f --是--&gt; n2[加入缓存] --&gt; n2a[返回结果]
	f --否--&gt; n3[返回空值]
</code></pre><blockquote><p>武技: 根据主键查询一条优惠卷记录</p></blockquote><ol><li>重写业务方法 <code>CoupansServiceImpl -> getById()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Cacheable</span>(key <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;#id&#34;</span>, unless <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;#result == null&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Coupons <span style=color:#a6e22e>getById</span>(Serializable id) {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>super</span>.<span style=color:#a6e22e>getById</span>(id);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=2><li>重写控制方法 <code>CouponsController -> getInfo()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Operation</span>(summary <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;根据主键查询&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@GetMapping</span>(<span style=color:#e6db74>&#34;getInfo/{id}&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Coupons <span style=color:#a6e22e>getInfo</span>(<span style=color:#a6e22e>@PathVariable</span> Long id) {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> couponsService.<span style=color:#a6e22e>getById</span>(id);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=e03-根据主键修改-1>E03. 根据主键修改</h2><blockquote><p>心法: 业务流程</p></blockquote><pre tabindex=0><code class=language-mermaid data-lang=mermaid>graph LR

	n1[设置&lt;br/&gt;当前修改时间]
--&gt; n2[置空&lt;br/&gt;创建时间]
--&gt; n3[置空&lt;br/&gt;兑换码]
--&gt; n4[修改&lt;br/&gt;记录]
--&gt; n5[逐出&lt;br/&gt;缓存]
--&gt; n6[返回&lt;br/&gt;布尔结果]
</code></pre><blockquote><p>武技: 根据主键修改一条优惠卷记录</p></blockquote><ol><li>开发DTO实体类 <code>CouponsUpdateDTO</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> com.lsx.dto;  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Schema</span>(name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;优惠卷修改DTO&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Data</span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>CouponsUpdateDTO</span> <span style=color:#66d9ef>implements</span> Serializable {  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@NotNull</span>(message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;主键不能为空&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Schema</span>(description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;主键&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> Long id;  
</span></span><span style=display:flex><span>	  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Size</span>(min <span style=color:#f92672>=</span> 1, max <span style=color:#f92672>=</span> 128, message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;名称长度必须在1~128之间&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Schema</span>(description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;名称&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> String name;  
</span></span><span style=display:flex><span>	  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Range</span>(min <span style=color:#f92672>=</span> 0, message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;优惠金额最少为0&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Schema</span>(description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;优惠金额，单位分&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> Double value;  
</span></span><span style=display:flex><span>	  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Range</span>(min <span style=color:#f92672>=</span> 0, max <span style=color:#f92672>=</span> 1, message<span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;状态仅支持0可用和1不可用&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Schema</span>(description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;状态，0可用，1不可用&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> Integer state;  
</span></span><span style=display:flex><span>	  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Size</span>(min <span style=color:#f92672>=</span> 1, max <span style=color:#f92672>=</span> 128, message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;满减条件文案长度必须在1~128之间&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Schema</span>(description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;满减条件文案&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> String condition;  
</span></span><span style=display:flex><span>	  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Size</span>(min <span style=color:#f92672>=</span> 1, max <span style=color:#f92672>=</span> 128, message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;描述信息长度必须在1~128之间&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Schema</span>(description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;描述信息，优惠券可用时展示&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> String description;  
</span></span><span style=display:flex><span>	  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Size</span>(min <span style=color:#f92672>=</span> 1, max <span style=color:#f92672>=</span> 128, message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;描述信息长度必须在1~128之间&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Schema</span>(description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;描述信息，优惠券不可用时展示&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> String reason;  
</span></span><span style=display:flex><span>	  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Size</span>(min <span style=color:#f92672>=</span> 1, max <span style=color:#f92672>=</span> 128, message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;优惠金额文案长度必须在1~128之间&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Schema</span>(description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;优惠金额文案&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> String valueDesc;  
</span></span><span style=display:flex><span>	  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Size</span>(min <span style=color:#f92672>=</span> 1, max <span style=color:#f92672>=</span> 128, message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;优惠金额单位文案长度必须在1~128之间&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Schema</span>(description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;优惠金额单位文案&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> String unitDesc;  
</span></span><span style=display:flex><span>	  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Future</span>(message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;生效时间必须是一个未来的时间&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Schema</span>(description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;生效时间&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> LocalDateTime startAt;  
</span></span><span style=display:flex><span>	  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Future</span>(message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;失效时间必须是一个未来的时间&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Schema</span>(description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;失效时间&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> LocalDateTime endAt;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=2><li>重写业务方法 <code>CoupansServiceImpl -> updateById()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@CacheEvict</span>(allEntries <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>updateById</span>(Coupons entity) {  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 设置最后修改时间为当前时间  </span>
</span></span><span style=display:flex><span>	entity.<span style=color:#a6e22e>setUpdated</span>(LocalDateTime.<span style=color:#a6e22e>now</span>());  
</span></span><span style=display:flex><span>	  
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 兑换码和创建时间不允许修改  </span>
</span></span><span style=display:flex><span>	entity.<span style=color:#a6e22e>setCode</span>(<span style=color:#66d9ef>null</span>);  
</span></span><span style=display:flex><span>	entity.<span style=color:#a6e22e>setCreated</span>(<span style=color:#66d9ef>null</span>);  
</span></span><span style=display:flex><span>	  
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 修改记录  </span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>super</span>.<span style=color:#a6e22e>updateById</span>(entity); 
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=3><li>重写控制方法 <code>CouponsController -> update()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Operation</span>(summary <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;根据主键修改&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@PostMapping</span>(<span style=color:#e6db74>&#34;update&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>update</span>(<span style=color:#a6e22e>@RequestBody</span> <span style=color:#a6e22e>@Validated</span> CouponsUpdateDTO dto) {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> couponsService.<span style=color:#a6e22e>updateById</span>(BeanUtil.<span style=color:#a6e22e>copyProperties</span>(dto, Coupons.<span style=color:#a6e22e>class</span>));  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=e04-根据主键删除-1>E04. 根据主键删除</h2><blockquote><p>心法: 业务流程</p></blockquote><pre tabindex=0><code class=language-mermaid data-lang=mermaid>graph LR

n1[根据主键&lt;br/&gt;删除优惠卷记录]
--&gt; n2[逐出&lt;br/&gt;缓存]
--&gt; n3[返回&lt;br/&gt;布尔结果]
</code></pre><blockquote><p>武技: 根据主键删除一条优惠卷记录</p></blockquote><ol><li>重写业务方法 <code>CoupansServiceImpl -> removeById()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@CacheEvict</span>(allEntries <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>removeById</span>(Serializable id) {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>super</span>.<span style=color:#a6e22e>removeById</span>(id);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=2><li>重写控制方法 <code>CouponsController -> remove()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Operation</span>(summary <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;根据主键删除&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@PostMapping</span>(<span style=color:#e6db74>&#34;remove/{id}&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>remove</span>(<span style=color:#a6e22e>@PathVariable</span> Long id) {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> couponsService.<span style=color:#a6e22e>removeById</span>(id);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=e05-根据主键批删-1>E05. 根据主键批删</h2><blockquote><p>心法: 业务流程</p></blockquote><pre tabindex=0><code class=language-mermaid data-lang=mermaid>graph LR

n1[根据主键列表&lt;br/&gt;批量删除优惠卷记录]
--&gt; n2[逐出&lt;br/&gt;缓存]
--&gt; n3[返回&lt;br/&gt;布尔结果]
</code></pre><blockquote><p>武技: 根据主键数组删除优惠卷记录</p></blockquote><ol><li>重写业务方法 <code>CoupansServiceImpl -> removeByIds()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@CacheEvict</span>(allEntries <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>removeByIds</span>(Collection<span style=color:#f92672>&lt;?</span> <span style=color:#66d9ef>extends</span> Serializable<span style=color:#f92672>&gt;</span> ids) {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>super</span>.<span style=color:#a6e22e>removeByIds</span>(ids);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=2><li>重写控制方法 <code>CouponsController -> removeBatch()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Operation</span>(summary <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;根据主键批删&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@PostMapping</span>(<span style=color:#e6db74>&#34;removeBatch&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>removeBatch</span>(<span style=color:#a6e22e>@RequestParam</span> List<span style=color:#f92672>&lt;</span>Long<span style=color:#f92672>&gt;</span> ids) {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> couponsService.<span style=color:#a6e22e>removeByIds</span>(ids);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=e06-根据状态分页>E06. 根据状态分页</h2><blockquote><p>心法: 业务流程</p></blockquote><pre tabindex=0><code class=language-mermaid data-lang=mermaid>graph LR

n1[检查分类指标] --&gt; f{是否&lt;br/&gt;合法}
	f--否--&gt; ex[抛出异常]
	f--是--&gt; n2[分页查询&lt;br/&gt;优惠卷记录] 
		--&gt; n3[根据创建时间降序&lt;br/&gt;根据主键降序] 
		--&gt; n4[加入&lt;br/&gt;缓存]
		--&gt; n5[返回&lt;br/&gt;分页结果]
</code></pre><blockquote><p>武技: 根据 state 属性分类，分页查询优惠卷记录</p></blockquote><ol><li>开发业务方法 <code>CoupansService -> page()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/**  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * 根据 state 属性分类，分页查询优惠卷记录  
</span></span></span><span style=display:flex><span><span style=color:#75715e> *  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param page  分页信息  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param state 状态，0可用，1不可用  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @return 分页信息  
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>  
</span></span><span style=display:flex><span>Page<span style=color:#f92672>&lt;</span>Coupons<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>page</span>(Page<span style=color:#f92672>&lt;</span>Coupons<span style=color:#f92672>&gt;</span> page, Integer state);
</span></span></code></pre></div><ol start=2><li>重写业务方法 <code>CoupansServiceImpl -> page()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Cacheable</span>(key <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;#root.methodName + &#39;:&#39; + #state + &#39;:&#39; + #page.getPageSize() + &#39;:&#39; + #page.getPageNumber()&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Page<span style=color:#f92672>&lt;</span>Coupons<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>page</span>(Page<span style=color:#f92672>&lt;</span>Coupons<span style=color:#f92672>&gt;</span> page, Integer state) {  
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 检查 state 参数是否不合法  </span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>state.<span style=color:#a6e22e>equals</span>(CouponsConst.<span style=color:#a6e22e>AVAILABLE</span>) <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span>state.<span style=color:#a6e22e>equals</span>(CouponsConst.<span style=color:#a6e22e>UNAVAILABLE</span>)) { 
</span></span><span style=display:flex><span>	    <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> ServiceException(<span style=color:#e6db74>&#34;state参数不合法&#34;</span>);  
</span></span><span style=display:flex><span>	}  
</span></span><span style=display:flex><span>	QueryWrapper queryWrapper <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> QueryWrapper();  
</span></span><span style=display:flex><span>	queryWrapper.<span style=color:#a6e22e>where</span>(COUPONS.<span style=color:#a6e22e>STATE</span>.<span style=color:#a6e22e>eq</span>(state));  
</span></span><span style=display:flex><span>	queryWrapper.<span style=color:#a6e22e>orderBy</span>(COUPONS.<span style=color:#a6e22e>CREATED</span>.<span style=color:#a6e22e>desc</span>(), COUPONS.<span style=color:#a6e22e>ID</span>.<span style=color:#a6e22e>desc</span>());
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>super</span>.<span style=color:#a6e22e>page</span>(page, queryWrapper);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=3><li>重写控制方法 <code>CouponsController -> page()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Operation</span>(summary <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;根据状态分页&#34;</span>,  
</span></span><span style=display:flex><span>        description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;根据创建日期降序，当state为0时，分页查询可用优惠卷，当state为1时，分页查询不可用优惠卷&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@GetMapping</span>(<span style=color:#e6db74>&#34;page/{state}&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Page<span style=color:#f92672>&lt;</span>Coupons<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>page</span>(Page<span style=color:#f92672>&lt;</span>Coupons<span style=color:#f92672>&gt;</span> page, <span style=color:#a6e22e>@PathVariable</span> Integer state) {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> couponsService.<span style=color:#a6e22e>page</span>(page, state);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=e07-删除过期记录>E07. 删除过期记录</h2><blockquote><p>武技: 每天凌晨零点，标记全部过期优惠卷为 &ldquo;已过期&rdquo;，每周一凌晨2点半，删除全部已过期的优惠卷</p></blockquote><ol><li>开发定时任务类 <code>CouponsTask</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> com.lsx.component;  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Slf4j</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Component</span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>CouponsTask</span> {  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Autowired</span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> CouponsService couponsService;  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>/** 每天凌晨零点，标记全部过期优惠卷为 &#34;已过期&#34; */</span>    
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Scheduled</span>(cron <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;00 00 00 * * ?&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>markExpiredCoupons</span>() {  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 将全部 &#34;ent_at = 今天&#34; 的优惠卷标记为不可用</span>
</span></span><span style=display:flex><span>	    QueryWrapper queryWrapper <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> QueryWrapper();  
</span></span><span style=display:flex><span>	    queryWrapper.<span style=color:#a6e22e>where</span>(dateFormat(COUPONS.<span style=color:#a6e22e>END_AT</span>, <span style=color:#e6db74>&#34;%Y-%m-%d&#34;</span>).<span style=color:#a6e22e>le</span>(curDate()));  
</span></span><span style=display:flex><span>	    Coupons coupons <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Coupons();  
</span></span><span style=display:flex><span>	    coupons.<span style=color:#a6e22e>setState</span>(CouponsConst.<span style=color:#a6e22e>UNAVAILABLE</span>);  
</span></span><span style=display:flex><span>	    coupons.<span style=color:#a6e22e>setReason</span>(<span style=color:#e6db74>&#34;该优惠卷已过期&#34;</span>);  
</span></span><span style=display:flex><span>	    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>couponsService.<span style=color:#a6e22e>update</span>(coupons, queryWrapper)) {  
</span></span><span style=display:flex><span>	        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> ServiceException(<span style=color:#e6db74>&#34;标记过期优惠卷任务执行异常&#34;</span>);  
</span></span><span style=display:flex><span>	    }  
</span></span><span style=display:flex><span>	    log.<span style=color:#a6e22e>info</span>(<span style=color:#e6db74>&#34;标记过期优惠卷任务执行完毕&#34;</span>);  
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>/** 每周一凌晨2:30，删除全部 &#34;已过期&#34; 的优惠卷 */</span>  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Scheduled</span>(cron <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;00 30 02 ? * MON&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>deleteExpiredCoupons</span>() {  
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	    <span style=color:#75715e>// 删除全部不可用的优惠卷</span>
</span></span><span style=display:flex><span>	    QueryWrapper queryWrapper <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> QueryWrapper();  
</span></span><span style=display:flex><span>	    queryWrapper.<span style=color:#a6e22e>where</span>(COUPONS.<span style=color:#a6e22e>START_AT</span>.<span style=color:#a6e22e>eq</span>(CouponsConst.<span style=color:#a6e22e>UNAVAILABLE</span>));  
</span></span><span style=display:flex><span>	    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>couponsService.<span style=color:#a6e22e>remove</span>(queryWrapper)) {  
</span></span><span style=display:flex><span>	        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> ServiceException(<span style=color:#e6db74>&#34;删除过期优惠卷任务执行异常&#34;</span>);  
</span></span><span style=display:flex><span>	    }  
</span></span><span style=display:flex><span>	    log.<span style=color:#a6e22e>info</span>(<span style=color:#e6db74>&#34;删除过期优惠卷任务执行完毕&#34;</span>);  
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h1 id=s07-开发订单接口>S07. 开发订单接口</h1><blockquote><p>心法: Order接口文档</p></blockquote><ul><li>前缀 <code>/api/v1/order</code>:</li></ul><table><thead><tr><th></th><th>接口</th><th>类型</th><th>描述</th><th>请求参数</th><th>必要参数</th></tr></thead><tbody><tr><td>1</td><td><code>getInfo/{id}</code></td><td>GET</td><td>根据主键查询</td><td><code>@PathVariable Long id</code></td><td><code>id</code></td></tr><tr><td>2</td><td><code>getBySn/{sn}</code></td><td>GET</td><td>根据编号查询</td><td><code>@PathVariable sn</code></td><td><code>sn</code></td></tr><tr><td>3</td><td><code>page/{state}</code></td><td>GET</td><td>根据状态分页</td><td><code>Page&lt;Coupanss> page</code><code>@PathVariable state</code></td><td><code>pageNumber</code><code>pageSize</code><code>state</code></td></tr><tr><td>4</td><td><code>pageMember/{memberId}</code></td><td>GET</td><td>根据会员分页</td><td><code>Page&lt;Coupanss> page</code><code>@PathVariable memberId</code></td><td><code>pageNumber</code><code>pageSize</code><code>memberId</code></td></tr><tr><td>5</td><td><code>excel</code></td><td>GET</td><td>报表打印数据</td><td></td><td></td></tr><tr><td>6</td><td><code>todayCount</code></td><td>GET</td><td>统计今日订单</td><td></td><td></td></tr><tr><td>7</td><td><code>totalCount</code></td><td>GET</td><td>统计订单总数</td><td></td><td></td></tr></tbody></table><h2 id=e01-根据主键查询-2>E01. 根据主键查询</h2><blockquote><p>心法: 业务流程</p></blockquote><pre tabindex=0><code class=language-mermaid data-lang=mermaid>graph LR

n1[根据主键&lt;br/&gt;查询订单] --&gt; f{是否&lt;br/&gt;存在}
	f --是--&gt; n2[加入缓存] --&gt; n2a[返回结果]
	f --否--&gt; n3[返回空值]
</code></pre><blockquote><p>武技: 根据主键查询一条订单记录，同时级联查询该订单中的全部课程</p></blockquote><ol><li>优化实体类 <code>Order</code>:<ul><li>1条订单对应N个课程，1个课程可以出现在多条订单中。</li></ul></li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/** 订单[N] : 课程[N] */</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RelationManyToMany</span>(  
</span></span><span style=display:flex><span>        selfField <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;id&#34;</span>, targetField <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;id&#34;</span>,  
</span></span><span style=display:flex><span>        joinTable <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;oms_order_course&#34;</span>,  
</span></span><span style=display:flex><span>        joinSelfColumn <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;fk_order_id&#34;</span>, joinTargetColumn <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;fk_course_id&#34;</span>  
</span></span><span style=display:flex><span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> List<span style=color:#f92672>&lt;</span>Course<span style=color:#f92672>&gt;</span> courses;
</span></span></code></pre></div><ol start=2><li>重写业务方法 <code>OrderServiceImpl -> getById()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Cacheable</span>(key <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;#id&#34;</span>, unless <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;#result == null&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Order <span style=color:#a6e22e>getById</span>(Serializable id) {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> orderMapper.<span style=color:#a6e22e>selectOneWithRelationsById</span>(id);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=3><li>重写控制方法 <code>OrderController -> getInfo()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Operation</span>(summary <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;根据主键查询&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@GetMapping</span>(<span style=color:#e6db74>&#34;getInfo/{id}&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Order <span style=color:#a6e22e>getInfo</span>(<span style=color:#a6e22e>@PathVariable</span> Long id) {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> orderService.<span style=color:#a6e22e>getById</span>(id);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=e02-根据编号查询>E02. 根据编号查询</h2><blockquote><p>心法: 业务流程</p></blockquote><pre tabindex=0><code class=language-mermaid data-lang=mermaid>graph LR

n1[根据订单编号&lt;br/&gt;查询订单] --&gt; f{是否&lt;br/&gt;存在}
	f --是--&gt; n2[加入缓存] --&gt; n2a[返回结果]
	f --否--&gt; n3[返回空值]
</code></pre><blockquote><p>武技: 根据订单编号查询一条订单记录，同时级联查询该订单中的全部课程</p></blockquote><ol><li>开发业务方法 <code>OrderService -> getBySn()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/**  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * 根据订单编号查询一条订单记录，同时查询该订单下的全部课程  
</span></span></span><span style=display:flex><span><span style=color:#75715e> *  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param sn 订单编号  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @return 订单信息  
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>  
</span></span><span style=display:flex><span>Order <span style=color:#a6e22e>getBySn</span>(String sn);
</span></span></code></pre></div><ol start=2><li>重写业务方法 <code>OrderServiceImpl -> getBySn()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Cacheable</span>(key <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;#sn&#34;</span>, unless <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;#result == null&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Override</span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Order <span style=color:#a6e22e>getBySn</span>(String sn) {  
</span></span><span style=display:flex><span>    QueryWrapper queryWrapper <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> QueryWrapper();  
</span></span><span style=display:flex><span>    queryWrapper.<span style=color:#a6e22e>where</span>(ORDER.<span style=color:#a6e22e>SN</span>.<span style=color:#a6e22e>eq</span>(sn));  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> orderMapper.<span style=color:#a6e22e>selectOneWithRelationsByQuery</span>(queryWrapper);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=3><li>重写控制方法 <code>OrderController -> getBySn()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Operation</span>(summary <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;根据编号查询&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@GetMapping</span>(<span style=color:#e6db74>&#34;getBySn/{sn}&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Order <span style=color:#a6e22e>getInfo</span>(<span style=color:#a6e22e>@PathVariable</span> String sn) {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> orderService.<span style=color:#a6e22e>getBySn</span>(sn);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=e03-根据状态分页>E03. 根据状态分页</h2><blockquote><p>心法: 业务流程</p></blockquote><pre tabindex=0><code class=language-mermaid data-lang=mermaid>graph LR

n1[检查分类指标] --&gt; f{是否&lt;br/&gt;合法}
	f--否--&gt; ex[抛出异常]
	f--是--&gt; n2[分页查询&lt;br/&gt;订单记录] 
		--&gt; n3[根据创建时间降序&lt;br/&gt;根据主键降序] 
		--&gt; n4[加入&lt;br/&gt;缓存]
		--&gt; n5[返回&lt;br/&gt;分页结果]
</code></pre><blockquote><p>武技: 根据 state 属性分类，分页查询订单记录，同时级联查询该订单中的全部课程</p></blockquote><ol><li>开发业务方法 <code>OrderService -> page()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/**  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * 根据 state 属性分类，分页查询订单记录，同时查询该订单下的全部课程  
</span></span></span><span style=display:flex><span><span style=color:#75715e> *  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param page  分页信息  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param state 状态，0未付款，1已付款，2已发货，3已退款  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @return 分页结果  
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>  
</span></span><span style=display:flex><span>Page<span style=color:#f92672>&lt;</span>Order<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>page</span>(Page<span style=color:#f92672>&lt;</span>Order<span style=color:#f92672>&gt;</span> page, Integer state);
</span></span></code></pre></div><ol start=2><li>重写业务方法 <code>OrderServiceImpl -> page()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Cacheable</span>(key <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;#root.methodName + &#39;:&#39; + #state + &#39;:&#39; + #page.getPageSize() + &#39;:&#39; + #page.getPageNumber()&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Page<span style=color:#f92672>&lt;</span>Order<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>page</span>(Page<span style=color:#f92672>&lt;</span>Order<span style=color:#f92672>&gt;</span> page, Integer state) {  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 检查 state 参数是否不合法  </span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>state.<span style=color:#a6e22e>equals</span>(OrderConst.<span style=color:#a6e22e>PAID</span>)  
</span></span><span style=display:flex><span>	        <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span>state.<span style=color:#a6e22e>equals</span>(OrderConst.<span style=color:#a6e22e>UNPAID</span>)  
</span></span><span style=display:flex><span>	        <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span>state.<span style=color:#a6e22e>equals</span>(OrderConst.<span style=color:#a6e22e>SENT_OUT</span>)  
</span></span><span style=display:flex><span>	        <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span>state.<span style=color:#a6e22e>equals</span>(OrderConst.<span style=color:#a6e22e>REFUNDED</span>)) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> ServiceException(<span style=color:#e6db74>&#34;state参数不合法&#34;</span>);  
</span></span><span style=display:flex><span>    }  
</span></span><span style=display:flex><span>    QueryWrapper queryWrapper <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> QueryWrapper();  
</span></span><span style=display:flex><span>    queryWrapper.<span style=color:#a6e22e>where</span>(ORDER.<span style=color:#a6e22e>STATE</span>.<span style=color:#a6e22e>eq</span>(state));  
</span></span><span style=display:flex><span>    queryWrapper.<span style=color:#a6e22e>orderBy</span>(ORDER.<span style=color:#a6e22e>CREATED</span>.<span style=color:#a6e22e>desc</span>(), ORDER.<span style=color:#a6e22e>ID</span>.<span style=color:#a6e22e>desc</span>());
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> orderMapper.<span style=color:#a6e22e>paginateWithRelations</span>(page, queryWrapper);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=3><li>重写控制方法 <code>OrderController -> page()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Operation</span>(summary <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;根据状态分页&#34;</span>, description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;</span> <span style=color:#f92672>+</span>  
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;当state为0时，分页查询未付款订单，&#34;</span> <span style=color:#f92672>+</span>  
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;当state为1时，分页查询已付款订单，&#34;</span> <span style=color:#f92672>+</span>  
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;当state为2时，分页查询已发货订单，&#34;</span> <span style=color:#f92672>+</span>  
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;当state为3时，分页查询已退款订单。&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>@GetMapping</span>(<span style=color:#e6db74>&#34;page/{state}&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Page<span style=color:#f92672>&lt;</span>Order<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>page</span>(Page<span style=color:#f92672>&lt;</span>Order<span style=color:#f92672>&gt;</span> page, <span style=color:#a6e22e>@PathVariable</span> Integer state) {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> orderService.<span style=color:#a6e22e>page</span>(page, state);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=e04-根据会员分页>E04. 根据会员分页</h2><blockquote><p>心法: 业务流程</p></blockquote><pre tabindex=0><code class=language-mermaid data-lang=mermaid>graph LR

n1[根据会员主键&lt;br/&gt;分页查询订单记录] 
--&gt; n2[根据创建时间降序&lt;br/&gt;根据主键降序] 
--&gt; n3[加入&lt;br/&gt;缓存]
--&gt; n4[返回&lt;br/&gt;分页结果]
</code></pre><blockquote><p>武技: 根据会员主键分页查询该会员的订单记录，同时级联查询该订单中的全部课程</p></blockquote><ol><li>开发业务接口 <code>OrderService -> pageMember()</code></li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/**  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * 根据会员主键分页查询该会员的订单记录，同时查询该订单下的全部课程  
</span></span></span><span style=display:flex><span><span style=color:#75715e> *  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param page     分页信息  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param memberId 会员主键  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @return 分页结果  
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>  
</span></span><span style=display:flex><span>Page<span style=color:#f92672>&lt;</span>Order<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>pageMember</span>(Page<span style=color:#f92672>&lt;</span>Order<span style=color:#f92672>&gt;</span> page, Integer memberId);
</span></span></code></pre></div><ol start=2><li>重写业务方法 <code>OrderServiceImpl -> pageMember()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Cacheable</span>(key <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;#root.methodName + &#39;:&#39; + #memberId + &#39;:&#39; + #page.getPageSize() + &#39;:&#39; + #page.getPageNumber()&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Override</span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Page<span style=color:#f92672>&lt;</span>Order<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>pageMember</span>(Page<span style=color:#f92672>&lt;</span>Order<span style=color:#f92672>&gt;</span> page, Integer memberId) {  
</span></span><span style=display:flex><span>    QueryWrapper queryWrapper <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> QueryWrapper();  
</span></span><span style=display:flex><span>    queryWrapper.<span style=color:#a6e22e>where</span>(ORDER.<span style=color:#a6e22e>FK_MEMBER_ID</span>.<span style=color:#a6e22e>eq</span>(memberId));  
</span></span><span style=display:flex><span>    queryWrapper.<span style=color:#a6e22e>orderBy</span>(ORDER.<span style=color:#a6e22e>CREATED</span>.<span style=color:#a6e22e>desc</span>(), ORDER.<span style=color:#a6e22e>ID</span>.<span style=color:#a6e22e>desc</span>());
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> orderMapper.<span style=color:#a6e22e>paginateWithRelations</span>(page, queryWrapper);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=3><li>重写控制方法 <code>OrderController -> pageMember()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Operation</span>(summary <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;根据会员分页&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@GetMapping</span>(<span style=color:#e6db74>&#34;pageMember/{memberId}&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Page<span style=color:#f92672>&lt;</span>Order<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>pageMember</span>(Page<span style=color:#f92672>&lt;</span>Order<span style=color:#f92672>&gt;</span> page, <span style=color:#a6e22e>@PathVariable</span> Integer memberId) {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> orderService.<span style=color:#a6e22e>pageMember</span>(page, memberId);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=e05-报表打印数据>E05. 报表打印数据</h2><blockquote><p>心法: 业务流程</p></blockquote><pre tabindex=0><code class=language-mermaid data-lang=mermaid>graph LR

n1[全查&lt;br/&gt;订单列表]
--&gt; n2[将订单列表&lt;br/&gt;转为EasyExcel所需格式]
	n2 -.- n2a[订单支付方式中文处理&lt;br/&gt;订单状态中文处理] -.- n2b[真实姓名数据脱敏&lt;br/&gt;身份证号数据脱敏&lt;br/&gt;手机号码数据脱敏]
n2 --&gt; n5[加入&lt;br/&gt;缓存] --&gt; n6[返回&lt;br/&gt;订单列表]
</code></pre><blockquote><p>武技: 打印全部订单明细，包括订单信息和课程信息</p></blockquote><ol><li>优化实体类 <code>OrderCourse</code>:<ul><li>1条订单明细记录只能对应1条订单记录，1条订单记录可以出现在N条订单明细记录中。</li><li>1条订单明细记录只能对应1条课程记录，1条课程记录可以出现在N条订单明细记录中。</li></ul></li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/** 订单明细[N] : 订单[1] */</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RelationManyToOne</span>(selfField <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;fkOrderId&#34;</span>, targetField <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;id&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> Order order;  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#75715e>/** 订单明细[N] : 课程[1] */</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RelationManyToOne</span>(selfField <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;fkCourseId&#34;</span>, targetField <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;id&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> Course course;
</span></span></code></pre></div><ol start=2><li>开发DTO实体类 <code>OrderExcelDTO</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> com.lsx.dto;  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@ColumnWidth</span>(20)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Data</span> 
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>OrderExcelDTO</span> <span style=color:#66d9ef>implements</span> Serializable {  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@ColumnWidth</span>(40)  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@ExcelProperty</span>(value <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#34;订单表&#34;</span>, <span style=color:#e6db74>&#34;订单基础信息&#34;</span>, <span style=color:#e6db74>&#34;订单编号&#34;</span>})  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String sn;  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@ExcelProperty</span>(value <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#34;订单表&#34;</span>, <span style=color:#e6db74>&#34;订单基础信息&#34;</span>, <span style=color:#e6db74>&#34;订单总金额&#34;</span>})  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Double totalAmount;  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@ExcelProperty</span>(value <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#34;订单表&#34;</span>, <span style=color:#e6db74>&#34;订单基础信息&#34;</span>, <span style=color:#e6db74>&#34;实际支付总金额&#34;</span>})  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Double payAmount;  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@ExcelProperty</span>(value <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#34;订单表&#34;</span>, <span style=color:#e6db74>&#34;订单基础信息&#34;</span>, <span style=color:#e6db74>&#34;订单支付方式&#34;</span>})  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String payType;  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@ExcelProperty</span>(value <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#34;订单表&#34;</span>, <span style=color:#e6db74>&#34;订单基础信息&#34;</span>, <span style=color:#e6db74>&#34;订单描述&#34;</span>})  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String info;  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@ExcelProperty</span>(value <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#34;订单表&#34;</span>, <span style=color:#e6db74>&#34;订单基础信息&#34;</span>, <span style=color:#e6db74>&#34;订单状态&#34;</span>})  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String state;  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@ExcelProperty</span>(value <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#34;订单表&#34;</span>, <span style=color:#e6db74>&#34;订单基础信息&#34;</span>, <span style=color:#e6db74>&#34;下单账号&#34;</span>})  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String username;  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@ExcelProperty</span>(value <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#34;订单表&#34;</span>, <span style=color:#e6db74>&#34;课程商品信息&#34;</span>, <span style=color:#e6db74>&#34;课程标题&#34;</span>})  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String courseTitle;  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@ExcelProperty</span>(value <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#34;订单表&#34;</span>, <span style=color:#e6db74>&#34;课程商品信息&#34;</span>, <span style=color:#e6db74>&#34;课程单价&#34;</span>})  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Double price;  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@ExcelProperty</span>(value <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#34;订单表&#34;</span>, <span style=color:#e6db74>&#34;课程商品信息&#34;</span>, <span style=color:#e6db74>&#34;课程类目&#34;</span>})  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String categoryTitle;  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=3><li>开发业务接口 <code>OrderService -> getExcelData()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/**  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * 全查订单明细，同时联查该订单明细关联的订单信息和课程信息  
</span></span></span><span style=display:flex><span><span style=color:#75715e> *  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @return 全部订单明细，包括订单信息和课程信息  
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>  
</span></span><span style=display:flex><span>List<span style=color:#f92672>&lt;</span>OrderExcelDTO<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>getExcelData</span>();
</span></span></code></pre></div><ol start=4><li>重写业务方法 <code>OrderServiceImpl -> getExcelData()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Cacheable</span>(key <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;#root.methodName&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Override</span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> List<span style=color:#f92672>&lt;</span>OrderExcelDTO<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>getExcelData</span>() {  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 忽略订单中的课程联查以及课程中的作者联查  </span>
</span></span><span style=display:flex><span>    RelationManager.<span style=color:#a6e22e>addIgnoreRelations</span>(<span style=color:#e6db74>&#34;courses&#34;</span>, <span style=color:#e6db74>&#34;member&#34;</span>);  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 查询全部订单明细记录  </span>
</span></span><span style=display:flex><span>    List<span style=color:#f92672>&lt;</span>OrderCourse<span style=color:#f92672>&gt;</span> orderCourses <span style=color:#f92672>=</span> orderCourseMapper.<span style=color:#a6e22e>selectAllWithRelations</span>();  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// List&lt;OrderCourse&gt; -&gt; List&lt;OrderExcelDTO&gt;  </span>
</span></span><span style=display:flex><span>    List<span style=color:#f92672>&lt;</span>OrderExcelDTO<span style=color:#f92672>&gt;</span> result <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ArrayList<span style=color:#f92672>&lt;&gt;</span>();  
</span></span><span style=display:flex><span>    orderCourses.<span style=color:#a6e22e>forEach</span>(orderCourse <span style=color:#f92672>-&gt;</span> {  
</span></span><span style=display:flex><span>        OrderExcelDTO orderExcelDTO <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> OrderExcelDTO();  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 赋值Order相关信息  </span>
</span></span><span style=display:flex><span>        Order order <span style=color:#f92672>=</span> orderCourse.<span style=color:#a6e22e>getOrder</span>();  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (ObjectUtil.<span style=color:#a6e22e>isNull</span>(order)) {  
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> ServiceException(<span style=color:#e6db74>&#34;订单记录不存在&#34;</span>);  
</span></span><span style=display:flex><span>        }  
</span></span><span style=display:flex><span>        BeanUtil.<span style=color:#a6e22e>copyProperties</span>(order, orderExcelDTO);  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 处理订单支付方式  </span>
</span></span><span style=display:flex><span>        Integer payType <span style=color:#f92672>=</span> order.<span style=color:#a6e22e>getPayType</span>();  
</span></span><span style=display:flex><span>        orderExcelDTO.<span style=color:#a6e22e>setPayType</span>(  
</span></span><span style=display:flex><span>                OrderConst.<span style=color:#a6e22e>NO_PAY</span>.<span style=color:#a6e22e>equals</span>(payType) <span style=color:#f92672>?</span> <span style=color:#e6db74>&#34;未支付&#34;</span> :  
</span></span><span style=display:flex><span>                OrderConst.<span style=color:#a6e22e>ALI_PAY</span>.<span style=color:#a6e22e>equals</span>(payType) <span style=color:#f92672>?</span> <span style=color:#e6db74>&#34;支付宝&#34;</span> :  
</span></span><span style=display:flex><span>                OrderConst.<span style=color:#a6e22e>WECHAT_PAY</span>.<span style=color:#a6e22e>equals</span>(payType) <span style=color:#f92672>?</span> <span style=color:#e6db74>&#34;微信&#34;</span> :  
</span></span><span style=display:flex><span>                OrderConst.<span style=color:#a6e22e>OTHER_PAY</span>.<span style=color:#a6e22e>equals</span>(payType) <span style=color:#f92672>?</span> <span style=color:#e6db74>&#34;其他方式&#34;</span> : <span style=color:#e6db74>&#34;支付方式异常&#34;</span>  
</span></span><span style=display:flex><span>        );  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 处理订单状态  </span>
</span></span><span style=display:flex><span>        Integer state <span style=color:#f92672>=</span> order.<span style=color:#a6e22e>getState</span>();  
</span></span><span style=display:flex><span>        orderExcelDTO.<span style=color:#a6e22e>setState</span>(  
</span></span><span style=display:flex><span>                OrderConst.<span style=color:#a6e22e>UNPAID</span>.<span style=color:#a6e22e>equals</span>(state) <span style=color:#f92672>?</span> <span style=color:#e6db74>&#34;未付款&#34;</span> :  
</span></span><span style=display:flex><span>                OrderConst.<span style=color:#a6e22e>PAID</span>.<span style=color:#a6e22e>equals</span>(state) <span style=color:#f92672>?</span> <span style=color:#e6db74>&#34;已付款&#34;</span> :  
</span></span><span style=display:flex><span>                OrderConst.<span style=color:#a6e22e>SENT_OUT</span>.<span style=color:#a6e22e>equals</span>(state) <span style=color:#f92672>?</span> <span style=color:#e6db74>&#34;已发货&#34;</span> :  
</span></span><span style=display:flex><span>                OrderConst.<span style=color:#a6e22e>REFUNDED</span>.<span style=color:#a6e22e>equals</span>(state) <span style=color:#f92672>?</span> <span style=color:#e6db74>&#34;已退款&#34;</span> : <span style=color:#e6db74>&#34;订单状态异常&#34;</span>  
</span></span><span style=display:flex><span>        );  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 赋值Course相关信息  </span>
</span></span><span style=display:flex><span>        Course course <span style=color:#f92672>=</span> orderCourse.<span style=color:#a6e22e>getCourse</span>();  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (ObjectUtil.<span style=color:#a6e22e>isNull</span>(course)) {  
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> ServiceException(<span style=color:#e6db74>&#34;课程记录不存在&#34;</span>);  
</span></span><span style=display:flex><span>        }  
</span></span><span style=display:flex><span>        orderExcelDTO.<span style=color:#a6e22e>setCourseTitle</span>(course.<span style=color:#a6e22e>getTitle</span>());  
</span></span><span style=display:flex><span>        orderExcelDTO.<span style=color:#a6e22e>setPrice</span>(course.<span style=color:#a6e22e>getPrice</span>());  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 赋值Category相关信息  </span>
</span></span><span style=display:flex><span>        Category category <span style=color:#f92672>=</span> course.<span style=color:#a6e22e>getCategory</span>();  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (ObjectUtil.<span style=color:#a6e22e>isNull</span>(category)) {  
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> ServiceException(<span style=color:#e6db74>&#34;类目记录不存在&#34;</span>);  
</span></span><span style=display:flex><span>        }  
</span></span><span style=display:flex><span>        orderExcelDTO.<span style=color:#a6e22e>setCategoryTitle</span>(category.<span style=color:#a6e22e>getTitle</span>());  
</span></span><span style=display:flex><span>        result.<span style=color:#a6e22e>add</span>(orderExcelDTO);  
</span></span><span style=display:flex><span>    });  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> result;  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=5><li>重写控制方法 <code>OrderController -> excel()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Operation</span>(summary <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;报表打印数据&#34;</span>, description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;打印订单明细，包括该订单明细关联的订单信息和课程信息&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@GetMapping</span>(<span style=color:#e6db74>&#34;excel&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>excel</span>(HttpServletResponse response) {  
</span></span><span style=display:flex><span>    EasyExcelUtil.<span style=color:#a6e22e>download</span>(response,  
</span></span><span style=display:flex><span>            OrderConst.<span style=color:#a6e22e>EXCEL_FILE_NAME</span>,  
</span></span><span style=display:flex><span>            OrderConst.<span style=color:#a6e22e>EXCEL_SHEET_NAME</span>,  
</span></span><span style=display:flex><span>            OrderExcelDTO.<span style=color:#a6e22e>class</span>,  
</span></span><span style=display:flex><span>            orderService.<span style=color:#a6e22e>getExcelData</span>());  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=e06-统计日增订单>E06. 统计日增订单</h2><blockquote><p>心法: 业务流程</p></blockquote><pre tabindex=0><code class=language-mermaid data-lang=mermaid>graph LR

n1[查询&lt;br/&gt;日增订单数量] 
--&gt; n2[加入&lt;br/&gt;缓存]
--&gt; n3[返回&lt;br/&gt;日增订单数量]
</code></pre><blockquote><p>武技: 开发统计日增订单的接口</p></blockquote><ol><li>开发业务方法 <code>OrderService -> countToday()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/**  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * 获取今日新增的订单数量  
</span></span></span><span style=display:flex><span><span style=color:#75715e> *  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @return 今日新增的订单数量    
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>  
</span></span><span style=display:flex><span>Long <span style=color:#a6e22e>countToday</span>();
</span></span></code></pre></div><ol start=2><li>实现业务方法 <code>OrderServiceImpl -> countToday()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Cacheable</span>(key <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;#root.methodName&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Override</span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Long <span style=color:#a6e22e>countToday</span>() {  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// select count(*) from oms_order where date_format(created, &#39;%Y-%m-%d&#39;) = curdate()  </span>
</span></span><span style=display:flex><span>    QueryWrapper queryWrapper <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> QueryWrapper();  
</span></span><span style=display:flex><span>    queryWrapper.<span style=color:#a6e22e>select</span>(QueryMethods.<span style=color:#a6e22e>count</span>().<span style=color:#a6e22e>as</span>(<span style=color:#e6db74>&#34;count&#34;</span>))  
</span></span><span style=display:flex><span>            .<span style=color:#a6e22e>where</span>(dateFormat(ORDER.<span style=color:#a6e22e>CREATED</span>, <span style=color:#e6db74>&#34;%Y-%m-%d&#34;</span>).<span style=color:#a6e22e>eq</span>(curDate()));  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> (Long) orderMapper.<span style=color:#a6e22e>selectObjectByQuery</span>(queryWrapper);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=3><li>开发控制方法 <code>OrderController -> countToday()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Operation</span>(summary <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;统计日增订单&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@GetMapping</span>(<span style=color:#e6db74>&#34;countToday&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Long <span style=color:#a6e22e>countToday</span>() {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> orderService.<span style=color:#a6e22e>countToday</span>();  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=e07-统计订单总数>E07. 统计订单总数</h2><blockquote><p>心法: 业务流程</p></blockquote><pre tabindex=0><code class=language-mermaid data-lang=mermaid>graph LR

n1[查询&lt;br/&gt;全部订单总数] 
--&gt; n2[加入&lt;br/&gt;缓存]
--&gt; n3[返回&lt;br/&gt;全部订单总数]
</code></pre><blockquote><p>武技: 开发统计订单总数的接口</p></blockquote><ol><li>开发业务方法 <code>OrderService -> countTotal()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/**  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * 获取全部订单数量  
</span></span></span><span style=display:flex><span><span style=color:#75715e> *  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @return 全部订单数量  
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>  
</span></span><span style=display:flex><span>Long <span style=color:#a6e22e>countTotal</span>();
</span></span></code></pre></div><ol start=2><li>实现业务方法 <code>OrderServiceImpl -> countTotal()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Cacheable</span>(key <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;#root.methodName&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Override</span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Long <span style=color:#a6e22e>countTotal</span>() {  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// select count(*) from oms_order  </span>
</span></span><span style=display:flex><span>    QueryWrapper queryWrapper <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> QueryWrapper();  
</span></span><span style=display:flex><span>    queryWrapper.<span style=color:#a6e22e>select</span>(QueryMethods.<span style=color:#a6e22e>count</span>().<span style=color:#a6e22e>as</span>(<span style=color:#e6db74>&#34;count&#34;</span>));  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> (Long) orderMapper.<span style=color:#a6e22e>selectObjectByQuery</span>(queryWrapper);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=3><li>开发控制方法 <code>OrderController -> countToday()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Operation</span>(summary <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;统计全部订单&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@GetMapping</span>(<span style=color:#e6db74>&#34;countTotal&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Long <span style=color:#a6e22e>countTotal</span>() {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> orderService.<span style=color:#a6e22e>countTotal</span>();  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h1 id=s08-开发类目接口>S08. 开发类目接口</h1><blockquote><p>心法: Category接口文档</p></blockquote><ul><li>前缀 <code>/api/v1/category</code>:</li></ul><table><thead><tr><th></th><th>接口</th><th>类型</th><th>描述</th><th>请求参数</th><th>必要参数</th></tr></thead><tbody><tr><td>1</td><td><code>save</code></td><td>POST</td><td>添加一条记录</td><td><code>@RequestBody CategoryInsertDTO dto</code></td><td><code>title</code></td></tr><tr><td>2</td><td><code>getInfo/{id}</code></td><td>GET</td><td>根据主键查询</td><td><code>@PathVariable Long id</code></td><td><code>id</code></td></tr><tr><td>3</td><td><code>update</code></td><td>POST</td><td>根据主键修改</td><td><code>@RequestBody CategoryUpdateDTO dto</code></td><td><code>id</code></td></tr><tr><td>4</td><td><code>remove/{id}</code></td><td>POST</td><td>根据主键删除</td><td><code>@PathVariable Long id</code></td><td><code>id</code></td></tr><tr><td>5</td><td><code>removeBatch</code></td><td>POST</td><td>根据主键批删</td><td><code>@RequestParam List&lt;Long> idtts</code></td><td><code>ids</code></td></tr><tr><td>6</td><td><code>page</code></td><td>GET</td><td>全量数据分页</td><td><code>Page&lt;Category> page</code></td><td><code>pageNumber</code><code>pageSize</code></td></tr><tr><td>7</td><td><code>list</code></td><td>GET</td><td>查询全部记录</td><td></td><td></td></tr></tbody></table><h2 id=e01-添加一条记录-2>E01. 添加一条记录</h2><blockquote><p>心法: 业务流程</p></blockquote><pre tabindex=0><code class=language-mermaid data-lang=mermaid>graph LR

n1[根据标题&lt;br/&gt;查询类目] --&gt; f{是否&lt;br/&gt;存在}
	f --是--&gt; ex[抛出异常]
	f --否--&gt; n2[置空主键]
		--&gt; n3[设置当前创建时间&lt;br/&gt;设置当前修改时间] 
		--&gt; n4[添加记录]
		--&gt; n5[逐出缓存]
		--&gt; n6[返回布尔结果]
</code></pre><blockquote><p>武技: 添加一条类目记录</p></blockquote><ol><li>开发DTO实体类 <code>CategoryInsertDTO</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> com.lsx.dto;  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Schema</span>(name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;类目添加DTO&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Data</span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>CategoryInsertDTO</span> <span style=color:#66d9ef>implements</span> Serializable {  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@NotEmpty</span>(message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;标题不能为空&#34;</span>)  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Size</span>(min <span style=color:#f92672>=</span> 1, max <span style=color:#f92672>=</span> 128, message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;标题长度必须在1~512之间&#34;</span>)  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Schema</span>(description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;标题&#34;</span>)  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String title;  
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Range</span>(min <span style=color:#f92672>=</span> 0, message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;权重最小为0&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Schema</span>(description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;权重，数字越小越优先&#34;</span>)  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Long weight;  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=2><li>重写业务方法 <code>CategoryServiceImpl -> save()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@CacheEvict</span>(allEntries <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>save</span>(Category entity) {  
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 判断类目标题是否已经存在  </span>
</span></span><span style=display:flex><span>	Category category <span style=color:#f92672>=</span> categoryMapper.<span style=color:#a6e22e>selectOneByCondition</span>(CATEGORY.<span style=color:#a6e22e>TITLE</span>.<span style=color:#a6e22e>eq</span>(entity.<span style=color:#a6e22e>getTitle</span>()));  
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span>(ObjectUtil.<span style=color:#a6e22e>isNotNull</span>(category)){  
</span></span><span style=display:flex><span>	    <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> ServiceException(<span style=color:#e6db74>&#34;类目标题已存在&#34;</span>);  
</span></span><span style=display:flex><span>	}  
</span></span><span style=display:flex><span>	  
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 清空主键  </span>
</span></span><span style=display:flex><span>	entity.<span style=color:#a6e22e>setId</span>(<span style=color:#66d9ef>null</span>);  
</span></span><span style=display:flex><span>	  
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 设置创建时间和修改时间为当前时间  </span>
</span></span><span style=display:flex><span>	entity.<span style=color:#a6e22e>setCreated</span>(LocalDateTime.<span style=color:#a6e22e>now</span>());  
</span></span><span style=display:flex><span>	entity.<span style=color:#a6e22e>setUpdated</span>(LocalDateTime.<span style=color:#a6e22e>now</span>());  
</span></span><span style=display:flex><span>	  
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 添加记录  </span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>super</span>.<span style=color:#a6e22e>save</span>(entity); 
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=3><li>重写控制方法 <code>CategoryController -> save()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Operation</span>(summary <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;添加一条记录&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@PostMapping</span>(<span style=color:#e6db74>&#34;save&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>save</span>(<span style=color:#a6e22e>@RequestBody</span> <span style=color:#a6e22e>@Validated</span> CategoryInsertDTO dto) {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> categoryService.<span style=color:#a6e22e>save</span>(BeanUtil.<span style=color:#a6e22e>copyProperties</span>(dto, Category.<span style=color:#a6e22e>class</span>));  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=e02-根据主键查询-2>E02. 根据主键查询</h2><blockquote><p>武技: 根据主键查询一条类目记录</p></blockquote><ol><li>重写业务方法 <code>CategoryServiceImpl -> getById()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Cacheable</span>(key <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;#id&#34;</span>, unless <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;#result == null&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Category <span style=color:#a6e22e>getById</span>(Serializable id) {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>super</span>.<span style=color:#a6e22e>getById</span>(id);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=2><li>重写控制方法 <code>CategoryController -> getInfo()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Operation</span>(summary <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;根据主键查询&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@GetMapping</span>(<span style=color:#e6db74>&#34;getInfo/{id}&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Category <span style=color:#a6e22e>getInfo</span>(<span style=color:#a6e22e>@PathVariable</span> Long id) {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> categoryService.<span style=color:#a6e22e>getById</span>(id);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=e03-根据主键修改-2>E03. 根据主键修改</h2><blockquote><p>心法: 业务流程</p></blockquote><pre tabindex=0><code class=language-mermaid data-lang=mermaid>graph LR

	n1[设置&lt;br/&gt;当前修改时间]
--&gt; n2[置空&lt;br/&gt;创建时间]
--&gt; n3[修改&lt;br/&gt;记录]
--&gt; n4[逐出&lt;br/&gt;缓存]
--&gt; n5[返回&lt;br/&gt;布尔结果]
</code></pre><blockquote><p>武技: 根据主键修改一条类目记录</p></blockquote><ol><li>开发DTO实体类 <code>CategoryUpdateDTO</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> com.lsx.dto;  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Schema</span>(name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;类目修改DTO&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Data</span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>CategoryUpdateDTO</span> <span style=color:#66d9ef>implements</span> Serializable {  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@NotNull</span>(message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;主键不能为空&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Schema</span>(description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;主键&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> Long id;  
</span></span><span style=display:flex><span>	  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Size</span>(min <span style=color:#f92672>=</span> 1, max <span style=color:#f92672>=</span> 128, message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;标题长度必须在1~128之间&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Schema</span>(description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;标题&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> String title;  
</span></span><span style=display:flex><span>	  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Range</span>(min <span style=color:#f92672>=</span> 0, message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;权重最小为0&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Schema</span>(description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;权重，数字越小越优先&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> Long weight;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=2><li>重写业务方法 <code>CategoryServiceImpl -> updateById()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@CacheEvict</span>(allEntries <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>updateById</span>(Category entity) {  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 设置最后修改时间为当前时间  </span>
</span></span><span style=display:flex><span>    entity.<span style=color:#a6e22e>setUpdated</span>(LocalDateTime.<span style=color:#a6e22e>now</span>());  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 不允许修改创建时间  </span>
</span></span><span style=display:flex><span>    entity.<span style=color:#a6e22e>setCreated</span>(<span style=color:#66d9ef>null</span>);  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 修改记录  </span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>super</span>.<span style=color:#a6e22e>updateById</span>(entity);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=3><li>重写控制方法 <code>CategoryController -> update()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Operation</span>(summary <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;根据主键修改&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@PostMapping</span>(<span style=color:#e6db74>&#34;update&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>update</span>(<span style=color:#a6e22e>@RequestBody</span> <span style=color:#a6e22e>@Validated</span> CategoryUpdateDTO dto) {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> categoryService.<span style=color:#a6e22e>updateById</span>(BeanUtil.<span style=color:#a6e22e>copyProperties</span>(dto, Category.<span style=color:#a6e22e>class</span>));  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=e04-根据主键删除-2>E04. 根据主键删除</h2><blockquote><p>心法: 业务流程</p></blockquote><pre tabindex=0><code class=language-mermaid data-lang=mermaid>graph LR

ex[抛出异常]

f{是否关联&lt;br/&gt;课程记录}
	f --是--&gt; ex
	f --否--&gt; n1

n1[删除&lt;br/&gt;类目记录]
--&gt; n2[逐出&lt;br/&gt;缓存]
--&gt; n3[返回&lt;br/&gt;布尔结果]
</code></pre><blockquote><p>武技: 根据主键删除一条类目记录，已关联课程的类目不允许删除</p></blockquote><ol><li>重写业务方法 <code>CategoryServiceImpl -> removeById()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@CacheEvict</span>(allEntries <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>removeById</span>(Serializable id) {  .
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 已关联课程的类目不允许删除  </span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// select * from pms_course where fk_category_id = ?  </span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span>(ObjectUtil.<span style=color:#a6e22e>isNotEmpty</span>(courseMapper.<span style=color:#a6e22e>selectListByCondition</span>(COURSE.<span style=color:#a6e22e>FK_CATEGORY_ID</span>.<span style=color:#a6e22e>eq</span>(id)))){  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> ServiceException(<span style=color:#e6db74>&#34;该类目已关联课程，不允许删除&#34;</span>);  
</span></span><span style=display:flex><span>    }  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>super</span>.<span style=color:#a6e22e>removeById</span>(id);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=2><li>重写控制方法 <code>CategoryController -> remove()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Operation</span>(summary <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;根据主键删除&#34;</span>, description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;已关联课程的类目不允许删除&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@PostMapping</span>(<span style=color:#e6db74>&#34;remove/{id}&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>remove</span>(<span style=color:#a6e22e>@PathVariable</span> Long id) {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> categoryService.<span style=color:#a6e22e>removeById</span>(id);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=e05-根据主键批删-2>E05. 根据主键批删</h2><blockquote><p>心法: 业务流程</p></blockquote><pre tabindex=0><code class=language-mermaid data-lang=mermaid>graph LR

n1[根据主键列表&lt;br/&gt;批量删除类目记录]
--&gt; n2[逐出&lt;br/&gt;缓存]
--&gt; n3[返回&lt;br/&gt;布尔结果]
</code></pre><blockquote><p>武技: 根据主键列表批量删除类目记录</p></blockquote><ol><li>重写业务方法 <code>CategoryServiceImpl -> removeByIds()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@CacheEvict</span>(allEntries <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>removeByIds</span>(Collection<span style=color:#f92672>&lt;?</span> <span style=color:#66d9ef>extends</span> Serializable<span style=color:#f92672>&gt;</span> ids) {  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 检查是否存在已关联课程记录的类目  </span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> (Serializable id : ids) {  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (ObjectUtil.<span style=color:#a6e22e>isNotEmpty</span>(courseMapper.<span style=color:#a6e22e>selectListByCondition</span>(COURSE.<span style=color:#a6e22e>FK_CATEGORY_ID</span>.<span style=color:#a6e22e>eq</span>(id)))) {  
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> ServiceException(<span style=color:#e6db74>&#34;存在已关联课程记录的类目，整体不允许删除&#34;</span>);  
</span></span><span style=display:flex><span>        }  
</span></span><span style=display:flex><span>    }  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>super</span>.<span style=color:#a6e22e>removeByIds</span>(ids);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=2><li>重写控制方法 <code>CategoryController -> removeBatch()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Operation</span>(summary <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;根据主键批删&#34;</span>, description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;已关联课程的类目不允许删除&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@PostMapping</span>(<span style=color:#e6db74>&#34;removeBatch&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>removeBatch</span>(<span style=color:#a6e22e>@RequestParam</span> List<span style=color:#f92672>&lt;</span>Long<span style=color:#f92672>&gt;</span> ids) {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> categoryService.<span style=color:#a6e22e>removeByIds</span>(ids);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=e06-全量数据分页-1>E06. 全量数据分页</h2><blockquote><p>心法: 业务流程</p></blockquote><pre tabindex=0><code class=language-mermaid data-lang=mermaid>graph LR

n1[分页查询&lt;br/&gt;类目记录] 
--&gt; n2[根据权重升序&lt;br/&gt;根据创建时间降序] 
--&gt; n3[加入&lt;br/&gt;缓存]
--&gt; n4[返回&lt;br/&gt;分页结果]
</code></pre><blockquote><p>武技: 分页查询类目记录，根据权重字段升序，权重相同根据ID降序</p></blockquote><ol><li>重写业务方法 <code>CategoryServiceImpl -> page()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Cacheable</span>(key <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;#root.methodName + &#39;:&#39; + #page.getPageSize() + &#39;:&#39; + #page.getPageNumber()&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Page<span style=color:#f92672>&lt;</span>Category<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>page</span>(Page<span style=color:#f92672>&lt;</span>Category<span style=color:#f92672>&gt;</span> page) {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>super</span>.<span style=color:#a6e22e>page</span>(page, QueryWrapper.<span style=color:#a6e22e>create</span>().<span style=color:#a6e22e>orderBy</span>(CATEGORY.<span style=color:#a6e22e>WEIGHT</span>.<span style=color:#a6e22e>asc</span>(), CATEGORY.<span style=color:#a6e22e>ID</span>.<span style=color:#a6e22e>desc</span>()));  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=2><li>重写控制方法 <code>CategoryController -> page()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Operation</span>(summary <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;全量数据分页&#34;</span>, description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;根据权重字段升序，权重相同根据ID降序&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@GetMapping</span>(<span style=color:#e6db74>&#34;page&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Page<span style=color:#f92672>&lt;</span>Category<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>page</span>(Page<span style=color:#f92672>&lt;</span>Category<span style=color:#f92672>&gt;</span> page) {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> categoryService.<span style=color:#a6e22e>page</span>(page);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=e07-查询全部记录>E07. 查询全部记录</h2><blockquote><p>心法: 业务流程</p></blockquote><pre tabindex=0><code class=language-mermaid data-lang=mermaid>graph LR

n1[查询全部&lt;br/&gt;类目记录] 
--&gt; n2[根据权重升序&lt;br/&gt;根据创建时间降序] 
--&gt; n3[加入&lt;br/&gt;缓存]
--&gt; n4[返回&lt;br/&gt;分页结果]
</code></pre><blockquote><p>武技: 查询全部类目记录，根据权重字段升序，权重相同根据ID降序</p></blockquote><ol><li>重写业务方法 <code>CategoryServiceImpl -> list()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Cacheable</span>(key <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;#root.methodName&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> List<span style=color:#f92672>&lt;</span>Category<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>list</span>() {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>super</span>.<span style=color:#a6e22e>list</span>(QueryWrapper.<span style=color:#a6e22e>create</span>().<span style=color:#a6e22e>orderBy</span>(CATEGORY.<span style=color:#a6e22e>WEIGHT</span>.<span style=color:#a6e22e>asc</span>(), CATEGORY.<span style=color:#a6e22e>ID</span>.<span style=color:#a6e22e>desc</span>()));  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=2><li>重写控制方法 <code>CategoryController -> list()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Operation</span>(summary <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;查询全部记录&#34;</span>, description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;根据权重字段升序，权重相同根据ID降序&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@GetMapping</span>(<span style=color:#e6db74>&#34;list&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> List<span style=color:#f92672>&lt;</span>Category<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>list</span>() {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> categoryService.<span style=color:#a6e22e>list</span>();  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h1 id=s09-开发课程接口>S09. 开发课程接口</h1><blockquote><p>心法: Course接口文档</p></blockquote><ul><li>前缀 <code>/api/v1/course</code>:</li></ul><table><thead><tr><th></th><th>接口</th><th>类型</th><th>描述</th><th>请求参数</th><th>必要参数</th></tr></thead><tbody><tr><td>1</td><td><code>save</code></td><td>POST</td><td>添加一条记录</td><td><code>@RequestBody CourseInsertDTO dto</code></td><td><code>title</code></td></tr><tr><td>2</td><td><code>getInfo/{id}</code></td><td>GET</td><td>根据主键查询</td><td><code>@PathVariable Long id</code></td><td><code>id</code></td></tr><tr><td>3</td><td><code>update</code></td><td>POST</td><td>根据主键修改</td><td><code>@RequestBody CourseUpdateDTO dto</code></td><td><code>id</code></td></tr><tr><td>4</td><td><code>remove/{id}</code></td><td>POST</td><td>根据主键删除</td><td><code>@PathVariable Long id</code></td><td><code>id</code></td></tr><tr><td>5</td><td><code>removeBatch</code></td><td>POST</td><td>根据主键批删</td><td><code>@RequestParam List&lt;Long> ids</code></td><td><code>ids</code></td></tr><tr><td>6</td><td><code>page</code></td><td>GET</td><td>全量数据分页</td><td><code>Page&lt;Course> page</code></td><td><code>pageNumber</code><code>pageSize</code></td></tr><tr><td>7</td><td><code>pageCategory/{categoryId}</code></td><td>GET</td><td>根据类目分页</td><td><code>Page&lt;Course> page</code><code>@PathVariable Long categoryId</code></td><td><code>pageNumber</code><code>pageSize</code><code>categoryId</code></td></tr><tr><td>8</td><td><code>uploadCover/{id}</code></td><td>POST</td><td>上传封面图片</td><td><code>@RequestParam MultipartFile coverFile</code><code>@PathVariable Long id</code></td><td><code>coverFile</code><code>id</code></td></tr><tr><td>9</td><td><code>uploadSummary/{id}</code></td><td>POST</td><td>上传摘要图片</td><td><code>@RequestParam MultipartFile summaryFile</code><code>@PathVariable Long id</code></td><td><code>summaryFile</code><code>id</code></td></tr><tr><td>10</td><td><code>countStar</code></td><td>GET</td><td>统计课程评分</td><td></td><td></td></tr></tbody></table><h2 id=e01-添加一条记录-3>E01. 添加一条记录</h2><blockquote><p>心法: 业务流程</p></blockquote><pre tabindex=0><code class=language-mermaid data-lang=mermaid>graph LR

n1[根据标题&lt;br/&gt;查询课程] --&gt; f{是否&lt;br/&gt;存在}
	f --是--&gt; ex[抛出&lt;br/&gt;异常]
	f --否--&gt; n2[置空&lt;br/&gt;主键]
		--&gt; n3[设置当前创建时间&lt;br/&gt;设置当前修改时间] 
		--&gt; n4[设置默认课程封面图&lt;br/&gt;设置默认课程摘要图]
		--&gt; n5[添加&lt;br/&gt;记录]
		--&gt; n6[逐出&lt;br/&gt;缓存]
		--&gt; n7[返回&lt;br/&gt;布尔结果]
</code></pre><blockquote><p>武技: 添加一条课程记录</p></blockquote><ol><li>开发DTO实体类 <code>CourseInsertDTO</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> com.lsx.dto;  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Schema</span>(name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;课程添加DTO&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Data</span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>CourseInsertDTO</span> <span style=color:#66d9ef>implements</span> Serializable {  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@NotEmpty</span>(message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;标题不能为空&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Size</span>(min <span style=color:#f92672>=</span> 1, max <span style=color:#f92672>=</span> 128, message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;标题长度必须在1~128之间&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Schema</span>(description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;标题&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> String title;  
</span></span><span style=display:flex><span>	  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@NotNull</span>(message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;作者ID不能为空&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Schema</span>(description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;作者ID，会员表外键&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> Long fkMemberId;  
</span></span><span style=display:flex><span>	  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@NotNull</span>(message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;类别ID不能为空&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Schema</span>(description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;类别ID，类别表外键&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> Long fkCategoryId;  
</span></span><span style=display:flex><span>	  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Size</span>(min <span style=color:#f92672>=</span> 1, max <span style=color:#f92672>=</span> 512, message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;标题长度必须在1~512之间&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Schema</span>(description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;描述&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> String info;  
</span></span><span style=display:flex><span>	  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Range</span>(min <span style=color:#f92672>=</span> 0, message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;单价最少为0&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@NotNull</span>(message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;单价不能为空&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Schema</span>(description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;单价，单位元&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> Double price;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=2><li>重写业务方法 <code>CourseServiceImpl -> save()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@CacheEvict</span>(allEntries <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>save</span>(Course entity) {  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 判断课程标题是否已经存在  </span>
</span></span><span style=display:flex><span>	Course course <span style=color:#f92672>=</span> courseMapper.<span style=color:#a6e22e>selectOneByCondition</span>(COURSE.<span style=color:#a6e22e>TITLE</span>.<span style=color:#a6e22e>eq</span>(entity.<span style=color:#a6e22e>getTitle</span>()));  
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span>(ObjectUtil.<span style=color:#a6e22e>isNotNull</span>(course)) {  
</span></span><span style=display:flex><span>	    <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> ServiceException(<span style=color:#e6db74>&#34;课程标题已存在&#34;</span>);  
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 设置默认的课程摘要图和课程封面图  </span>
</span></span><span style=display:flex><span>	entity.<span style=color:#a6e22e>setSummary</span>(CourseConst.<span style=color:#a6e22e>DEFAULT_SUMMARY</span>);  
</span></span><span style=display:flex><span>	entity.<span style=color:#a6e22e>setCover</span>(CourseConst.<span style=color:#a6e22e>DEFAULT_COVER</span>); 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 清空主键  </span>
</span></span><span style=display:flex><span>    entity.<span style=color:#a6e22e>setId</span>(<span style=color:#66d9ef>null</span>);  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 设置创建时间和修改时间为当前时间  </span>
</span></span><span style=display:flex><span>    entity.<span style=color:#a6e22e>setCreated</span>(LocalDateTime.<span style=color:#a6e22e>now</span>());  
</span></span><span style=display:flex><span>    entity.<span style=color:#a6e22e>setUpdated</span>(LocalDateTime.<span style=color:#a6e22e>now</span>());  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 添加记录  </span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>super</span>.<span style=color:#a6e22e>save</span>(entity);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=3><li>重写控制方法 <code>CourseController -> save()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Operation</span>(summary <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;添加一条记录&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@PostMapping</span>(<span style=color:#e6db74>&#34;save&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>save</span>(<span style=color:#a6e22e>@RequestBody</span> <span style=color:#a6e22e>@Validated</span> CourseInsertDTO dto) {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> courseService.<span style=color:#a6e22e>save</span>(BeanUtil.<span style=color:#a6e22e>copyProperties</span>(dto, Course.<span style=color:#a6e22e>class</span>));  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=e02-根据主键查询-3>E02. 根据主键查询</h2><blockquote><p>心法: 业务流程</p></blockquote><pre tabindex=0><code class=language-mermaid data-lang=mermaid>graph LR

n1[根据主键&lt;br/&gt;查询课程] --&gt; f{是否&lt;br/&gt;存在}
	f --是--&gt; n2[加入缓存] --&gt; n2a[返回结果]
	f --否--&gt; n3[返回空值]
</code></pre><blockquote><p>武技: 根据主键查询一条课程记录，同时联查作者信息和类目信息</p></blockquote><ol><li>优化实体类 <code>Course</code>:<ul><li>1条课程记录只能对应1个作者，1个作者可以出现在N条课程记录中。</li><li>1条课程记录只能对应1个类目，1个类目可以出现在N条课程记录中。</li></ul></li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/** 课程[N] : 作者[1] */</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RelationManyToOne</span>(selfField <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;fkMemberId&#34;</span>, targetField <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;id&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> Member member;  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#75715e>/** 课程[N] : 类目[1] */</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RelationManyToOne</span>(selfField <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;fkCategoryId&#34;</span>, targetField <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;id&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> Category category;
</span></span></code></pre></div><ol start=2><li>重写业务方法 <code>CourseServiceImpl -> getById()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Cacheable</span>(key <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;#id&#34;</span>, unless <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;#result == null&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Course <span style=color:#a6e22e>getById</span>(Serializable id) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> courseMapper.<span style=color:#a6e22e>selectOneWithRelationsById</span>(id);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=3><li>重写控制方法 <code>CourseController -> getInfo()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Operation</span>(summary <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;根据主键查询&#34;</span>, description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;同时联查作者信息和类目信息&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@GetMapping</span>(<span style=color:#e6db74>&#34;getInfo/{id}&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Course <span style=color:#a6e22e>getInfo</span>(<span style=color:#a6e22e>@PathVariable</span> Long id) {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> courseService.<span style=color:#a6e22e>getById</span>(id);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=e03-根据主键修改-3>E03. 根据主键修改</h2><blockquote><p>心法: 业务流程</p></blockquote><pre tabindex=0><code class=language-mermaid data-lang=mermaid>graph LR

	n1[设置&lt;br/&gt;当前修改时间]
--&gt; n2[置空&lt;br/&gt;创建时间]
--&gt; n3[修改&lt;br/&gt;记录]
--&gt; n4[逐出&lt;br/&gt;缓存]
--&gt; n5[返回&lt;br/&gt;布尔结果]
</code></pre><blockquote><p>武技: 根据主键修改一条课程记录</p></blockquote><ol><li>开发DTO实体类 <code>CourseUpdateDTO</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> com.lsx.dto;  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Schema</span>(name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;课程修改DTO&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Data</span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>CourseUpdateDTO</span> <span style=color:#66d9ef>implements</span> Serializable {  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@NotNull</span>(message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;主键不能为空&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Schema</span>(description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;主键&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> Long id;  
</span></span><span style=display:flex><span>	  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Size</span>(min <span style=color:#f92672>=</span> 1, max <span style=color:#f92672>=</span> 128, message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;标题长度必须在1~128之间&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Schema</span>(description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;标题&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> String title;  
</span></span><span style=display:flex><span>	  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Schema</span>(description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;作者ID，会员表外键&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> Long fkMemberId;  
</span></span><span style=display:flex><span>	  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Schema</span>(description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;类别ID，类别表外键&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> Long fkCategoryId;  
</span></span><span style=display:flex><span>	  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Size</span>(min <span style=color:#f92672>=</span> 1, max <span style=color:#f92672>=</span> 512, message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;标题长度必须在1~512之间&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Schema</span>(description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;描述&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> String info;  
</span></span><span style=display:flex><span>	  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Range</span>(min <span style=color:#f92672>=</span> 0, message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;单价最少为0&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Schema</span>(description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;单价，单位元&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> Double price;  
</span></span><span style=display:flex><span>	  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Range</span>(min <span style=color:#f92672>=</span> 0, max <span style=color:#f92672>=</span> 5, message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;评分范围必须在0~5&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Schema</span>(description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;评分，默认0，最高5&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> Integer star;  
</span></span><span style=display:flex><span>	  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Range</span>(min <span style=color:#f92672>=</span> 0, message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;点赞数最少为0&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Schema</span>(description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;点赞数&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> Long likeCount;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=2><li>重写业务方法 <code>CourseServiceImpl -> updateById()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@CacheEvict</span>(allEntries <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>updateById</span>(Course entity) {  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 设置最后修改时间为当前时间  </span>
</span></span><span style=display:flex><span>    entity.<span style=color:#a6e22e>setUpdated</span>(LocalDateTime.<span style=color:#a6e22e>now</span>());  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 不允许修改创建时间  </span>
</span></span><span style=display:flex><span>    entity.<span style=color:#a6e22e>setCreated</span>(<span style=color:#66d9ef>null</span>);  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 修改记录  </span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>super</span>.<span style=color:#a6e22e>updateById</span>(entity);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=3><li>重写控制方法 <code>CourseController -> update()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Operation</span>(summary <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;根据主键修改&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@PostMapping</span>(<span style=color:#e6db74>&#34;update&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>update</span>(<span style=color:#a6e22e>@RequestBody</span> <span style=color:#a6e22e>@Validated</span> CourseUpdateDTO dto) {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> courseService.<span style=color:#a6e22e>updateById</span>(BeanUtil.<span style=color:#a6e22e>copyProperties</span>(dto, Course.<span style=color:#a6e22e>class</span>));  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=e04-根据主键删除-3>E04. 根据主键删除</h2><blockquote><p>心法: 业务流程</p></blockquote><pre tabindex=0><code class=language-mermaid data-lang=mermaid>graph LR

1[P1]
--&gt; n1[查询该课程下&lt;br/&gt;的全部季次]
--&gt; f{是否&lt;br/&gt;为空}
	f --是--&gt; P2
	f --否--&gt; n2[批量删除&lt;br/&gt;季次记录] --&gt; n3[查询每个季次&lt;br/&gt;的全部集次] --&gt; f1{是否&lt;br/&gt;为空}
		f1 --是--&gt; P2
		f1 --否--&gt; n4[批量删除&lt;br/&gt;集次记录] --&gt; P2
2[P2]
--&gt; n5[根据课程主键&lt;br/&gt;删除课程记录]
--&gt; n6[逐出缓存]
--&gt; n7[返回布尔结果]
</code></pre><blockquote><p>武技: 根据主键删除一条课程记录，同时删除全部季和全部集</p></blockquote><ol><li>重写业务方法 <code>CourseServiceImpl -> removeById()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Transactional</span>(rollbackFor <span style=color:#f92672>=</span> Exception.<span style=color:#a6e22e>class</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Override</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@CacheEvict</span>(allEntries <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>removeById</span>(Serializable id) {  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 通过课程主键查询全部季次的ID列表  </span>
</span></span><span style=display:flex><span>    List<span style=color:#f92672>&lt;</span>Long<span style=color:#f92672>&gt;</span> seasonIds <span style=color:#f92672>=</span> seasonMapper.<span style=color:#a6e22e>selectObjectListByQueryAs</span>(QueryWrapper.<span style=color:#a6e22e>create</span>()  
</span></span><span style=display:flex><span>            .<span style=color:#a6e22e>select</span>(SEASON.<span style=color:#a6e22e>ID</span>)  
</span></span><span style=display:flex><span>            .<span style=color:#a6e22e>where</span>(SEASON.<span style=color:#a6e22e>FK_COURSE_ID</span>.<span style=color:#a6e22e>eq</span>(id)), Long.<span style=color:#a6e22e>class</span>);  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 存在季记录时，批量删除季</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (ObjectUtil.<span style=color:#a6e22e>isNotEmpty</span>(seasonIds)) {  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (seasonMapper.<span style=color:#a6e22e>deleteBatchByIds</span>(seasonIds) <span style=color:#f92672>&lt;=</span> 0) {  
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> ServiceException(<span style=color:#e6db74>&#34;季删除失败&#34;</span>);  
</span></span><span style=display:flex><span>        }  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 通过季次主键列表查询全部集次的ID列表  </span>
</span></span><span style=display:flex><span>        List<span style=color:#f92672>&lt;</span>Long<span style=color:#f92672>&gt;</span> episodeIds <span style=color:#f92672>=</span> episodeMapper.<span style=color:#a6e22e>selectObjectListByQueryAs</span>(QueryWrapper.<span style=color:#a6e22e>create</span>()  
</span></span><span style=display:flex><span>                .<span style=color:#a6e22e>select</span>(EPISODE.<span style=color:#a6e22e>ID</span>)  
</span></span><span style=display:flex><span>                .<span style=color:#a6e22e>where</span>(EPISODE.<span style=color:#a6e22e>FK_SEASON_ID</span>.<span style=color:#a6e22e>in</span>(seasonIds)), Long.<span style=color:#a6e22e>class</span>);  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 存在集记录时，批量删除集  </span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (ObjectUtil.<span style=color:#a6e22e>isNotEmpty</span>(episodeIds)) {  
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (episodeMapper.<span style=color:#a6e22e>deleteBatchByIds</span>(episodeIds) <span style=color:#f92672>&lt;=</span> 0) {  
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> ServiceException(<span style=color:#e6db74>&#34;集删除失败&#34;</span>);  
</span></span><span style=display:flex><span>            }  
</span></span><span style=display:flex><span>        }  
</span></span><span style=display:flex><span>    }  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 删除课程  </span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>super</span>.<span style=color:#a6e22e>removeById</span>(id);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=2><li>重写控制方法 <code>CourseController -> remove()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Operation</span>(summary <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;根据主键删除&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@PostMapping</span>(<span style=color:#e6db74>&#34;remove/{id}&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>remove</span>(<span style=color:#a6e22e>@PathVariable</span> Long id) {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> courseService.<span style=color:#a6e22e>removeById</span>(id);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=e05-根据主键批删-3>E05. 根据主键批删</h2><blockquote><p>心法: 业务流程</p></blockquote><pre tabindex=0><code class=language-mermaid data-lang=mermaid>graph LR

1[P1]
--&gt; n1[查询每个课程&lt;br/&gt;下的全部季次]
--&gt; f{是否&lt;br/&gt;为空}
	f --是--&gt; P2
	f --否--&gt; n2[批量删除&lt;br/&gt;季次记录] --&gt; n3[查询每个季次&lt;br/&gt;的全部集次] --&gt; f1{是否&lt;br/&gt;为空}
		f1 --是--&gt; P2
		f1 --否--&gt; n4[批量删除&lt;br/&gt;集次记录] --&gt; P2
2[P2]
--&gt; n5[根据课程主键列表&lt;br/&gt;批量删除课程记录]
--&gt; n6[逐出缓存]
--&gt; n7[返回布尔结果]
</code></pre><blockquote><p>武技: 根据主键列表批量删除课程记录，同时删除全部季和全部集</p></blockquote><ol><li>重写业务方法 <code>CourseServiceImpl -> removeByIds()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Transactional</span>(rollbackFor <span style=color:#f92672>=</span> Exception.<span style=color:#a6e22e>class</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Override</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@CacheEvict</span>(allEntries <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>removeByIds</span>(Collection<span style=color:#f92672>&lt;?</span> <span style=color:#66d9ef>extends</span> Serializable<span style=color:#f92672>&gt;</span> ids) {  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 通过课程主键列表批量查询全部季次的ID列表  </span>
</span></span><span style=display:flex><span>    List<span style=color:#f92672>&lt;</span>Long<span style=color:#f92672>&gt;</span> seasonIds <span style=color:#f92672>=</span> seasonMapper.<span style=color:#a6e22e>selectObjectListByQueryAs</span>(QueryWrapper.<span style=color:#a6e22e>create</span>()  
</span></span><span style=display:flex><span>            .<span style=color:#a6e22e>select</span>(SEASON.<span style=color:#a6e22e>ID</span>)  
</span></span><span style=display:flex><span>            .<span style=color:#a6e22e>where</span>(SEASON.<span style=color:#a6e22e>FK_COURSE_ID</span>.<span style=color:#a6e22e>in</span>(ids)), Long.<span style=color:#a6e22e>class</span>);  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 存在季记录时，批量删除季  </span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (ObjectUtil.<span style=color:#a6e22e>isNotEmpty</span>(seasonIds)) {  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (seasonMapper.<span style=color:#a6e22e>deleteBatchByIds</span>(seasonIds) <span style=color:#f92672>&lt;=</span> 0) {  
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> ServiceException(<span style=color:#e6db74>&#34;季删除失败&#34;</span>);  
</span></span><span style=display:flex><span>        }  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 通过季次主键列表查询全部集次的ID列表  </span>
</span></span><span style=display:flex><span>        List<span style=color:#f92672>&lt;</span>Long<span style=color:#f92672>&gt;</span> episodeIds <span style=color:#f92672>=</span> episodeMapper.<span style=color:#a6e22e>selectObjectListByQueryAs</span>(QueryWrapper.<span style=color:#a6e22e>create</span>()  
</span></span><span style=display:flex><span>                .<span style=color:#a6e22e>select</span>(EPISODE.<span style=color:#a6e22e>ID</span>)  
</span></span><span style=display:flex><span>                .<span style=color:#a6e22e>where</span>(EPISODE.<span style=color:#a6e22e>FK_SEASON_ID</span>.<span style=color:#a6e22e>in</span>(seasonIds)), Long.<span style=color:#a6e22e>class</span>);  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 存在集记录时，批量删除集    </span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> (ObjectUtil.<span style=color:#a6e22e>isNotEmpty</span>(episodeIds)) {  
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (episodeMapper.<span style=color:#a6e22e>deleteBatchByIds</span>(episodeIds) <span style=color:#f92672>&lt;=</span> 0) {  
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> ServiceException(<span style=color:#e6db74>&#34;集删除失败&#34;</span>);  
</span></span><span style=display:flex><span>            }  
</span></span><span style=display:flex><span>        }  
</span></span><span style=display:flex><span>    }  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 批量删除课程  </span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>super</span>.<span style=color:#a6e22e>removeByIds</span>(ids);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=2><li>重写控制方法 <code>CourseController -> removeBatch()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Operation</span>(summary <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;根据主键批删&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@PostMapping</span>(<span style=color:#e6db74>&#34;removeBatch&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>removeBatch</span>(<span style=color:#a6e22e>@RequestParam</span> List<span style=color:#f92672>&lt;</span>Long<span style=color:#f92672>&gt;</span> ids) {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> courseService.<span style=color:#a6e22e>removeByIds</span>(ids);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=e06-全量数据分页-2>E06. 全量数据分页</h2><blockquote><p>心法: 业务流程</p></blockquote><pre tabindex=0><code class=language-mermaid data-lang=mermaid>graph LR

n1[分页查询&lt;br/&gt;课程记录] 
--&gt; n2[加入&lt;br/&gt;缓存]
--&gt; n3[返回&lt;br/&gt;分页结果]
</code></pre><blockquote><p>武技: 分页查询课程记录，同时联查作者信息和类目信息</p></blockquote><ol><li>重写业务方法 <code>CourseServiceImpl -> page()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Cacheable</span>(key <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;#root.methodName + &#39;:&#39; + #page.getPageSize() + &#39;:&#39; + #page.getPageNumber()&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Page<span style=color:#f92672>&lt;</span>Course<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>page</span>(Page<span style=color:#f92672>&lt;</span>Course<span style=color:#f92672>&gt;</span> page) {  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 分页查询，同时联查作者信息和类目信息  </span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> courseMapper.<span style=color:#a6e22e>paginateWithRelations</span>(page, <span style=color:#66d9ef>new</span> QueryWrapper());  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=2><li>重写控制方法 <code>CourseController -> page()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Operation</span>(summary <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;全量数据分页&#34;</span>, description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;同时联查作者信息和类目信息&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@GetMapping</span>(<span style=color:#e6db74>&#34;page&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Page<span style=color:#f92672>&lt;</span>Course<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>page</span>(Page<span style=color:#f92672>&lt;</span>Course<span style=color:#f92672>&gt;</span> page) {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> courseService.<span style=color:#a6e22e>page</span>(page);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=e07-根据类目分页>E07. 根据类目分页</h2><blockquote><p>心法: 业务流程</p></blockquote><pre tabindex=0><code class=language-mermaid data-lang=mermaid>graph LR

n1[根据类目主键&lt;br/&gt;分页查询课程记录] 
--&gt; n2[加入&lt;br/&gt;缓存]
--&gt; n3[返回&lt;br/&gt;分页结果]
</code></pre><blockquote><p>武技: 根据类目分类，分页查询该类目下的课程记录，同时联查作者信息和类目信息</p></blockquote><ol><li>开发业务方法 <code>CourseService -> pageCategory()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/**  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * 根据类目主键分类，分页查询课程记录  
</span></span></span><span style=display:flex><span><span style=color:#75715e> *  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param page       分页信息  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param categoryId 类目主键  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @return 分页结果  
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>  
</span></span><span style=display:flex><span>Page<span style=color:#f92672>&lt;</span>Course<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>pageCategory</span>(Page<span style=color:#f92672>&lt;</span>Course<span style=color:#f92672>&gt;</span> page, Long categoryId);
</span></span></code></pre></div><ol start=2><li>重写业务方法 <code>CourseServiceImpl -> pageCategory()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Cacheable</span>(key <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;#root.methodName + &#39;:&#39; + #categoryId + &#39;:&#39; + &#34;</span> <span style=color:#f92672>+</span>  
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;#page.getPageSize() + &#39;:&#39; + #page.getPageNumber()&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Page<span style=color:#f92672>&lt;</span>Course<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>pageCategory</span>(Page<span style=color:#f92672>&lt;</span>Course<span style=color:#f92672>&gt;</span> page, Long categoryId) {  
</span></span><span style=display:flex><span>    QueryWrapper queryWrapper <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> QueryWrapper();  
</span></span><span style=display:flex><span>    queryWrapper.<span style=color:#a6e22e>where</span>(COURSE.<span style=color:#a6e22e>FK_CATEGORY_ID</span>.<span style=color:#a6e22e>eq</span>(categoryId));  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 分页查询，同时联查作者信息和类目信息  </span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> courseMapper.<span style=color:#a6e22e>paginateWithRelations</span>(page, queryWrapper);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=3><li>重写控制方法 <code>CourseController -> pageCategory()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Operation</span>(summary <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;根据类目分页&#34;</span>, description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;根据类目主键分类，分页查询课程记录&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@GetMapping</span>(<span style=color:#e6db74>&#34;pageCategory/{categoryId}&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Page<span style=color:#f92672>&lt;</span>Course<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>pageCategory</span>(Page<span style=color:#f92672>&lt;</span>Course<span style=color:#f92672>&gt;</span> page, <span style=color:#a6e22e>@PathVariable</span> Long categoryId) {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> courseService.<span style=color:#a6e22e>pageCategory</span>(page, categoryId);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=e08-上传封面图片>E08. 上传封面图片</h2><blockquote><p>心法: 业务流程</p></blockquote><pre tabindex=0><code class=language-mermaid data-lang=mermaid>graph LR

ex1[抛出异常&lt;br/&gt;触发回滚]
ex2[抛出异常&lt;br/&gt;触发回滚]
ex3[抛出异常&lt;br/&gt;触发回滚]

1[P1] 
--&gt; n1[根据主键&lt;br/&gt;查询课程] 
--&gt; f1{是否&lt;br/&gt;存在}
	f1 --否--&gt; ex1
	f1 --是--&gt; P2

2[P2] 
--&gt; n2[获取&lt;br/&gt;旧封面图] 
--&gt; n3[随机&lt;br/&gt;新文件名] 
--&gt; n4[更新&lt;br/&gt;课程记录] 
--&gt; f2{是否&lt;br/&gt;成功}
	f2 --否--&gt; ex2
	f2 --是--&gt; P3

3[P3] 
--&gt; f3{是否使用&lt;br/&gt;默认封面图片}
	f3 --否--&gt; n5[删除&lt;br/&gt;旧图] --&gt; n6[上传&lt;br/&gt;新图] --&gt; f4{是否&lt;br/&gt;成功}
		f4 --否--&gt; ex3
		f4 --是--&gt; n7[返回&lt;br/&gt;新文件名]
	f3 --是--&gt; n6
</code></pre><blockquote><p>武技: 开发上传封面图片接口</p></blockquote><ol><li>开发业务方法 <code>CourseService -> uploadCover()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/**  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * 上传封面图片  
</span></span></span><span style=display:flex><span><span style=color:#75715e> *  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param coverFile 封面图片文件  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param id        课程主键  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @return 文件名  
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>  
</span></span><span style=display:flex><span>String <span style=color:#a6e22e>uploadCover</span>(MultipartFile coverFile, Long id);
</span></span></code></pre></div><ol start=2><li>实现业务方法 <code>CourseServiceImpl -> uploadCover()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Transactional</span>(rollbackFor <span style=color:#f92672>=</span> Exception.<span style=color:#a6e22e>class</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Override</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@CacheEvict</span>(allEntries <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>uploadCover</span>(MultipartFile coverFile, Long id) {  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 判断课程是否存在  </span>
</span></span><span style=display:flex><span>    Course course <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>getById</span>(id);  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 获取旧的课程封面图片名称（提前备份）  </span>
</span></span><span style=display:flex><span>    String oldFilename <span style=color:#f92672>=</span> course.<span style=color:#a6e22e>getCover</span>();  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 随机新文件名  </span>
</span></span><span style=display:flex><span>    String newFilename <span style=color:#f92672>=</span> MinioUtil.<span style=color:#a6e22e>randomFilename</span>(coverFile);  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 更新数据库记录  </span>
</span></span><span style=display:flex><span>    course.<span style=color:#a6e22e>setCover</span>(newFilename);  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>updateById</span>(course)) {  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> ServiceException(<span style=color:#e6db74>&#34;课程封面图片地址更新失败&#34;</span>);  
</span></span><span style=display:flex><span>    }  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 从MINIO中删除非默认的课程封面图片  </span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>StrUtil.<span style=color:#a6e22e>equals</span>(CourseConst.<span style=color:#a6e22e>DEFAULT_COVER</span>, oldFilename)) {  
</span></span><span style=display:flex><span>        MinioUtil.<span style=color:#a6e22e>delete</span>(oldFilename, CourseConst.<span style=color:#a6e22e>COVER_DIR</span>, MinioConst.<span style=color:#a6e22e>BUCKET_NAME</span>);  
</span></span><span style=display:flex><span>    }  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 向MINIO中上传新的课程封面图片  </span>
</span></span><span style=display:flex><span>    MinioUtil.<span style=color:#a6e22e>upload</span>(coverFile, newFilename, CourseConst.<span style=color:#a6e22e>COVER_DIR</span>, MinioConst.<span style=color:#a6e22e>BUCKET_NAME</span>);  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 返回文件名  </span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> newFilename;  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=3><li>开发控制方法 <code>CourseController -> uploadCover()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Operation</span>(summary <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;上传封面图片&#34;</span>, description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;上传一张课程的封面图片&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@PostMapping</span>(<span style=color:#e6db74>&#34;uploadCover/{id}&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Result <span style=color:#a6e22e>uploadCover</span>(<span style=color:#a6e22e>@RequestParam</span> MultipartFile coverFile, <span style=color:#a6e22e>@PathVariable</span> Long id) {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> Result(courseService.<span style=color:#a6e22e>uploadCover</span>(coverFile, id));  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=e09-上传摘要图片>E09. 上传摘要图片</h2><blockquote><p>心法: 业务流程</p></blockquote><pre tabindex=0><code class=language-mermaid data-lang=mermaid>graph LR

ex1[抛出异常&lt;br/&gt;触发回滚]
ex2[抛出异常&lt;br/&gt;触发回滚]
ex3[抛出异常&lt;br/&gt;触发回滚]

1[P1] 
--&gt; n1[根据主键&lt;br/&gt;查询课程] 
--&gt; f1{是否&lt;br/&gt;存在}
	f1 --否--&gt; ex1
	f1 --是--&gt; P2

2[P2] 
--&gt; n2[获取&lt;br/&gt;旧摘要图] 
--&gt; n3[随机&lt;br/&gt;新文件名] 
--&gt; n4[更新&lt;br/&gt;课程记录] 
--&gt; f2{是否&lt;br/&gt;成功}
	f2 --否--&gt; ex2
	f2 --是--&gt; P3

3[P3] 
--&gt; f3{是否使用&lt;br/&gt;默认摘要图片}
	f3 --否--&gt; n5[删除&lt;br/&gt;旧图] --&gt; n6[上传&lt;br/&gt;新图] --&gt; f4{是否&lt;br/&gt;成功}
		f4 --否--&gt; ex3
		f4 --是--&gt; n7[返回&lt;br/&gt;新文件名]
	f3 --是--&gt; n6
</code></pre><blockquote><p>武技: 开发上传摘要图片接口</p></blockquote><ol><li>开发业务方法 <code>CourseService -> uploadSummary()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/**  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * 上传摘要图片  
</span></span></span><span style=display:flex><span><span style=color:#75715e> *  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param summaryFile 摘要图片文件  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param id          课程主键  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @return 文件名  
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>  
</span></span><span style=display:flex><span>String <span style=color:#a6e22e>uploadSummary</span>(MultipartFile summaryFile, Long id);
</span></span></code></pre></div><ol start=2><li>实现业务方法 <code>CourseServiceImpl -> uploadSummary()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Transactional</span>(rollbackFor <span style=color:#f92672>=</span> Exception.<span style=color:#a6e22e>class</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Override</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@CacheEvict</span>(allEntries <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>uploadSummary</span>(MultipartFile summaryFile, Long id) {  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 判断课程是否存在  </span>
</span></span><span style=display:flex><span>    Course course <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>getById</span>(id);  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 获取旧的课程摘要图片名称（提前备份）  </span>
</span></span><span style=display:flex><span>    String oldFilename <span style=color:#f92672>=</span> course.<span style=color:#a6e22e>getSummary</span>();  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 随机新文件名  </span>
</span></span><span style=display:flex><span>    String newFilename <span style=color:#f92672>=</span> MinioUtil.<span style=color:#a6e22e>randomFilename</span>(summaryFile);  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 更新数据库记录  </span>
</span></span><span style=display:flex><span>    course.<span style=color:#a6e22e>setSummary</span>(newFilename);  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>updateById</span>(course)) {  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> ServiceException(<span style=color:#e6db74>&#34;课程摘要图片地址更新失败&#34;</span>);  
</span></span><span style=display:flex><span>    }  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 从MINIO中删除非默认的课程摘要图片  </span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>StrUtil.<span style=color:#a6e22e>equals</span>(CourseConst.<span style=color:#a6e22e>DEFAULT_SUMMARY</span>, oldFilename)) {  
</span></span><span style=display:flex><span>        MinioUtil.<span style=color:#a6e22e>delete</span>(oldFilename, CourseConst.<span style=color:#a6e22e>SUMMARY_DIR</span>, MinioConst.<span style=color:#a6e22e>BUCKET_NAME</span>);  
</span></span><span style=display:flex><span>    }  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 向MINIO中上传新的课程摘要图片  </span>
</span></span><span style=display:flex><span>    MinioUtil.<span style=color:#a6e22e>upload</span>(summaryFile, newFilename, CourseConst.<span style=color:#a6e22e>SUMMARY_DIR</span>, MinioConst.<span style=color:#a6e22e>BUCKET_NAME</span>);  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 返回文件名  </span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> newFilename;  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=3><li>开发控制方法 <code>CourseController -> uploadSummary()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Operation</span>(summary <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;上传摘要图片&#34;</span>, description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;上传一张课程的摘要图片&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@PostMapping</span>(<span style=color:#e6db74>&#34;uploadSummary/{id}&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Result <span style=color:#a6e22e>uploadSummary</span>(<span style=color:#a6e22e>@RequestParam</span> MultipartFile summaryFile, <span style=color:#a6e22e>@PathVariable</span> Long id) {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> Result(courseService.<span style=color:#a6e22e>uploadSummary</span>(summaryFile, id));  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=e10-统计课程评分>E10. 统计课程评分</h2><blockquote><p>心法: 业务流程</p></blockquote><pre tabindex=0><code class=language-mermaid data-lang=mermaid>graph LR

n1[查询&lt;br/&gt;课程评分] 
--&gt; n2[加入&lt;br/&gt;缓存]
--&gt; n3[返回&lt;br/&gt;课程评分]
</code></pre><blockquote><p>武技: 开发统计课程评分的接口</p></blockquote><ol><li>开发DTO实体类 <code>CourseStarCountDTO</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> com.lsx.dto;  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Schema</span>(name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;统计课程评分DTO&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Data</span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>CourseStarCountDTO</span> {  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>/** 课程评分 */</span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Integer name;  
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>/** 每种课程评分对应的课程数量 */</span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Integer value;  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=2><li>开发业务方法 <code>CourseService -> countStar()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/**  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * 根据评分类型，统计每种评分对应的视频数量  
</span></span></span><span style=display:flex><span><span style=color:#75715e> *  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @return 每种评分对应的视频数量  
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>  
</span></span><span style=display:flex><span>List<span style=color:#f92672>&lt;</span>CourseStarCountDTO<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>countStar</span>();
</span></span></code></pre></div><ol start=3><li>实现业务方法 <code>CourseServiceImpl -> countStar()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Cacheable</span>(key <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;#root.methodName&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> List<span style=color:#f92672>&lt;</span>CourseStarCountDTO<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>countStar</span>() {  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// select star as name, count(*) as value from cms_course group by star, order by star  </span>
</span></span><span style=display:flex><span>    QueryWrapper queryWrapper <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> QueryWrapper();  
</span></span><span style=display:flex><span>    queryWrapper.<span style=color:#a6e22e>select</span>(COURSE.<span style=color:#a6e22e>STAR</span>.<span style=color:#a6e22e>as</span>(<span style=color:#e6db74>&#34;name&#34;</span>), QueryMethods.<span style=color:#a6e22e>count</span>().<span style=color:#a6e22e>as</span>(<span style=color:#e6db74>&#34;value&#34;</span>))  
</span></span><span style=display:flex><span>            .<span style=color:#a6e22e>groupBy</span>(COURSE.<span style=color:#a6e22e>STAR</span>)  
</span></span><span style=display:flex><span>            .<span style=color:#a6e22e>orderBy</span>(COURSE.<span style=color:#a6e22e>STAR</span>.<span style=color:#a6e22e>asc</span>());  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> courseMapper.<span style=color:#a6e22e>selectListByQueryAs</span>(queryWrapper, CourseStarCountDTO.<span style=color:#a6e22e>class</span>);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=4><li>开发控制方法 <code>CourseController -> countStar()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Operation</span>(summary <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;统计课程评分&#34;</span>, description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;根据评分类型，查询每种评分对应的视频数量&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@GetMapping</span>(<span style=color:#e6db74>&#34;countStar&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Result <span style=color:#a6e22e>countStar</span>() {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> Result(courseService.<span style=color:#a6e22e>countStar</span>());  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h1 id=s10-开发季次接口>S10. 开发季次接口</h1><blockquote><p>心法: Season接口文档</p></blockquote><ul><li>前缀 <code>/api/v1/season</code>:</li></ul><table><thead><tr><th></th><th>接口</th><th>类型</th><th>描述</th><th>请求参数</th><th>必要参数</th></tr></thead><tbody><tr><td>1</td><td><code>save</code></td><td>POST</td><td>添加一条记录</td><td><code>@RequestBody SeasonInsertDTO dto</code></td><td><code>title</code></td></tr><tr><td>2</td><td><code>getInfo/{id}</code></td><td>GET</td><td>根据主键查询</td><td><code>@PathVariable Long id</code></td><td><code>id</code></td></tr><tr><td>3</td><td><code>update</code></td><td>POST</td><td>根据主键修改</td><td><code>@RequestBody SeasonUpdateDTO dto</code></td><td><code>id</code></td></tr><tr><td>4</td><td><code>remove/{id}</code></td><td>POST</td><td>根据主键删除</td><td><code>@PathVariable Long id</code></td><td><code>id</code></td></tr><tr><td>5</td><td><code>removeBatch</code></td><td>POST</td><td>根据主键批删</td><td><code>@RequestParam List&lt;Long> ids</code></td><td><code>ids</code></td></tr><tr><td>6</td><td><code>pageCourse/{courseId}</code></td><td>GET</td><td>根据课程分页</td><td><code>Page&lt;Season> page</code><code>@PathVariable courseId</code></td><td><code>pageNumber</code><code>pageSize</code><code>courseId</code></td></tr></tbody></table><h2 id=e01-添加一条记录-4>E01. 添加一条记录</h2><blockquote><p>心法: 业务流程</p></blockquote><pre tabindex=0><code class=language-mermaid data-lang=mermaid>graph LR

n1[根据标题&lt;br/&gt;查询季次] --&gt; f{是否&lt;br/&gt;存在}
	f --是--&gt; ex[抛出&lt;br/&gt;异常]
	f --否--&gt; n2[置空&lt;br/&gt;主键]
		--&gt; n3[设置当前创建时间&lt;br/&gt;设置当前修改时间] 
		--&gt; n4[添加&lt;br/&gt;记录]
		--&gt; n5[逐出&lt;br/&gt;缓存]
		--&gt; n6[返回&lt;br/&gt;布尔结果]
</code></pre><blockquote><p>武技: 添加一条季次记录</p></blockquote><ol><li>开发DTO实体类 <code>SeasonInsertDTO</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> com.lsx.dto;   
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Schema</span>(name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;季次添加DTO&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Data</span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SeasonInsertDTO</span> <span style=color:#66d9ef>implements</span> Serializable {  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@NotEmpty</span>(message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;标题不能为空&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Size</span>(min <span style=color:#f92672>=</span> 1, max <span style=color:#f92672>=</span> 128, message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;标题长度必须在1~128之间&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Schema</span>(description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;标题&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> String title;  
</span></span><span style=display:flex><span>	  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Size</span>(min <span style=color:#f92672>=</span> 1, max <span style=color:#f92672>=</span> 512, message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;描述长度必须在1~512之间&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Schema</span>(description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;描述&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> String info;  
</span></span><span style=display:flex><span>	  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Range</span>(min <span style=color:#f92672>=</span> 0, message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;权重最小为0&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Schema</span>(description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;权重，数字越小越优先&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> Long weight;  
</span></span><span style=display:flex><span>	  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@NotNull</span>(message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;课程表ID不能为空&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Schema</span>(description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;课程表ID，课程表外键&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> Long fkCourseId; 
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=2><li>重写业务方法 <code>SeasonServiceImpl -> save()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@CacheEvict</span>(allEntries <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>save</span>(Season entity) {  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 判断季次标题是否已经存在  </span>
</span></span><span style=display:flex><span>	Season season <span style=color:#f92672>=</span> seasonMapper.<span style=color:#a6e22e>selectOneByCondition</span>(SEASON.<span style=color:#a6e22e>TITLE</span>.<span style=color:#a6e22e>eq</span>(entity.<span style=color:#a6e22e>getTitle</span>()));  
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span>(ObjectUtil.<span style=color:#a6e22e>isNotNull</span>(season)){  
</span></span><span style=display:flex><span>	    <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> ServiceException(<span style=color:#e6db74>&#34;季次标题已存在&#34;</span>);  
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 清空主键  </span>
</span></span><span style=display:flex><span>    entity.<span style=color:#a6e22e>setId</span>(<span style=color:#66d9ef>null</span>);  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 设置创建时间和修改时间为当前时间  </span>
</span></span><span style=display:flex><span>    entity.<span style=color:#a6e22e>setCreated</span>(LocalDateTime.<span style=color:#a6e22e>now</span>());  
</span></span><span style=display:flex><span>    entity.<span style=color:#a6e22e>setUpdated</span>(LocalDateTime.<span style=color:#a6e22e>now</span>());  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 添加记录  </span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>super</span>.<span style=color:#a6e22e>save</span>(entity);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=3><li>重写控制方法 <code>SeasonController -> save()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Operation</span>(summary <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;添加一条记录&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@PostMapping</span>(<span style=color:#e6db74>&#34;save&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>save</span>(<span style=color:#a6e22e>@RequestBody</span> <span style=color:#a6e22e>@Validated</span> SeasonInsertDTO dto) {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> seasonService.<span style=color:#a6e22e>save</span>(BeanUtil.<span style=color:#a6e22e>copyProperties</span>(dto, Season.<span style=color:#a6e22e>class</span>));  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=e02-根据主键查询-4>E02. 根据主键查询</h2><blockquote><p>心法: 业务流程</p></blockquote><pre tabindex=0><code class=language-mermaid data-lang=mermaid>graph LR

n1[根据主键&lt;br/&gt;查询季次] --&gt; f{是否&lt;br/&gt;存在}
	f --是--&gt; n2[加入缓存] --&gt; n2a[返回结果]
	f --否--&gt; n3[返回空值]
</code></pre><blockquote><p>武技: 根据主键查询一条季次记录</p></blockquote><ol><li>重写业务方法 <code>SeasonServiceImpl -> getById()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Cacheable</span>(key <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;#id&#34;</span>, unless <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;#result == null&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Season <span style=color:#a6e22e>getById</span>(Serializable id) {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>super</span>.<span style=color:#a6e22e>getById</span>(id);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=2><li>重写控制方法 <code>SeasonController -> getInfo()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Operation</span>(summary <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;根据主键查询&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@GetMapping</span>(<span style=color:#e6db74>&#34;getInfo/{id}&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Season <span style=color:#a6e22e>getInfo</span>(<span style=color:#a6e22e>@PathVariable</span> Long id) {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> seasonService.<span style=color:#a6e22e>getById</span>(id);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=e03-根据主键修改-4>E03. 根据主键修改</h2><blockquote><p>心法: 业务流程</p></blockquote><pre tabindex=0><code class=language-mermaid data-lang=mermaid>graph LR

	n1[设置&lt;br/&gt;当前修改时间]
--&gt; n2[置空&lt;br/&gt;创建时间]
--&gt; n3[置空&lt;br/&gt;课程外键]
--&gt; n4[修改&lt;br/&gt;记录]
--&gt; n5[逐出&lt;br/&gt;缓存]
--&gt; n6[返回&lt;br/&gt;布尔结果]
</code></pre><blockquote><p>武技: 根据主键修改一条季次记录</p></blockquote><ol><li>开发DTO实体类 <code>SeasonUpdateDTO</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> com.lsx.dto;  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Schema</span>(name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;季次修改DTO&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Data</span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SeasonUpdateDTO</span> <span style=color:#66d9ef>implements</span> Serializable {  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@NotNull</span>(message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;主键不能为空&#34;</span>)  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Schema</span>(description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;主键&#34;</span>)  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Long id;  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Size</span>(min <span style=color:#f92672>=</span> 1, max <span style=color:#f92672>=</span> 128, message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;标题长度必须在1~128之间&#34;</span>)  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Schema</span>(description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;标题&#34;</span>)  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String title;  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Size</span>(min <span style=color:#f92672>=</span> 1, max <span style=color:#f92672>=</span> 512, message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;描述长度必须在1~512之间&#34;</span>)  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Schema</span>(description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;描述&#34;</span>)  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String info;  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Range</span>(min <span style=color:#f92672>=</span> 0, message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;权重最小为0&#34;</span>)  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Schema</span>(description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;权重，数字越小越优先&#34;</span>)  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Long weight;  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=2><li>重写业务方法 <code>SeasonServiceImpl -> updateBy1Id()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@CacheEvict</span>(allEntries <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>updateById</span>(Season entity) {  
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 设置最后修改时间为当前时间    </span>
</span></span><span style=display:flex><span>	entity.<span style=color:#a6e22e>setUpdated</span>(LocalDateTime.<span style=color:#a6e22e>now</span>());  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 创建时间不允许修改    </span>
</span></span><span style=display:flex><span>	entity.<span style=color:#a6e22e>setCreated</span>(<span style=color:#66d9ef>null</span>);  
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 课程外键不允许修改  </span>
</span></span><span style=display:flex><span>	entity.<span style=color:#a6e22e>setFkCourseId</span>(<span style=color:#66d9ef>null</span>);
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 修改记录    </span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>super</span>.<span style=color:#a6e22e>updateById</span>(entity);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=3><li>重写控制方法 <code>SeasonController -> update()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Operation</span>(summary <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;根据主键修改&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@PostMapping</span>(<span style=color:#e6db74>&#34;update&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>update</span>(<span style=color:#a6e22e>@RequestBody</span> <span style=color:#a6e22e>@Validated</span> SeasonUpdateDTO dto) {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> seasonService.<span style=color:#a6e22e>updateById</span>(BeanUtil.<span style=color:#a6e22e>copyProperties</span>(dto, Season.<span style=color:#a6e22e>class</span>));  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=e04-根据主键删除-4>E04. 根据主键删除</h2><blockquote><p>心法: 业务流程</p></blockquote><pre tabindex=0><code class=language-mermaid data-lang=mermaid>graph LR

1[P1]
--&gt; n1[查询该季次下&lt;br/&gt;的全部集次]
--&gt; f{是否&lt;br/&gt;为空}
	f --是--&gt; P2
	f --否--&gt; n2[批量删除&lt;br/&gt;集次记录] --&gt; P2
2[P2]
--&gt; n5[根据季次主键&lt;br/&gt;删除集次记录]
--&gt; n6[逐出缓存]
--&gt; n7[返回布尔结果]
</code></pre><blockquote><p>武技: 根据主键删除一条季次记录，同时删除全部集</p></blockquote><ol><li>重写业务方法 <code>SeasonServiceImpl -> removeById()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Transactional</span>(rollbackFor <span style=color:#f92672>=</span> Exception.<span style=color:#a6e22e>class</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Override</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@CacheEvict</span>(allEntries <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>removeById</span>(Serializable id) {  
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 通过季次主键查询全部集次的ID列表  </span>
</span></span><span style=display:flex><span>    List<span style=color:#f92672>&lt;</span>Long<span style=color:#f92672>&gt;</span> episodeIds <span style=color:#f92672>=</span> episodeMapper.<span style=color:#a6e22e>selectObjectListByQueryAs</span>(QueryWrapper.<span style=color:#a6e22e>create</span>()  
</span></span><span style=display:flex><span>            .<span style=color:#a6e22e>select</span>(EPISODE.<span style=color:#a6e22e>ID</span>)  
</span></span><span style=display:flex><span>            .<span style=color:#a6e22e>where</span>(EPISODE.<span style=color:#a6e22e>FK_SEASON_ID</span>.<span style=color:#a6e22e>eq</span>(id)), Long.<span style=color:#a6e22e>class</span>);  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 存在集记录时，批量删除集  </span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (ObjectUtil.<span style=color:#a6e22e>isNotEmpty</span>(episodeIds)) {  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (episodeMapper.<span style=color:#a6e22e>deleteBatchByIds</span>(episodeIds) <span style=color:#f92672>&lt;=</span> 0) {  
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> ServiceException(<span style=color:#e6db74>&#34;集删除失败&#34;</span>);  
</span></span><span style=display:flex><span>        }  
</span></span><span style=display:flex><span>    }  
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 删除季次  </span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>super</span>.<span style=color:#a6e22e>removeById</span>(id);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=2><li>重写控制方法 <code>CouponsController -> remove()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Operation</span>(summary <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;根据主键删除&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@PostMapping</span>(<span style=color:#e6db74>&#34;remove/{id}&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>remove</span>(<span style=color:#a6e22e>@PathVariable</span> Long id) {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> seasonService.<span style=color:#a6e22e>removeById</span>(id);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=e05-根据主键批删-4>E05. 根据主键批删</h2><blockquote><p>心法: 业务流程</p></blockquote><pre tabindex=0><code class=language-mermaid data-lang=mermaid>graph LR

1[P1]
--&gt; n1[查询每个季次&lt;br/&gt;下的全部集次]
--&gt; f{是否&lt;br/&gt;为空}
	f --是--&gt; P2
	f --否--&gt; n2[批量删除&lt;br/&gt;集次记录] --&gt; P2
2[P2]
--&gt; n5[根据季次主键列表&lt;br/&gt;批量删除集次记录]
--&gt; n6[逐出缓存]
--&gt; n7[返回布尔结果]
</code></pre><blockquote><p>武技: 根据主键数组删除季次记录，同时删除全部集</p></blockquote><ol><li>重写业务方法 <code>SeasonServiceImpl -> removeByIds()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Transactional</span>(rollbackFor <span style=color:#f92672>=</span> Exception.<span style=color:#a6e22e>class</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Override</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@CacheEvict</span>(allEntries <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>removeByIds</span>(Collection<span style=color:#f92672>&lt;?</span> <span style=color:#66d9ef>extends</span> Serializable<span style=color:#f92672>&gt;</span> ids) {  
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 通过季次主键列表查询全部集次的ID列表  </span>
</span></span><span style=display:flex><span>	List<span style=color:#f92672>&lt;</span>Long<span style=color:#f92672>&gt;</span> episodeIds <span style=color:#f92672>=</span> episodeMapper.<span style=color:#a6e22e>selectObjectListByQueryAs</span>(QueryWrapper.<span style=color:#a6e22e>create</span>()  
</span></span><span style=display:flex><span>	        .<span style=color:#a6e22e>select</span>(EPISODE.<span style=color:#a6e22e>ID</span>)  
</span></span><span style=display:flex><span>	        .<span style=color:#a6e22e>where</span>(EPISODE.<span style=color:#a6e22e>FK_SEASON_ID</span>.<span style=color:#a6e22e>in</span>(ids)), Long.<span style=color:#a6e22e>class</span>);  
</span></span><span style=display:flex><span>	  
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 存在集记录时，批量删除集  </span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (ObjectUtil.<span style=color:#a6e22e>isNotEmpty</span>(episodeIds)) {  
</span></span><span style=display:flex><span>	    <span style=color:#66d9ef>if</span> (episodeMapper.<span style=color:#a6e22e>deleteBatchByIds</span>(episodeIds) <span style=color:#f92672>&lt;=</span> 0) {  
</span></span><span style=display:flex><span>	        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> ServiceException(<span style=color:#e6db74>&#34;集删除失败&#34;</span>);  
</span></span><span style=display:flex><span>	    }  
</span></span><span style=display:flex><span>	}  
</span></span><span style=display:flex><span>	      
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 批量删除季次  </span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>super</span>.<span style=color:#a6e22e>removeByIds</span>(ids);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=3><li>重写控制方法 <code>SeasonController -> removeBatch()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Operation</span>(summary <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;根据主键批删&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@PostMapping</span>(<span style=color:#e6db74>&#34;removeBatch&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>removeBatch</span>(<span style=color:#a6e22e>@RequestParam</span> List<span style=color:#f92672>&lt;</span>Long<span style=color:#f92672>&gt;</span> ids) {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> seasonService.<span style=color:#a6e22e>removeByIds</span>(ids);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=e06-根据课程分页>E06. 根据课程分页</h2><blockquote><p>心法: 业务流程</p></blockquote><pre tabindex=0><code class=language-mermaid data-lang=mermaid>graph LR

n1[根据课程主键&lt;br/&gt;分页查询季次记录] 
--&gt; n2[加入&lt;br/&gt;缓存]
--&gt; n3[根据权重升序&lt;br/&gt;根据主键降序]
--&gt; n4[返回&lt;br/&gt;分页结果]
</code></pre><blockquote><p>武技: 根据课程分类，分页查询该课程下的全部季次记录</p></blockquote><ol><li>开发业务方法 <code>SeasonService -> pageCourse()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/**  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * 根据课程分类，分页查询该课程下的全部季次记录  
</span></span></span><span style=display:flex><span><span style=color:#75715e> *  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param page     分页信息  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param courseId 课程表ID  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @return 分页信息  
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>  
</span></span><span style=display:flex><span>Page<span style=color:#f92672>&lt;</span>Season<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>pageCourse</span>(Page<span style=color:#f92672>&lt;</span>Season<span style=color:#f92672>&gt;</span> page, Long courseId);
</span></span></code></pre></div><ol start=2><li>重写业务方法 <code>SeasonServiceImpl -> pageCourse()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Cacheable</span>(key <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;#root.methodName + &#39;:&#39; + #courseId + &#39;:&#39; + &#34;</span> <span style=color:#f92672>+</span>  
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;#page.getPageSize() + &#39;:&#39; + #page.getPageNumber()&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Page<span style=color:#f92672>&lt;</span>Season<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>pageCourse</span>(Page<span style=color:#f92672>&lt;</span>Season<span style=color:#f92672>&gt;</span> page, Long courseId) {  
</span></span><span style=display:flex><span>    QueryWrapper queryWrapper <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> QueryWrapper();  
</span></span><span style=display:flex><span>    queryWrapper.<span style=color:#a6e22e>where</span>(SEASON.<span style=color:#a6e22e>FK_COURSE_ID</span>.<span style=color:#a6e22e>eq</span>(courseId));  
</span></span><span style=display:flex><span>    queryWrapper.<span style=color:#a6e22e>orderBy</span>(SEASON.<span style=color:#a6e22e>WEIGHT</span>.<span style=color:#a6e22e>asc</span>(), SEASON.<span style=color:#a6e22e>ID</span>.<span style=color:#a6e22e>desc</span>());  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>super</span>.<span style=color:#a6e22e>page</span>(page, queryWrapper);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=3><li>重写控制方法 <code>SeasonController -> pageCourse()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Operation</span>(summary <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;根据课程分页&#34;</span>, description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;根据课程分类，分页查询该课程下的全部季次记录&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@GetMapping</span>(<span style=color:#e6db74>&#34;pageCourse/{courseId}&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Page<span style=color:#f92672>&lt;</span>Season<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>pageCourse</span>(Page<span style=color:#f92672>&lt;</span>Season<span style=color:#f92672>&gt;</span> page, <span style=color:#a6e22e>@PathVariable</span> Long courseId) {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> seasonService.<span style=color:#a6e22e>pageCourse</span>(page, courseId);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h1 id=s11-开发集次接口>S11. 开发集次接口</h1><blockquote><p>心法: Episode接口文档</p></blockquote><ul><li>前缀 <code>/api/v1/episode</code>:</li></ul><table><thead><tr><th></th><th>接口</th><th>类型</th><th>描述</th><th>请求参数</th><th>必要参数</th></tr></thead><tbody><tr><td>1</td><td><code>save</code></td><td>POST</td><td>添加一条记录</td><td><code>@RequestBody EpisodeInsertDTO dto</code></td><td><code>title</code></td></tr><tr><td>2</td><td><code>getInfo/{id}</code></td><td>GET</td><td>根据主键查询</td><td><code>@PathVariable Long id</code></td><td><code>id</code></td></tr><tr><td>3</td><td><code>update</code></td><td>POST</td><td>根据主键修改</td><td><code>@RequestBody EpisodeUpdateDTO dto</code></td><td><code>id</code></td></tr><tr><td>4</td><td><code>remove/{id}</code></td><td>POST</td><td>根据主键删除</td><td><code>@PathVariable Long id</code></td><td><code>id</code></td></tr><tr><td>5</td><td><code>removeBatch</code></td><td>POST</td><td>根据主键批删</td><td><code>@RequestParam List&lt;Long> ids</code></td><td><code>ids</code></td></tr><tr><td>6</td><td><code>pageSeason/{seasonId}</code></td><td>GET</td><td>根据季次分页</td><td><code>Page&lt;Episode> page</code><code>@PathVariable seasonId</code></td><td><code>pageNumber</code><code>pageSize</code><code>seasonId</code></td></tr><tr><td>7</td><td><code>excel</code></td><td>GET</td><td>报表打印数据</td><td></td><td></td></tr><tr><td>8</td><td><code>uploadCover/{id}</code></td><td>POST</td><td>上传视频封面</td><td><code>@RequestParam MultipartFile videoCoverFile</code><code>@PathVariable Long id</code></td><td><code>videoCoverFile</code><code>id</code></td></tr><tr><td>9</td><td><code>uploadVideo/{id}</code></td><td>POST</td><td>上传视频文件</td><td><code>@RequestParam MultipartFile videoFile</code><code>@PathVariable Long id</code></td><td><code>videoFile</code><code>id</code></td></tr></tbody></table><h2 id=e01-添加一条记录-5>E01. 添加一条记录</h2><blockquote><p>心法: 业务流程</p></blockquote><pre tabindex=0><code class=language-mermaid data-lang=mermaid>graph LR

n1[根据标题&lt;br/&gt;查询集次] --&gt; f{是否&lt;br/&gt;存在}
	f --是--&gt; ex[抛出&lt;br/&gt;异常]
	f --否--&gt; n2[置空&lt;br/&gt;主键]
		--&gt; n3[设置当前创建时间&lt;br/&gt;设置当前修改时间] 
		--&gt; n4[设置默认视频封面&lt;br/&gt;设置默认视频地址] 
		--&gt; n5[添加&lt;br/&gt;记录]
		--&gt; n6[逐出&lt;br/&gt;缓存]
		--&gt; n7[返回&lt;br/&gt;布尔结果]
</code></pre><blockquote><p>武技: 添加一条集次记录</p></blockquote><ol><li>开发DTO实体类 <code>EpisodeInsertDTO</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> com.lsx.dto;  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Schema</span>(name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;集次添加DTO&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Data</span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>EpisodeInsertDTO</span> <span style=color:#66d9ef>implements</span> Serializable {  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@NotEmpty</span>(message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;标题不能为空&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Size</span>(min <span style=color:#f92672>=</span> 1, max <span style=color:#f92672>=</span> 128, message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;标题长度必须在1~128之间&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Schema</span>(description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;标题&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> String title;  
</span></span><span style=display:flex><span>	  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Size</span>(min <span style=color:#f92672>=</span> 1, max <span style=color:#f92672>=</span> 512, message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;描述长度必须在1~512之间&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Schema</span>(description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;描述&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> String info;  
</span></span><span style=display:flex><span>	  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Range</span>(min <span style=color:#f92672>=</span> 0, message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;权重最小为0&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Schema</span>(description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;权重，数字越小越优先&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> Long weight;  
</span></span><span style=display:flex><span>	  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@NotNull</span>(message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;季次表ID不能为空&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Schema</span>(description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;季次表ID，季次表外键&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> Long fkSeasonId; 
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=2><li>重写业务方法 <code>EpisodeServiceImpl -> save()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@CacheEvict</span>(allEntries <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>save</span>(Episode entity) {  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 判断集次标题是否已经存在  </span>
</span></span><span style=display:flex><span>	Episode episode <span style=color:#f92672>=</span> episodeMapper.<span style=color:#a6e22e>selectOneByCondition</span>(EPISODE.<span style=color:#a6e22e>TITLE</span>.<span style=color:#a6e22e>eq</span>(entity.<span style=color:#a6e22e>getTitle</span>()));  
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span>(ObjectUtil.<span style=color:#a6e22e>isNotNull</span>(episode)){  
</span></span><span style=display:flex><span>	    <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> ServiceException(<span style=color:#e6db74>&#34;集次标题已存在&#34;</span>);  
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 清空主键  </span>
</span></span><span style=display:flex><span>    entity.<span style=color:#a6e22e>setId</span>(<span style=color:#66d9ef>null</span>);  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 设置默认视频地址  </span>
</span></span><span style=display:flex><span>    entity.<span style=color:#a6e22e>setVideo</span>(EpisodeConst.<span style=color:#a6e22e>DEFAULT_VIDEO</span>);  
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 设置默认封面地址  </span>
</span></span><span style=display:flex><span>    entity.<span style=color:#a6e22e>setCover</span>(EpisodeConst.<span style=color:#a6e22e>DEFAULT_VIDEO_COVER</span>);  
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 设置创建时间和修改时间为当前时间  </span>
</span></span><span style=display:flex><span>    entity.<span style=color:#a6e22e>setCreated</span>(LocalDateTime.<span style=color:#a6e22e>now</span>());  
</span></span><span style=display:flex><span>    entity.<span style=color:#a6e22e>setUpdated</span>(LocalDateTime.<span style=color:#a6e22e>now</span>());  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 添加记录  </span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>super</span>.<span style=color:#a6e22e>save</span>(entity);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=3><li>重写控制方法 <code>EpisodeController -> save()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Operation</span>(summary <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;添加一条记录&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@PostMapping</span>(<span style=color:#e6db74>&#34;save&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>save</span>(<span style=color:#a6e22e>@RequestBody</span> <span style=color:#a6e22e>@Validated</span> EpisodeInsertDTO dto) {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> episodeService.<span style=color:#a6e22e>save</span>(BeanUtil.<span style=color:#a6e22e>copyProperties</span>(dto, Episode.<span style=color:#a6e22e>class</span>));  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=e02-根据主键查询-5>E02. 根据主键查询</h2><blockquote><p>心法: 业务流程</p></blockquote><pre tabindex=0><code class=language-mermaid data-lang=mermaid>graph LR

n1[根据主键&lt;br/&gt;查询集次] --&gt; f{是否&lt;br/&gt;存在}
	f --是--&gt; n2[加入缓存] --&gt; n2a[返回结果]
	f --否--&gt; n3[返回空值]
</code></pre><blockquote><p>武技: 根据主键查询一条集次记录</p></blockquote><ol><li>重写业务方法 <code>EpisodeServiceImpl -> getById()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Cacheable</span>(key <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;#id&#34;</span>, unless <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;#result == null&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Episode <span style=color:#a6e22e>getById</span>(Serializable id) {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>super</span>.<span style=color:#a6e22e>getById</span>(id);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=2><li>重写控制方法 <code>EpisodeController -> getInfo()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Operation</span>(summary <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;根据主键查询&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@GetMapping</span>(<span style=color:#e6db74>&#34;getInfo/{id}&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Episode <span style=color:#a6e22e>getInfo</span>(<span style=color:#a6e22e>@PathVariable</span> Long id) {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> episodeService.<span style=color:#a6e22e>getById</span>(id);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=e03-根据主键修改-5>E03. 根据主键修改</h2><blockquote><p>心法: 业务流程</p></blockquote><pre tabindex=0><code class=language-mermaid data-lang=mermaid>graph LR

	n1[设置&lt;br/&gt;当前修改时间]
--&gt; n2[置空&lt;br/&gt;创建时间]
--&gt; n3[置空&lt;br/&gt;季次外键]
--&gt; n4[修改&lt;br/&gt;记录]
--&gt; n5[逐出&lt;br/&gt;缓存]
--&gt; n6[返回&lt;br/&gt;布尔结果]
</code></pre><blockquote><p>武技: 根据主键修改一条集次记录</p></blockquote><ol><li>开发DTO实体类 <code>EpisodeUpdateDTO</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> com.lsx.dto;  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Schema</span>(name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;集次修改DTO&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Data</span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>EpisodeUpdateDTO</span> <span style=color:#66d9ef>implements</span> Serializable {  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@NotNull</span>(message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;主键不能为空&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Schema</span>(description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;主键&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> Long id;  
</span></span><span style=display:flex><span>	  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Size</span>(min <span style=color:#f92672>=</span> 1, max <span style=color:#f92672>=</span> 128, message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;标题长度必须在1~128之间&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Schema</span>(description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;标题&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> String title;  
</span></span><span style=display:flex><span>	  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Size</span>(min <span style=color:#f92672>=</span> 1, max <span style=color:#f92672>=</span> 512, message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;描述长度必须在1~512之间&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Schema</span>(description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;描述&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> String info;  
</span></span><span style=display:flex><span>	  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Range</span>(min <span style=color:#f92672>=</span> 0, message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;权重最小为0&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Schema</span>(description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;权重，数字越小越优先&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> Long weight; 
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=2><li>重写业务方法 <code>EpisodeServiceImpl -> updateById()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@CacheEvict</span>(allEntries <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>updateById</span>(Episode entity) {  
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 设置最后修改时间为当前时间      </span>
</span></span><span style=display:flex><span>	entity.<span style=color:#a6e22e>setUpdated</span>(LocalDateTime.<span style=color:#a6e22e>now</span>());  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 创建时间不允许修改      </span>
</span></span><span style=display:flex><span>	entity.<span style=color:#a6e22e>setCreated</span>(<span style=color:#66d9ef>null</span>); 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 季次外键不允许修改  </span>
</span></span><span style=display:flex><span>	entity.<span style=color:#a6e22e>setFkSeasonId</span>(<span style=color:#66d9ef>null</span>);
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 修改记录      </span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>super</span>.<span style=color:#a6e22e>updateById</span>(entity);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=3><li>重写控制方法 <code>EpisodeController -> update()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Operation</span>(summary <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;根据主键修改&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@PostMapping</span>(<span style=color:#e6db74>&#34;update&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>update</span>(<span style=color:#a6e22e>@RequestBody</span> <span style=color:#a6e22e>@Validated</span> EpisodeUpdateDTO dto) {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> episodeService.<span style=color:#a6e22e>updateById</span>(BeanUtil.<span style=color:#a6e22e>copyProperties</span>(dto, Episode.<span style=color:#a6e22e>class</span>));  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=e04-根据主键删除-5>E04. 根据主键删除</h2><blockquote><p>心法: 业务流程</p></blockquote><pre tabindex=0><code class=language-mermaid data-lang=mermaid>graph LR

n1[根据主键&lt;br/&gt;删除集次记录]
--&gt; n2[逐出&lt;br/&gt;缓存]
--&gt; n3[返回&lt;br/&gt;布尔结果]
</code></pre><blockquote><p>武技: 根据主键删除一条集次记录</p></blockquote><ol><li>重写业务方法 <code>EpisodeServiceImpl -> removeById()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@CacheEvict</span>(allEntries <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>removeById</span>(Serializable id) {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>super</span>.<span style=color:#a6e22e>removeById</span>(id);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=2><li>重写控制方法 <code>EpisodeController -> remove()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Operation</span>(summary <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;根据主键删除&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@PostMapping</span>(<span style=color:#e6db74>&#34;remove/{id}&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>remove</span>(<span style=color:#a6e22e>@PathVariable</span> Long id) {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> episodeService.<span style=color:#a6e22e>removeById</span>(id);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=e05-根据主键批删-5>E05. 根据主键批删</h2><blockquote><p>心法: 业务流程</p></blockquote><pre tabindex=0><code class=language-mermaid data-lang=mermaid>graph LR

n1[根据主键列表&lt;br/&gt;批量删除集次记录]
--&gt; n2[逐出&lt;br/&gt;缓存]
--&gt; n3[返回&lt;br/&gt;布尔结果]
</code></pre><blockquote><p>武技: 根据主键数组删除集次记录</p></blockquote><ol><li>重写业务方法 <code>EpisodeServiceImpl -> removeByIds()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@CacheEvict</span>(allEntries <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>removeByIds</span>(Collection<span style=color:#f92672>&lt;?</span> <span style=color:#66d9ef>extends</span> Serializable<span style=color:#f92672>&gt;</span> ids) {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>super</span>.<span style=color:#a6e22e>removeByIds</span>(ids);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=2><li>重写控制方法 <code>EpisodeController -> removeBatch()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Operation</span>(summary <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;根据主键批删&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@PostMapping</span>(<span style=color:#e6db74>&#34;removeBatch&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>removeBatch</span>(<span style=color:#a6e22e>@RequestParam</span> List<span style=color:#f92672>&lt;</span>Long<span style=color:#f92672>&gt;</span> ids) {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> episodeService.<span style=color:#a6e22e>removeByIds</span>(ids);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=e06-根据季次分页>E06. 根据季次分页</h2><blockquote><p>心法: 业务流程</p></blockquote><pre tabindex=0><code class=language-mermaid data-lang=mermaid>graph LR

n1[根据季次主键&lt;br/&gt;分页查询集次记录] 
--&gt; n2[加入&lt;br/&gt;缓存]
--&gt; n3[根据权重升序&lt;br/&gt;根据主键降序]
--&gt; n4[返回&lt;br/&gt;分页结果]
</code></pre><blockquote><p>武技: 根据季次分类，分页查询该季次下的全部集次记录</p></blockquote><ol><li>开发业务方法 <code>EpisodeService -> pageSeason()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/**  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * 根据季次分类，分页查询该季次下的全部集次记录
</span></span></span><span style=display:flex><span><span style=color:#75715e> *  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param page     分页信息  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param seasonId 季次表ID  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @return 分页信息  
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>  
</span></span><span style=display:flex><span>Page<span style=color:#f92672>&lt;</span>Episode<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>pageSeason</span>(Page<span style=color:#f92672>&lt;</span>Episode<span style=color:#f92672>&gt;</span> page, Long seasonId);
</span></span></code></pre></div><ol start=2><li>重写业务方法 <code>EpisodeServiceImpl -> pageSeason()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Cacheable</span>(key <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;#root.methodName + &#39;:&#39; + #seasonId + &#39;:&#39; + &#34;</span> <span style=color:#f92672>+</span>  
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;#page.getPageSize() + &#39;:&#39; + #page.getPageNumber()&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Page<span style=color:#f92672>&lt;</span>Episode<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>pageSeason</span>(Page<span style=color:#f92672>&lt;</span>Episode<span style=color:#f92672>&gt;</span> page, Long seasonId) {  
</span></span><span style=display:flex><span>    QueryWrapper queryWrapper <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> QueryWrapper();  
</span></span><span style=display:flex><span>    queryWrapper.<span style=color:#a6e22e>where</span>(EPISODE.<span style=color:#a6e22e>FK_SEASON_ID</span>.<span style=color:#a6e22e>eq</span>(seasonId));  
</span></span><span style=display:flex><span>    queryWrapper.<span style=color:#a6e22e>orderBy</span>(EPISODE.<span style=color:#a6e22e>WEIGHT</span>.<span style=color:#a6e22e>asc</span>(), EPISODE.<span style=color:#a6e22e>ID</span>.<span style=color:#a6e22e>desc</span>());  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>super</span>.<span style=color:#a6e22e>page</span>(page, queryWrapper);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=3><li>重写控制方法 <code>EpisodeController -> pageSeason()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Operation</span>(summary <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;根据季次分页&#34;</span>, description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;根据季次分类，分页查询该季次下的全部集次记录&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@GetMapping</span>(<span style=color:#e6db74>&#34;pageSeason/{seasonId}&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Page<span style=color:#f92672>&lt;</span>Episode<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>pageSeason</span>(Page<span style=color:#f92672>&lt;</span>Episode<span style=color:#f92672>&gt;</span> page, <span style=color:#a6e22e>@PathVariable</span> Long seasonId) {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> episodeService.<span style=color:#a6e22e>pageSeason</span>(page, seasonId);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=e07-报表打印数据>E07. 报表打印数据</h2><blockquote><p>心法: 业务流程</p></blockquote><pre tabindex=0><code class=language-mermaid data-lang=mermaid>graph LR

n1[全查&lt;br/&gt;集次列表]
--&gt; n2[将集次列表&lt;br/&gt;转为EasyExcel所需格式]
--&gt; n3[加入&lt;br/&gt;缓存] --&gt; n4[返回&lt;br/&gt;集次列表]
</code></pre><blockquote><p>武技: 打印全部集次，包括该集次所属的季次信息和课程信息</p></blockquote><ol><li>优化实体类 <code>Episode</code>:<ul><li>1条集次记录只能对应1个季次，1个季次可以包含N条集次。</li></ul></li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/** 集次[N] : 季次[1] */</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RelationManyToOne</span>(selfField <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;fkSeasonId&#34;</span>, targetField <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;id&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> Season season;
</span></span></code></pre></div><ol start=2><li>优化实体类 <code>Season</code>:<ul><li>1条季次记录只能对应1个课程，1个课程可以包含N条季次。</li></ul></li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/** 季次[N] : 课程[1] */</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RelationManyToOne</span>(selfField <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;fkCourseId&#34;</span>, targetField <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;id&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> Course course;
</span></span></code></pre></div><ol start=3><li>开发DTO实体类 <code>EpisodeExcelDTO</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> com.lsx.dto;  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@ColumnWidth</span>(20)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Data</span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>EpisodeExcelDTO</span> <span style=color:#66d9ef>implements</span> Serializable {  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@ExcelProperty</span>(value <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#34;视频表&#34;</span>, <span style=color:#e6db74>&#34;视频基础信息&#34;</span>, <span style=color:#e6db74>&#34;视频标题&#34;</span>})  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String title;  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@ColumnWidth</span>(100)  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@ExcelProperty</span>(value <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#34;视频表&#34;</span>, <span style=color:#e6db74>&#34;视频基础信息&#34;</span>, <span style=color:#e6db74>&#34;视频描述&#34;</span>})  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String info;  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@ExcelProperty</span>(value <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#34;视频表&#34;</span>, <span style=color:#e6db74>&#34;视频基础信息&#34;</span>, <span style=color:#e6db74>&#34;作者&#34;</span>})  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String author;  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@ExcelProperty</span>(value <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#34;视频表&#34;</span>, <span style=color:#e6db74>&#34;视频基础信息&#34;</span>, <span style=color:#e6db74>&#34;视频类别&#34;</span>})  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String categoryTitle;  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@ExcelProperty</span>(value <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#34;视频表&#34;</span>, <span style=color:#e6db74>&#34;视频基础信息&#34;</span>, <span style=color:#e6db74>&#34;视频单价&#34;</span>})  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Double price;  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@ExcelProperty</span>(value <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#34;视频表&#34;</span>, <span style=color:#e6db74>&#34;视频基础信息&#34;</span>, <span style=color:#e6db74>&#34;视频评分&#34;</span>})  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Integer star;  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@ExcelProperty</span>(value <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#34;视频表&#34;</span>, <span style=color:#e6db74>&#34;视频基础信息&#34;</span>, <span style=color:#e6db74>&#34;点赞数&#34;</span>})  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Long likeCount; 
</span></span><span style=display:flex><span>     
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@ExcelProperty</span>(value <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#34;视频表&#34;</span>, <span style=color:#e6db74>&#34;视频基础信息&#34;</span>, <span style=color:#e6db74>&#34;创建时间&#34;</span>})  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> LocalDateTime created;  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@ExcelProperty</span>(value <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#34;视频表&#34;</span>, <span style=color:#e6db74>&#34;视频基础信息&#34;</span>, <span style=color:#e6db74>&#34;修改时间&#34;</span>})  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> LocalDateTime updated;  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@ExcelProperty</span>(value <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#34;视频表&#34;</span>, <span style=color:#e6db74>&#34;所属季次信息&#34;</span>, <span style=color:#e6db74>&#34;季次标题&#34;</span>})  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String seasonTitle;  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@ExcelProperty</span>(value <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#34;视频表&#34;</span>, <span style=color:#e6db74>&#34;所属季次信息&#34;</span>,<span style=color:#e6db74>&#34;季次描述&#34;</span>})  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String seasonInfo;  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@ExcelProperty</span>(value <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#34;视频表&#34;</span>, <span style=color:#e6db74>&#34;所属课程信息&#34;</span>,<span style=color:#e6db74>&#34;课程标题&#34;</span>})  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String courseTitle;  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@ExcelProperty</span>(value <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#34;视频表&#34;</span>, <span style=color:#e6db74>&#34;所属课程信息&#34;</span>, <span style=color:#e6db74>&#34;课程描述&#34;</span>})  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String courseInfo;  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=4><li>开发业务接口 <code>EpisodeService -> getExcelData()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/**  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * 全查集次，同时联查该集所属的季次信息和课程信息  
</span></span></span><span style=display:flex><span><span style=color:#75715e> *  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @return 全部集次记录，Excel类型的数据  
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>  
</span></span><span style=display:flex><span>List<span style=color:#f92672>&lt;</span>EpisodeExcelDTO<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>getExcelData</span>();
</span></span></code></pre></div><ol start=5><li>重写业务方法 <code>EpisodeServiceImpl -> getExcelData()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Cacheable</span>(key <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;#root.methodName&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> List<span style=color:#f92672>&lt;</span>EpisodeExcelDTO<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>getExcelData</span>(){  
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 加1层递归深度: episode -&gt; season -&gt; course -&gt; member &amp; category  </span>
</span></span><span style=display:flex><span>    RelationManager.<span style=color:#a6e22e>setMaxDepth</span>(4);  
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 查询全部集次记录  </span>
</span></span><span style=display:flex><span>    List<span style=color:#f92672>&lt;</span>Episode<span style=color:#f92672>&gt;</span> episodes <span style=color:#f92672>=</span> episodeMapper.<span style=color:#a6e22e>selectAllWithRelations</span>();  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// List&lt;Episode&gt; -&gt; List&lt;EpisodeExcelDTO&gt;  </span>
</span></span><span style=display:flex><span>    List<span style=color:#f92672>&lt;</span>EpisodeExcelDTO<span style=color:#f92672>&gt;</span> result <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ArrayList<span style=color:#f92672>&lt;&gt;</span>();  
</span></span><span style=display:flex><span>    episodes.<span style=color:#a6e22e>forEach</span>(episode <span style=color:#f92672>-&gt;</span> {  
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 赋值Episode相关信息  </span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span>(ObjectUtil.<span style=color:#a6e22e>isNull</span>(episode)){  
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> ServiceException(<span style=color:#e6db74>&#34;集次记录不存在&#34;</span>);  
</span></span><span style=display:flex><span>        }  
</span></span><span style=display:flex><span>        EpisodeExcelDTO episodeExcelDTO <span style=color:#f92672>=</span> BeanUtil.<span style=color:#a6e22e>copyProperties</span>(episode, EpisodeExcelDTO.<span style=color:#a6e22e>class</span>);  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 赋值Season相关信息  </span>
</span></span><span style=display:flex><span>        Season season <span style=color:#f92672>=</span> episode.<span style=color:#a6e22e>getSeason</span>();  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span>(ObjectUtil.<span style=color:#a6e22e>isNull</span>(season)){  
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> ServiceException(<span style=color:#e6db74>&#34;季次记录不存在&#34;</span>);  
</span></span><span style=display:flex><span>        }  
</span></span><span style=display:flex><span>        episodeExcelDTO.<span style=color:#a6e22e>setSeasonTitle</span>(season.<span style=color:#a6e22e>getTitle</span>());  
</span></span><span style=display:flex><span>        episodeExcelDTO.<span style=color:#a6e22e>setSeasonInfo</span>(season.<span style=color:#a6e22e>getInfo</span>());  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 赋值Course相关信息  </span>
</span></span><span style=display:flex><span>        Course course <span style=color:#f92672>=</span> season.<span style=color:#a6e22e>getCourse</span>();  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span>(ObjectUtil.<span style=color:#a6e22e>isNull</span>(course)){  
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> ServiceException(<span style=color:#e6db74>&#34;课程记录不存在&#34;</span>);  
</span></span><span style=display:flex><span>        }  
</span></span><span style=display:flex><span>        episodeExcelDTO.<span style=color:#a6e22e>setCourseTitle</span>(course.<span style=color:#a6e22e>getTitle</span>());  
</span></span><span style=display:flex><span>        episodeExcelDTO.<span style=color:#a6e22e>setCourseInfo</span>(course.<span style=color:#a6e22e>getInfo</span>());  
</span></span><span style=display:flex><span>        episodeExcelDTO.<span style=color:#a6e22e>setPrice</span>(course.<span style=color:#a6e22e>getPrice</span>());  
</span></span><span style=display:flex><span>        episodeExcelDTO.<span style=color:#a6e22e>setStar</span>(course.<span style=color:#a6e22e>getStar</span>());  
</span></span><span style=display:flex><span>        episodeExcelDTO.<span style=color:#a6e22e>setLikeCount</span>(course.<span style=color:#a6e22e>getLikeCount</span>());  
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 赋值Member相关信息  </span>
</span></span><span style=display:flex><span>        Member member <span style=color:#f92672>=</span> course.<span style=color:#a6e22e>getMember</span>();  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span>(ObjectUtil.<span style=color:#a6e22e>isNull</span>(member)){  
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> ServiceException(<span style=color:#e6db74>&#34;会员记录不存在&#34;</span>);  
</span></span><span style=display:flex><span>        }  
</span></span><span style=display:flex><span>        episodeExcelDTO.<span style=color:#a6e22e>setAuthor</span>(member.<span style=color:#a6e22e>getNickname</span>());  
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 赋值Category相关信息  </span>
</span></span><span style=display:flex><span>        Category category <span style=color:#f92672>=</span> course.<span style=color:#a6e22e>getCategory</span>();  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span>(ObjectUtil.<span style=color:#a6e22e>isNull</span>(category)){  
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> ServiceException(<span style=color:#e6db74>&#34;类目记录不存在&#34;</span>);  
</span></span><span style=display:flex><span>        }  
</span></span><span style=display:flex><span>        episodeExcelDTO.<span style=color:#a6e22e>setCategoryTitle</span>(category.<span style=color:#a6e22e>getTitle</span>());  
</span></span><span style=display:flex><span>        result.<span style=color:#a6e22e>add</span>(episodeExcelDTO);  
</span></span><span style=display:flex><span>    });  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> result;  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=6><li>重写控制方法 <code>EpisodeController -> excel()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Operation</span>(summary <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;报表打印数据&#34;</span>, description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;打印全部集次，包括该集次所属的季次信息和课程信息&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@GetMapping</span>(<span style=color:#e6db74>&#34;excel&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>excel</span>(HttpServletResponse response) {  
</span></span><span style=display:flex><span>    EasyExcelUtil.<span style=color:#a6e22e>download</span>(response,  
</span></span><span style=display:flex><span>            EpisodeConst.<span style=color:#a6e22e>EXCEL_FILE_NAME</span>,  
</span></span><span style=display:flex><span>            EpisodeConst.<span style=color:#a6e22e>EXCEL_SHEET_NAME</span>,  
</span></span><span style=display:flex><span>            EpisodeExcelDTO.<span style=color:#a6e22e>class</span>,  
</span></span><span style=display:flex><span>            episodeService.<span style=color:#a6e22e>getExcelData</span>());  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=e08-上传视频封面>E08. 上传视频封面</h2><blockquote><p>心法: 业务流程</p></blockquote><pre tabindex=0><code class=language-mermaid data-lang=mermaid>graph LR

ex1[抛出异常&lt;br/&gt;触发回滚]
ex2[抛出异常&lt;br/&gt;触发回滚]
ex3[抛出异常&lt;br/&gt;触发回滚]

1[P1] 
--&gt; n1[根据主键&lt;br/&gt;查询集次] 
--&gt; f1{是否&lt;br/&gt;存在}
	f1 --否--&gt; ex1
	f1 --是--&gt; P2

2[P2] 
--&gt; n2[获取&lt;br/&gt;旧封面图] 
--&gt; n3[随机&lt;br/&gt;新文件名] 
--&gt; n4[更新&lt;br/&gt;集次记录] 
--&gt; f2{是否&lt;br/&gt;成功}
	f2 --否--&gt; ex2
	f2 --是--&gt; P3

3[P3] 
--&gt; f3{是否使用&lt;br/&gt;默认封面图片}
	f3 --否--&gt; n5[删除&lt;br/&gt;旧图] --&gt; n6[上传&lt;br/&gt;新图] --&gt; f4{是否&lt;br/&gt;成功}
		f4 --否--&gt; ex3
		f4 --是--&gt; n7[返回&lt;br/&gt;新文件名]
	f3 --是--&gt; n6
</code></pre><blockquote><p>武技: 开发上传视频封面图片接口</p></blockquote><ol><li>开发业务方法 <code>EpisodeService -> uploadCover()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/**  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * 上传视频封面图片  
</span></span></span><span style=display:flex><span><span style=color:#75715e> *  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param videoCoverFile 视频封面图片文件  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param id             集次主键  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @return 文件名  
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>  
</span></span><span style=display:flex><span>String <span style=color:#a6e22e>uploadCover</span>(MultipartFile videoCoverFile, Long id);
</span></span></code></pre></div><ol start=2><li>实现业务方法 <code>EpisodeServiceImpl -> uploadCover()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Transactional</span>(rollbackFor <span style=color:#f92672>=</span> Exception.<span style=color:#a6e22e>class</span>) 
</span></span><span style=display:flex><span><span style=color:#a6e22e>@CacheEvict</span>(allEntries <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Override</span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>uploadCover</span>(MultipartFile videoCoverFile, Long id) {  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 判断集次是否存在  </span>
</span></span><span style=display:flex><span>    Episode episode <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>getById</span>(id);  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 获取旧的视频封面图片名称（提前备份）  </span>
</span></span><span style=display:flex><span>    String oldFilename <span style=color:#f92672>=</span> episode.<span style=color:#a6e22e>getCover</span>();  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 随机新文件名  </span>
</span></span><span style=display:flex><span>    String newFilename <span style=color:#f92672>=</span> MinioUtil.<span style=color:#a6e22e>randomFilename</span>(videoCoverFile);  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 更新数据库记录  </span>
</span></span><span style=display:flex><span>    episode.<span style=color:#a6e22e>setCover</span>(newFilename);  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>updateById</span>(episode)) {  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> ServiceException(<span style=color:#e6db74>&#34;视频封面图片地址更新失败&#34;</span>);  
</span></span><span style=display:flex><span>    }  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 从MINIO中删除非默认的视频封面图片  </span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>StrUtil.<span style=color:#a6e22e>equals</span>(EpisodeConst.<span style=color:#a6e22e>DEFAULT_VIDEO_COVER</span>, oldFilename)) {  
</span></span><span style=display:flex><span>        MinioUtil.<span style=color:#a6e22e>delete</span>(oldFilename, EpisodeConst.<span style=color:#a6e22e>VIDEO_COVER_DIR</span>, MinioConst.<span style=color:#a6e22e>BUCKET_NAME</span>);  
</span></span><span style=display:flex><span>    }  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 向MINIO中上传新的视频封面图片  </span>
</span></span><span style=display:flex><span>    MinioUtil.<span style=color:#a6e22e>upload</span>(videoCoverFile, newFilename, EpisodeConst.<span style=color:#a6e22e>VIDEO_COVER_DIR</span>, MinioConst.<span style=color:#a6e22e>BUCKET_NAME</span>);  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 返回文件名  </span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> newFilename;  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=3><li>开发控制方法 <code>EpisodeController -> uploadCover()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Operation</span>(summary <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;上传封面图片&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@PostMapping</span>(<span style=color:#e6db74>&#34;uploadCover/{id}&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Result <span style=color:#a6e22e>uploadCover</span>(<span style=color:#a6e22e>@RequestParam</span> MultipartFile videoCoverFile, <span style=color:#a6e22e>@PathVariable</span> Long id) {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> Result(episodeService.<span style=color:#a6e22e>uploadCover</span>(videoCoverFile, id));  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=e09-上传视频文件>E09. 上传视频文件</h2><blockquote><p>心法: 上传视频业务流程</p></blockquote><pre tabindex=0><code class=language-mermaid data-lang=mermaid>graph LR

ex1[抛出异常&lt;br/&gt;触发回滚]
ex2[抛出异常&lt;br/&gt;触发回滚]
ex3[抛出异常&lt;br/&gt;触发回滚]

1[P1] 
--&gt; n1[根据主键&lt;br/&gt;查询集次] 
--&gt; f1{是否&lt;br/&gt;存在}
	f1 --否--&gt; ex1
	f1 --是--&gt; P2

2[P2] 
--&gt; n2[获取&lt;br/&gt;旧视频文件] 
--&gt; n3[随机&lt;br/&gt;新文件名] 
--&gt; n4[更新&lt;br/&gt;集次记录] 
--&gt; f2{是否&lt;br/&gt;成功}
	f2 --否--&gt; ex2
	f2 --是--&gt; P3

3[P3] 
--&gt; f3{是否使用&lt;br/&gt;默认视频文件}
	f3 --否--&gt; n5[删除&lt;br/&gt;旧视频文件] --&gt; n6[上传&lt;br/&gt;新视频文件] --&gt; f4{是否&lt;br/&gt;成功}
		f4 --否--&gt; ex3
		f4 --是--&gt; n7[返回&lt;br/&gt;新文件名]
	f3 --是--&gt; n6
</code></pre><blockquote><p>武技: 开发上传视频接口</p></blockquote><ol><li>开发业务方法 <code>EpisodeService -> uploadVideo()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/**  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * 上传视频  
</span></span></span><span style=display:flex><span><span style=color:#75715e> *  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param videoFile 视频文件  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param id        集次主键  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @return 文件名  
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>  
</span></span><span style=display:flex><span>String <span style=color:#a6e22e>uploadVideo</span>(MultipartFile videoFile, Long id);
</span></span></code></pre></div><ol start=2><li>实现业务方法 <code>EpisodeServiceImpl -> uploadVideo()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Transactional</span>(rollbackFor <span style=color:#f92672>=</span> Exception.<span style=color:#a6e22e>class</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@CacheEvict</span>(allEntries <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Override</span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>uploadVideo</span>(MultipartFile videoFile, Long id) {  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 判断集次是否存在  </span>
</span></span><span style=display:flex><span>    Episode episode <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>getById</span>(id);  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 获取旧的视频文件名称（提前备份）  </span>
</span></span><span style=display:flex><span>    String oldFilename <span style=color:#f92672>=</span> episode.<span style=color:#a6e22e>getVideo</span>();  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 随机新文件名  </span>
</span></span><span style=display:flex><span>    String newFilename <span style=color:#f92672>=</span> MinioUtil.<span style=color:#a6e22e>randomFilename</span>(videoFile);  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 更新数据库记录  </span>
</span></span><span style=display:flex><span>    episode.<span style=color:#a6e22e>setVideo</span>(newFilename);  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>updateById</span>(episode)) {  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> ServiceException(<span style=color:#e6db74>&#34;视频文件地址更新失败&#34;</span>);  
</span></span><span style=display:flex><span>    }  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 从MINIO中删除非默认的视频文件  </span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>StrUtil.<span style=color:#a6e22e>equals</span>(EpisodeConst.<span style=color:#a6e22e>DEFAULT_VIDEO</span>, oldFilename)) {  
</span></span><span style=display:flex><span>        MinioUtil.<span style=color:#a6e22e>delete</span>(oldFilename, EpisodeConst.<span style=color:#a6e22e>VIDEO_DIR</span>, MinioConst.<span style=color:#a6e22e>BUCKET_NAME</span>);  
</span></span><span style=display:flex><span>    }  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 向MINIO中上传新的视频文件  </span>
</span></span><span style=display:flex><span>    MinioUtil.<span style=color:#a6e22e>upload</span>(videoFile, newFilename, EpisodeConst.<span style=color:#a6e22e>VIDEO_DIR</span>, MinioConst.<span style=color:#a6e22e>BUCKET_NAME</span>);  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 返回文件名  </span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> newFilename;  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=3><li>开发控制方法 <code>EpisodeController -> uploadVideo()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Operation</span>(summary <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;上传视频文件&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@PostMapping</span>(<span style=color:#e6db74>&#34;uploadVideo/{id}&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Result <span style=color:#a6e22e>uploadVideo</span>(<span style=color:#a6e22e>@RequestParam</span> MultipartFile videoFile, <span style=color:#a6e22e>@PathVariable</span> Long id) {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> Result(episodeService.<span style=color:#a6e22e>uploadVideo</span>(videoFile, id));  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h1 id=s12-开发会员接口>S12. 开发会员接口</h1><blockquote><p>心法: Member接口文档</p></blockquote><ul><li>前缀 <code>/api/v1/member</code>:</li></ul><table><thead><tr><th></th><th>接口</th><th>类型</th><th>描述</th><th>请求参数</th><th>必要参数</th></tr></thead><tbody><tr><td>1</td><td><code>getInfo/{id}</code></td><td>GET</td><td>根据主键查询</td><td><code>@PathVariable Long id</code></td><td><code>id</code></td></tr><tr><td>2</td><td><code>getByUsername/{username}</code></td><td>GET</td><td>根据账号查询</td><td><code>@PathVariable String username</code></td><td><code>username</code></td></tr><tr><td>3</td><td><code>getByNickname/{nickname}</code></td><td>GET</td><td>根据昵称查询</td><td><code>@PathVariable String nickname</code></td><td><code>nickname</code></td></tr><tr><td>4</td><td><code>getByPhone/{phone}</code></td><td>GET</td><td>根据手机查询</td><td><code>@PathVariable String phone</code></td><td><code>phone</code></td></tr><tr><td>5</td><td><code>pageState/{state}</code></td><td>GET</td><td>根据状态分页</td><td><code>@PathVariable String state</code></td><td><code>state</code></td></tr><tr><td>6</td><td><code>freeze/{id}</code></td><td>POST</td><td>冻结会员账号</td><td><code>@PathVariable Long id</code></td><td><code>id</code></td></tr><tr><td>7</td><td><code>unfreeze/{id}</code></td><td>POST</td><td>解冻会员账号</td><td><code>@PathVariable Long id</code></td><td><code>id</code></td></tr><tr><td>8</td><td><code>excel</code></td><td>GET</td><td>报表打印数据</td><td></td><td></td></tr><tr><td>9</td><td><code>countGender</code></td><td>GET</td><td>统计会员性别</td><td></td><td></td></tr><tr><td>10</td><td><code>countToday</code></td><td>GET</td><td>统计日增会员</td><td></td><td></td></tr><tr><td>11</td><td><code>countTotal</code></td><td>GET</td><td>统计会员总数</td><td></td><td></td></tr><tr><td>12</td><td><code>getRoles/{id}</code></td><td>GET</td><td>查询角色列表</td><td><code>@PathVariable Long id</code></td><td><code>id</code></td></tr><tr><td>13</td><td><code>updateRoles/{id}</code></td><td>POST</td><td>修改角色列表</td><td><code>@PathVariable Long id</code><code>@RequestParam List&lt;Long> roleIds</code></td><td><code>id</code><code>roleIds</code></td></tr><tr><td>14</td><td><code>resetPassword</code></td><td>POST</td><td>重置会员密码</td><td></td><td></td></tr><tr><td>15</td><td><code>loginByAccount</code></td><td>POST</td><td>账号密码登录</td><td><code>@RequestParam String username</code><code>@RequestParam String password</code></td><td><code>username</code><code>password</code></td></tr></tbody></table><h2 id=e01-根据主键查询-3>E01. 根据主键查询</h2><blockquote><p>心法: 业务流程</p></blockquote><pre tabindex=0><code class=language-mermaid data-lang=mermaid>graph LR

n1[根据主键&lt;br/&gt;查询会员] --&gt; f{是否&lt;br/&gt;存在}
	f --是--&gt; n2[加入缓存] --&gt; n2a[返回结果]
	f --否--&gt; n3[返回空值]
</code></pre><blockquote><p>武技: 根据主键查询一条会员记录</p></blockquote><ol><li>重写业务方法 <code>MemberServiceImpl -> getById()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Cacheable</span>(key <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;#id&#34;</span>, unless <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;#result == null&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Member <span style=color:#a6e22e>getById</span>(Serializable id) {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>super</span>.<span style=color:#a6e22e>getById</span>(id);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=2><li>重写控制方法 <code>MemberController -> getInfo()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Operation</span>(summary <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;根据主键查询&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@GetMapping</span>(<span style=color:#e6db74>&#34;getInfo/{id}&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Member <span style=color:#a6e22e>getInfo</span>(<span style=color:#a6e22e>@PathVariable</span> Long id) {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> memberService.<span style=color:#a6e22e>getById</span>(id);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=e02-根据账号查询>E02. 根据账号查询</h2><blockquote><p>心法: 业务流程</p></blockquote><pre tabindex=0><code class=language-mermaid data-lang=mermaid>graph LR

n1[根据账号&lt;br/&gt;查询会员] --&gt; f{是否&lt;br/&gt;存在}
	f --是--&gt; n2[加入缓存] --&gt; n2a[返回结果]
	f --否--&gt; n3[返回空值]
</code></pre><blockquote><p>武技: 根据会员账号查询一条会员记录</p></blockquote><ol><li>开发业务方法 <code>MemberService -> getByUsername()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/**  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * 根据会员账号查询一条会员记录  
</span></span></span><span style=display:flex><span><span style=color:#75715e> *  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param username 会员账号  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @return 会员记录  
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>  
</span></span><span style=display:flex><span>Member <span style=color:#a6e22e>getByUsername</span>(String username);
</span></span></code></pre></div><ol start=2><li>重写业务方法 <code>MemberServiceImpl -> getByUsername()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Cacheable</span>(key <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#39;username_&#39; + #username&#34;</span>, unless <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;#result == null&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Override</span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Member <span style=color:#a6e22e>getByUsername</span>(String username) {  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// select * from ums_member where username = ?  </span>
</span></span><span style=display:flex><span>    QueryWrapper queryWrapper <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> QueryWrapper();  
</span></span><span style=display:flex><span>    queryWrapper.<span style=color:#a6e22e>where</span>(MEMBER.<span style=color:#a6e22e>USERNAME</span>.<span style=color:#a6e22e>eq</span>(username));  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> memberMapper.<span style=color:#a6e22e>selectOneByQuery</span>(queryWrapper);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=3><li>重写控制方法 <code>MemberController -> getByUsername()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Operation</span>(summary <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;根据账号查询&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@GetMapping</span>(<span style=color:#e6db74>&#34;getByUsername/{username}&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Member <span style=color:#a6e22e>getByUsername</span>(<span style=color:#a6e22e>@PathVariable</span> String username) {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> memberService.<span style=color:#a6e22e>getByUsername</span>(username);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=e03-根据昵称查询>E03. 根据昵称查询</h2><blockquote><p>心法: 业务流程</p></blockquote><pre tabindex=0><code class=language-mermaid data-lang=mermaid>graph LR

n1[根据昵称&lt;br/&gt;查询会员] --&gt; f{是否&lt;br/&gt;存在}
	f --是--&gt; n2[加入缓存] --&gt; n2a[返回结果]
	f --否--&gt; n3[返回空值]
</code></pre><blockquote><p>武技: 根据会员昵称查询一条会员记录</p></blockquote><ol><li>开发业务方法 <code>MemberService -> getByNickname()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/**  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * 根据会员昵称查询一条会员记录  
</span></span></span><span style=display:flex><span><span style=color:#75715e> *  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param nickname 会员昵称  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @return 会员记录  
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>  
</span></span><span style=display:flex><span>Member <span style=color:#a6e22e>getByNickname</span>(String nickname);
</span></span></code></pre></div><ol start=2><li>重写业务方法 <code>MemberServiceImpl -> getByNickname()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Cacheable</span>(key <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#39;nickname_&#39; + #nickname&#34;</span>, unless <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;#result == null&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Override</span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Member <span style=color:#a6e22e>getByNickname</span>(String nickname) {  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// select * from ums_member where nickname = ?  </span>
</span></span><span style=display:flex><span>    QueryWrapper queryWrapper <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> QueryWrapper();  
</span></span><span style=display:flex><span>    queryWrapper.<span style=color:#a6e22e>where</span>(MEMBER.<span style=color:#a6e22e>NICKNAME</span>.<span style=color:#a6e22e>eq</span>(nickname));  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> memberMapper.<span style=color:#a6e22e>selectOneByQuery</span>(queryWrapper);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=3><li>重写控制方法 <code>MemberController -> getByNickname()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Operation</span>(summary <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;根据昵称查询&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@GetMapping</span>(<span style=color:#e6db74>&#34;getByNickname/{nickname}&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Member <span style=color:#a6e22e>getByNickname</span>(<span style=color:#a6e22e>@PathVariable</span> String nickname) {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> memberService.<span style=color:#a6e22e>getByNickname</span>(nickname);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=e04-根据手机查询>E04. 根据手机查询</h2><blockquote><p>心法: 业务流程</p></blockquote><pre tabindex=0><code class=language-mermaid data-lang=mermaid>graph LR

n1[根据手机&lt;br/&gt;查询会员] --&gt; f{是否&lt;br/&gt;存在}
	f --是--&gt; n2[加入缓存] --&gt; n2a[返回结果]
	f --否--&gt; n3[返回空值]
</code></pre><blockquote><p>武技: 根据会员手机查询一条会员记录</p></blockquote><ol><li>开发业务方法 <code>MemberService -> getByPhone()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/**  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * 根据会员手机查询一条会员记录  
</span></span></span><span style=display:flex><span><span style=color:#75715e> *  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param phone 手机号码  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @return 会员记录  
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>  
</span></span><span style=display:flex><span>Member <span style=color:#a6e22e>getByPhone</span>(String phone);
</span></span></code></pre></div><ol start=2><li>重写业务方法 <code>MemberServiceImpl -> getByPhone()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Cacheable</span>(key <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#39;phone_&#39; + #phone&#34;</span>, unless <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;#result == null&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Override</span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Member <span style=color:#a6e22e>getByPhone</span>(String phone) {  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// select * from ums_member where phone = ?  </span>
</span></span><span style=display:flex><span>    QueryWrapper queryWrapper <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> QueryWrapper();  
</span></span><span style=display:flex><span>    queryWrapper.<span style=color:#a6e22e>where</span>(MEMBER.<span style=color:#a6e22e>PHONE</span>.<span style=color:#a6e22e>eq</span>(phone));  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> memberMapper.<span style=color:#a6e22e>selectOneByQuery</span>(queryWrapper);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=3><li>重写控制方法 <code>MemberController -> getByPhone()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Operation</span>(summary <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;根据手机查询&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@GetMapping</span>(<span style=color:#e6db74>&#34;getByPhone/{phone}&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Member <span style=color:#a6e22e>getByPhone</span>(<span style=color:#a6e22e>@PathVariable</span> String phone) {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> memberService.<span style=color:#a6e22e>getByPhone</span>(phone);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=e05-根据状态分页>E05. 根据状态分页</h2><blockquote><p>心法: 业务流程</p></blockquote><pre tabindex=0><code class=language-mermaid data-lang=mermaid>graph LR

n1[检查分类指标] --&gt; f{是否&lt;br/&gt;合法}
	f--否--&gt; ex[抛出异常]
	f--是--&gt; n2[分页查询&lt;br/&gt;会员记录] 
		--&gt; n3[根据创建时间降序&lt;br/&gt;根据主键降序] 
		--&gt; n4[加入&lt;br/&gt;缓存]
		--&gt; n5[返回&lt;br/&gt;分页结果]
</code></pre><blockquote><p>武技: 根据 state 状态分类，分页查询会员记录</p></blockquote><ol><li>开发业务方法 <code>MemberService -> page()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/**  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * 根据 state 属性分类，分页查询会员记录  
</span></span></span><span style=display:flex><span><span style=color:#75715e> *  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param page  分页信息  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param state 状态，0正常，1冻结  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @return 分页信息  
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>  
</span></span><span style=display:flex><span>Page<span style=color:#f92672>&lt;</span>Member<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>page</span>(Page<span style=color:#f92672>&lt;</span>Member<span style=color:#f92672>&gt;</span> page, Integer state);
</span></span></code></pre></div><ol start=2><li>重写业务方法 <code>MemberServiceImpl -> page()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Cacheable</span>(key <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;#root.methodName + &#39;:&#39; + #state + &#39;:&#39; + #page.getPageSize() + &#39;:&#39; + #page.getPageNumber()&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Page<span style=color:#f92672>&lt;</span>Member<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>page</span>(Page<span style=color:#f92672>&lt;</span>Member<span style=color:#f92672>&gt;</span> page, Integer state) {  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 检查 state 参数是否不合法  </span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>state.<span style=color:#a6e22e>equals</span>(MemberConst.<span style=color:#a6e22e>NORMAL</span>) <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span>state.<span style=color:#a6e22e>equals</span>(MemberConst.<span style=color:#a6e22e>FROZEN</span>)) {  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> ServiceException(<span style=color:#e6db74>&#34;state参数不合法&#34;</span>);  
</span></span><span style=display:flex><span>    }  
</span></span><span style=display:flex><span>    QueryWrapper queryWrapper <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> QueryWrapper();  
</span></span><span style=display:flex><span>    queryWrapper.<span style=color:#a6e22e>where</span>(MEMBER.<span style=color:#a6e22e>STATE</span>.<span style=color:#a6e22e>eq</span>(state));  
</span></span><span style=display:flex><span>    queryWrapper.<span style=color:#a6e22e>orderBy</span>(MEMBER.<span style=color:#a6e22e>CREATED</span>.<span style=color:#a6e22e>desc</span>(), MEMBER.<span style=color:#a6e22e>ID</span>.<span style=color:#a6e22e>desc</span>());
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>super</span>.<span style=color:#a6e22e>page</span>(page, queryWrapper);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=3><li>重写控制方法 <code>MemberController -> page()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Operation</span>(summary <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;根据状态分页&#34;</span>,  
</span></span><span style=display:flex><span>        description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;当state为0时，分页查询正常会员，当state为1时，分页查询已冻结的会员&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@GetMapping</span>(<span style=color:#e6db74>&#34;page/{state}&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Page<span style=color:#f92672>&lt;</span>Member<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>page</span>(Page<span style=color:#f92672>&lt;</span>Member<span style=color:#f92672>&gt;</span> page, <span style=color:#a6e22e>@PathVariable</span> Integer state) {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> memberService.<span style=color:#a6e22e>page</span>(page, state);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=e06-冻结会员账号>E06. 冻结会员账号</h2><blockquote><p>心法: 业务流程</p></blockquote><pre tabindex=0><code class=language-mermaid data-lang=mermaid>graph LR

n1[根据会员主键&lt;br/&gt;修改账号状态值为1] 
--&gt; n2[逐出&lt;br/&gt;缓存]
--&gt; n3[返回&lt;br/&gt;布尔结果]
</code></pre><blockquote><p>武技: 冻结一个会员账号</p></blockquote><ol><li>开发业务方法 <code>MemberService -> freeze()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/**  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * 冻结账号  
</span></span></span><span style=display:flex><span><span style=color:#75715e> *  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param id 会员主键  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @return true表示冻结成功  
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>freeze</span>(Long id);
</span></span></code></pre></div><ol start=2><li>重写业务方法 <code>MemberServiceImpl -> freeze()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@CacheEvict</span>(allEntries <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>freeze</span>(Long id) {  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// update ums_member set state = 1 where id = ?  </span>
</span></span><span style=display:flex><span>    Member member <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Member();  
</span></span><span style=display:flex><span>    member.<span style=color:#a6e22e>setState</span>(MemberConst.<span style=color:#a6e22e>FROZEN</span>);  
</span></span><span style=display:flex><span>    QueryWrapper queryWrapper <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> QueryWrapper();  
</span></span><span style=display:flex><span>    queryWrapper.<span style=color:#a6e22e>where</span>(MEMBER.<span style=color:#a6e22e>ID</span>.<span style=color:#a6e22e>eq</span>(id));  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> memberMapper.<span style=color:#a6e22e>updateByQuery</span>(member, queryWrapper) <span style=color:#f92672>&gt;</span> 0;  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=3><li>重写控制方法 <code>MemberController -> freeze()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Operation</span>(summary <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;冻结会员账号&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@PostMapping</span>(<span style=color:#e6db74>&#34;freeze/{id}&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>freeze</span>(<span style=color:#a6e22e>@PathVariable</span> Long id) {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> memberService.<span style=color:#a6e22e>freeze</span>(id);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=e07-解冻会员账号>E07. 解冻会员账号</h2><blockquote><p>心法: 业务流程</p></blockquote><pre tabindex=0><code class=language-mermaid data-lang=mermaid>graph LR

n1[根据会员主键&lt;br/&gt;修改账号状态值为0] 
--&gt; n2[逐出&lt;br/&gt;缓存]
--&gt; n3[返回&lt;br/&gt;布尔结果]
</code></pre><blockquote><p>武技: 解冻一个会员账号</p></blockquote><ol><li>开发业务方法 <code>MemberService -> unfreeze()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/**  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * 解冻账号  
</span></span></span><span style=display:flex><span><span style=color:#75715e> *  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param id 会员主键  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @return true表示解冻成功  
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>unfreeze</span>(Long id);
</span></span></code></pre></div><ol start=2><li>重写业务方法 <code>MemberServiceImpl -> unfreeze()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@CacheEvict</span>(allEntries <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>unfreeze</span>(Long id) {  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// update ums_member set state = 0 where id = ?  </span>
</span></span><span style=display:flex><span>    Member member <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Member();  
</span></span><span style=display:flex><span>    member.<span style=color:#a6e22e>setState</span>(MemberConst.<span style=color:#a6e22e>NORMAL</span>);  
</span></span><span style=display:flex><span>    QueryWrapper queryWrapper <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> QueryWrapper();  
</span></span><span style=display:flex><span>    queryWrapper.<span style=color:#a6e22e>where</span>(MEMBER.<span style=color:#a6e22e>ID</span>.<span style=color:#a6e22e>eq</span>(id));  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> memberMapper.<span style=color:#a6e22e>updateByQuery</span>(member, queryWrapper) <span style=color:#f92672>&gt;</span> 0;  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=3><li>重写控制方法 <code>MemberController -> unfreeze()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Operation</span>(summary <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;解冻会员账号&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@PostMapping</span>(<span style=color:#e6db74>&#34;unfreeze/{id}&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>unfreeze</span>(<span style=color:#a6e22e>@PathVariable</span> Long id) {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> memberService.<span style=color:#a6e22e>unfreeze</span>(id);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=e08-报表打印数据>E08. 报表打印数据</h2><blockquote><p>心法: 业务流程</p></blockquote><pre tabindex=0><code class=language-mermaid data-lang=mermaid>graph LR

n1[全查&lt;br/&gt;会员列表]
--&gt; n2[将会员列表&lt;br/&gt;转为EasyExcel所需格式]
	n2 -.- n2a[会员性别中文处理&lt;br/&gt;账号状态中文处理] -.- n2b[真实姓名数据脱敏&lt;br/&gt;身份证号数据脱敏&lt;br/&gt;手机号码数据脱敏]
n2 --&gt; n5[加入&lt;br/&gt;缓存] --&gt; n6[返回&lt;br/&gt;会员列表]
</code></pre><blockquote><p>武技: 打印全部会员记录</p></blockquote><ol><li>开发DTO实体类 <code>MemberExcelDTO</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> com.lsx.dto;  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@ColumnWidth</span>(20)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Data</span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MemberExcelDTO</span> <span style=color:#66d9ef>implements</span> Serializable {  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@ExcelProperty</span>(value <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#34;会员表&#34;</span>, <span style=color:#e6db74>&#34;账号信息&#34;</span>, <span style=color:#e6db74>&#34;账号&#34;</span>})  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String username;  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@ExcelProperty</span>(value <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#34;会员表&#34;</span>, <span style=color:#e6db74>&#34;账号信息&#34;</span>, <span style=color:#e6db74>&#34;账号状态&#34;</span>})  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String state;  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@ExcelProperty</span>(value <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#34;会员表&#34;</span>, <span style=color:#e6db74>&#34;账号信息&#34;</span>, <span style=color:#e6db74>&#34;创建时间&#34;</span>})  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> LocalDateTime created;  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@ExcelProperty</span>(value <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#34;会员表&#34;</span>, <span style=color:#e6db74>&#34;账号信息&#34;</span>, <span style=color:#e6db74>&#34;修改时间&#34;</span>})  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> LocalDateTime updated;  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@ExcelProperty</span>(value <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#34;会员表&#34;</span>, <span style=color:#e6db74>&#34;基础信息&#34;</span>, <span style=color:#e6db74>&#34;昵称&#34;</span>})  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String nickname;  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@ExcelProperty</span>(value <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#34;会员表&#34;</span>, <span style=color:#e6db74>&#34;基础信息&#34;</span>, <span style=color:#e6db74>&#34;手机号码&#34;</span>})  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String phone;  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@ExcelProperty</span>(value <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#34;会员表&#34;</span>, <span style=color:#e6db74>&#34;基础信息&#34;</span>, <span style=color:#e6db74>&#34;邮箱地址&#34;</span>})  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String email;  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@ExcelProperty</span>(value <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#34;会员表&#34;</span>, <span style=color:#e6db74>&#34;基础信息&#34;</span>, <span style=color:#e6db74>&#34;性别&#34;</span>})  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String gender;  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@ExcelProperty</span>(value <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#34;会员表&#34;</span>, <span style=color:#e6db74>&#34;基础信息&#34;</span>, <span style=color:#e6db74>&#34;年龄&#34;</span>})  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Integer age;  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@ExcelProperty</span>(value <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#34;会员表&#34;</span>, <span style=color:#e6db74>&#34;基础信息&#34;</span>, <span style=color:#e6db74>&#34;星座&#34;</span>})  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String zodiac;  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@ExcelProperty</span>(value <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#34;会员表&#34;</span>, <span style=color:#e6db74>&#34;基础信息&#34;</span>, <span style=color:#e6db74>&#34;省份&#34;</span>})  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String province;  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@ExcelProperty</span>(value <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#34;会员表&#34;</span>, <span style=color:#e6db74>&#34;基础信息&#34;</span>, <span style=color:#e6db74>&#34;个人呢描述&#34;</span>})  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String info;  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@ExcelProperty</span>(value <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#34;会员表&#34;</span>, <span style=color:#e6db74>&#34;实名信息&#34;</span>, <span style=color:#e6db74>&#34;真实姓名&#34;</span>})  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String realname;  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@ExcelProperty</span>(value <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#34;会员表&#34;</span>, <span style=color:#e6db74>&#34;实名信息&#34;</span>, <span style=color:#e6db74>&#34;身份证号&#34;</span>})  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String idcard;  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@ExcelProperty</span>(value <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#34;会员表&#34;</span>, <span style=color:#e6db74>&#34;其他信息&#34;</span>, <span style=color:#e6db74>&#34;粉丝数&#34;</span>})  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Long fanCount;  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=2><li>开发业务接口 <code>MemberService -> getExcelData()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/**  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * 全查会员记录  
</span></span></span><span style=display:flex><span><span style=color:#75715e> *  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @return 全查会员记录，Excel类型的数据  
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>  
</span></span><span style=display:flex><span>List<span style=color:#f92672>&lt;</span>MemberExcelDTO<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>getExcelData</span>();
</span></span></code></pre></div><ol start=3><li>重写业务方法 <code>MemberServiceImpl -> getExcelData()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Cacheable</span>(key <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;#root.methodName&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> List<span style=color:#f92672>&lt;</span>MemberExcelDTO<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>getExcelData</span>() {  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 查询全部会员记录  </span>
</span></span><span style=display:flex><span>    List<span style=color:#f92672>&lt;</span>Member<span style=color:#f92672>&gt;</span> members <span style=color:#f92672>=</span> memberMapper.<span style=color:#a6e22e>selectAllWithRelations</span>();  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// List&lt;Member&gt; -&gt; List&lt;MemberExcelDTO&gt;  </span>
</span></span><span style=display:flex><span>    List<span style=color:#f92672>&lt;</span>MemberExcelDTO<span style=color:#f92672>&gt;</span> result <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ArrayList<span style=color:#f92672>&lt;&gt;</span>();  
</span></span><span style=display:flex><span>    members.<span style=color:#a6e22e>forEach</span>(member <span style=color:#f92672>-&gt;</span> {  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 拷贝会员基础信息</span>
</span></span><span style=display:flex><span>        MemberExcelDTO memberExcelDTO <span style=color:#f92672>=</span> BeanUtil.<span style=color:#a6e22e>copyProperties</span>(member, MemberExcelDTO.<span style=color:#a6e22e>class</span>);  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 处理性别: 0女1男2保密  </span>
</span></span><span style=display:flex><span>        Integer gender <span style=color:#f92672>=</span> member.<span style=color:#a6e22e>getGender</span>();  
</span></span><span style=display:flex><span>        memberExcelDTO.<span style=color:#a6e22e>setGender</span>(  
</span></span><span style=display:flex><span>                gender.<span style=color:#a6e22e>equals</span>(MemberConst.<span style=color:#a6e22e>FEMALE</span>) <span style=color:#f92672>?</span> <span style=color:#e6db74>&#34;女&#34;</span> :  
</span></span><span style=display:flex><span>                gender.<span style=color:#a6e22e>equals</span>(MemberConst.<span style=color:#a6e22e>MALE</span>) <span style=color:#f92672>?</span> <span style=color:#e6db74>&#34;男&#34;</span> :  
</span></span><span style=display:flex><span>                gender.<span style=color:#a6e22e>equals</span>(MemberConst.<span style=color:#a6e22e>SECRET</span>) <span style=color:#f92672>?</span> <span style=color:#e6db74>&#34;保密&#34;</span> : <span style=color:#e6db74>&#34;会员性别异常&#34;</span>);  
</span></span><span style=display:flex><span>                
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 处理状态: 0正常1冻结</span>
</span></span><span style=display:flex><span>        Integer state <span style=color:#f92672>=</span> member.<span style=color:#a6e22e>getState</span>();  
</span></span><span style=display:flex><span>        memberExcelDTO.<span style=color:#a6e22e>setState</span>(  
</span></span><span style=display:flex><span>                state.<span style=color:#a6e22e>equals</span>(MemberConst.<span style=color:#a6e22e>NORMAL</span>) <span style=color:#f92672>?</span> <span style=color:#e6db74>&#34;正常&#34;</span> :  
</span></span><span style=display:flex><span>                state.<span style=color:#a6e22e>equals</span>(MemberConst.<span style=color:#a6e22e>FROZEN</span>) <span style=color:#f92672>?</span> <span style=color:#e6db74>&#34;冻结&#34;</span> : <span style=color:#e6db74>&#34;账号状态异常&#34;</span>);  
</span></span><span style=display:flex><span>                
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 数据脱敏  </span>
</span></span><span style=display:flex><span>        memberExcelDTO.<span style=color:#a6e22e>setRealname</span>(DesensitizedUtil.<span style=color:#a6e22e>chineseName</span>(member.<span style=color:#a6e22e>getRealname</span>()));
</span></span><span style=display:flex><span>        memberExcelDTO.<span style=color:#a6e22e>setIdcard</span>(DesensitizedUtil.<span style=color:#a6e22e>idCardNum</span>(member.<span style=color:#a6e22e>getIdcard</span>(), 6, 3));  
</span></span><span style=display:flex><span>        memberExcelDTO.<span style=color:#a6e22e>setPhone</span>(DesensitizedUtil.<span style=color:#a6e22e>mobilePhone</span>(member.<span style=color:#a6e22e>getPhone</span>()));  
</span></span><span style=display:flex><span>        result.<span style=color:#a6e22e>add</span>(memberExcelDTO);  
</span></span><span style=display:flex><span>    });  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> result;  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=4><li>重写控制方法 <code>MemberController -> excel()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Operation</span>(summary <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;报表打印数据&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@GetMapping</span>(<span style=color:#e6db74>&#34;excel&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>excel</span>(HttpServletResponse response) {  
</span></span><span style=display:flex><span>    EasyExcelUtil.<span style=color:#a6e22e>download</span>(response,  
</span></span><span style=display:flex><span>            MemberConst.<span style=color:#a6e22e>EXCEL_FILE_NAME</span>,  
</span></span><span style=display:flex><span>            MemberConst.<span style=color:#a6e22e>EXCEL_SHEET_NAME</span>,  
</span></span><span style=display:flex><span>            MemberExcelDTO.<span style=color:#a6e22e>class</span>,  
</span></span><span style=display:flex><span>            memberService.<span style=color:#a6e22e>getExcelData</span>());  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=e09-统计会员性别>E09. 统计会员性别</h2><blockquote><p>心法: 业务流程</p></blockquote><pre tabindex=0><code class=language-mermaid data-lang=mermaid>graph LR

n1[按性别分组&lt;br/&gt;查询性别及对应会员数量] 
--&gt; n2[加入&lt;br/&gt;缓存]
--&gt; n3[返回&lt;br/&gt;查询结果]
</code></pre><blockquote><p>武技: 开发统计会员性别的接口</p></blockquote><ol><li>开发DTO实体类 <code>MemberGenderCountDTO</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> com.lsx.dto;  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Schema</span>(name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;统计会员性别DTO&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Data</span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MemberGenderCountDTO</span> {  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>/** 会员性别 */</span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Integer name;  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>/** 每种会员性别对应的会员数量 */</span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Integer value;  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=2><li>开发业务方法 <code>MemberService -> countGender()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/**  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * 按会员性别，统计每种性别对应的会员数量  
</span></span></span><span style=display:flex><span><span style=color:#75715e> *  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @return 每种性别对应的会员数量  
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>  
</span></span><span style=display:flex><span>List<span style=color:#f92672>&lt;</span>MemberGenderCountDTO<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>countGender</span>();
</span></span></code></pre></div><ol start=3><li>实现业务方法 <code>MemberServiceImpl -> countGender()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Cacheable</span>(key <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;#root.methodName&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> List<span style=color:#f92672>&lt;</span>MemberGenderCountDTO<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>countGender</span>() {  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// select gender as name, count(*) as value from ums_member group by  gender  </span>
</span></span><span style=display:flex><span>    QueryWrapper queryWrapper <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> QueryWrapper();  
</span></span><span style=display:flex><span>    queryWrapper.<span style=color:#a6e22e>select</span>(MEMBER.<span style=color:#a6e22e>GENDER</span>.<span style=color:#a6e22e>as</span>(<span style=color:#e6db74>&#34;name&#34;</span>), QueryMethods.<span style=color:#a6e22e>count</span>().<span style=color:#a6e22e>as</span>(<span style=color:#e6db74>&#34;value&#34;</span>))  
</span></span><span style=display:flex><span>            .<span style=color:#a6e22e>groupBy</span>(MEMBER.<span style=color:#a6e22e>GENDER</span>)  
</span></span><span style=display:flex><span>            .<span style=color:#a6e22e>orderBy</span>(MEMBER.<span style=color:#a6e22e>GENDER</span>.<span style=color:#a6e22e>asc</span>());  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> memberMapper.<span style=color:#a6e22e>selectListByQueryAs</span>(queryWrapper, MemberGenderCountDTO.<span style=color:#a6e22e>class</span>);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=4><li>开发控制方法 <code>MemberController -> countGender()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Operation</span>(summary <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;统计会员性别&#34;</span>, description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;按会员性别，查询每种性别对应的会员数量&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@GetMapping</span>(<span style=color:#e6db74>&#34;countGender&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Result <span style=color:#a6e22e>countGender</span>() {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> Result(memberService.<span style=color:#a6e22e>countGender</span>());  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=e10-统计日增会员>E10. 统计日增会员</h2><blockquote><p>心法: 业务流程</p></blockquote><pre tabindex=0><code class=language-mermaid data-lang=mermaid>graph LR

n1[查询&lt;br/&gt;日增会员数量] 
--&gt; n2[加入&lt;br/&gt;缓存]
--&gt; n3[返回&lt;br/&gt;日增会员数量]
</code></pre><blockquote><p>武技: 开发统计日增会员的接口</p></blockquote><ol><li>开发业务方法 <code>MemberService -> countToday()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/**  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * 获取今日新增的会员数量    
</span></span></span><span style=display:flex><span><span style=color:#75715e> *  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @return 今日新增的会员数量  
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>  
</span></span><span style=display:flex><span>Long <span style=color:#a6e22e>countToday</span>();
</span></span></code></pre></div><ol start=2><li>实现业务方法 <code>MemberServiceImpl -> countToday()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Cacheable</span>(key <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;#root.methodName&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Override</span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Long <span style=color:#a6e22e>countToday</span>() {  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// select count(*) from ums_member where date_format(created, &#39;%Y-%m-%d&#39;) = curdate()    </span>
</span></span><span style=display:flex><span>	QueryWrapper queryWrapper <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> QueryWrapper();  
</span></span><span style=display:flex><span>    queryWrapper.<span style=color:#a6e22e>select</span>(QueryMethods.<span style=color:#a6e22e>count</span>().<span style=color:#a6e22e>as</span>(<span style=color:#e6db74>&#34;count&#34;</span>))  
</span></span><span style=display:flex><span>            .<span style=color:#a6e22e>where</span>(dateFormat(MEMBER.<span style=color:#a6e22e>CREATED</span>, <span style=color:#e6db74>&#34;%Y-%m-%d&#34;</span>).<span style=color:#a6e22e>eq</span>(curDate()));  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> (Long) memberMapper.<span style=color:#a6e22e>selectObjectByQuery</span>(queryWrapper);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=3><li>开发控制方法 <code>MemberController -> countToday()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Operation</span>(summary <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;统计日增会员&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@GetMapping</span>(<span style=color:#e6db74>&#34;countToday&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Long <span style=color:#a6e22e>countToday</span>() {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> memberService.<span style=color:#a6e22e>countToday</span>();  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=e11-统计会员总数>E11. 统计会员总数</h2><blockquote><p>心法: 业务流程</p></blockquote><pre tabindex=0><code class=language-mermaid data-lang=mermaid>graph LR

n1[查询&lt;br/&gt;会员记录总数] 
--&gt; n2[加入&lt;br/&gt;缓存]
--&gt; n3[返回&lt;br/&gt;会员记录总数]
</code></pre><blockquote><p>武技: 开发统计会员总数的接口</p></blockquote><ol><li>开发业务方法 <code>MemberService -> countTotal()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/**  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * 获取全部会员数量    
</span></span></span><span style=display:flex><span><span style=color:#75715e> *  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @return 全部会员数量  
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>  
</span></span><span style=display:flex><span>Long <span style=color:#a6e22e>countTotal</span>();
</span></span></code></pre></div><ol start=2><li>实现业务方法 <code>MemberServiceImpl -> countTotal()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Cacheable</span>(key <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;#root.methodName&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Override</span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Long <span style=color:#a6e22e>countTotal</span>() {  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// select count(*) from ums_member    </span>
</span></span><span style=display:flex><span>	QueryWrapper queryWrapper <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> QueryWrapper();  
</span></span><span style=display:flex><span>    queryWrapper.<span style=color:#a6e22e>select</span>(QueryMethods.<span style=color:#a6e22e>count</span>().<span style=color:#a6e22e>as</span>(<span style=color:#e6db74>&#34;count&#34;</span>));  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> (Long) memberMapper.<span style=color:#a6e22e>selectObjectByQuery</span>(queryWrapper);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=3><li>开发控制方法 <code>MemberController -> countTotal()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Operation</span>(summary <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;统计全部会员&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@GetMapping</span>(<span style=color:#e6db74>&#34;countTotal&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Long <span style=color:#a6e22e>countTotal</span>() {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> memberService.<span style=color:#a6e22e>countTotal</span>();  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=e12-查询角色列表>E12. 查询角色列表</h2><blockquote><p>心法: 业务流程</p></blockquote><pre tabindex=0><code class=language-mermaid data-lang=mermaid>graph LR

n1[根据会员主键&lt;br/&gt;查询会员记录] 
--&gt; n2[联查该会员的&lt;br/&gt;角色列表] 
--&gt; n3[加入&lt;br/&gt;缓存]
--&gt; n4[返回该会员的&lt;br/&gt;角色列表]
</code></pre><blockquote><p>武技: 按主键查询该会员的全部角色列表</p></blockquote><ol><li>优化实体类 <code>Member</code>:<ul><li>1条会员记录对应N条角色记录，1条角色记录对应N条会员记录。</li></ul></li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/** 会员[N] : 角色[N] */</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RelationManyToMany</span>(  
</span></span><span style=display:flex><span>        selfField <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;id&#34;</span>, targetField <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;id&#34;</span>,  
</span></span><span style=display:flex><span>        joinTable <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;ums_member_role&#34;</span>,  
</span></span><span style=display:flex><span>        joinSelfColumn <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;fk_member_id&#34;</span>, joinTargetColumn <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;fk_role_id&#34;</span>,
</span></span><span style=display:flex><span>        orderBy <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;weight&#34;</span>  
</span></span><span style=display:flex><span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> List<span style=color:#f92672>&lt;</span>Role<span style=color:#f92672>&gt;</span> roles;
</span></span></code></pre></div><ol start=2><li>开发业务方法 <code>MemberService -> getRoles()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/**  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * 按会员主键查询该会员的全部角色列表  
</span></span></span><span style=display:flex><span><span style=color:#75715e> *  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param id 会员主键  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @return 该会员的全部角色列表  
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>  
</span></span><span style=display:flex><span>List<span style=color:#f92672>&lt;</span>Role<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>getRoles</span>(Long id);
</span></span></code></pre></div><ol start=3><li>实现业务方法 <code>MemberServiceImpl -> getRoles()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Cacheable</span>(key <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;#root.methodName + &#39;:&#39; + #id&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Override</span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> List<span style=color:#f92672>&lt;</span>Role<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>getRoles</span>(Long id) {  
</span></span><span style=display:flex><span>    QueryWrapper queryWrapper <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> QueryWrapper();  
</span></span><span style=display:flex><span>    queryWrapper.<span style=color:#a6e22e>where</span>(MEMBER.<span style=color:#a6e22e>ID</span>.<span style=color:#a6e22e>eq</span>(id));  
</span></span><span style=display:flex><span>    Member member <span style=color:#f92672>=</span> memberMapper.<span style=color:#a6e22e>selectOneWithRelationsByQuery</span>(queryWrapper);  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> member.<span style=color:#a6e22e>getRoles</span>();  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=4><li>开发控制方法 <code>MemberController -> getRoles()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Operation</span>(summary <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;查询角色列表&#34;</span>, description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;根据权重字段升序&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@GetMapping</span>(<span style=color:#e6db74>&#34;getRoles/{id}&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> List<span style=color:#f92672>&lt;</span>Role<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>getRoles</span>(<span style=color:#a6e22e>@PathVariable</span> Long id) {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> memberService.<span style=color:#a6e22e>getRoles</span>(id);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=e13-修改角色列表>E13. 修改角色列表</h2><blockquote><p>心法: 业务流程</p></blockquote><pre tabindex=0><code class=language-mermaid data-lang=mermaid>graph LR

n1[在会员角色中间表中&lt;br/&gt;删除该会员的全部记录]
--&gt; n2[在会员角色中间表中&lt;br/&gt;批量添加该会员的新记录] 
--&gt; n3[逐出&lt;br/&gt;缓存]
--&gt; n4[返回&lt;br/&gt;布尔结果]
</code></pre><blockquote><p>武技: 按主键修改该会员的角色列表</p></blockquote><ol><li>开发业务方法 <code>MemberService -> updateRoles()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/**  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * 按会员主键修改该会员的角色列表  
</span></span></span><span style=display:flex><span><span style=color:#75715e> *  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param id      会员主键  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param roleIds 角色主键列表  
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>updateRoles</span>(Long id, List<span style=color:#f92672>&lt;</span>Long<span style=color:#f92672>&gt;</span> roleIds);
</span></span></code></pre></div><ol start=2><li>实现业务方法 <code>MemberServiceImpl -> updateRoles()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@CacheEvict</span>(allEntries <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Transactional</span>(rollbackFor <span style=color:#f92672>=</span> Exception.<span style=color:#a6e22e>class</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Override</span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>updateRoles</span>(Long id, List<span style=color:#f92672>&lt;</span>Long<span style=color:#f92672>&gt;</span> roleIds) {  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 在会员角色中间表中，删除该会员的全部记录  </span>
</span></span><span style=display:flex><span>    QueryWrapper queryWrapper <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> QueryWrapper();  
</span></span><span style=display:flex><span>    queryWrapper.<span style=color:#a6e22e>where</span>(MEMBER_ROLE.<span style=color:#a6e22e>FK_MEMBER_ID</span>.<span style=color:#a6e22e>eq</span>(id));  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span>(memberRoleMapper.<span style=color:#a6e22e>deleteByQuery</span>(queryWrapper) <span style=color:#f92672>&lt;=</span> 0){  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> ServiceException(<span style=color:#e6db74>&#34;会员角色中间表记录删除失败&#34;</span>);  
</span></span><span style=display:flex><span>    }  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 在会员角色中间表中，批量添加该会员的新记录</span>
</span></span><span style=display:flex><span>    List<span style=color:#f92672>&lt;</span>MemberRole<span style=color:#f92672>&gt;</span> memberRoles <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ArrayList<span style=color:#f92672>&lt;&gt;</span>();  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> (Long roleId: roleIds){  
</span></span><span style=display:flex><span>        MemberRole memberRole <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> MemberRole();  
</span></span><span style=display:flex><span>        memberRole.<span style=color:#a6e22e>setFkMemberId</span>(id);  
</span></span><span style=display:flex><span>        memberRole.<span style=color:#a6e22e>setFkRoleId</span>(roleId);  
</span></span><span style=display:flex><span>        memberRole.<span style=color:#a6e22e>setCreated</span>(LocalDateTime.<span style=color:#a6e22e>now</span>());  
</span></span><span style=display:flex><span>        memberRole.<span style=color:#a6e22e>setUpdated</span>(LocalDateTime.<span style=color:#a6e22e>now</span>());  
</span></span><span style=display:flex><span>        memberRoles.<span style=color:#a6e22e>add</span>(memberRole);  
</span></span><span style=display:flex><span>    }  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 批量添加中间表记录  </span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span>(memberRoleMapper.<span style=color:#a6e22e>insertBatch</span>(memberRoles) <span style=color:#f92672>&lt;=</span> 0){  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> ServiceException(<span style=color:#e6db74>&#34;会员角色中间表记录添加失败&#34;</span>);  
</span></span><span style=display:flex><span>    }  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=3><li>开发控制方法 <code>MemberController -> updateRoles()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Operation</span>(summary <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;修改角色列表&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@PostMapping</span>(<span style=color:#e6db74>&#34;updateRoles/{id}&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Result <span style=color:#a6e22e>updateRoles</span>(<span style=color:#a6e22e>@PathVariable</span> Long id, <span style=color:#a6e22e>@RequestParam</span> List<span style=color:#f92672>&lt;</span>Long<span style=color:#f92672>&gt;</span> roleIds) {  
</span></span><span style=display:flex><span>    memberService.<span style=color:#a6e22e>updateRoles</span>(id, roleIds);  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> Result(ResultCode.<span style=color:#a6e22e>SUCCESS</span>);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=e14-重置会员密码>E14. 重置会员密码</h2><blockquote><p>心法: 业务流程</p></blockquote><pre tabindex=0><code class=language-mermaid data-lang=mermaid>graph LR

n1[重置会员密码为&lt;br/&gt;123456]
--&gt; n2[逐出&lt;br/&gt;缓存]
--&gt; n3[返回&lt;br/&gt;布尔结果]
</code></pre><blockquote><p>武技: 开发重置会员密码的接口</p></blockquote><ol><li>开发业务方法 <code>MemberService -> resetPassword()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/**  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * 重置会员密码  
</span></span></span><span style=display:flex><span><span style=color:#75715e> *  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param id 会员主键  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @return true表示重置成功  
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>resetPassword</span>(Long id);
</span></span></code></pre></div><ol start=2><li>实现业务方法 <code>MemberServiceImpl -> resetPassword()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@CacheEvict</span>(allEntries <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Override</span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>resetPassword</span>(Long id) {  
</span></span><span style=display:flex><span>    Member member <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Member();  
</span></span><span style=display:flex><span>    member.<span style=color:#a6e22e>setId</span>(id);  
</span></span><span style=display:flex><span>    member.<span style=color:#a6e22e>setPassword</span>(SecureUtil.<span style=color:#a6e22e>md5</span>(MemberConst.<span style=color:#a6e22e>DEFAULT_PASSWORD</span>));  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> memberMapper.<span style=color:#a6e22e>update</span>(member) <span style=color:#f92672>&gt;</span> 0;  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=3><li>开发控制方法 <code>MemberController -> resetPassword()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Operation</span>(summary <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;重置会员密码&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@PostMapping</span>(<span style=color:#e6db74>&#34;resetPassword/{id}&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>resetPassword</span>(<span style=color:#a6e22e>@PathVariable</span> Long id) {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> memberService.<span style=color:#a6e22e>resetPassword</span>(id);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=e15-账号密码登录>E15. 账号密码登录</h2><blockquote><p>心法: 业务流程</p></blockquote><ul><li><a href=../../%E7%AC%AC3%E9%98%B6%E6%AE%B5-SSM/JB3-4-SpringBoot/res/%E5%B0%81%E8%A3%85JWT%E5%B7%A5%E5%85%B7%E7%B1%BB.md>Token令牌 + 拦截器使用流程</a></li></ul><pre tabindex=0><code class=language-mermaid data-lang=mermaid>graph LR

ex1[抛出异常&lt;br/&gt;账号密码错误]
ex2[抛出异常&lt;br/&gt;会员权限不足]

n1[按账号密码&lt;br/&gt;查询会员记录] --&gt; f{是否&lt;br/&gt;存在}
	f --是--&gt; n2[查询该会员的&lt;br/&gt;角色主键列表] --&gt; f1{是否拥有&lt;br/&gt;管理员角色}
		f1 --是--&gt; n3[创建&lt;br/&gt;Token令牌] --&gt; n4[返回会员记录&lt;br/&gt;及其Token令牌]
		f1 --否--&gt; ex2
	f --否--&gt; ex1
</code></pre><blockquote><p>武技: 开发按账号密码登录系统的接口</p></blockquote><ol><li>开发VO实体类 <code>MemberVO</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> com.lsx.vo;  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Schema</span>(name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;会员VO&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Data</span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MemberVO</span> <span style=color:#66d9ef>implements</span> Serializable {  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Schema</span>(description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;会员信息&#34;</span>)  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Member member;  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Schema</span>(description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Token令牌&#34;</span>)  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String token;  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Schema</span>(description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;权限列表&#34;</span>)  
</span></span><span style=display:flex><span>	List<span style=color:#f92672>&lt;</span>Permission<span style=color:#f92672>&gt;</span> permissions;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=2><li>优化实体类 <code>Member</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/** 会员[N] : 角色[N] */</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RelationManyToMany</span>(  
</span></span><span style=display:flex><span>        selfField <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;id&#34;</span>, targetField <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;id&#34;</span>,  
</span></span><span style=display:flex><span>        joinTable <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;ums_member_role&#34;</span>,  
</span></span><span style=display:flex><span>        joinSelfColumn <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;fk_member_id&#34;</span>, joinTargetColumn <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;fk_role_id&#34;</span>,  
</span></span><span style=display:flex><span>        orderBy <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;weight&#34;</span>  
</span></span><span style=display:flex><span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> List<span style=color:#f92672>&lt;</span>Role<span style=color:#f92672>&gt;</span> roles;
</span></span></code></pre></div><ol start=3><li>优化实体类 <code>Role</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/** 角色[N] : 权限[N] */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RelationManyToMany</span>(  
</span></span><span style=display:flex><span>        selfField <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;id&#34;</span>, targetField <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;id&#34;</span>,  
</span></span><span style=display:flex><span>        joinTable <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;ums_role_permission&#34;</span>,  
</span></span><span style=display:flex><span>        joinSelfColumn <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;fk_role_id&#34;</span>, joinTargetColumn <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;fk_permission_id&#34;</span>,  
</span></span><span style=display:flex><span>        orderBy <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;weight&#34;</span>  
</span></span><span style=display:flex><span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> List<span style=color:#f92672>&lt;</span>Permission<span style=color:#f92672>&gt;</span> permissions;
</span></span></code></pre></div><ol start=4><li>优化实体类 <code>Permission</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/** 权限[1] : 子权限[N] */</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RelationOneToMany</span>(selfField <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;id&#34;</span>, targetField <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;pid&#34;</span>)  
</span></span><span style=display:flex><span>List<span style=color:#f92672>&lt;</span>Permission<span style=color:#f92672>&gt;</span> subPermissions;
</span></span></code></pre></div><ol start=5><li>开发业务方法 <code>MemberService -> loginByAccount()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/**  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * 按账号密码登录系统  
</span></span></span><span style=display:flex><span><span style=color:#75715e> *  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param username 账号  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param password 密码  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @return 返回登陆成功的会员记录及其Token令牌  
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>  
</span></span><span style=display:flex><span>MemberVO <span style=color:#a6e22e>loginByAccount</span>(String username, String password);
</span></span></code></pre></div><ol start=6><li>实现业务方法 <code>MemberServiceImpl -> loginByAccount()</code>:<ul><li>登录业务不需要设置缓存。</li></ul></li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> MemberVO <span style=color:#a6e22e>loginByAccount</span>(String username, String password) {  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 添加1层递归深度: member -&gt; role -&gt; permission -&gt; subPermission  </span>
</span></span><span style=display:flex><span>    RelationManager.<span style=color:#a6e22e>setMaxDepth</span>(4);  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 按账号密码查询会员记录，同时联查角色列表  </span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// select * from ums_member where username = ? and password = ?  </span>
</span></span><span style=display:flex><span>    Member member <span style=color:#f92672>=</span> memberMapper.<span style=color:#a6e22e>selectOneWithRelationsByQuery</span>(QueryWrapper.<span style=color:#a6e22e>create</span>()  
</span></span><span style=display:flex><span>            .<span style=color:#a6e22e>where</span>(MEMBER.<span style=color:#a6e22e>USERNAME</span>.<span style=color:#a6e22e>eq</span>(username))  
</span></span><span style=display:flex><span>            .<span style=color:#a6e22e>and</span>(MEMBER.<span style=color:#a6e22e>PASSWORD</span>.<span style=color:#a6e22e>eq</span>(SecureUtil.<span style=color:#a6e22e>md5</span>(password))));  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 检查记录是否存在  </span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (ObjectUtil.<span style=color:#a6e22e>isNull</span>(member)) {  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> ServiceException(<span style=color:#e6db74>&#34;账号密码错误&#34;</span>);  
</span></span><span style=display:flex><span>    }  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 处理会员权限列表  </span>
</span></span><span style=display:flex><span>    List<span style=color:#f92672>&lt;</span>Permission<span style=color:#f92672>&gt;</span> permissions <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ArrayList<span style=color:#f92672>&lt;&gt;</span>();  
</span></span><span style=display:flex><span>    member.<span style=color:#a6e22e>getRoles</span>().<span style=color:#a6e22e>forEach</span>(role <span style=color:#f92672>-&gt;</span> role.<span style=color:#a6e22e>getPermissions</span>().<span style=color:#a6e22e>forEach</span>(permission <span style=color:#f92672>-&gt;</span> {  
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 仅组装根权限  </span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (permission.<span style=color:#a6e22e>getPid</span>() <span style=color:#f92672>==</span> 0) {  
</span></span><span style=display:flex><span>            permissions.<span style=color:#a6e22e>add</span>(permission);  
</span></span><span style=display:flex><span>        }  
</span></span><span style=display:flex><span>    }));  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 组装MemberVO: 包含会员信息，对应该会员的Token令牌以及权限列表  </span>
</span></span><span style=display:flex><span>    MemberVO memberVO <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> MemberVO();  
</span></span><span style=display:flex><span>    memberVO.<span style=color:#a6e22e>setPermissions</span>(permissions);  
</span></span><span style=display:flex><span>    memberVO.<span style=color:#a6e22e>setMember</span>(member);  
</span></span><span style=display:flex><span>    memberVO.<span style=color:#a6e22e>setToken</span>(JwtUtil.<span style=color:#a6e22e>build</span>(member.<span style=color:#a6e22e>getId</span>(), member.<span style=color:#a6e22e>getNickname</span>(), member.<span style=color:#a6e22e>getAvatar</span>()));  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> memberVO;  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=7><li>开发控制方法 <code>MemberController -> loginByAccount()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Operation</span>(summary <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;账号密码登录&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@PostMapping</span>(<span style=color:#e6db74>&#34;loginByAccount&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> MemberVO <span style=color:#a6e22e>loginByAccount</span>(<span style=color:#a6e22e>@RequestParam</span> String username, <span style=color:#a6e22e>@RequestParam</span> String password) {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> memberService.<span style=color:#a6e22e>loginByAccount</span>(username, password);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=8><li>开发Token拦截器 <code>TokenInterceptor</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> com.lsx.component;  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Component</span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>TokenInterceptor</span> <span style=color:#66d9ef>implements</span> HandlerInterceptor {  
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@SneakyThrows</span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>preHandle</span>(HttpServletRequest req, HttpServletResponse resp, Object handler) {  
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 若目标方法不是Controller方法，则直接放行    </span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>(handler <span style=color:#66d9ef>instanceof</span> HandlerMethod)) {  
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>;  
</span></span><span style=display:flex><span>        }  
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 若请求头中不存在Token令牌，则抛出异常    </span>
</span></span><span style=display:flex><span>		String token <span style=color:#f92672>=</span> req.<span style=color:#a6e22e>getHeader</span>(JwtConst.<span style=color:#a6e22e>TOKEN_KEY</span>);  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (ObjectUtil.<span style=color:#a6e22e>isEmpty</span>(token)) {  
</span></span><span style=display:flex><span>           <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> ServiceException(<span style=color:#e6db74>&#34;Token令牌失效&#34;</span>);  
</span></span><span style=display:flex><span>	    }  
</span></span><span style=display:flex><span>          
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 解析Token令牌  </span>
</span></span><span style=display:flex><span>        Map<span style=color:#f92672>&lt;</span>String, Object<span style=color:#f92672>&gt;</span> verifyResult <span style=color:#f92672>=</span> JwtUtil.<span style=color:#a6e22e>verify</span>(token);  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 获取Token令牌的过期标记: true表示即将要过期  </span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>boolean</span> expireSoon <span style=color:#f92672>=</span> (<span style=color:#66d9ef>boolean</span>)verifyResult.<span style=color:#a6e22e>get</span>(JwtConst.<span style=color:#a6e22e>EXPIRATION_KEY</span>);  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 若Token令牌即将过期，则返回过期提示以及一个新的Token令牌  </span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (expireSoon) {  
</span></span><span style=display:flex><span>            String newToken <span style=color:#f92672>=</span> (String) verifyResult.<span style=color:#a6e22e>get</span>(JwtConst.<span style=color:#a6e22e>NEW_TOKEN_KEY</span>);  
</span></span><span style=display:flex><span>            resp.<span style=color:#a6e22e>setContentType</span>(<span style=color:#e6db74>&#34;application/json;charset=utf-8&#34;</span>);    
</span></span><span style=display:flex><span>			resp.<span style=color:#a6e22e>getWriter</span>().<span style=color:#a6e22e>print</span>(<span style=color:#66d9ef>new</span> Result(ResultCode.<span style=color:#a6e22e>TOKEN_EXPIRING_SOON</span>, newToken));  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 拦截请求  </span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>;          
</span></span><span style=display:flex><span>		}  
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 放行    </span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>;    
</span></span><span style=display:flex><span>	}    
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=9><li>配置Token拦截器 <code>InterceptorConfig</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> com.lsx.config;  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Configuration</span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>InterceptorConfig</span> <span style=color:#66d9ef>implements</span> WebMvcConfigurer {    
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Autowired</span>    
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> TokenInterceptor tokenInterceptor;    
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Override</span>    
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>addInterceptors</span>(InterceptorRegistry registry) {    
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 将自定义拦截器注册到全局拦截器链中    </span>
</span></span><span style=display:flex><span>		registry.<span style=color:#a6e22e>addInterceptor</span>(tokenInterceptor)    
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 拦截所有 `/api/v1/**` 请求    </span>
</span></span><span style=display:flex><span>		.<span style=color:#a6e22e>addPathPatterns</span>(<span style=color:#e6db74>&#34;/api/v1/**&#34;</span>)    
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 放行部分不需要Token验证的请求    </span>
</span></span><span style=display:flex><span>		.<span style=color:#a6e22e>excludePathPatterns</span>(<span style=color:#e6db74>&#34;/api/v1/member/loginByAccount&#34;</span>);    
</span></span><span style=display:flex><span>	}    
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h1 id=s13-开发角色接口>S13. 开发角色接口</h1><blockquote><p>心法: Role接口文档</p></blockquote><ul><li>前缀 <code>/api/v1/role</code>:</li></ul><table><thead><tr><th></th><th>接口</th><th>类型</th><th>描述</th><th>请求参数</th><th>必要参数</th></tr></thead><tbody><tr><td>1</td><td><code>save</code></td><td>POST</td><td>添加一条记录</td><td><code>@RequestBody RoleInsert dto</code></td><td><code>title</code></td></tr><tr><td>2</td><td><code>getInfo/{id}</code></td><td>GET</td><td>根据主键查询</td><td><code>@PathVariable Long id</code></td><td><code>id</code></td></tr><tr><td>3</td><td><code>update</code></td><td>POST</td><td>根据主键修改</td><td><code>@RequestBody RoleUpdate dto</code></td><td><code>id</code></td></tr><tr><td>4</td><td><code>remove/{id}</code></td><td>POST</td><td>根据主键删除</td><td><code>@PathVariable Long id</code></td><td><code>id</code></td></tr><tr><td>5</td><td><code>removeBatch</code></td><td>POST</td><td>根据主键批删</td><td><code>@RequestParam List&lt;Long> ids</code></td><td><code>ids</code></td></tr><tr><td>6</td><td><code>page</code></td><td>GET</td><td>全量数据分页</td><td><code>Page&lt;Role> page</code></td><td><code>pageNumber</code><code>pageSize</code></td></tr><tr><td>7</td><td><code>list</code></td><td>GET</td><td>查询全部角色</td><td></td><td></td></tr><tr><td>8</td><td><code>getPermissions/{id}</code></td><td>GET</td><td>查询权限列表</td><td><code>@PathVariable Long id</code></td><td><code>id</code></td></tr><tr><td>9</td><td><code>updatePermissions/{id}</code></td><td>POST</td><td>修改权限列表</td><td><code>@PathVariable Long id</code><code>@RequestParam List&lt;Long> permissionIds</code></td><td><code>id</code><code>permissionIds</code></td></tr></tbody></table><h2 id=e01-添加一条记录-6>E01. 添加一条记录</h2><blockquote><p>心法: 业务流程</p></blockquote><pre tabindex=0><code class=language-mermaid data-lang=mermaid>graph LR

n1[根据标题&lt;br/&gt;查询角色] --&gt; f{是否&lt;br/&gt;存在}
	f --是--&gt; ex[抛出异常]
	f --否--&gt; n3[置空主键]
		--&gt; n4[设置当前创建时间&lt;br/&gt;设置当前修改时间] 
		--&gt; n5[添加记录]
		--&gt; n6[逐出缓存]
		--&gt; n7[返回布尔结果]
</code></pre><blockquote><p>武技: 添加一条角色记录</p></blockquote><ol><li>开发DTO实体类 <code>RoleInsertDTO</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> com.lsx.dto;  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Schema</span>(name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;角色添加DTO&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Data</span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>RoleInsertDTO</span> <span style=color:#66d9ef>implements</span> Serializable {  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@NotEmpty</span>(message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;标题不能为空&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Size</span>(min <span style=color:#f92672>=</span> 1, max <span style=color:#f92672>=</span> 128, message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;标题长度必须在1~128之间&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Schema</span>(description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;标题&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> String title;  
</span></span><span style=display:flex><span>	  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Range</span>(min <span style=color:#f92672>=</span> 0, message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;权重最小为0&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Schema</span>(description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;权重，数字越小越优先&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> Long weight;  
</span></span><span style=display:flex><span>	  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Size</span>(min <span style=color:#f92672>=</span> 1, max <span style=color:#f92672>=</span> 512, message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;描述长度必须在1~512之间&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Schema</span>(description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;描述&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> String info; 
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=2><li>重写业务方法 <code>RoleServiceImpl -> save()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@CacheEvict</span>(allEntries <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>save</span>(Role entity) {  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 判断角色标题是否已经存在  </span>
</span></span><span style=display:flex><span>    Role role <span style=color:#f92672>=</span> roleMapper.<span style=color:#a6e22e>selectOneByCondition</span>(ROLE.<span style=color:#a6e22e>TITLE</span>.<span style=color:#a6e22e>eq</span>(entity.<span style=color:#a6e22e>getTitle</span>()));  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span>(ObjectUtil.<span style=color:#a6e22e>isNotNull</span>(role)){  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> ServiceException(<span style=color:#e6db74>&#34;角色标题已存在&#34;</span>);  
</span></span><span style=display:flex><span>    }  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 清空主键  </span>
</span></span><span style=display:flex><span>    entity.<span style=color:#a6e22e>setId</span>(<span style=color:#66d9ef>null</span>);  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 设置创建时间和修改时间为当前时间  </span>
</span></span><span style=display:flex><span>    entity.<span style=color:#a6e22e>setCreated</span>(LocalDateTime.<span style=color:#a6e22e>now</span>());  
</span></span><span style=display:flex><span>    entity.<span style=color:#a6e22e>setUpdated</span>(LocalDateTime.<span style=color:#a6e22e>now</span>());  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 添加记录  </span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>super</span>.<span style=color:#a6e22e>save</span>(entity);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=3><li>重写控制方法 <code>RoleController -> save()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Operation</span>(summary <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;添加一条记录&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@PostMapping</span>(<span style=color:#e6db74>&#34;save&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>save</span>(<span style=color:#a6e22e>@RequestBody</span> <span style=color:#a6e22e>@Validated</span> RoleInsertDTO dto) {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> roleService.<span style=color:#a6e22e>save</span>(BeanUtil.<span style=color:#a6e22e>copyProperties</span>(dto, Role.<span style=color:#a6e22e>class</span>));  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=e02-根据主键查询-6>E02. 根据主键查询</h2><blockquote><p>心法: 业务流程</p></blockquote><pre tabindex=0><code class=language-mermaid data-lang=mermaid>graph LR

n1[根据主键&lt;br/&gt;查询角色] --&gt; f{是否&lt;br/&gt;存在}
	f --是--&gt; n2[加入&lt;br/&gt;缓存] --&gt; n2a[返回&lt;br/&gt;角色记录]
	f --否--&gt; n3[抛出&lt;br/&gt;异常]
</code></pre><blockquote><p>武技: 根据主键查询一条角色记录</p></blockquote><ol><li>重写业务方法 <code>RoleServiceImpl -> getById()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Cacheable</span>(key <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;#id&#34;</span>, unless <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;#result == null&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Role <span style=color:#a6e22e>getById</span>(Serializable id) {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>super</span>.<span style=color:#a6e22e>getById</span>(id);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=2><li>重写控制方法 <code>RoleController -> getInfo()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Operation</span>(summary <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;根据主键查询&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@GetMapping</span>(<span style=color:#e6db74>&#34;getInfo/{id}&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Role <span style=color:#a6e22e>getInfo</span>(<span style=color:#a6e22e>@PathVariable</span> Long id) {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> roleService.<span style=color:#a6e22e>getById</span>(id);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=e03-根据主键修改-6>E03. 根据主键修改</h2><blockquote><p>心法: 业务流程</p></blockquote><pre tabindex=0><code class=language-mermaid data-lang=mermaid>graph LR

ex[抛出异常]

f{是否需要&lt;br/&gt;修改标题}
	f --是--&gt; f1{标题是否&lt;br/&gt;已经存在}
		f1 --是--&gt; ex 
		f1 --否--&gt; n1 
	f --否--&gt; n1

	n1[设置&lt;br/&gt;当前修改时间]
--&gt; n2[置空&lt;br/&gt;创建时间]
--&gt; n3[修改&lt;br/&gt;记录]
--&gt; n4[逐出&lt;br/&gt;缓存]
--&gt; n5[返回&lt;br/&gt;布尔结果]
</code></pre><blockquote><p>武技: 根据主键修改一条角色记录</p></blockquote><ol><li>开发DTO实体类 <code>RoleUpdateDTO</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> com.lsx.dto;  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Schema</span>(name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;角色修改DTO&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Data</span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>RoleUpdateDTO</span> <span style=color:#66d9ef>implements</span> Serializable {  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@NotNull</span>(message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;主键不能为空&#34;</span>)  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Schema</span>(description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;主键&#34;</span>)  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Long id;  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Size</span>(min <span style=color:#f92672>=</span> 1, max <span style=color:#f92672>=</span> 128, message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;标题长度必须在1~128之间&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Schema</span>(description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;标题&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> String title;
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Range</span>(min <span style=color:#f92672>=</span> 0, message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;权重最小为0&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Schema</span>(description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;权重，数字越小越优先&#34;</span>)  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Long weight;  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Size</span>(max <span style=color:#f92672>=</span> 512, message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;描述长度必须小于512&#34;</span>)  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Schema</span>(description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;描述&#34;</span>)  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String info;  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=2><li>重写业务方法 <code>RoleServiceImpl -> updateById()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@CacheEvict</span>(allEntries <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>updateById</span>(Role entity) {  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 判断是否要修改角色标题  </span>
</span></span><span style=display:flex><span>	String title <span style=color:#f92672>=</span> entity.<span style=color:#a6e22e>getTitle</span>();  
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span>(ObjectUtil.<span style=color:#a6e22e>isNotNull</span>(title)){  
</span></span><span style=display:flex><span>	    <span style=color:#75715e>// 判断角色标题是否已经存在  </span>
</span></span><span style=display:flex><span>	    Role role <span style=color:#f92672>=</span> roleMapper.<span style=color:#a6e22e>selectOneByCondition</span>(ROLE.<span style=color:#a6e22e>TITLE</span>.<span style=color:#a6e22e>eq</span>(title));  
</span></span><span style=display:flex><span>	    <span style=color:#66d9ef>if</span>(ObjectUtil.<span style=color:#a6e22e>isNotNull</span>(role)){  
</span></span><span style=display:flex><span>	        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> ServiceException(<span style=color:#e6db74>&#34;角色标题已存在&#34;</span>);  
</span></span><span style=display:flex><span>	    }  
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 设置最后修改时间为当前时间  </span>
</span></span><span style=display:flex><span>    entity.<span style=color:#a6e22e>setUpdated</span>(LocalDateTime.<span style=color:#a6e22e>now</span>());  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 不允许修改创建时间  </span>
</span></span><span style=display:flex><span>    entity.<span style=color:#a6e22e>setCreated</span>(<span style=color:#66d9ef>null</span>);  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 修改记录  </span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>super</span>.<span style=color:#a6e22e>updateById</span>(entity);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=3><li>重写控制方法 <code>RoleController -> update()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Operation</span>(summary <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;根据主键修改&#34;</span>, description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;已关联会员的角色无法删除&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>@PostMapping</span>(<span style=color:#e6db74>&#34;update&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>update</span>(<span style=color:#a6e22e>@RequestBody</span> <span style=color:#a6e22e>@Validated</span> RoleUpdateDTO dto) {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> roleService.<span style=color:#a6e22e>updateById</span>(BeanUtil.<span style=color:#a6e22e>copyProperties</span>(dto, Role.<span style=color:#a6e22e>class</span>));  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=e04-根据主键删除-6>E04. 根据主键删除</h2><blockquote><p>心法: 业务流程</p></blockquote><pre tabindex=0><code class=language-mermaid data-lang=mermaid>graph LR

ex[抛出异常]

f{是否关联&lt;br/&gt;会员记录}
	f --是--&gt; ex
	f --否--&gt; n1

n1[删除&lt;br/&gt;角色权限中间表记录]
--&gt; n2[删除&lt;br/&gt;角色记录]
--&gt; n3[逐出&lt;br/&gt;缓存]
--&gt; n4[返回&lt;br/&gt;布尔结果]
</code></pre><blockquote><p>武技: 根据主键删除一条角色记录，已关联会员记录的角色不允许删除</p></blockquote><ol><li>重写业务方法 <code>RoleServiceImpl -> removeById()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Transactional</span>(rollbackFor <span style=color:#f92672>=</span> Exception.<span style=color:#a6e22e>class</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Override</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@CacheEvict</span>(allEntries <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>removeById</span>(Serializable id) {  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 已关联会员的角色不允许删除  </span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// select count(*) from ums_member_role where fk_role_id = ?  </span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span>(memberRoleMapper.<span style=color:#a6e22e>selectCountByCondition</span>(MEMBER_ROLE.<span style=color:#a6e22e>FK_ROLE_ID</span>.<span style=color:#a6e22e>eq</span>(id)) <span style=color:#f92672>&gt;</span> 0){  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> ServiceException(<span style=color:#e6db74>&#34;该角色已关联会员记录，不允许删除&#34;</span>);  
</span></span><span style=display:flex><span>    }  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 删除中间表记录  </span>
</span></span><span style=display:flex><span>	rolePermissionMapper.<span style=color:#a6e22e>deleteByCondition</span>(ROLE_PERMISSION.<span style=color:#a6e22e>FK_ROLE_ID</span>.<span style=color:#a6e22e>eq</span>(id));  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 删除角色表记录  </span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>super</span>.<span style=color:#a6e22e>removeById</span>(id);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=2><li>重写控制方法 <code>RoleController -> remove()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Operation</span>(summary <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;根据主键删除&#34;</span>, description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;已关联会员的角色无法删除&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@PostMapping</span>(<span style=color:#e6db74>&#34;remove/{id}&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>remove</span>(<span style=color:#a6e22e>@PathVariable</span> Long id) {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> roleService.<span style=color:#a6e22e>removeById</span>(id);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=e05-根据主键批删-6>E05. 根据主键批删</h2><blockquote><p>心法: 业务流程</p></blockquote><pre tabindex=0><code class=language-mermaid data-lang=mermaid>graph LR

ex[抛出异常]

f{是否存在已关联&lt;br/&gt;会员记录的角色}
	f --是--&gt; ex
	f --否--&gt; n1

n1[批量删除&lt;br/&gt;角色权限中间表记录]
--&gt; n2[批量删除&lt;br/&gt;角色记录]
--&gt; n3[逐出&lt;br/&gt;缓存]
--&gt; n4[返回&lt;br/&gt;布尔结果]
</code></pre><blockquote><p>武技: 根据主键列表批量删除角色记录，已关联会员记录的角色不允许删除</p></blockquote><ol><li>重写业务方法 <code>RoleServiceImpl -> removeByIds()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Transactional</span>(rollbackFor <span style=color:#f92672>=</span> Exception.<span style=color:#a6e22e>class</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Override</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@CacheEvict</span>(allEntries <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>removeByIds</span>(Collection<span style=color:#f92672>&lt;?</span> <span style=color:#66d9ef>extends</span> Serializable<span style=color:#f92672>&gt;</span> ids) {  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 检查是否存在已关联会员记录的角色  </span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> (Serializable id : ids) {  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span>(memberRoleMapper.<span style=color:#a6e22e>selectCountByCondition</span>(MEMBER_ROLE.<span style=color:#a6e22e>FK_ROLE_ID</span>.<span style=color:#a6e22e>eq</span>(id)) <span style=color:#f92672>&gt;</span> 0){  
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> ServiceException(<span style=color:#e6db74>&#34;存在已关联会员记录的角色，整体不允许删除&#34;</span>);  
</span></span><span style=display:flex><span>        }  
</span></span><span style=display:flex><span>    }  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 删除中间表记录  </span>
</span></span><span style=display:flex><span>	rolePermissionMapper.<span style=color:#a6e22e>deleteByCondition</span>(ROLE_PERMISSION.<span style=color:#a6e22e>FK_ROLE_ID</span>.<span style=color:#a6e22e>in</span>(ids));  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 批量删除角色表记录</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>super</span>.<span style=color:#a6e22e>removeByIds</span>(ids);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=2><li>重写控制方法 <code>RoleController -> removeBatch()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Operation</span>(summary <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;根据主键批删&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@PostMapping</span>(<span style=color:#e6db74>&#34;removeBatch&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>removeBatch</span>(<span style=color:#a6e22e>@RequestParam</span> List<span style=color:#f92672>&lt;</span>Long<span style=color:#f92672>&gt;</span> ids) {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> roleService.<span style=color:#a6e22e>removeByIds</span>(ids);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=e06-全量数据分页-3>E06. 全量数据分页</h2><blockquote><p>心法: 业务流程</p></blockquote><pre tabindex=0><code class=language-mermaid data-lang=mermaid>graph LR

n1[分页查询&lt;br/&gt;角色记录] 
--&gt; n2[根据权重升序&lt;br/&gt;根据主键降序] 
--&gt; n3[加入&lt;br/&gt;缓存]
--&gt; n4[返回&lt;br/&gt;分页数据]
</code></pre><blockquote><p>武技: 分页查询角色记录</p></blockquote><ol><li>重写业务方法 <code>RoleServiceImpl -> page()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Cacheable</span>(key <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;#root.methodName + &#39;:&#39; + #page.getPageSize() + &#39;:&#39; + #page.getPageNumber()&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Page<span style=color:#f92672>&lt;</span>Role<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>page</span>(Page<span style=color:#f92672>&lt;</span>Role<span style=color:#f92672>&gt;</span> page) {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>super</span>.<span style=color:#a6e22e>page</span>(page, QueryWrapper.<span style=color:#a6e22e>create</span>().<span style=color:#a6e22e>orderBy</span>(ROLE.<span style=color:#a6e22e>WEIGHT</span>.<span style=color:#a6e22e>asc</span>(), ROLE.<span style=color:#a6e22e>ID</span>.<span style=color:#a6e22e>desc</span>()));  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=2><li>重写控制方法 <code>RoleController -> page()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Operation</span>(summary <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;全量数据分页&#34;</span>, description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;根据权重字段升序，权重相同根据ID降序&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@GetMapping</span>(<span style=color:#e6db74>&#34;page&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Page<span style=color:#f92672>&lt;</span>Role<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>page</span>(Page<span style=color:#f92672>&lt;</span>Role<span style=color:#f92672>&gt;</span> page) {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> roleService.<span style=color:#a6e22e>page</span>(page);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=e07-查询全部角色>E07. 查询全部角色</h2><blockquote><p>心法: 业务流程</p></blockquote><pre tabindex=0><code class=language-mermaid data-lang=mermaid>graph LR

n1[查询全部&lt;br/&gt;角色记录] 
--&gt; n2[根据权重升序&lt;br/&gt;根据主键降序] 
--&gt; n3[加入&lt;br/&gt;缓存]
--&gt; n4[返回&lt;br/&gt;全部数据]
</code></pre><blockquote><p>武技: 查询全部角色记录</p></blockquote><ol><li>重写业务方法 <code>RoleServiceImpl -> list()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Cacheable</span>(key <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;#root.methodName&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> List<span style=color:#f92672>&lt;</span>Role<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>list</span>() {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>super</span>.<span style=color:#a6e22e>list</span>(QueryWrapper.<span style=color:#a6e22e>create</span>().<span style=color:#a6e22e>orderBy</span>(ROLE.<span style=color:#a6e22e>WEIGHT</span>.<span style=color:#a6e22e>asc</span>(), ROLE.<span style=color:#a6e22e>ID</span>.<span style=color:#a6e22e>desc</span>()));  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=2><li>重写控制方法 <code>RoleController -> list()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Operation</span>(summary <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;查询全部角色&#34;</span>, description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;根据权重字段升序，权重相同根据ID降序&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@GetMapping</span>(<span style=color:#e6db74>&#34;list&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> List<span style=color:#f92672>&lt;</span>Role<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>list</span>() {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> roleService.<span style=color:#a6e22e>list</span>();  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=e08-查询权限列表>E08. 查询权限列表</h2><blockquote><p>心法: 业务流程</p></blockquote><pre tabindex=0><code class=language-mermaid data-lang=mermaid>graph LR

n1[根据角色主键&lt;br/&gt;查询角色记录] 
--&gt; n2[联查该角色的&lt;br/&gt;权限列表] 
--&gt; n3[加入&lt;br/&gt;缓存]
--&gt; n4[返回该角色的&lt;br/&gt;权限列表]
</code></pre><blockquote><p>武技: 按主键查询该角色的全部权限列表，仅查询根权限</p></blockquote><ol><li>优化实体类 <code>Role</code>:<ul><li>1条角色记录对应N条权限记录，1条权限记录对应N条角色记录。</li></ul></li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/** 角色[N] : 权限[N] */</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@RelationManyToMany</span>(  
</span></span><span style=display:flex><span>        selfField <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;id&#34;</span>, targetField <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;id&#34;</span>,  
</span></span><span style=display:flex><span>        joinTable <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;ums_role_permission&#34;</span>,  
</span></span><span style=display:flex><span>        joinSelfColumn <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;fk_role_id&#34;</span>, joinTargetColumn <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;fk_permission_id&#34;</span>,  
</span></span><span style=display:flex><span>        orderBy <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;weight&#34;</span>,
</span></span><span style=display:flex><span>        extraCondition <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;pid = 0&#34;</span>  
</span></span><span style=display:flex><span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> List<span style=color:#f92672>&lt;</span>Permission<span style=color:#f92672>&gt;</span> permissions;
</span></span></code></pre></div><ol start=2><li>开发业务方法 <code>RoleService -> getPermissions()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/**  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * 按主键查询该角色的全部权限列表  
</span></span></span><span style=display:flex><span><span style=color:#75715e> *  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param id 角色主键  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @return 该角色的全部权限列表  
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>  
</span></span><span style=display:flex><span>List<span style=color:#f92672>&lt;</span>Permission<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>getPermissions</span>(Long id);
</span></span></code></pre></div><ol start=3><li>实现业务方法 <code>RoleServiceImpl -> getPermissions()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Cacheable</span>(key <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;#root.methodName + &#39;:&#39; + #id&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Override</span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> List<span style=color:#f92672>&lt;</span>Permission<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>getPermissions</span>(Long id) {  
</span></span><span style=display:flex><span>    QueryWrapper queryWrapper <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> QueryWrapper();  
</span></span><span style=display:flex><span>    queryWrapper.<span style=color:#a6e22e>where</span>(ROLE.<span style=color:#a6e22e>ID</span>.<span style=color:#a6e22e>eq</span>(id));  
</span></span><span style=display:flex><span>    Role role <span style=color:#f92672>=</span> roleMapper.<span style=color:#a6e22e>selectOneWithRelationsByQuery</span>(queryWrapper);  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> role.<span style=color:#a6e22e>getPermissions</span>();  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=4><li>开发控制方法 <code>RoleController -> getPermissions()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Operation</span>(summary <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;查询权限列表&#34;</span>, description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;根据权重字段升序&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@GetMapping</span>(<span style=color:#e6db74>&#34;getPermissions/{id}&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> List<span style=color:#f92672>&lt;</span>Permission<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>getPermissions</span>(<span style=color:#a6e22e>@PathVariable</span> Long id) {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> roleService.<span style=color:#a6e22e>getPermissions</span>(id);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=e09-修改权限列表>E09. 修改权限列表</h2><blockquote><p>心法: 业务流程</p></blockquote><pre tabindex=0><code class=language-mermaid data-lang=mermaid>graph LR

n1[在角色权限中间表中&lt;br/&gt;删除该角色的全部权限]
--&gt; n2[在角色权限中间表中&lt;br/&gt;批量添加该角色的新记录] 
--&gt; n3[逐出&lt;br/&gt;缓存]
--&gt; n4[返回&lt;br/&gt;布尔结果]
</code></pre><blockquote><p>武技: 按主键修改该角色的权限列表</p></blockquote><ol><li>开发业务方法 <code>RoleService -> updatePermissions()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/**  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * 按主键修改该角色的权限列表    
</span></span></span><span style=display:flex><span><span style=color:#75715e> *  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param id      角色主键    
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param permissionIds 权限主键列表    
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>updatePermissions</span>(Long id, List<span style=color:#f92672>&lt;</span>Long<span style=color:#f92672>&gt;</span> permissionIds);
</span></span></code></pre></div><ol start=2><li>实现业务方法 <code>RoleServiceImpl -> updatePermissions()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@CacheEvict</span>(allEntries <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Transactional</span>(rollbackFor <span style=color:#f92672>=</span> Exception.<span style=color:#a6e22e>class</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Override</span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>updatePermissions</span>(Long id, List<span style=color:#f92672>&lt;</span>Long<span style=color:#f92672>&gt;</span> permissionIds) {  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 在角色权限中间表中，删除该角色的全部记录    </span>
</span></span><span style=display:flex><span>	QueryWrapper queryWrapper <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> QueryWrapper();  
</span></span><span style=display:flex><span>    queryWrapper.<span style=color:#a6e22e>where</span>(ROLE_PERMISSION.<span style=color:#a6e22e>FK_ROLE_ID</span>.<span style=color:#a6e22e>eq</span>(id));  
</span></span><span style=display:flex><span>    rolePermissionMapper.<span style=color:#a6e22e>deleteByQuery</span>(queryWrapper);
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 在角色权限中间表中，批量添加该角色的新记录  </span>
</span></span><span style=display:flex><span>    List<span style=color:#f92672>&lt;</span>RolePermission<span style=color:#f92672>&gt;</span> rolePermissions <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ArrayList<span style=color:#f92672>&lt;&gt;</span>();  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> (Long permissionId: permissionIds){  
</span></span><span style=display:flex><span>        RolePermission rolePermission <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> RolePermission();  
</span></span><span style=display:flex><span>        rolePermission.<span style=color:#a6e22e>setFkRoleId</span>(id);  
</span></span><span style=display:flex><span>        rolePermission.<span style=color:#a6e22e>setFkPermissionId</span>(permissionId);  
</span></span><span style=display:flex><span>        rolePermission.<span style=color:#a6e22e>setCreated</span>(LocalDateTime.<span style=color:#a6e22e>now</span>());  
</span></span><span style=display:flex><span>        rolePermission.<span style=color:#a6e22e>setUpdated</span>(LocalDateTime.<span style=color:#a6e22e>now</span>());  
</span></span><span style=display:flex><span>        rolePermissions.<span style=color:#a6e22e>add</span>(rolePermission);  
</span></span><span style=display:flex><span>    }  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 批量添加中间表记录    </span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span>(rolePermissionMapper.<span style=color:#a6e22e>insertBatch</span>(rolePermissions) <span style=color:#f92672>&lt;=</span> 0){  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> ServiceException(<span style=color:#e6db74>&#34;角色权限中间表记录添加失败&#34;</span>);  
</span></span><span style=display:flex><span>    }  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=3><li>开发控制方法 <code>RoleController -> updatePermissions()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Operation</span>(summary <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;修改权限列表&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@PostMapping</span>(<span style=color:#e6db74>&#34;updatePermissions/{id}&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Result <span style=color:#a6e22e>updatePermissions</span>(<span style=color:#a6e22e>@PathVariable</span> Long id, <span style=color:#a6e22e>@RequestParam</span> List<span style=color:#f92672>&lt;</span>Long<span style=color:#f92672>&gt;</span> permissionIds) {  
</span></span><span style=display:flex><span>    roleService.<span style=color:#a6e22e>updatePermissions</span>(id, permissionIds);  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> Result(ResultCode.<span style=color:#a6e22e>SUCCESS</span>);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h1 id=s14-开发权限接口>S14. 开发权限接口</h1><blockquote><p>心法: Permission接口文档</p></blockquote><ul><li>前缀 <code>/api/v1/permission</code>:</li></ul><table><thead><tr><th></th><th>接口</th><th>类型</th><th>描述</th><th>请求参数</th><th>必要参数</th></tr></thead><tbody><tr><td>1</td><td><code>save</code></td><td>POST</td><td>添加一条记录</td><td><code>@RequestBody PermissionInsert dto</code></td><td></td></tr><tr><td>2</td><td><code>getInfo/{id}</code></td><td>GET</td><td>根据主键查询</td><td><code>@PathVariable Long id</code></td><td><code>id</code></td></tr><tr><td>3</td><td><code>update</code></td><td>POST</td><td>根据主键修改</td><td><code>@RequestBody PermissionUpdate dto</code></td><td><code>id</code></td></tr><tr><td>4</td><td><code>remove/{id}</code></td><td>POST</td><td>根据主键删除</td><td><code>@PathVariable Long id</code></td><td><code>id</code></td></tr><tr><td>5</td><td><code>removeBatch</code></td><td>POST</td><td>根据主键批删</td><td><code>@RequestParam List&lt;Long> ids</code></td><td><code>ids</code></td></tr><tr><td>6</td><td><code>page</code></td><td>GET</td><td>根据父级分页</td><td><code>Page&lt;Permission> page</code><code>@PathVariable Long pid</code></td><td><code>pageNumber</code><code>pageSize</code><code>pid</code></td></tr><tr><td>7</td><td><code>list</code></td><td>GET</td><td>查询全部权限</td><td></td><td></td></tr></tbody></table><h2 id=e01-添加一条记录-7>E01. 添加一条记录</h2><blockquote><p>心法: 业务流程</p></blockquote><pre tabindex=0><code class=language-mermaid data-lang=mermaid>graph LR

ex1[抛出异常]
ex2[抛出异常]

1[P1]
--&gt; n1[根据标题&lt;br/&gt;查询权限] --&gt; f{是否&lt;br/&gt;存在}
		f --是--&gt; ex1[抛出异常]
		f --否--&gt; f1{父权限参数&lt;br/&gt;是否为空}
			f1 --是--&gt; n2[设置该权限为根权限]
			f1 --否--&gt; f2{查询父权限&lt;br/&gt;是否存在}
				f2 --否--&gt; ex2[抛出异常]
				f2 --是--&gt; P2
	
2[P2] --&gt; n3[置空主键]
		--&gt; n4[设置当前创建时间&lt;br/&gt;设置当前修改时间] 
		--&gt; n5[添加记录]
		--&gt; n6[逐出缓存]
		--&gt; n7[返回布尔结果]
</code></pre><blockquote><p>武技: 添加一条权限记录</p></blockquote><ol><li>开发DTO实体类 <code>PermissionInsertDTO</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> com.lsx.dto;  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Schema</span>(name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;权限添加DTO&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Data</span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>PermissionInsertDTO</span> <span style=color:#66d9ef>implements</span> Serializable {  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@NotEmpty</span>(message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;标题不能为空&#34;</span>)  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Size</span>(min <span style=color:#f92672>=</span> 1, max <span style=color:#f92672>=</span> 128, message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;标题长度必须在1~128之间&#34;</span>)  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Schema</span>(description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;标题&#34;</span>)  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String title;  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Range</span>(min <span style=color:#f92672>=</span> 0, message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;权重最小为0&#34;</span>)  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Schema</span>(description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;权重，数字越小越优先&#34;</span>)  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Long weight;  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Size</span>(min <span style=color:#f92672>=</span> 1, max <span style=color:#f92672>=</span> 512, message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;描述长度必须在1~512之间&#34;</span>)  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Schema</span>(description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;描述&#34;</span>)  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String info;  
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Size</span>(min <span style=color:#f92672>=</span> 1, max <span style=color:#f92672>=</span> 256, message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;跳转地址长度必须在1~256之间&#34;</span>)  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Schema</span>(description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;跳转地址&#34;</span>)  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String url;  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@NotEmpty</span>(message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;图标不能为空&#34;</span>) 
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Size</span>(min <span style=color:#f92672>=</span> 1, max <span style=color:#f92672>=</span> 256, message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;图标长度必须在1~256之间&#34;</span>)  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Schema</span>(description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;图标&#34;</span>)  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String icon;  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Range</span>(min <span style=color:#f92672>=</span> 0, message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;父权限主键最小为0&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>@Schema</span>(description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;父权限主键，0视为根节点&#34;</span>)  
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>private</span> Long pid;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=2><li>重写业务方法 <code>PermissionServiceImpl -> save()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@CacheEvict</span>(allEntries <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>save</span>(Permission entity) {  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 判断权限标题是否已经存在  </span>
</span></span><span style=display:flex><span>    Permission permission <span style=color:#f92672>=</span> permissionMapper.<span style=color:#a6e22e>selectOneByCondition</span>(PERMISSION.<span style=color:#a6e22e>TITLE</span>.<span style=color:#a6e22e>eq</span>(entity.<span style=color:#a6e22e>getTitle</span>()));  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (ObjectUtil.<span style=color:#a6e22e>isNotNull</span>(permission)) {  
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> ServiceException(<span style=color:#e6db74>&#34;权限标题已存在&#34;</span>);  
</span></span><span style=display:flex><span>    }  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 判断父权限是否存在  </span>
</span></span><span style=display:flex><span>	Long pid <span style=color:#f92672>=</span> entity.<span style=color:#a6e22e>getPid</span>();  
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (ObjectUtil.<span style=color:#a6e22e>isNotNull</span>(pid) <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span>(pid.<span style=color:#a6e22e>equals</span>(PermissionConst.<span style=color:#a6e22e>ROOT_ID</span>))) {  
</span></span><span style=display:flex><span>	    <span style=color:#66d9ef>if</span> (ObjectUtil.<span style=color:#a6e22e>isNull</span>(permissionMapper.<span style=color:#a6e22e>selectOneByCondition</span>(PERMISSION.<span style=color:#a6e22e>ID</span>.<span style=color:#a6e22e>eq</span>(pid)))) {  
</span></span><span style=display:flex><span>	        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> ServiceException(<span style=color:#e6db74>&#34;父权限不存在&#34;</span>);  
</span></span><span style=display:flex><span>	    }  
</span></span><span style=display:flex><span>	} <span style=color:#66d9ef>else</span> {  
</span></span><span style=display:flex><span>	    <span style=color:#75715e>// 设置为根权限  </span>
</span></span><span style=display:flex><span>	    entity.<span style=color:#a6e22e>setPid</span>(PermissionConst.<span style=color:#a6e22e>ROOT_ID</span>); 
</span></span><span style=display:flex><span>	    entity.<span style=color:#a6e22e>setUrl</span>(<span style=color:#66d9ef>null</span>); 
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 清空主键  </span>
</span></span><span style=display:flex><span>    entity.<span style=color:#a6e22e>setId</span>(<span style=color:#66d9ef>null</span>);  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 设置创建时间和修改时间为当前时间    </span>
</span></span><span style=display:flex><span>	entity.<span style=color:#a6e22e>setCreated</span>(LocalDateTime.<span style=color:#a6e22e>now</span>());  
</span></span><span style=display:flex><span>    entity.<span style=color:#a6e22e>setUpdated</span>(LocalDateTime.<span style=color:#a6e22e>now</span>());  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 添加记录    </span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>super</span>.<span style=color:#a6e22e>save</span>(entity);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=3><li>重写控制方法 <code>PermissionController -> save()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Operation</span>(summary <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;添加一条记录&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@PostMapping</span>(<span style=color:#e6db74>&#34;save&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>save</span>(<span style=color:#a6e22e>@RequestBody</span> <span style=color:#a6e22e>@Validated</span> PermissionInsertDTO dto) {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> permissionService.<span style=color:#a6e22e>save</span>(BeanUtil.<span style=color:#a6e22e>copyProperties</span>(dto, Permission.<span style=color:#a6e22e>class</span>));  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=e02-根据主键查询-7>E02. 根据主键查询</h2><blockquote><p>心法: 业务流程</p></blockquote><pre tabindex=0><code class=language-mermaid data-lang=mermaid>graph LR

n1[根据主键&lt;br/&gt;查询权限] --&gt; f{是否&lt;br/&gt;存在}
	f --是--&gt; n2[加入&lt;br/&gt;缓存] --&gt; n2a[返回&lt;br/&gt;结果]
	f --否--&gt; n3[抛出&lt;br/&gt;异常]
</code></pre><blockquote><p>武技: 根据主键查询一条权限记录</p></blockquote><ol><li>重写业务方法 <code>PermissionServiceImpl -> getById()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Cacheable</span>(key <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;#id&#34;</span>, unless <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;#result == null&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Permission <span style=color:#a6e22e>getById</span>(Serializable id) {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>super</span>.<span style=color:#a6e22e>getById</span>(id);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=2><li>重写控制方法 <code>PermissionController -> getInfo()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Operation</span>(summary <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;根据主键查询&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@GetMapping</span>(<span style=color:#e6db74>&#34;getInfo/{id}&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Permission <span style=color:#a6e22e>getInfo</span>(<span style=color:#a6e22e>@PathVariable</span> Long id) {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> permissionService.<span style=color:#a6e22e>getById</span>(id);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=e03-根据主键修改-7>E03. 根据主键修改</h2><blockquote><p>心法: 业务流程</p></blockquote><pre tabindex=0><code class=language-mermaid data-lang=mermaid>graph LR

ex[抛出异常]

f{是否需要&lt;br/&gt;修改标题}
	f --是--&gt; f1{标题是否&lt;br/&gt;已经存在}
		f1 --是--&gt; ex 
		f1 --否--&gt; n1 
	f --否--&gt; n1

	n1[设置&lt;br/&gt;当前修改时间]
--&gt; n2[置空&lt;br/&gt;创建时间]
--&gt; n3[修改&lt;br/&gt;记录]
--&gt; n4[逐出&lt;br/&gt;缓存]
--&gt; n5[返回&lt;br/&gt;布尔结果]
</code></pre><blockquote><p>武技: 根据主键修改一条权限记录</p></blockquote><ol><li>开发DTO实体类 <code>RoleUpdateDTO</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> com.lsx.dto;  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/** @author lsx */</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Schema</span>(name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;权限修改DTO&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Data</span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>PermissionUpdateDTO</span> <span style=color:#66d9ef>implements</span> Serializable {  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@NotNull</span>(message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;主键不能为空&#34;</span>)  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Schema</span>(description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;主键&#34;</span>)  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Long id;  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Size</span>(min <span style=color:#f92672>=</span> 1, max <span style=color:#f92672>=</span> 128, message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;标题长度必须在1~128之间&#34;</span>)  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Schema</span>(description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;标题&#34;</span>)  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String title;  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Range</span>(min <span style=color:#f92672>=</span> 0, message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;权重最小为0&#34;</span>)  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Schema</span>(description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;权重，数字越小越优先&#34;</span>)  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Long weight;  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Size</span>(min <span style=color:#f92672>=</span> 1, max <span style=color:#f92672>=</span> 512, message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;描述长度必须在1~512之间&#34;</span>)  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Schema</span>(description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;描述&#34;</span>)  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String info;  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Size</span>(min <span style=color:#f92672>=</span> 1, max <span style=color:#f92672>=</span> 256, message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;跳转地址长度必须在1~256之间&#34;</span>)  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Schema</span>(description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;跳转地址&#34;</span>)  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String url;  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Size</span>(min <span style=color:#f92672>=</span> 1, max <span style=color:#f92672>=</span> 256, message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;图标长度必须在1~256之间&#34;</span>)  
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Schema</span>(description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;图标&#34;</span>)  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String icon;  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=2><li>重写业务方法 <code>PermissionServiceImpl -> updateById()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@CacheEvict</span>(allEntries <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>updateById</span>(Permission entity) {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 判断是否要修改权限标题</span>
</span></span><span style=display:flex><span>	String title <span style=color:#f92672>=</span> entity.<span style=color:#a6e22e>getTitle</span>();
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (ObjectUtil.<span style=color:#a6e22e>isNotNull</span>(title)) {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 判断权限标题是否已经存在</span>
</span></span><span style=display:flex><span>		Permission permission <span style=color:#f92672>=</span> permissionMapper.<span style=color:#a6e22e>selectOneByQuery</span>(QueryWrapper.<span style=color:#a6e22e>create</span>()
</span></span><span style=display:flex><span>				.<span style=color:#a6e22e>where</span>(PERMISSION.<span style=color:#a6e22e>TITLE</span>.<span style=color:#a6e22e>eq</span>(title))
</span></span><span style=display:flex><span>				.<span style=color:#a6e22e>and</span>(PERMISSION.<span style=color:#a6e22e>ID</span>.<span style=color:#a6e22e>ne</span>(entity.<span style=color:#a6e22e>getId</span>())));
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> (ObjectUtil.<span style=color:#a6e22e>isNotNull</span>(permission)) {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> ServiceException(<span style=color:#e6db74>&#34;权限标题已存在&#34;</span>);
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 设置最后修改时间为当前时间</span>
</span></span><span style=display:flex><span>	entity.<span style=color:#a6e22e>setUpdated</span>(LocalDateTime.<span style=color:#a6e22e>now</span>());
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 不允许修改创建时间和PID</span>
</span></span><span style=display:flex><span>	entity.<span style=color:#a6e22e>setPid</span>(<span style=color:#66d9ef>null</span>);
</span></span><span style=display:flex><span>	entity.<span style=color:#a6e22e>setCreated</span>(<span style=color:#66d9ef>null</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 修改记录</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>super</span>.<span style=color:#a6e22e>updateById</span>(entity);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=3><li>重写控制方法 <code>PermissionController -> update()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Operation</span>(summary <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;根据主键修改&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@PostMapping</span>(<span style=color:#e6db74>&#34;update&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>update</span>(<span style=color:#a6e22e>@RequestBody</span> <span style=color:#a6e22e>@Validated</span> PermissionUpdateDTO dto) {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> permissionService.<span style=color:#a6e22e>updateById</span>(BeanUtil.<span style=color:#a6e22e>copyProperties</span>(dto, Permission.<span style=color:#a6e22e>class</span>));  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=e04-根据主键删除-7>E04. 根据主键删除</h2><blockquote><p>心法: 业务流程</p></blockquote><pre tabindex=0><code class=language-mermaid data-lang=mermaid>graph LR

n1[删除该权限关联的&lt;br/&gt;全部中间表记录]
--&gt; n2[删除该权限的&lt;br/&gt;全部子权限]
--&gt; n3[删除&lt;br/&gt;该权限]
--&gt; n4[逐出&lt;br/&gt;缓存]
--&gt; n5[返回&lt;br/&gt;布尔结果]
</code></pre><blockquote><p>武技: 根据主键删除一条权限记录</p></blockquote><ol><li>重写业务方法 <code>PermissionServiceImpl -> removeById()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Transactional</span>(rollbackFor <span style=color:#f92672>=</span> Exception.<span style=color:#a6e22e>class</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Override</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@CacheEvict</span>(allEntries <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>removeById</span>(Serializable id) {  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 删除该权限关联的全部中间表记录  </span>
</span></span><span style=display:flex><span>    rolePermissionMapper.<span style=color:#a6e22e>deleteByCondition</span>(ROLE_PERMISSION.<span style=color:#a6e22e>FK_PERMISSION_ID</span>.<span style=color:#a6e22e>eq</span>(id));  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 删除该权限的全部子权限  </span>
</span></span><span style=display:flex><span>    permissionMapper.<span style=color:#a6e22e>deleteByCondition</span>(PERMISSION.<span style=color:#a6e22e>PID</span>.<span style=color:#a6e22e>eq</span>(id));  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 删除该权限  </span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>super</span>.<span style=color:#a6e22e>removeById</span>(id);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=2><li>重写控制方法 <code>PermissionController -> remove()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Operation</span>(summary <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;根据主键删除&#34;</span>, description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;根据主键删除一条权限记录&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>@PostMapping</span>(<span style=color:#e6db74>&#34;remove/{id}&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>remove</span>(<span style=color:#a6e22e>@PathVariable</span> Long id) {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> permissionService.<span style=color:#a6e22e>removeById</span>(id);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=e05-根据主键批删-7>E05. 根据主键批删</h2><blockquote><p>心法: 业务流程</p></blockquote><pre tabindex=0><code class=language-mermaid data-lang=mermaid>graph LR

n1[批量删除权限关联的&lt;br/&gt;全部中间表记录]
--&gt; n2[批量删除权限的&lt;br/&gt;全部子权限]
--&gt; n3[批量删除&lt;br/&gt;权限]
--&gt; n4[逐出&lt;br/&gt;缓存]
--&gt; n5[返回&lt;br/&gt;布尔结果]
</code></pre><blockquote><p>武技: 根据主键列表批量删除权限记录</p></blockquote><ol><li>重写业务方法 <code>PermissionServiceImpl -> removeByIds()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Transactional</span>(rollbackFor <span style=color:#f92672>=</span> Exception.<span style=color:#a6e22e>class</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Override</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@CacheEvict</span>(allEntries <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>removeByIds</span>(Collection<span style=color:#f92672>&lt;?</span> <span style=color:#66d9ef>extends</span> Serializable<span style=color:#f92672>&gt;</span> ids) {  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 批量删除权限关联的全部中间表记录  </span>
</span></span><span style=display:flex><span>    rolePermissionMapper.<span style=color:#a6e22e>deleteByCondition</span>(ROLE_PERMISSION.<span style=color:#a6e22e>FK_PERMISSION_ID</span>.<span style=color:#a6e22e>in</span>(ids));  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 批量删除权限的全部子权限  </span>
</span></span><span style=display:flex><span>    permissionMapper.<span style=color:#a6e22e>deleteByCondition</span>(PERMISSION.<span style=color:#a6e22e>PID</span>.<span style=color:#a6e22e>in</span>(ids));  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 批量删除权限  </span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>super</span>.<span style=color:#a6e22e>removeByIds</span>(ids);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=2><li>重写控制方法 <code>PermissionController -> removeBatch()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Operation</span>(summary <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;根据主键批删&#34;</span>, description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;根据主键列表批量删除权限记录&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>@PostMapping</span>(<span style=color:#e6db74>&#34;removeBatch&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>removeBatch</span>(<span style=color:#a6e22e>@RequestParam</span> List<span style=color:#f92672>&lt;</span>Long<span style=color:#f92672>&gt;</span> ids) {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> permissionService.<span style=color:#a6e22e>removeByIds</span>(ids);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=e06-根据父级分页>E06. 根据父级分页</h2><blockquote><p>心法: 业务流程</p></blockquote><pre tabindex=0><code class=language-mermaid data-lang=mermaid>graph LR

n1[分页查询&lt;br/&gt;权限记录] 
--&gt; n2[根据权重升序&lt;br/&gt;根据主键降序] 
--&gt; n3[加入&lt;br/&gt;缓存]
--&gt; n4[返回&lt;br/&gt;分页数据]
</code></pre><blockquote><p>武技: 分页查询权限记录，仅查询根权限</p></blockquote><ol><li>开发业务方法 <code>PermissionService -> page()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/**  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * 分页查询指定父权限下的全部子权限  
</span></span></span><span style=display:flex><span><span style=color:#75715e> *  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param page 分页信息  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @param pid  父权限主键  
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @return 分页信息  
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>  
</span></span><span style=display:flex><span>Page<span style=color:#f92672>&lt;</span>Permission<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>page</span>(Page<span style=color:#f92672>&lt;</span>Permission<span style=color:#f92672>&gt;</span> page, Long pid);
</span></span></code></pre></div><ol start=2><li>重写业务方法 <code>PermissionServiceImpl -> page()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Cacheable</span>(key <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;#root.methodName + &#39;:&#39; + #pid + &#39;:&#39; + #page.getPageSize() + &#39;:&#39; + #page.getPageNumber()&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Page<span style=color:#f92672>&lt;</span>Permission<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>page</span>(Page<span style=color:#f92672>&lt;</span>Permission<span style=color:#f92672>&gt;</span> page, Long pid) {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>super</span>.<span style=color:#a6e22e>page</span>(page, QueryWrapper.<span style=color:#a6e22e>create</span>()  
</span></span><span style=display:flex><span>            .<span style=color:#a6e22e>where</span>(PERMISSION.<span style=color:#a6e22e>PID</span>.<span style=color:#a6e22e>eq</span>(pid))  
</span></span><span style=display:flex><span>            .<span style=color:#a6e22e>orderBy</span>(PERMISSION.<span style=color:#a6e22e>WEIGHT</span>.<span style=color:#a6e22e>asc</span>(), PERMISSION.<span style=color:#a6e22e>ID</span>.<span style=color:#a6e22e>desc</span>()));  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=3><li>重写控制方法 <code>PermissionController -> page()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Operation</span>(summary <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;根据父级分页&#34;</span>, description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;根据权重字段升序，权重相同根据ID降序&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@GetMapping</span>(<span style=color:#e6db74>&#34;page/{pid}&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> Page<span style=color:#f92672>&lt;</span>Permission<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>page</span>(Page<span style=color:#f92672>&lt;</span>Permission<span style=color:#f92672>&gt;</span> page, <span style=color:#a6e22e>@PathVariable</span> Long pid) {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> permissionService.<span style=color:#a6e22e>page</span>(page, pid);  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=e07-查询全部权限>E07. 查询全部权限</h2><blockquote><p>心法: 业务流程</p></blockquote><pre tabindex=0><code class=language-mermaid data-lang=mermaid>graph LR

n1[查询全部&lt;br/&gt;权限记录] 
--&gt; n2[根据权重升序&lt;br/&gt;根据主键降序] 
--&gt; n3[加入&lt;br/&gt;缓存]
--&gt; n4[返回&lt;br/&gt;全部数据]
</code></pre><blockquote><p>武技: 查询全部权限记录，仅查询根权限</p></blockquote><ol><li>重写业务方法 <code>PermissionServiceImpl -> list()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Override</span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Cacheable</span>(key <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;#root.methodName&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> List<span style=color:#f92672>&lt;</span>Permission<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>list</span>() {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>super</span>.<span style=color:#a6e22e>list</span>(QueryWrapper.<span style=color:#a6e22e>create</span>()  
</span></span><span style=display:flex><span>            .<span style=color:#a6e22e>where</span>(PERMISSION.<span style=color:#a6e22e>PID</span>.<span style=color:#a6e22e>eq</span>(0))  
</span></span><span style=display:flex><span>            .<span style=color:#a6e22e>orderBy</span>(PERMISSION.<span style=color:#a6e22e>WEIGHT</span>.<span style=color:#a6e22e>asc</span>(), PERMISSION.<span style=color:#a6e22e>ID</span>.<span style=color:#a6e22e>desc</span>()));  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=2><li>重写控制方法 <code>PermissionController -> list()</code>:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Operation</span>(summary <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;查询全部权限&#34;</span>, description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;根据权重字段升序，权重相同根据ID降序&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#a6e22e>@GetMapping</span>(<span style=color:#e6db74>&#34;list&#34;</span>)  
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> List<span style=color:#f92672>&lt;</span>Permission<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>list</span>() {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> permissionService.<span style=color:#a6e22e>list</span>();  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h1 id=s15-部署后台后端>S15. 部署后台后端</h1><h2 id=e01-部署项目>E01. 部署项目</h2><blockquote><p>武技：在Docker中部署 <code>lesson-admin</code> 项目</p></blockquote><h3 id=1-打包项目>1. 打包项目</h3><ol><li>将主配中的全部IP地址由 <code>localhost</code> 改为 <code>192.168.40.77</code> 虚拟机地址。</li><li>在子项目 <code>lesson-admin</code> 中添加打包插件：</li></ol><p><code>pom.xml</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#75715e>&lt;!--项目打包--&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;build&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>&lt;!--最终Jar包名--&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;finalName&gt;</span>lesson-admin<span style=color:#f92672>&lt;/finalName&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;plugins&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>&lt;!--SpringBoot打包插件--&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;plugin&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>&lt;groupId&gt;</span>org.springframework.boot<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>&lt;artifactId&gt;</span>spring-boot-maven-plugin<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>&lt;version&gt;</span>2.4.8<span style=color:#f92672>&lt;/version&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>&lt;!--配置启动类--&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>&lt;configuration&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>&lt;mainClass&gt;</span>com.lsx.LessonAdminApp<span style=color:#f92672>&lt;/mainClass&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>&lt;/configuration&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>&lt;!--打包本项目全部依赖包到最终Jar包内--&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>&lt;executions&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>&lt;execution&gt;</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&lt;goals&gt;</span>
</span></span><span style=display:flex><span>                        <span style=color:#f92672>&lt;goal&gt;</span>repackage<span style=color:#f92672>&lt;/goal&gt;</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&lt;/goals&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>&lt;/execution&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>&lt;/executions&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;/plugin&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;/plugins&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/build&gt;</span>
</span></span></code></pre></div><ol start=3><li>打包父项目（然后打包子项目）：</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#75715e># 打包父项目</span>
</span></span><span style=display:flex><span>cd D:\workspace\java\lesson-project
</span></span><span style=display:flex><span>mvn clean install -Dmaven.test.skip=true
</span></span></code></pre></div><h3 id=2-创建容器>2. 创建容器</h3><ol><li>创建相关目录：</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 创建相关目录</span>
</span></span><span style=display:flex><span>mkdir -p /opt/app/lesson/lesson-admin;
</span></span><span style=display:flex><span>chmod -R <span style=color:#ae81ff>777</span> /opt/app/lesson;
</span></span></code></pre></div><ol start=2><li>将Jar包 <code>lesson-admin.jar</code> 拷贝到 <code>/opt/app/lesson/lesson-admin</code> 目录中。</li><li>创建DockerFile：</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 开发节点的Dockerfile文件</span>
</span></span><span style=display:flex><span>cd /opt/app/lesson/lesson-admin;
</span></span><span style=display:flex><span>touch Dockerfile;
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#39;FROM openjdk:11&#39;</span> &gt;&gt; Dockerfile;
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#39;MAINTAINER lsx&#39;</span> &gt;&gt; Dockerfile;
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#39;ADD lesson-admin.jar lesson-admin.jar&#39;</span> &gt;&gt; Dockerfile;
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#39;EXPOSE 5266&#39;</span> &gt;&gt; Dockerfile;
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#39;CMD [&#34;nohup&#34;, &#34;java&#34;, &#34;-jar&#34;, &#34;lesson-admin.jar&#34;, &#34;&amp;&#34;]&#39;</span> &gt;&gt; Dockerfile;
</span></span></code></pre></div><ol start=4><li>构建镜像：</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cd /opt/app/lesson/lesson-admin;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 根据Dockerfile文件制作镜像: 必须在Dockerfile文件同级目录下</span>
</span></span><span style=display:flex><span>docker build -t lesson-admin:v1.0 .
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 查看镜像</span>
</span></span><span style=display:flex><span>docker images
</span></span></code></pre></div><ol start=5><li>创建容器：</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 创建并运行节点容器</span>
</span></span><span style=display:flex><span>docker run --name lesson-admin --network my-net -p 5266:5266 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	-e TZ<span style=color:#f92672>=</span>Asia/Shanghai <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	-d lesson-admin:v1.0;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 查看节点容器</span>
</span></span><span style=display:flex><span>docker ps --format <span style=color:#e6db74>&#34;{{.ID}}\t{{.Names}}\t{{.Ports}}&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 永久开放5055端口</span>
</span></span><span style=display:flex><span>firewall-cmd --add-port<span style=color:#f92672>=</span>5266/tcp --permanent
</span></span><span style=display:flex><span>firewall-cmd --reload
</span></span></code></pre></div><ol start=6><li>在Windows机器上 <a href=http://192.168.40.77:5266/doc.html>访问容器的Swagger文档</a></li></ol><h2 id=e02-线上诊断>E02. 线上诊断</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 进入容器内部</span>
</span></span><span style=display:flex><span>docker exec -it lesson-admin bash
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 在当前目录下，下载Arthas</span>
</span></span><span style=display:flex><span>wget https://arthas.aliyun.com/arthas-boot.jar
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 运行Arthas：输入1回车</span>
</span></span><span style=display:flex><span>java -jar arthas-boot.jar
</span></span></code></pre></div></div><svg id="btt-button" class="arrow-logo" xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 384 512" onclick="scrollToTop()" title="Go to top"><path d="M177 159.7l136 136c9.4 9.4 9.4 24.6.0 33.9l-22.6 22.6c-9.4 9.4-24.6 9.4-33.9.0L160 255.9l-96.4 96.4c-9.4 9.4-24.6 9.4-33.9.0L7 329.7c-9.4-9.4-9.4-24.6.0-33.9l136-136c9.4-9.5 24.6-9.5 34-.1z"/></svg>
<script>let backToTopButton=document.getElementById("btt-button");window.onscroll=function(){scrollFunction()};function scrollFunction(){document.body.scrollTop>20||document.documentElement.scrollTop>20?backToTopButton.style.display="block":backToTopButton.style.display="none"}function scrollToTop(){window.scrollTo(0,0)}</script></div></main><footer class=footer><span>&copy; 2024 The Marauders</span>
<span>Made with &#10084;&#65039; using <a target=_blank href=https://github.com/gokarna-theme/gokarna-hugo>Gokarna</a></span></footer></body></html>